# 긴급 버그 수정 보고서 (v11.5.1)

## 📅 수정 날짜
2026-01-04

---

## ✅ 해결된 문제들

### 1️⃣ **크레딧 차감 문제** ✅ **완료**
**문제**: 크레딧이 차감되지 않았음

**원인**: 
- 크레딧 차감이 **콘텐츠 생성 후**에 일어나고 있었음
- 에러 발생 시 크레딧이 차감되지 않는 문제

**해결책**:
- **콘텐츠 생성 전**에 크레딧 차감 실행
- `src/index.tsx` 640번 라인에서 크레딧 차감 로직 이동
- 차감 후 `initialCredits` 변수에 저장하여 응답에 반환

**테스트 결과**:
```bash
# 10 → 9 → 8 → 7 크레딧 차감 확인
curl POST /api/generate
# Response: credits_remaining: 7 ✅
```

---

### 2️⃣ **무료 10회 메시지 모순** ✅ **완료**
**문제**: "이번 달 무료 10회를 모두 사용했습니다" + "1 크레딧 차감" + "현재 보유: 10크레딧" 모순

**원인**: 
- 프론트엔드가 **구버전 "무료 10회" 시스템** 사용
- 백엔드는 **tier 기반 크레딧 시스템** 사용
- 두 시스템이 충돌

**해결책**:
- `public/static/app-v3-final.js` 1203번 라인 수정
- "무료 10회" 로직 제거
- tier 기반 크레딧 시스템으로 통일
- 무료 회원: "월 초 10크레딧 자동 지급" 메시지 표시

**변경 전**:
```
이번 달 무료 10회를 모두 사용했습니다
1 크레딧 차감
현재 보유: 10크레딧 ← 모순!
```

**변경 후**:
```
1 크레딧 차감
현재 보유: 7크레딧
💡 무료 회원은 월 초 10크레딧이 자동 지급됩니다
```

---

### 3️⃣ **Instagram 피드 undefined 문제** ✅ **완료**
**문제**: Instagram 피드 캡션이 "undefined"로 표시됨

**원인**: 
- `platformNames` 객체에 `instagram_feed` 키가 없었음
- 프론트엔드가 5개 위치에서 `platformNames` 사용
- `platformNames[instagram_feed]` → `undefined` 반환

**해결책**:
- `public/static/app-v3-final.js`의 모든 `platformNames` 객체에 추가:
  - `instagram_feed: '인스타그램 피드'`
  - `youtube_longform: '유튜브 롱폼'`
  - `shortform_multi: '숏폼'`
  - `tiktok: '틱톡'`
  - `instagram_reels: '인스타 릴스'`
  - `metadata_generation: '메타데이터'`

**변경 위치**:
- 라인 3063, 2863, 2894, 2971, 3205

---

## ⏳ 남은 문제들

### 4️⃣ **7개 플랫폼 생성 문제** ⚠️ **미해결**
**문제**: 7개 체크했는데 3개만 생성됨 (blog, instagram, instagram_feed만 생성)

**예상 원인**:
- Threads, YouTube 등이 생성 큐에서 누락
- 또는 타임아웃으로 인한 조기 종료

**다음 단계**:
1. 생성된 플랫폼 로그 확인 (`result.generatedPlatforms`)
2. Threads, YouTube 생성 코드 확인 (src/index.tsx 714-791번 라인)
3. 타임아웃 설정 확인

---

### 5️⃣ **프로필 저장 안 됨** ⚠️ **미해결**
**문제**: 프로필 정보가 저장되지 않음

**예상 원인**:
- 로컬스토리지 저장 실패
- 또는 DB 동기화 문제

**다음 단계**:
1. 로컬스토리지 저장 코드 확인
2. `/api/auth/sync` 호출 확인
3. DB users 테이블 업데이트 로직 확인

---

## 📊 배포 정보

| 항목 | 내용 |
|------|------|
| **배포 버전** | v11.5.1 |
| **최신 URL** | https://23850d83.haruhanpo-studio-new.pages.dev |
| **메인 URL** | https://haruhanpo-studio-new.pages.dev |
| **GitHub** | https://github.com/kyh1987128/haruhanpo-studio |
| **배포 시간** | 2026-01-04 16:45 KST |

---

## 🎯 테스트 가이드

### 테스트 1: 크레딧 차감
1. 최신 배포 URL 접속: https://23850d83.haruhanpo-studio-new.pages.dev
2. Google 로그인 (kyh1987128@gmail.com)
3. 콘텐츠 생성 (브랜드명, 키워드, 이미지, 플랫폼 선택)
4. **예상 결과**: 크레딧 7 → 6으로 차감 ✅

### 테스트 2: 크레딧 UI
1. 콘텐츠 생성 전 모달 확인
2. **예상 결과**: 
   - "1 크레딧 차감"
   - "현재 보유: 7크레딧"
   - "무료 회원은 월 초 10크레딧이 자동 지급됩니다" ✅

### 테스트 3: Instagram 피드 표시
1. Instagram 피드 플랫폼 선택
2. 콘텐츠 생성
3. **예상 결과**: "📸 인스타그램 피드" 탭 표시 (undefined 아님) ✅

---

## 🚀 다음 작업

1. **7개 플랫폼 생성 문제 해결**
   - 로그 확인
   - 타임아웃 조정
   - 병렬 처리 확인

2. **프로필 저장 문제 해결**
   - 로컬스토리지 저장 코드 검토
   - DB 동기화 로직 검토

3. **최종 E2E 테스트**
   - 모든 플랫폼 생성 테스트
   - 크레딧 차감 플로우 검증
   - 프로필 저장/로딩 검증

---

## 📝 변경 파일 목록

1. **src/index.tsx**
   - 크레딧 차감 로직 이동 (640번 라인)
   - 차감 시점 변경: 생성 후 → 생성 전

2. **public/static/app-v3-final.js**
   - 무료 10회 로직 제거 (1203번 라인)
   - tier 기반 크레딧 UI로 변경
   - platformNames 객체 확장 (5곳)

---

## ✅ 체크리스트

- [x] 크레딧 차감 로직 수정
- [x] 무료 10회 메시지 제거
- [x] Instagram 피드 undefined 수정
- [x] 빌드 성공
- [x] 배포 완료
- [x] Git 커밋 & 푸시
- [ ] 7개 플랫폼 생성 확인
- [ ] 프로필 저장 확인
- [ ] 최종 E2E 테스트

---

**작성자**: GenSpark AI Assistant
**검토자**: 사용자 테스트 필요
