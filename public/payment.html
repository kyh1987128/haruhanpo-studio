<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í¬ë ˆë”§ ì¶©ì „ì†Œ | ë§ˆì¼€íŒ…í—ˆë¸Œ ìŠ¤íŠœë””ì˜¤</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://js.tosspayments.com/v1/payment"></script>
  <style>
    @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
    body { font-family: "Pretendard", sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .product-card:hover { transform: translateY(-5px); transition: all 0.3s ease; }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
  <div class="max-w-6xl w-full">
    <!-- í—¤ë” -->
    <div class="text-center mb-12">
      <h1 class="text-4xl font-bold text-white mb-4">âš¡ í¬ë ˆë”§ ì¶©ì „ì†Œ</h1>
      <p class="text-white/80 text-lg">ì°¨ë“± ê³¼ê¸ˆìœ¼ë¡œ ë” í•©ë¦¬ì ì¸ ì½˜í…ì¸  ìƒì„±</p>
      <div class="mt-6 bg-white/10 backdrop-blur-sm rounded-2xl p-4 inline-block">
        <p class="text-white/90 text-sm">
          ğŸ’¡ <strong>ì°¨ë“± ê³¼ê¸ˆ ì•ˆë‚´:</strong> 1ê°œ=1í¬ë ˆë”§ | 2-3ê°œ=2í¬ë ˆë”§ | 4-9ê°œ=4í¬ë ˆë”§
        </p>
      </div>
    </div>

    <!-- ë¡œë”© -->
    <div id="loading" class="text-center py-20">
      <div class="animate-spin rounded-full h-16 w-16 border-4 border-white/30 border-t-white mx-auto"></div>
      <p class="mt-6 text-white/80 text-lg">ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>

    <!-- ìƒí’ˆ ëª©ë¡ -->
    <div id="products-container" class="grid md:grid-cols-3 gap-8 hidden">
      <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ë™ì  ìƒì„± -->
    </div>

    <!-- í•˜ë‹¨ ë§í¬ -->
    <div class="mt-16 text-center">
      <a href="/" class="text-white/80 hover:text-white font-medium text-lg transition-colors">
        â† ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°
      </a>
    </div>
  </div>

  <script>
    // í† ìŠ¤í˜ì´ë¨¼ì¸  ì´ˆê¸°í™” (í…ŒìŠ¤íŠ¸ í‚¤)
    let tossPayments = null;
    try {
      const clientKey = 'test_ck_D5GePWvyJnrK0W0k6q8gLzN97Eoq'; // ì„ì‹œ í…ŒìŠ¤íŠ¸ í‚¤
      tossPayments = TossPayments(clientKey);
      console.log('âœ… í† ìŠ¤í˜ì´ë¨¼ì¸  ì´ˆê¸°í™” ì„±ê³µ');
    } catch (e) {
      console.warn('âš ï¸ í† ìŠ¤í˜ì´ë¨¼ì¸  ì´ˆê¸°í™” ì‹¤íŒ¨:', e.message);
    }

    // ìƒí’ˆ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadProducts() {
      try {
        const response = await fetch('/api/products');
        const data = await response.json();

        console.log('ğŸ“¦ ìƒí’ˆ API ì‘ë‹µ:', data);

        if (data.success && data.products && data.products.length > 0) {
          renderProducts(data.products);
          console.log(`âœ… ìƒí’ˆ ëª©ë¡ ë¡œë“œ ì„±ê³µ: ${data.products.length}ê°œ`);
        } else {
          showError('íŒë§¤ ì¤‘ì¸ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤. DBì—ì„œ ìƒí’ˆì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
        }
      } catch (error) {
        console.error('âŒ ìƒí’ˆ ë¡œë”© ì‹¤íŒ¨:', error);
        showError('ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ìƒí’ˆ ì¹´ë“œ ë Œë”ë§
    function renderProducts(products) {
      const container = document.getElementById('products-container');
      const loading = document.getElementById('loading');
      
      container.innerHTML = products.map(product => {
        const isPopular = product.name === 'PRO';
        const pricePerCredit = Math.round(product.price / product.credits);
        
        return `
          <div class="product-card bg-white rounded-3xl shadow-xl overflow-hidden ${isPopular ? 'ring-4 ring-yellow-400' : ''}">
            ${isPopular ? '<div class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white text-center py-2 font-bold">ğŸ”¥ ê°€ì¥ ì¸ê¸°</div>' : ''}
            
            <div class="p-8">
              <div class="text-center mb-6">
                <h3 class="text-2xl font-bold text-gray-900 mb-2">${product.name}</h3>
                <div class="text-5xl font-bold text-indigo-600 mb-1">${product.credits}</div>
                <div class="text-gray-500">í¬ë ˆë”§</div>
              </div>
              
              <div class="mb-6">
                <p class="text-gray-600 text-center mb-4">${product.description || 'í¬ë ˆë”§ì„ ì¶©ì „í•˜ê³  ì½˜í…ì¸ ë¥¼ ìƒì„±í•˜ì„¸ìš”'}</p>
                <div class="bg-gray-50 rounded-xl p-4">
                  <div class="text-sm text-gray-600 space-y-2">
                    <div class="flex justify-between">
                      <span>ê°œë‹¹ ê°€ê²©:</span>
                      <span class="font-semibold">${pricePerCredit}ì›</span>
                    </div>
                    <div class="flex justify-between">
                      <span>ìœ íš¨ê¸°ê°„:</span>
                      <span class="font-semibold text-green-600">ë¬´ì œí•œ</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <button 
                onclick="requestPayment('${product.name}', ${product.credits}, ${product.price})" 
                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-xl transition duration-200 text-lg">
                ${product.price.toLocaleString()}ì› ê²°ì œí•˜ê¸°
              </button>
            </div>
          </div>
        `;
      }).join('');

      loading.classList.add('hidden');
      container.classList.remove('hidden');
    }

    // ê²°ì œ ìš”ì²­
    async function requestPayment(productName, credits, price) {
      // ë¡œê·¸ì¸ ì²´í¬
      const userStr = localStorage.getItem('postflow_user');
      if (!userStr) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        location.href = '/';
        return;
      }

      if (!tossPayments) {
        alert('ê²°ì œ ì‹œìŠ¤í…œ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤. (í† ìŠ¤ API í‚¤ ì„¤ì • í•„ìš”)');
        return;
      }

      const user = JSON.parse(userStr);
      const orderId = 'ORDER-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);

      console.log('ğŸ’³ ê²°ì œ ìš”ì²­:', { productName, credits, price, orderId });

      try {
        await tossPayments.requestPayment('ì¹´ë“œ', {
          amount: price,
          orderId: orderId,
          orderName: `ë§ˆì¼€íŒ…í—ˆë¸Œ ${productName} ${credits}í¬ë ˆë”§`,
          customerName: user.name || user.email || 'ì‚¬ìš©ì',
          successUrl: window.location.origin + '/payment-success.html',
          failUrl: window.location.origin + '/payment-fail.html',
        });
      } catch (error) {
        if (error.code === 'USER_CANCEL') {
          console.log('ì‚¬ìš©ìê°€ ê²°ì œë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.');
        } else {
          console.error('ê²°ì œ ì˜¤ë¥˜:', error);
          alert('ê²°ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
      }
    }

    // ì—ëŸ¬ í‘œì‹œ
    function showError(message) {
      document.getElementById('loading').innerHTML = 
        `<div class="text-center py-20">
          <div class="text-6xl mb-4">âš ï¸</div>
          <p class="text-white text-xl">${message}</p>
          <p class="text-white/60 text-sm mt-4">ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.</p>
        </div>`;
    }

    // ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', loadProducts);
  </script>
</body>
</html>
