<!-- í†µê³„ ëŒ€ì‹œë³´ë“œ UI -->
<style>
  .stats-dashboard {
    background: white;
    border-radius: 1rem;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
  }

  .stats-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e5e7eb;
  }

  .stats-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: #1f2937;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .stats-refresh {
    padding: 0.5rem 1rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .stats-refresh:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 1rem;
    border-radius: 0.75rem;
    color: white;
  }

  .stat-card-label {
    font-size: 0.875rem;
    opacity: 0.9;
    margin-bottom: 0.5rem;
  }

  .stat-card-value {
    font-size: 2rem;
    font-weight: 700;
  }

  .stat-card-change {
    font-size: 0.75rem;
    margin-top: 0.5rem;
    opacity: 0.8;
  }

  .stats-section {
    margin-bottom: 1.5rem;
  }

  .stats-section-title {
    font-size: 1rem;
    font-weight: 600;
    color: #374151;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .stats-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .stats-list-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    background: #f9fafb;
    border-radius: 0.5rem;
    transition: all 0.2s;
  }

  .stats-list-item:hover {
    background: #f3f4f6;
  }

  .stats-list-item-name {
    font-weight: 600;
    color: #1f2937;
    font-size: 0.875rem;
  }

  .stats-list-item-value {
    font-weight: 700;
    color: #667eea;
    font-size: 0.875rem;
  }

  .stats-chart {
    height: 200px;
    background: #f9fafb;
    border-radius: 0.5rem;
    padding: 1rem;
    display: flex;
    align-items: flex-end;
    gap: 0.5rem;
  }

  .stats-chart-bar {
    flex: 1;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 0.25rem;
    transition: all 0.3s;
    position: relative;
    cursor: pointer;
  }

  .stats-chart-bar:hover {
    opacity: 0.8;
  }

  .stats-chart-tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: #1f2937;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
    margin-bottom: 0.5rem;
  }

  .stats-chart-bar:hover .stats-chart-tooltip {
    opacity: 1;
  }

  .stats-empty {
    text-align: center;
    padding: 3rem 1rem;
    color: #6b7280;
  }

  .stats-empty-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
  }

  .stats-toggle {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 0.5rem;
    padding: 0.5rem 1rem;
    font-weight: 600;
    color: #374151;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 1rem;
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .stats-toggle:hover {
    border-color: #667eea;
    background: #f9fafb;
  }

  .stats-toggle.open {
    border-color: #667eea;
    background: #ede9fe;
  }

  .stats-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out;
  }

  .stats-content.open {
    max-height: 1000px;
  }

  @media (max-width: 768px) {
    .stats-grid {
      grid-template-columns: 1fr;
    }

    .stat-card-value {
      font-size: 1.5rem;
    }
  }
</style>

<button class="stats-toggle" id="statsToggle" onclick="toggleStats()">
  <div style="display: flex; align-items: center; gap: 0.5rem;">
    <i class="fas fa-chart-bar"></i>
    <span>ğŸ“Š ë‚´ í†µê³„</span>
  </div>
  <i class="fas fa-chevron-down" id="statsToggleIcon"></i>
</button>

<div class="stats-content" id="statsContent">
  <div class="stats-dashboard">
    <!-- í—¤ë” -->
    <div class="stats-header">
      <div class="stats-title">
        <i class="fas fa-chart-line"></i>
        <span>ì´ë²ˆ ë‹¬ í†µê³„</span>
      </div>
      <button class="stats-refresh" onclick="refreshStats()">
        <i class="fas fa-sync-alt"></i> ìƒˆë¡œê³ ì¹¨
      </button>
    </div>

    <!-- ì£¼ìš” í†µê³„ ì¹´ë“œ -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-card-label">ìƒì„±í•œ ì½˜í…ì¸ </div>
        <div class="stat-card-value" id="totalContents">0</div>
        <div class="stat-card-change" id="contentsChange">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-label">ì‚¬ìš©í•œ í¬ë ˆë”§</div>
        <div class="stat-card-value" id="totalCredits">0</div>
        <div class="stat-card-change" id="creditsChange">-</div>
      </div>
    </div>

    <!-- ì›”ë³„ íŠ¸ë Œë“œ ì°¨íŠ¸ -->
    <div class="stats-section">
      <div class="stats-section-title">
        <i class="fas fa-chart-area"></i>
        <span>ì›”ë³„ íŠ¸ë Œë“œ (ìµœê·¼ 6ê°œì›”)</span>
      </div>
      <div class="stats-chart" id="monthlyChart">
        <div class="stats-empty" id="chartEmpty">
          <div class="stats-empty-icon">ğŸ“Š</div>
          <div>ì•„ì§ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>
        </div>
      </div>
    </div>

    <!-- í”Œë«í¼ë³„ í†µê³„ -->
    <div class="stats-section">
      <div class="stats-section-title">
        <i class="fas fa-layer-group"></i>
        <span>í”Œë«í¼ë³„ ì½˜í…ì¸ </span>
      </div>
      <div class="stats-list" id="platformStats">
        <div class="stats-empty">
          <div class="stats-empty-icon">ğŸ“±</div>
          <div>ì•„ì§ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>
        </div>
      </div>
    </div>

    <!-- ìì£¼ ì‚¬ìš©í•œ ë„êµ¬ -->
    <div class="stats-section">
      <div class="stats-section-title">
        <i class="fas fa-star"></i>
        <span>ìì£¼ ì‚¬ìš©í•œ ë„êµ¬ (TOP 5)</span>
      </div>
      <div class="stats-list" id="topWorkflows">
        <div class="stats-empty">
          <div class="stats-empty-icon">ğŸ”§</div>
          <div>ì•„ì§ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // í†µê³„ ëŒ€ì‹œë³´ë“œ í† ê¸€
  function toggleStats() {
    const content = document.getElementById('statsContent');
    const toggle = document.getElementById('statsToggle');
    const icon = document.getElementById('statsToggleIcon');
    
    if (content.classList.contains('open')) {
      content.classList.remove('open');
      toggle.classList.remove('open');
      icon.style.transform = 'rotate(0deg)';
    } else {
      content.classList.add('open');
      toggle.classList.add('open');
      icon.style.transform = 'rotate(180deg)';
      
      // ì²˜ìŒ ì—´ ë•Œ ë°ì´í„° ë¡œë“œ
      if (!window.statsLoaded) {
        loadStatsData();
      }
    }
  }

  // í†µê³„ ë°ì´í„° ë¡œë“œ
  async function loadStatsData() {
    if (!window.supabaseClient || !window.currentUser?.id) {
      console.log('Supabase ë˜ëŠ” ì‚¬ìš©ì ì •ë³´ ì—†ìŒ');
      return;
    }

    try {
      window.statsLoaded = true;
      
      // í˜„ì¬ ì›”
      const currentMonth = new Date().toISOString().slice(0, 7); // '2026-01'
      
      // 1. ì´ë²ˆ ë‹¬ í†µê³„
      const { data: currentMonthStats, error: monthError } = await window.supabaseClient
        .from('content_generation_stats')
        .select('content_count, credits_used, platform')
        .eq('user_id', window.currentUser.id)
        .eq('year_month', currentMonth);

      if (monthError) throw monthError;

      if (currentMonthStats && currentMonthStats.length > 0) {
        const totalContents = currentMonthStats.reduce((sum, s) => sum + s.content_count, 0);
        const totalCredits = currentMonthStats.reduce((sum, s) => sum + s.credits_used, 0);
        
        document.getElementById('totalContents').textContent = totalContents;
        document.getElementById('totalCredits').textContent = totalCredits;
        
        // í”Œë«í¼ë³„ í†µê³„ ë Œë”ë§
        renderPlatformStats(currentMonthStats);
      }

      // 2. ì›”ë³„ íŠ¸ë Œë“œ (ìµœê·¼ 6ê°œì›”)
      const sixMonthsAgo = new Date();
      sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 5);
      const startMonth = sixMonthsAgo.toISOString().slice(0, 7);

      const { data: monthlyData, error: trendError } = await window.supabaseClient
        .from('content_generation_stats')
        .select('year_month, content_count')
        .eq('user_id', window.currentUser.id)
        .gte('year_month', startMonth)
        .order('year_month', { ascending: true });

      if (trendError) throw trendError;

      if (monthlyData && monthlyData.length > 0) {
        renderMonthlyChart(monthlyData);
      }

      // 3. ìì£¼ ì‚¬ìš©í•œ ì›Œí¬í”Œë¡œìš°
      const { data: topWorkflows, error: workflowError } = await window.supabaseClient
        .rpc('get_top_workflows_by_user', { p_user_id: window.currentUser.id });

      // rpcê°€ ì—†ìœ¼ë©´ ì§ì ‘ ì¡°íšŒ
      if (workflowError || !topWorkflows) {
        const { data: workflowStats } = await window.supabaseClient
          .from('workflow_usage_stats')
          .select(`
            workflow_id,
            click_count,
            user_workflows (display_name, category, icon)
          `)
          .eq('user_id', window.currentUser.id)
          .order('click_count', { ascending: false })
          .limit(5);

        if (workflowStats && workflowStats.length > 0) {
          renderTopWorkflows(workflowStats);
        }
      } else {
        renderTopWorkflows(topWorkflows);
      }

    } catch (error) {
      console.error('í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
      showToast('í†µê³„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
    }
  }

  // í”Œë«í¼ë³„ í†µê³„ ë Œë”ë§
  function renderPlatformStats(stats) {
    const container = document.getElementById('platformStats');
    
    const platformNames = {
      'instagram_reels': 'Instagram ë¦´ìŠ¤',
      'youtube_shorts': 'YouTube ìˆí¼',
      'youtube_longform': 'YouTube ë¡±í¼',
      'naver_blog': 'ë„¤ì´ë²„ ë¸”ë¡œê·¸',
      'brunch': 'ë¸ŒëŸ°ì¹˜'
    };

    const html = stats
      .sort((a, b) => b.content_count - a.content_count)
      .map(stat => `
        <div class="stats-list-item">
          <div class="stats-list-item-name">
            ${platformNames[stat.platform] || stat.platform}
          </div>
          <div class="stats-list-item-value">
            ${stat.content_count}ê°œ (${stat.credits_used}í¬ë ˆë”§)
          </div>
        </div>
      `).join('');

    container.innerHTML = html;
  }

  // ì›”ë³„ ì°¨íŠ¸ ë Œë”ë§
  function renderMonthlyChart(data) {
    const container = document.getElementById('monthlyChart');
    const empty = document.getElementById('chartEmpty');
    
    if (empty) empty.remove();

    // ì›”ë³„ ì§‘ê³„
    const monthlyMap = {};
    data.forEach(d => {
      if (!monthlyMap[d.year_month]) {
        monthlyMap[d.year_month] = 0;
      }
      monthlyMap[d.year_month] += d.content_count;
    });

    const maxValue = Math.max(...Object.values(monthlyMap), 1);

    const html = Object.entries(monthlyMap)
      .map(([month, count]) => {
        const height = (count / maxValue) * 100;
        const monthName = month.slice(5); // '01', '02' ...
        return `
          <div class="stats-chart-bar" style="height: ${height}%">
            <div class="stats-chart-tooltip">${monthName}ì›”: ${count}ê°œ</div>
          </div>
        `;
      }).join('');

    container.innerHTML = html;
  }

  // ìì£¼ ì‚¬ìš©í•œ ì›Œí¬í”Œë¡œìš° ë Œë”ë§
  function renderTopWorkflows(workflows) {
    const container = document.getElementById('topWorkflows');

    if (!workflows || workflows.length === 0) {
      container.innerHTML = `
        <div class="stats-empty">
          <div class="stats-empty-icon">ğŸ”§</div>
          <div>ì•„ì§ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>
        </div>
      `;
      return;
    }

    const html = workflows.map((wf, index) => {
      const workflow = wf.user_workflows || wf;
      const clickCount = wf.click_count || wf.total_clicks || 0;
      
      return `
        <div class="stats-list-item">
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span style="font-weight: 700; color: #667eea;">${index + 1}</span>
            <i class="${workflow.icon || 'fas fa-link'}" style="color: #667eea;"></i>
            <span class="stats-list-item-name">${workflow.display_name}</span>
          </div>
          <div class="stats-list-item-value">${clickCount}íšŒ</div>
        </div>
      `;
    }).join('');

    container.innerHTML = html;
  }

  // í†µê³„ ìƒˆë¡œê³ ì¹¨
  function refreshStats() {
    window.statsLoaded = false;
    loadStatsData();
    showToast('ğŸ“Š í†µê³„ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
  }

  // ì „ì—­ í•¨ìˆ˜ ë…¸ì¶œ
  window.toggleStats = toggleStats;
  window.loadStatsData = loadStatsData;
  window.refreshStats = refreshStats;
