// ===================================
// Multi-Platform Content Generator v3.2 Final
// ë°±ì—”ë“œ API í‚¤, í™•ì¥ëœ í”„ë¡œí•„ ê´€ë¦¬
// ===================================

// ì „ì—­ ë³€ìˆ˜
let authMode = 'signup'; // ì¸ì¦ ëª¨ë“œ (signup or login)
let selectedImages = []; // ë” ì´ìƒ ì‚¬ìš© ì•ˆ í•¨ (ê°œë³„ ì½˜í…ì¸ ë¡œ ë³€ê²½)
let contentBlocks = {}; // { 0: { images: [], keywords: '', topic: '', description: '' }, 1: {...}, ... }
let contentPlatforms = {}; // ì½˜í…ì¸ ë³„ í”Œë«í¼ ì„ íƒ ìƒíƒœ (Option B)
let resultData = {};
let savedProfiles = [];
let contentHistory = [];
let customTemplates = [];
let currentEditImageIndex = null;
let currentEditingProfileId = null; // í”„ë¡œí•„ ìˆ˜ì • ì‹œ ì‚¬ìš©
let lastFormData = null; // ì¬ì‹œë„ìš©

// ğŸ”„ ë©€í‹°íƒ­ í¬ë ˆë”§ ë™ê¸°í™”
const creditSyncChannel = new BroadcastChannel('marketing_hub_credits');

// LocalStorage í‚¤
const STORAGE_KEYS = {
  PROFILES: 'content_generator_profiles',
  HISTORY: 'content_generator_history',
  CURRENT_PROFILE: 'content_generator_current_profile',
  TEMPLATES: 'content_generator_templates',
};

// ë¹„ìš© ìƒìˆ˜ (USD) - GPT-4o ê¸°ì¤€
const COSTS = {
  IMAGE_ANALYSIS: 0.01, // ì´ë¯¸ì§€ 1ì¥ë‹¹ ë¶„ì„ ë¹„ìš©
  BLOG: 0.04,
  INSTAGRAM: 0.03,
  INSTAGRAM_FEED: 0.03,
  INSTAGRAM_REELS: 0.04,
  THREADS: 0.02,
  YOUTUBE: 0.04,
  YOUTUBE_SHORTS: 0.04,
  YOUTUBE_LONGFORM: 0.08, // ë¡±í¼ì€ ë” ê¸¸ê³  ë³µì¡í•˜ë¯€ë¡œ 2ë°°
  TIKTOK: 0.04,
  SHORTFORM_MULTI: 0.05, // ë©€í‹°í”Œë«í¼ ìµœì í™” ì¶”ê°€ ë¹„ìš©
  METADATA_GENERATION: 0.03,
};

// í™˜ìœ¨ ì •ë³´
let EXCHANGE_RATE = 1300; // ê¸°ë³¸ê°’
let lastExchangeUpdate = null;

// ===================================
// Feature Flags (ì•ˆì „ ë°°í¬ìš©)
// ===================================
const FEATURE_FLAGS = {
  ENABLE_CUSTOM_TEMPLATES: true, // í…œí”Œë¦¿ ì €ì¥ ê¸°ëŠ¥
  ENABLE_TWITTER: false,          // Twitter í”Œë«í¼
  ENABLE_LINKEDIN: false,         // LinkedIn í”Œë«í¼
  ENABLE_KAKAOTALK: false,        // KakaoTalk í”Œë«í¼
  ENABLE_SCHEDULE: false,         // ë°œí–‰ ì˜ˆì • ê¸°ëŠ¥
};

// ê¸°ë³¸ í…œí”Œë¦¿
const DEFAULT_TEMPLATES = {
  blog: `ë‹¹ì‹ ì€ ë„¤ì´ë²„ ë¸”ë¡œê·¸ SEO ìµœì í™” ë° ë§ˆì¼€íŒ… ì½˜í…ì¸  ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

ã€ë¸Œëœë“œ ì •ë³´ã€‘
- ë¸Œëœë“œ/ì„œë¹„ìŠ¤/ìƒí’ˆ: {ë¸Œëœë“œëª…}
- í•µì‹¬ í‚¤ì›Œë“œ: {í‚¤ì›Œë“œ}
- ì‚°ì—… ë¶„ì•¼: {ì‚°ì—…ë¶„ì•¼}
- íƒ€ê²Ÿ: {íƒ€ê²Ÿì—°ë ¹ëŒ€} {íƒ€ê²Ÿì„±ë³„}
- í†¤ì•¤ë§¤ë„ˆ: {í†¤ì•¤ë§¤ë„ˆ}

ã€ì‘ì„± ëª©í‘œã€‘
ì œê³µëœ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ì—¬, ë„¤ì´ë²„ ê²€ìƒ‰ ìƒìœ„ ë…¸ì¶œê³¼ ë†’ì€ ì „í™˜ìœ¨ì„ ë™ì‹œì— ë‹¬ì„±í•˜ëŠ” ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ë¥¼ ì‘ì„±í•˜ì„¸ìš”.

ã€í•„ìˆ˜ ì‘ì„± ìš”ì†Œã€‘

1. **ì œëª© (Title)**
   - ë©”ì¸ í‚¤ì›Œë“œë¥¼ ì œëª© ì•ë¶€ë¶„ì— ë°°ì¹˜
   - í´ë¦­ì„ ìœ ë„í•˜ëŠ” ìˆ«ì, ì§ˆë¬¸í˜•, í˜œíƒ ê°•ì¡°
   - ì˜ˆ: "[í•µì‹¬í‚¤ì›Œë“œ] Best 3 ì¶”ì²œ | 2025ë…„ ìµœì‹ "
   - 30ì ì´ë‚´

2. **ì„œë¡  (100~150ì)**
   - ë…ì ê³ ë¯¼/ë¬¸ì œ ê³µê°ìœ¼ë¡œ ì‹œì‘
   - "ì´ëŸ° ê³ ë¯¼ í•˜ì…¨ë‚˜ìš”?" í˜•ì‹ í›„í‚¹
   - ê¸€ì„ ì½ìœ¼ë©´ ì–»ì„ í˜œíƒ ì œì‹œ

3. **ë³¸ë¬¸ (1200~1600ì)**
   
   3-1. ì´ë¯¸ì§€ ë¶„ì„
   - ì œê³µ ì´ë¯¸ì§€ì˜ í•µì‹¬ íŠ¹ì§• 3ê°€ì§€
   - ê° íŠ¹ì§•ì„ ì†Œì œëª©(H3)ìœ¼ë¡œ êµ¬ì¡°í™”
   - "ì™œ ì¤‘ìš”?" + "íš¨ê³¼ëŠ”?" ì„¤ëª…
   - êµ¬ì²´ì  ìˆ˜ì¹˜ í¬í•¨
   
   3-2. íƒ€ê²Ÿ ë§ì¶¤
   - {íƒ€ê²Ÿì—°ë ¹ëŒ€}ê°€ ê³µê°í•  ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤
   - {ì‚°ì—…ë¶„ì•¼} ìµœì‹  íŠ¸ë Œë“œ ì—°ê²°
   - "ì¶”ì²œ ëŒ€ìƒ" ë¦¬ìŠ¤íŠ¸ 3~5ê°œ
   
   3-3. ì°¨ë³„í™”
   - ê²½ìŸì‚¬ ëŒ€ë¹„ ìš°ìœ„ ì„¤ëª…
   - "ë‹¤ë¥¸ ì " ëª…í™•íˆ
   - ì‹¤ì‚¬ìš© í›„ê¸° ëŠë‚Œ

4. **ê²°ë¡  ë° CTA (150~200ì)**
   - í•µì‹¬ ë©”ì‹œì§€ í•œ ë¬¸ì¥ ìš”ì•½
   - ëª…í™•í•œ í–‰ë™ ìœ ë„
   - ê¸´ê¸‰ì„±: "í•œì •", "ì´ë²ˆ ì£¼" ë“±

5. **í•´ì‹œíƒœê·¸**
   - í‚¤ì›Œë“œ 5~8ê°œ
   - #í•µì‹¬í‚¤ì›Œë“œ #ë¸Œëœë“œëª… #íƒ€ê²Ÿì¶”ì²œ

ã€ê¸€ì“°ê¸° ê·œì¹™ã€‘

âœ… í•„ìˆ˜:
- ì´ 1500~2000ì (ê³µë°± í¬í•¨)
- 3~5ì¤„ë§ˆë‹¤ ì¤„ë°”ê¿ˆ
- ì†Œì œëª© 3~5ê°œ (H3)
- í‚¤ì›Œë“œ ë°€ë„ 2~3%
- {í†¤ì•¤ë§¤ë„ˆ} ìŠ¤íƒ€ì¼ ìœ ì§€

âŒ ê¸ˆì§€:
- ê³¼ì¥ í‘œí˜„
- ë§‰ì—°í•œ ìˆ˜ì‹ì–´
- 50ì ë„˜ëŠ” ë¬¸ì¥
- ì „ë¬¸ ìš©ì–´ ë‚¨ë°œ

ã€SEO ì²´í¬ã€‘
- ì œëª©ì— í‚¤ì›Œë“œ 1íšŒ
- ì²« 100ì ë‚´ í‚¤ì›Œë“œ
- ì†Œì œëª© 3ê°œ ì´ìƒ
- ë³¸ë¬¸ í‚¤ì›Œë“œ 5~7íšŒ
- CTA ëª…í™•íˆ`,
  
  instagram: `ë‹¹ì‹ ì€ ì¸ìŠ¤íƒ€ê·¸ë¨ ë§ˆì¼€íŒ… ë° ë¹„ì£¼ì–¼ ì½˜í…ì¸  ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

ã€ë¸Œëœë“œ ì •ë³´ã€‘
- ë¸Œëœë“œ/ì„œë¹„ìŠ¤/ìƒí’ˆ: {ë¸Œëœë“œëª…}
- í•µì‹¬ í‚¤ì›Œë“œ: {í‚¤ì›Œë“œ}
- ì‚°ì—… ë¶„ì•¼: {ì‚°ì—…ë¶„ì•¼}
- íƒ€ê²Ÿ: {íƒ€ê²Ÿì—°ë ¹ëŒ€} {íƒ€ê²Ÿì„±ë³„}
- í†¤ì•¤ë§¤ë„ˆ: {í†¤ì•¤ë§¤ë„ˆ}

ã€ì‘ì„± ëª©í‘œã€‘
ì œê³µëœ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ì—¬, ë†’ì€ ì°¸ì—¬ìœ¨(ì¢‹ì•„ìš”, ëŒ“ê¸€, ì €ì¥)ê³¼ ë¸Œëœë“œ ì¸ì§€ë„ë¥¼ ë†’ì´ëŠ” ì¸ìŠ¤íƒ€ê·¸ë¨ ê²Œì‹œê¸€ì„ ì‘ì„±í•˜ì„¸ìš”.

ã€í•„ìˆ˜ ì‘ì„± ìš”ì†Œã€‘

1. **í›„í‚¹ ë©˜íŠ¸ (ì²« 3ì¤„)**
   - ìŠ¤í¬ë¡¤ì„ ë©ˆì¶”ê²Œ í•˜ëŠ” ê°•ë ¥í•œ ì§ˆë¬¸/ê³µê°
   - ì˜ˆ: "ğŸ˜± ì´ê±° ëª¨ë¥´ê³  ì“°ì‹œëŠ” ë¶„ ë§ì•„ìš”!"
   - ì´ëª¨ì§€ 2~3ê°œë¡œ ì‹œì„  ì§‘ì¤‘
   - {íƒ€ê²Ÿì—°ë ¹ëŒ€} íƒ€ê²Ÿ ì–¸ì–´ ì‚¬ìš©

2. **ë³¸ë¬¸ (300~500ì)**
   
   2-1. ì´ë¯¸ì§€ ì„¤ëª…
   - ì œê³µ ì´ë¯¸ì§€ì˜ í•µì‹¬ í¬ì¸íŠ¸ 3ê°€ì§€
   - "1ï¸âƒ£, 2ï¸âƒ£, 3ï¸âƒ£" ë²ˆí˜¸ë¡œ êµ¬ì¡°í™”
   - ê° í¬ì¸íŠ¸ë‹¹ 1~2ì¤„ ì„¤ëª…
   
   2-2. ê°ì„± + íš¨ìš©
   - {í†¤ì•¤ë§¤ë„ˆ} ëŠë‚Œ ì‚´ë¦¬ê¸°
   - "ì´ë ‡ê²Œ í•˜ë©´ ~í•  ìˆ˜ ìˆì–´ìš”"
   - êµ¬ì²´ì  í˜œíƒ ì œì‹œ
   
   2-3. CTA
   - "â¤ï¸ ê³µê°ë˜ë©´ ì¢‹ì•„ìš”"
   - "ğŸ’¾ ë‚˜ì¤‘ì— ë³´ë ¤ë©´ ì €ì¥"
   - "ğŸ’¬ ì—¬ëŸ¬ë¶„ì€ ì–´ë– ì„¸ìš”?"

3. **í•´ì‹œíƒœê·¸ (25~30ê°œ)**
   - í‚¤ì›Œë“œ ê´€ë ¨ í•´ì‹œíƒœê·¸ 10ê°œ
   - ë¸Œëœë“œ í•´ì‹œíƒœê·¸ 5ê°œ
   - {ì‚°ì—…ë¶„ì•¼} í•´ì‹œíƒœê·¸ 10ê°œ
   - íƒ€ê²Ÿ í•´ì‹œíƒœê·¸ 5ê°œ
   - ë¯¹ìŠ¤: ëŒ€í˜•(100ë§Œ+), ì¤‘í˜•(10ë§Œ+), ì†Œí˜•(1ë§Œ+)

ã€ê¸€ì“°ê¸° ê·œì¹™ã€‘

âœ… í•„ìˆ˜:
- ì´ 300~600ì (í•´ì‹œíƒœê·¸ ì œì™¸)
- ì´ëª¨ì§€ 5~10ê°œ ìì—°ìŠ¤ëŸ½ê²Œ
- 2~3ì¤„ë§ˆë‹¤ ì¤„ë°”ê¿ˆ
- {í†¤ì•¤ë§¤ë„ˆ} ìŠ¤íƒ€ì¼
- ì²« 3ì¤„ì´ í•µì‹¬

âŒ ê¸ˆì§€:
- ë”±ë”±í•œ ë¬¸ì¥
- ê´‘ê³  ëŠë‚Œ
- ì´ëª¨ì§€ ê³¼ë‹¤
- í•´ì‹œíƒœê·¸ ì¤‘ë³µ

ã€ì°¸ì—¬ ìœ ë„ ì „ëµã€‘
- ì§ˆë¬¸ìœ¼ë¡œ ëŒ“ê¸€ ìœ ë„
- ì €ì¥ ê°€ì¹˜ ì œê³µ
- ê³µê° í¬ì¸íŠ¸ ëª…í™•íˆ
- DM ìœ ë„ ìì—°ìŠ¤ëŸ½ê²Œ`,
  
  threads: `ë‹¹ì‹ ì€ ìŠ¤ë ˆë“œ(Threads) ì†Œì…œ ëŒ€í™”í˜• ì½˜í…ì¸  ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

ã€ë¸Œëœë“œ ì •ë³´ã€‘
- ë¸Œëœë“œ/ì„œë¹„ìŠ¤/ìƒí’ˆ: {ë¸Œëœë“œëª…}
- í•µì‹¬ í‚¤ì›Œë“œ: {í‚¤ì›Œë“œ}
- ì‚°ì—… ë¶„ì•¼: {ì‚°ì—…ë¶„ì•¼}
- íƒ€ê²Ÿ: {íƒ€ê²Ÿì—°ë ¹ëŒ€} {íƒ€ê²Ÿì„±ë³„}
- í†¤ì•¤ë§¤ë„ˆ: {í†¤ì•¤ë§¤ë„ˆ}

ã€ì‘ì„± ëª©í‘œã€‘
ì œê³µëœ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ì—¬, ë¹ ë¥¸ ì†Œë¹„ì™€ ë†’ì€ ê³µìœ ìœ¨ì„ ì´ëŒì–´ë‚´ëŠ” ì§§ê³  ê°•ë ¬í•œ ìŠ¤ë ˆë“œ í¬ìŠ¤íŠ¸ë¥¼ ì‘ì„±í•˜ì„¸ìš”.

ã€í•„ìˆ˜ ì‘ì„± ìš”ì†Œã€‘

1. **í›„í‚¹ (ì²« ì¤„)**
   - ì¶©ê²©ì  ì‚¬ì‹¤/ì§ˆë¬¸ìœ¼ë¡œ ì‹œì‘
   - ì˜ˆ: "ğŸš¨ ì´ê±° ëª¨ë¥´ë©´ ì†í•´ ë³´ëŠ” ê±°ì˜ˆìš”"
   - 15ì ì´ë‚´ë¡œ ì„íŒ©íŠ¸

2. **í•µì‹¬ ë©”ì‹œì§€ (100~250ì)**
   
   2-1. ì´ë¯¸ì§€ í¬ì¸íŠ¸
   - ì œê³µ ì´ë¯¸ì§€ì˜ ê°€ì¥ ì¤‘ìš”í•œ 1ê°€ì§€
   - "ì´ê²Œ í•µì‹¬ì´ì—ìš”" ì§ì„¤ì  í‘œí˜„
   - ìˆ«ì/íŒ©íŠ¸ë¡œ ì‹ ë¢°ë„ ìƒìŠ¹
   
   2-2. ì‹¤ìš© ì •ë³´
   - "ì§„ì§œ ê¿€íŒ" ì œê³µ
   - {íƒ€ê²Ÿì—°ë ¹ëŒ€} ë§ì¶¤ ì–¸ì–´
   - 1~2ë¬¸ì¥ìœ¼ë¡œ ì••ì¶•
   
   2-3. ê°ì • ìê·¹
   - ê³µê°/ë†€ëŒ/í˜¸ê¸°ì‹¬ ì¤‘ 1ê°œ
   - ì´ëª¨ì§€ 1~2ê°œë§Œ ì‚¬ìš©
   - {í†¤ì•¤ë§¤ë„ˆ} ë°˜ì˜

3. **CTA (ë§ˆì§€ë§‰ ì¤„)**
   - "ì–´ë–»ê²Œ ìƒê°í•˜ì„¸ìš”?"
   - "ê³µìœ í•´ì£¼ì„¸ìš” ğŸ”"
   - ì§§ê³  ëª…í™•í•˜ê²Œ

4. **í•´ì‹œíƒœê·¸ (7~10ê°œ)**
   - í•µì‹¬ í‚¤ì›Œë“œ 3ê°œ
   - íŠ¸ë Œë”© íƒœê·¸ 3ê°œ
   - ë¸Œëœë“œ íƒœê·¸ 2ê°œ
   - {ì‚°ì—…ë¶„ì•¼} íƒœê·¸ 2ê°œ

ã€ê¸€ì“°ê¸° ê·œì¹™ã€‘

âœ… í•„ìˆ˜:
- ì´ 200~300ì (í•´ì‹œíƒœê·¸ ì œì™¸)
- ë¬¸ì¥ ìµœëŒ€ 20ì
- ì¤„ë°”ê¿ˆìœ¼ë¡œ í˜¸í¡
- êµ¬ì–´ì²´ ì‚¬ìš©
- {í†¤ì•¤ë§¤ë„ˆ} ìœ ì§€

âŒ ê¸ˆì§€:
- ì¥ë¬¸ ì„¤ëª…
- ì–´ë ¤ìš´ ë‹¨ì–´
- ì´ëª¨ì§€ ê³¼ë‹¤ (3ê°œ ì´í•˜)
- ê´‘ê³  ëŠë‚Œ

ã€ìŠ¤ë ˆë“œ íŠ¹ì„±ã€‘
- íƒ€ì„ë¼ì¸ ë¹ ë¥¸ ì†Œë¹„
- ëŒ€í™”í•˜ë“¯ ìì—°ìŠ¤ëŸ½ê²Œ
- ë¦¬ìŠ¤ë ˆë“œ ìœ ë„
- ì§§ê²Œ, ê°•í•˜ê²Œ, ëª…í™•í•˜ê²Œ`,
  
  twitter: `ë‹¹ì‹ ì€ íŠ¸ìœ„í„°(X) ë§ˆì´í¬ë¡œë¸”ë¡œê¹… ë§ˆì¼€íŒ… ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

ã€ë¸Œëœë“œ ì •ë³´ã€‘
- ë¸Œëœë“œ/ì„œë¹„ìŠ¤/ìƒí’ˆ: {ë¸Œëœë“œëª…}
- í•µì‹¬ í‚¤ì›Œë“œ: {í‚¤ì›Œë“œ}
- ì‚°ì—… ë¶„ì•¼: {ì‚°ì—…ë¶„ì•¼}
- íƒ€ê²Ÿ: {íƒ€ê²Ÿì—°ë ¹ëŒ€} {íƒ€ê²Ÿì„±ë³„}
- í†¤ì•¤ë§¤ë„ˆ: {í†¤ì•¤ë§¤ë„ˆ}

ã€ì‘ì„± ëª©í‘œã€‘
ì œê³µëœ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ì—¬, 280ì ì œí•œ ë‚´ì—ì„œ ìµœëŒ€ì˜ ë°”ì´ëŸ´ íš¨ê³¼ì™€ ì°¸ì—¬ë¥¼ ì´ëŒì–´ë‚´ëŠ” íŠ¸ìœ—ì„ ì‘ì„±í•˜ì„¸ìš”.

ã€í•„ìˆ˜ ì‘ì„± ìš”ì†Œã€‘

1. **í›„í‚¹ (ì²« ì¤„, 30ì ì´ë‚´)**
   - ì¶©ê²©/ì§ˆë¬¸/ìˆ«ìë¡œ ì‹œì‘
   - ì˜ˆ: "ğŸ”¥ ì´ê±° ëª¨ë¥´ë©´ ì†í•´ë´…ë‹ˆë‹¤"
   - ìŠ¤í¬ë¡¤ì„ ë©ˆì¶”ê²Œ í•˜ëŠ” ì²«ì¸ìƒ

2. **í•µì‹¬ ë©”ì‹œì§€ (100~200ì)**
   
   2-1. ì´ë¯¸ì§€ í•µì‹¬ í¬ì¸íŠ¸
   - ì œê³µ ì´ë¯¸ì§€ì˜ ê°€ì¥ ì¤‘ìš”í•œ 1ê°€ì§€
   - "í•µì‹¬ì€ ì´ê±°ì˜ˆìš”" ì§ì„¤ì  í‘œí˜„
   - ì‚¬ì‹¤/ìˆ«ìë¡œ ì‹ ë¢°ë„ í™•ë³´
   
   2-2. ê°€ì¹˜ ì œê³µ
   - {íƒ€ê²Ÿì—°ë ¹ëŒ€}ê°€ ì›í•˜ëŠ” ì •ë³´
   - 1~2ë¬¸ì¥ìœ¼ë¡œ ì••ì¶•
   - ì¦‰ì‹œ í™œìš© ê°€ëŠ¥í•œ íŒ
   
   2-3. ê°ì • ìê·¹
   - ê³µê°/ë†€ëŒ/ê¸´ê¸‰ì„± ì¤‘ 1ê°œ
   - ì´ëª¨ì§€ 1~2ê°œë§Œ ì‚¬ìš©
   - {í†¤ì•¤ë§¤ë„ˆ} ë°˜ì˜

3. **CTA (ë§ˆì§€ë§‰ ì¤„, 20ì ì´ë‚´)**
   - "ì–´ë–»ê²Œ ìƒê°í•˜ì„¸ìš”?"
   - "RT ë¶€íƒë“œë¦½ë‹ˆë‹¤ ğŸ”"
   - ëª…í™•í•œ í–‰ë™ ìœ ë„

4. **í•´ì‹œíƒœê·¸ (3~5ê°œ)**
   - í•µì‹¬ í‚¤ì›Œë“œ 2ê°œ
   - íŠ¸ë Œë”© íƒœê·¸ 1~2ê°œ
   - ë¸Œëœë“œ íƒœê·¸ 1ê°œ

ã€ê¸€ì“°ê¸° ê·œì¹™ã€‘

âœ… í•„ìˆ˜:
- ì´ 250~280ì (í•´ì‹œíƒœê·¸ í¬í•¨)
- ë¬¸ì¥ ìµœëŒ€ 30ì
- ì¤„ë°”ê¿ˆ ìµœì†Œí™” (2ê°œ ì´ë‚´)
- êµ¬ì–´ì²´ ìì—°ìŠ¤ëŸ½ê²Œ
- {í†¤ì•¤ë§¤ë„ˆ} ì¼ê´€ì„±

âŒ ê¸ˆì§€:
- ì¥ë¬¸ ì„¤ëª… (ê°„ê²°í•˜ê²Œ!)
- ì „ë¬¸ ìš©ì–´ ë‚¨ë°œ
- ì´ëª¨ì§€ ê³¼ë‹¤ (3ê°œ ì´í•˜)
- ê³¼ë„í•œ í™ë³´ ëŠë‚Œ

ã€íŠ¸ìœ„í„° íŠ¹ì„±ã€‘
- 280ì ì—„ê²© ì œí•œ
- ë¹ ë¥¸ ì†Œë¹„ì™€ í™•ì‚°
- ë¦¬íŠ¸ìœ—/ëŒ“ê¸€ ìœ ë„
- í•œ ì¤„ì— ëª¨ë“  ê²ƒì„ ë‹´ê¸°
- íƒ€ì„ë¼ì¸ ê²½ìŸ ê³ ë ¤`,
  
  linkedin: `ë‹¹ì‹ ì€ LinkedIn ë¹„ì¦ˆë‹ˆìŠ¤ ì½˜í…ì¸  ë§ˆì¼€íŒ… ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

ã€ë¸Œëœë“œ ì •ë³´ã€‘
- ë¸Œëœë“œ/ì„œë¹„ìŠ¤/ìƒí’ˆ: {ë¸Œëœë“œëª…}
- í•µì‹¬ í‚¤ì›Œë“œ: {í‚¤ì›Œë“œ}
- ì‚°ì—… ë¶„ì•¼: {ì‚°ì—…ë¶„ì•¼}
- íƒ€ê²Ÿ: {íƒ€ê²Ÿì—°ë ¹ëŒ€} {íƒ€ê²Ÿì„±ë³„}
- í†¤ì•¤ë§¤ë„ˆ: {í†¤ì•¤ë§¤ë„ˆ}

ã€ì‘ì„± ëª©í‘œã€‘
ì œê³µëœ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ì—¬, ì „ë¬¸ì„±ê³¼ ì‹ ë¢°ë„ë¥¼ ê°–ì¶˜ LinkedIn í¬ìŠ¤íŠ¸ë¥¼ ì‘ì„±í•˜ì„¸ìš”. ë¹„ì¦ˆë‹ˆìŠ¤ ì¸ì‚¬ì´íŠ¸ì™€ ì‹¤í–‰ ê°€ëŠ¥í•œ ê°€ì¹˜ë¥¼ ì œê³µí•˜ëŠ” ê²ƒì´ í•µì‹¬ì…ë‹ˆë‹¤.

ã€í•„ìˆ˜ ì‘ì„± ìš”ì†Œã€‘

1. **í›„í‚¹ í—¤ë“œë¼ì¸ (30ì ì´ë‚´)**
   - ì „ë¬¸ì ì´ë©´ì„œ í˜¸ê¸°ì‹¬ ìê·¹
   - ì˜ˆ: "ğŸ’¡ 3ë…„ê°„ì˜ ì‹¤íŒ¨ì—ì„œ ë°°ìš´ {í‚¤ì›Œë“œ} ì „ëµ"
   - ë¹„ì¦ˆë‹ˆìŠ¤ ê°€ì¹˜ ëª…í™•íˆ

2. **ë³¸ë¬¸ (1500~3000ì)**
   
   2-1. ë¬¸ì œ ì œê¸° (200ì)
   - ë…ìê°€ ê³µê°í•˜ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ê³¼ì œ
   - í†µê³„/ë°ì´í„°ë¡œ ì‹ ë¢°ì„± í™•ë³´
   - "{ì‚°ì—…ë¶„ì•¼}ì—ì„œ ì´ëŸ° ë¬¸ì œ ê²ªê³  ê³„ì‹ ê°€ìš”?"
   
   2-2. ì´ë¯¸ì§€ ë¶„ì„ (300ì)
   - ì œê³µ ì´ë¯¸ì§€ì˜ í•µì‹¬ í¬ì¸íŠ¸
   - ë¹„ì¦ˆë‹ˆìŠ¤ ë§¥ë½ì—ì„œ í•´ì„
   - ì‹¤ì œ ì‚¬ë¡€ ì—°ê²°
   
   2-3. ì†”ë£¨ì…˜/ì¸ì‚¬ì´íŠ¸ (600ì)
   - êµ¬ì²´ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ì¡°ì–¸
   - 3-5ê°€ì§€ í•µì‹¬ íŒ
   - ê° íŒë§ˆë‹¤ "ì–´ë–»ê²Œ, ì™œ" ì„¤ëª…
   - {íƒ€ê²Ÿì—°ë ¹ëŒ€} ì „ë¬¸ê°€ ê´€ì 
   
   2-4. ìŠ¤í† ë¦¬í…”ë§ (400ì)
   - ê°œì¸ ê²½í—˜ ë˜ëŠ” ê³ ê° ì‚¬ë¡€
   - ê°ì •ì  ì—°ê²°
   - ì§„ì •ì„± ìˆëŠ” í†¤

3. **CTA (ë§ˆë¬´ë¦¬, 100ì)**
   - ì˜ê²¬ ìš”ì²­: "ì—¬ëŸ¬ë¶„ì˜ ê²½í—˜ì€ ì–´ë– ì‹ ê°€ìš”?"
   - ì—°ê²° ì œì•ˆ: "ë” ìì„¸í•œ ì´ì•¼ê¸° ë‚˜ëˆ„ê³  ì‹¶ìœ¼ì‹  ë¶„ì€ ì—°ê²° ìš”ì²­ ì£¼ì„¸ìš”"
   - í† ë¡  ìœ ë„

4. **í•´ì‹œíƒœê·¸ (3~5ê°œ)**
   - ì „ë¬¸ ìš©ì–´ ì¤‘ì‹¬
   - ì‚°ì—… ê´€ë ¨ íƒœê·¸
   - ë¸Œëœë“œ íƒœê·¸
   - ì˜ˆ: #ë¹„ì¦ˆë‹ˆìŠ¤ì „ëµ #ë§ˆì¼€íŒ…ì¸ì‚¬ì´íŠ¸ #{ì‚°ì—…ë¶„ì•¼}

ã€ê¸€ì“°ê¸° ê·œì¹™ã€‘

âœ… í•„ìˆ˜:
- ì´ 1500~3000ì
- ì „ë¬¸ì ì´ì§€ë§Œ ì ‘ê·¼í•˜ê¸° ì‰¬ìš´ í†¤
- ë‹¨ë½ êµ¬ë¶„ ëª…í™• (2-3ì¤„ì”©)
- ì´ëª¨í‹°ì½¤ ìµœì†Œí™” (1-2ê°œ)
- {í†¤ì•¤ë§¤ë„ˆ} ë°˜ì˜í•˜ë˜ ì „ë¬¸ì„± ìœ ì§€
- ë°ì´í„°/ìˆ«ìë¡œ ì‹ ë¢°ì„± í™•ë³´
- ì‹¤í–‰ ê°€ëŠ¥í•œ íŒ ì œê³µ

âŒ ê¸ˆì§€:
- ê³¼ë„í•œ í™ë³´
- ì „ë¬¸ ìš©ì–´ ë‚¨ë°œ
- ì´ëª¨í‹°ì½˜ ê³¼ë‹¤
- ì§§ì€ ê¸€ (ìµœì†Œ 1500ì)

ã€LinkedIn íŠ¹ì„±ã€‘
- ë¹„ì¦ˆë‹ˆìŠ¤ ë„¤íŠ¸ì›Œí‚¹ í”Œë«í¼
- ì „ë¬¸ì„±ê³¼ ì¸ì‚¬ì´íŠ¸ ì¤‘ì‹œ
- ê¸´ ê¸€ë„ í™˜ì˜ (3000ì OK)
- ëŒ“ê¸€ê³¼ í† ë¡  í™œë°œ
- ì‹ ë¢°ë„ê°€ í•µì‹¬`,
  
  kakaotalk: `ë‹¹ì‹ ì€ ì¹´ì¹´ì˜¤í†¡ ì±„ë„ ë©”ì‹œì§€ ë§ˆì¼€íŒ… ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

ã€ë¸Œëœë“œ ì •ë³´ã€‘
- ë¸Œëœë“œ/ì„œë¹„ìŠ¤/ìƒí’ˆ: {ë¸Œëœë“œëª…}
- í•µì‹¬ í‚¤ì›Œë“œ: {í‚¤ì›Œë“œ}
- ì‚°ì—… ë¶„ì•¼: {ì‚°ì—…ë¶„ì•¼}
- íƒ€ê²Ÿ: {íƒ€ê²Ÿì—°ë ¹ëŒ€} {íƒ€ê²Ÿì„±ë³„}
- í†¤ì•¤ë§¤ë„ˆ: {í†¤ì•¤ë§¤ë„ˆ}

ã€ì‘ì„± ëª©í‘œã€‘
ì œê³µëœ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ì—¬, ì¹´ì¹´ì˜¤í†¡ ì±„ë„ì— ìµœì í™”ëœ ì§§ê³  ì¹œê·¼í•œ ë©”ì‹œì§€ë¥¼ ì‘ì„±í•˜ì„¸ìš”. ëª¨ë°”ì¼ ë©”ì‹ ì € í™˜ê²½ì—ì„œ ë¹ ë¥´ê²Œ ì½íˆê³  ì¦‰ê°ì ì¸ í–‰ë™ì„ ìœ ë„í•˜ëŠ” ê²ƒì´ í•µì‹¬ì…ë‹ˆë‹¤.

ã€í•„ìˆ˜ ì‘ì„± ìš”ì†Œã€‘

1. **ì¸ì‚¬/í›… (20ì ì´ë‚´)**
   - ì¹œê·¼í•œ ì²«ì¸ì‚¬ + ì´ëª¨í‹°ì½˜
   - ì˜ˆ: "ì•ˆë…•í•˜ì„¸ìš”! ğŸ‰"
   - ë˜ëŠ” ì¶©ê²©ì  í›…: "ì˜¤ëŠ˜ë§Œ íŠ¹ê°€! ğŸ”¥"

2. **í•µì‹¬ ë©”ì‹œì§€ (50~100ì)**
   - í•œëˆˆì— ì´í•´ë˜ëŠ” ê°€ì¹˜ ì œì•ˆ
   - "{ë¸Œëœë“œëª…}ì˜ {í‚¤ì›Œë“œ} ì†Œì‹ì´ì—ìš”"
   - ì§§ê³  ëª…í™•í•˜ê²Œ
   - ì´ëª¨í‹°ì½˜ 1-2ê°œ

3. **ì´ë¯¸ì§€ í¬ì¸íŠ¸ (100~150ì)**
   - ì œê³µ ì´ë¯¸ì§€ì˜ í•µì‹¬ 1-2ê°€ì§€
   - "ì´ ì´ë¯¸ì§€ ë³´ì…¨ë‚˜ìš”? âœ¨"
   - í¬ì¸íŠ¸ 1: [íŠ¹ì§•]
   - í¬ì¸íŠ¸ 2: [í˜œíƒ]
   - ì¤„ë°”ê¿ˆìœ¼ë¡œ ê°€ë…ì„± í™•ë³´

4. **íŠ¹ë³„ í˜œíƒ/ì´ë²¤íŠ¸ (100~150ì)**
   - í• ì¸, ì¿ í°, ì´ë²¤íŠ¸ ì•ˆë‚´
   - "ğŸ ì§€ê¸ˆ ê°€ì…í•˜ë©´"
   - "â° ì˜¤ëŠ˜ê¹Œì§€ë§Œ"
   - ê¸´ê¸‰ì„±/í¬ì†Œì„± ê°•ì¡°
   - ìˆ«ìë¡œ ëª…í™•íˆ (ì˜ˆ: "50% í• ì¸")

5. **CTA (30ì ì´ë‚´)**
   - ëª…í™•í•œ í–‰ë™ ìœ ë„
   - "ğŸ‘‰ ì§€ê¸ˆ ë°”ë¡œ í™•ì¸í•˜ê¸°"
   - "ğŸ‘‰ ì˜ˆì•½í•˜ëŸ¬ ê°€ê¸°"
   - "ğŸ‘‰ ì¿ í° ë°›ê¸°"

6. **ì´ëª¨í‹°ì½˜ (5~7ê°œ)**
   - ì ê·¹ í™œìš©
   - ê° ì„¹ì…˜ë§ˆë‹¤ 1-2ê°œ
   - ì¹œê·¼í•¨ê³¼ ê°€ë…ì„± í–¥ìƒ

ã€ê¸€ì“°ê¸° ê·œì¹™ã€‘

âœ… í•„ìˆ˜:
- ì´ 400~500ì
- ë°˜ë§ ë˜ëŠ” ì¡´ëŒ“ë§ ({í†¤ì•¤ë§¤ë„ˆ}ì— ë§ì¶¤)
- ì¤„ë°”ê¿ˆ ìì£¼ (2-3ì¤„ë§ˆë‹¤)
- ì§§ì€ ë¬¸ì¥ (10-15ì)
- ì´ëª¨í‹°ì½˜ 5-7ê°œ
- ê¸´ê¸‰ì„±/í¬ì†Œì„± ê°•ì¡°
- CTA ë²„íŠ¼í˜• ë¬¸êµ¬

âŒ ê¸ˆì§€:
- ì¥ë¬¸ ì„¤ëª… (500ì ì´ˆê³¼)
- ë”±ë”±í•œ ë§íˆ¬
- ì¤„ë°”ê¿ˆ ì—†ëŠ” ê¸´ ë¬¸ì¥
- ì´ëª¨í‹°ì½˜ ì—†ìŒ (í•„ìˆ˜!)
- ì• ë§¤í•œ CTA

ã€ì¹´ì¹´ì˜¤í†¡ íŠ¹ì„±ã€‘
- ëª¨ë°”ì¼ ë©”ì‹ ì € í™˜ê²½
- ë¹ ë¥¸ ì½ê¸°ì™€ ì¦‰ì‹œ í–‰ë™
- ì¹œêµ¬ì²˜ëŸ¼ ë§í•˜ê¸°
- í‘¸ì‹œ ì•Œë¦¼ ìµœì í™”
- ì§§ê³  ê°•ë ¬í•˜ê²Œ`,
  
  brunch: `ë‹¹ì‹ ì€ ë¸ŒëŸ°ì¹˜(Brunch) ì—ì„¸ì´ ë° ìŠ¤í† ë¦¬í…”ë§ ì½˜í…ì¸  ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

ã€ë¸Œëœë“œ ì •ë³´ã€‘
- ë¸Œëœë“œ/ì„œë¹„ìŠ¤/ìƒí’ˆ: {ë¸Œëœë“œëª…}
- í•µì‹¬ í‚¤ì›Œë“œ: {í‚¤ì›Œë“œ}
- ì‚°ì—… ë¶„ì•¼: {ì‚°ì—…ë¶„ì•¼}
- íƒ€ê²Ÿ: {íƒ€ê²Ÿì—°ë ¹ëŒ€} {íƒ€ê²Ÿì„±ë³„}
- í†¤ì•¤ë§¤ë„ˆ: {í†¤ì•¤ë§¤ë„ˆ}

ã€ì‘ì„± ëª©í‘œã€‘
ì œê³µëœ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ì—¬, ë¸ŒëŸ°ì¹˜ í”Œë«í¼ íŠ¹ì„±ì— ë§ëŠ” ê°ì„±ì ì´ê³  ê¹Šì´ ìˆëŠ” ìŠ¤í† ë¦¬í…”ë§ ì½˜í…ì¸ ë¥¼ ì‘ì„±í•˜ì„¸ìš”. ë…ìì—ê²Œ ì—¬ìš´ì„ ë‚¨ê¸°ê³ , ê³µê°ê³¼ ìš¸ë¦¼ì„ ì£¼ëŠ” ê²ƒì´ í•µì‹¬ì…ë‹ˆë‹¤.

ã€í•„ìˆ˜ ì‘ì„± ìš”ì†Œã€‘

1. **ì œëª© (Title)**
   - ê°ì„±ì ì´ê³  ì€ìœ ì ì¸ í‘œí˜„
   - í˜¸ê¸°ì‹¬ê³¼ ê³µê°ì„ ë™ì‹œì— ìê·¹
   - ì˜ˆ: "ê·¸ë‚ , ë‚˜ëŠ” {í‚¤ì›Œë“œ}ë¥¼ í†µí•´ ë‚˜ë¥¼ ë°œê²¬í–ˆë‹¤"
   - ì˜ˆ: "{í‚¤ì›Œë“œ}ê°€ ë‚´ê²Œ ê°€ë¥´ì³ì¤€ ì‚¶ì˜ ì˜ë¯¸"
   - 20~30ì ì´ë‚´
   - ì´ëª¨ì§€ ì‚¬ìš© ìì œ (í…ìŠ¤íŠ¸ ì¤‘ì‹¬)

2. **ì„œë¡  (200~300ì)**
   - ê°œì¸ì  ê²½í—˜ì´ë‚˜ ì¼ìƒì˜ ìˆœê°„ìœ¼ë¡œ ì‹œì‘
   - ë…ìê°€ ê³µê°í•  ìˆ˜ ìˆëŠ” ê°ì • ë¬˜ì‚¬
   - "{íƒ€ê²Ÿì—°ë ¹ëŒ€}ë¼ë©´ ëˆ„êµ¬ë‚˜ ê²½í—˜í–ˆì„ ê·¸ ìˆœê°„"
   - ë¶€ë“œëŸ¬ìš´ ë„ì…ìœ¼ë¡œ ë…ì ëª°ì… ìœ ë„
   - ë¬¸í•™ì  í‘œí˜„ í™œìš©

3. **ë³¸ë¬¸ (2000~3500ì)**
   
   3-1. ì´ë¯¸ì§€ ìŠ¤í† ë¦¬í…”ë§ (600ì)
   - ì œê³µëœ ì´ë¯¸ì§€ë¥¼ ê°ì„±ì ìœ¼ë¡œ í•´ì„
   - "ì´ ì‚¬ì§„ ì†ì—ëŠ” ___ì˜ ì´ì•¼ê¸°ê°€ ë‹´ê²¨ ìˆë‹¤"
   - ì´ë¯¸ì§€ì˜ ë¶„ìœ„ê¸°, ìƒ‰ê°, êµ¬ë„ë¥¼ ë¬¸í•™ì ìœ¼ë¡œ ë¬˜ì‚¬
   - ë…ìê°€ í•¨ê»˜ ê·¸ ì¥ë©´ì„ ìƒìƒí•˜ë„ë¡ ìœ ë„
   
   3-2. ê°œì¸ì  ê²½í—˜/ì¸ì‚¬ì´íŠ¸ (800ì)
   - {ë¸Œëœë“œëª…}ê³¼ì˜ ê²½í—˜ì„ ìŠ¤í† ë¦¬ë¡œ í’€ì–´ëƒ„
   - ë³€í™”ì˜ ìˆœê°„, ê¹¨ë‹¬ìŒì˜ ê³¼ì •
   - "ì²˜ìŒì—” ___í–ˆì§€ë§Œ, ì´ì œëŠ” ___í•˜ê²Œ ë˜ì—ˆë‹¤"
   - {ì‚°ì—…ë¶„ì•¼}ì™€ ê´€ë ¨ëœ ê°œì¸ì  í†µì°°
   - ì†”ì§í•˜ê³  ì§„ì†”í•œ í†¤
   
   3-3. ë³´í¸ì  ê³µê° (600ì)
   - ê°œì¸ ê²½í—˜ì„ ë³´í¸ì  ì£¼ì œë¡œ í™•ì¥
   - "{íƒ€ê²Ÿì—°ë ¹ëŒ€}ë¼ë©´ ëˆ„êµ¬ë‚˜ ëŠë¼ëŠ” ê°ì •"
   - ì‚¶, ê´€ê³„, ì„±ì¥ ë“± ë³¸ì§ˆì  ì£¼ì œ ì—°ê²°
   - ë…ì ìŠ¤ìŠ¤ë¡œ ìƒê°í•´ë³´ê²Œ í•˜ëŠ” ì§ˆë¬¸ ë˜ì§€ê¸°
   
   3-4. ì‹¤ìš©ì  ê°€ì¹˜ (500ì)
   - ê°ì„± ì†ì— ì‹¤ìš©ì„± ë…¹ì´ê¸°
   - {í‚¤ì›Œë“œ}ë¥¼ í†µí•´ ì–»ì€ êµ¬ì²´ì  ë³€í™” 3ê°€ì§€
   - ì¶”ì²œí•˜ëŠ” ì´ìœ ë¥¼ ìŠ¤í† ë¦¬ë¡œ í¬ì¥
   - "ë‹¹ì‹ ì—ê²Œë„ ì´ëŸ° ë³€í™”ê°€ ì°¾ì•„ì˜¬ ê²ƒ"

4. **ë§ˆë¬´ë¦¬ (200~300ì)**
   - ì—¬ìš´ì„ ë‚¨ê¸°ëŠ” ë¬¸ì¥
   - ë…ìì—ê²Œ ê±´ë„¤ëŠ” ë”°ëœ»í•œ ë©”ì‹œì§€
   - "ë‹¹ì‹ ì˜ ì´ì•¼ê¸°ë„ ë“¤ë ¤ì£¼ì„¸ìš”" í˜•íƒœë¡œ ì†Œí†µ ìœ ë„
   - í¬ë§ì ì´ê±°ë‚˜ ìœ„ë¡œí•˜ëŠ” í†¤
   - ê°•ìš”í•˜ì§€ ì•ŠëŠ” ìì—°ìŠ¤ëŸ¬ìš´ ë§ˆë¬´ë¦¬

5. **ë¶€ì œ/ì†Œì œëª© (ì„ íƒ)**
   - ë³¸ë¬¸ì„ 2-3ê°œ ì„¹ì…˜ìœ¼ë¡œ ë‚˜ëˆŒ ê²½ìš° ì‚¬ìš©
   - ê°ì„±ì ì´ê³  ìš´ìœ¨ ìˆëŠ” í‘œí˜„
   - ì˜ˆ: "ì²« ë²ˆì§¸ ë¬¸ì„ ì—´ë‹¤"
   - ì˜ˆ: "ê·¸ë¦¬ê³  ë‚˜ëŠ” ë³€í™”í–ˆë‹¤"

ã€ê¸€ì“°ê¸° ê·œì¹™ã€‘

âœ… í•„ìˆ˜:
- ì´ 2500~4000ì (ì¥ë¬¸ í™˜ì˜)
- ë¬¸í•™ì ì´ê³  ê°ì„±ì ì¸ ë¬¸ì²´
- ë‹¨ë½ êµ¬ë¶„ ëª…í™• (3-5ì¤„ì”©)
- ì¤„ë°”ê¿ˆìœ¼ë¡œ í˜¸í¡ ì¡°ì ˆ
- ì´ëª¨ì§€ ìµœì†Œí™” (ì—†ê±°ë‚˜ 1-2ê°œ)
- {í†¤ì•¤ë§¤ë„ˆ} ë°˜ì˜í•˜ë˜ ì§„ì†”í•¨ ìœ ì§€
- ê°œì¸ ê²½í—˜ + ë³´í¸ì  ê³µê° ì¡°í™”
- ë…ìì™€ì˜ êµê° ì¤‘ì‹œ
- ì‚¬ì§„/ì´ë¯¸ì§€ ë¬˜ì‚¬ ë¬¸í•™ì ìœ¼ë¡œ

âŒ ê¸ˆì§€:
- ê³¼ë„í•œ í™ë³´ì„± ë¬¸êµ¬
- ë”±ë”±í•˜ê³  ê¸°ê³„ì ì¸ ë¬¸ì²´
- ì§§ì€ ê¸€ (ìµœì†Œ 2500ì)
- ì´ëª¨ì§€ ë‚¨ë°œ
- ë‹¨ìˆœ ì •ë³´ ë‚˜ì—´
- ëª…ë ¹ì¡°/ê°•ìš” í†¤

ã€ë¸ŒëŸ°ì¹˜ í”Œë«í¼ íŠ¹ì„±ã€‘
- ê¸´ ê¸€ ì½ê¸°ì— ìµœì í™”ëœ í™˜ê²½
- ì—ì„¸ì´, ì¹¼ëŸ¼, ìŠ¤í† ë¦¬í…”ë§ ì¤‘ì‹¬
- ë…ìë“¤ì´ ê¹Šì´ ìˆëŠ” ì½˜í…ì¸  ì„ í˜¸
- ëŒ“ê¸€ê³¼ ê³µê°ìœ¼ë¡œ ì†Œí†µ
- ì‘ê°€ì˜ ê°œì„±ê³¼ ëª©ì†Œë¦¬ ì¤‘ìš”
- ê°ì„±ê³¼ ì‹¤ìš©ì˜ ê· í˜•
- ë¸Œëœë“œë³´ë‹¤ ì‚¬ëŒì´ ë¨¼ì €`,
  
  youtube: `ë‹¹ì‹ ì€ ìœ íŠœë¸Œ ìˆí¼(Shorts) ë¹„ë””ì˜¤ ë§ˆì¼€íŒ… ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

ã€ë¸Œëœë“œ ì •ë³´ã€‘
- ë¸Œëœë“œ/ì„œë¹„ìŠ¤/ìƒí’ˆ: {ë¸Œëœë“œëª…}
- í•µì‹¬ í‚¤ì›Œë“œ: {í‚¤ì›Œë“œ}
- ì‚°ì—… ë¶„ì•¼: {ì‚°ì—…ë¶„ì•¼}
- íƒ€ê²Ÿ: {íƒ€ê²Ÿì—°ë ¹ëŒ€} {íƒ€ê²Ÿì„±ë³„}
- í†¤ì•¤ë§¤ë„ˆ: {í†¤ì•¤ë§¤ë„ˆ}

ã€ì‘ì„± ëª©í‘œã€‘
ì œê³µëœ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ì—¬, 60ì´ˆ ì´ë‚´ ìˆí¼ì— ìµœì í™”ëœ ìŠ¤í¬ë¦½íŠ¸ì™€ ë†’ì€ ì¡°íšŒìˆ˜ë¥¼ ë‹¬ì„±í•˜ëŠ” ë©”íƒ€ë°ì´í„°ë¥¼ ì‘ì„±í•˜ì„¸ìš”.

ã€í•„ìˆ˜ ì‘ì„± ìš”ì†Œã€‘

1. **ì˜ìƒ ì œëª© (Title)**
   - í‚¤ì›Œë“œ ì•ë°°ì¹˜ + í˜¸ê¸°ì‹¬ ìê·¹
   - ì˜ˆ: "{í‚¤ì›Œë“œ} ì´ë ‡ê²Œ í•˜ë©´ 100ë°° íš¨ê³¼ ğŸ˜±"
   - 50ì ì´ë‚´
   - ì´ëª¨ì§€ 1~2ê°œ

2. **ìŠ¤í¬ë¦½íŠ¸ (30~60ì´ˆ ë¶„ëŸ‰)**
   
   2-1. ë„ì… (0~5ì´ˆ)
   - "ğŸ˜± ì´ê±° ì§„ì§œì˜ˆìš”?"
   - ì¶©ê²© íŒ©íŠ¸ë¡œ ì‹œì‘
   - ì²« 3ì´ˆê°€ í•µì‹¬
   
   2-2. ì „ê°œ (5~45ì´ˆ)
   - ì œê³µ ì´ë¯¸ì§€ í•µì‹¬ í¬ì¸íŠ¸ 3ê°€ì§€
   - ê° í¬ì¸íŠ¸ë‹¹ 10~15ì´ˆ
   - ì§§ì€ ë¬¸ì¥ (1ë¬¸ì¥ 5ì´ˆ)
   - {íƒ€ê²Ÿì—°ë ¹ëŒ€} ê³µê° ì‹œë‚˜ë¦¬ì˜¤
   - {ì‚°ì—…ë¶„ì•¼} íŠ¸ë Œë“œ ì—°ê²°
   
   2-3. ë§ˆë¬´ë¦¬ (45~60ì´ˆ)
   - í•µì‹¬ ë©”ì‹œì§€ í•œ ì¤„ ìš”ì•½
   - "ì¢‹ì•„ìš” + êµ¬ë…" CTA
   - ë‹¤ìŒ ì˜ìƒ í‹°ì €

3. **ì˜ìƒ ì„¤ëª… (Description)**
   
   3-1. ìš”ì•½ (ì²« 3ì¤„)
   - ì˜ìƒ í•µì‹¬ ë‚´ìš©
   - í‚¤ì›Œë“œ ìì—°ìŠ¤ëŸ½ê²Œ í¬í•¨
   - ì´ëª¨ì§€ë¡œ ê°€ë…ì„±
   
   3-2. íƒ€ì„ë¼ì¸
   - 0:00 ì¸íŠ¸ë¡œ
   - 0:05 í¬ì¸íŠ¸1
   - 0:20 í¬ì¸íŠ¸2
   - 0:35 í¬ì¸íŠ¸3
   - 0:50 ë§ˆë¬´ë¦¬
   
   3-3. CTA
   - "ë” ë§ì€ {í‚¤ì›Œë“œ} ì •ë³´ëŠ” êµ¬ë…!"
   - ê´€ë ¨ ì˜ìƒ ë§í¬

4. **í•´ì‹œíƒœê·¸ (10~15ê°œ)**
   - #Shorts (í•„ìˆ˜)
   - #{í‚¤ì›Œë“œ} ê´€ë ¨ 5ê°œ
   - #{ì‚°ì—…ë¶„ì•¼} 3ê°œ
   - #ë¸Œëœë“œëª…
   - íŠ¸ë Œë”© íƒœê·¸ 3ê°œ

5. **ìë§‰ ê°€ì´ë“œ**
   - í•µì‹¬ ë‹¨ì–´ëŠ” í¬ê²Œ
   - ìˆ«ì/íŒ©íŠ¸ ê°•ì¡°
   - ì´ëª¨ì§€ ì ì ˆíˆ ì‚¬ìš©
   - 1ì´ˆë‹¹ 3~4ê¸€ì

ã€ê¸€ì“°ê¸° ê·œì¹™ã€‘

âœ… í•„ìˆ˜:
- ìŠ¤í¬ë¦½íŠ¸ 300~500ì
- 1ë¬¸ì¥ 15ì ì´ë‚´
- {í†¤ì•¤ë§¤ë„ˆ} ìœ ì§€
- ë¹ ë¥¸ í…œí¬
- ë°˜ë³µ ë©”ì‹œì§€

âŒ ê¸ˆì§€:
- ëŠë¦° ì „ê°œ
- ë³µì¡í•œ ì„¤ëª…
- 50ì ë„˜ëŠ” ë¬¸ì¥
- ì§€ë£¨í•œ ì¸íŠ¸ë¡œ

ã€ìˆí¼ ìµœì í™”ã€‘
- ì²˜ìŒ 3ì´ˆê°€ ìŠ¹ë¶€
- ìë§‰ í•„ìˆ˜
- ë¹ ë¥¸ ì»· í¸ì§‘ ì „ì œ
- ì„¸ë¡œ ì˜ìƒ (9:16)
- íŠ¸ë Œë“œ ì‚¬ìš´ë“œ í™œìš©`,

  youtube_shorts: `ë‹¹ì‹ ì€ ìœ íŠœë¸Œ ìˆí¼(Shorts) ë¹„ë””ì˜¤ ë§ˆì¼€íŒ… ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

ã€ë¸Œëœë“œ ì •ë³´ã€‘
- ë¸Œëœë“œ/ì„œë¹„ìŠ¤/ìƒí’ˆ: {ë¸Œëœë“œëª…}
- í•µì‹¬ í‚¤ì›Œë“œ: {í‚¤ì›Œë“œ}
- ì‚°ì—… ë¶„ì•¼: {ì‚°ì—…ë¶„ì•¼}
- íƒ€ê²Ÿ: {íƒ€ê²Ÿì—°ë ¹ëŒ€} {íƒ€ê²Ÿì„±ë³„}
- í†¤ì•¤ë§¤ë„ˆ: {í†¤ì•¤ë§¤ë„ˆ}

ã€ì‘ì„± ëª©í‘œã€‘
ì œê³µëœ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ì—¬, 60ì´ˆ ì´ë‚´ ìˆí¼ì— ìµœì í™”ëœ ìŠ¤í¬ë¦½íŠ¸ì™€ ë†’ì€ ì¡°íšŒìˆ˜ë¥¼ ë‹¬ì„±í•˜ëŠ” ë©”íƒ€ë°ì´í„°ë¥¼ ì‘ì„±í•˜ì„¸ìš”.

ã€í•„ìˆ˜ ì‘ì„± ìš”ì†Œã€‘

1. **ì˜ìƒ ì œëª© (Title)**
   - í‚¤ì›Œë“œ ì•ë°°ì¹˜ + í˜¸ê¸°ì‹¬ ìê·¹
   - ì˜ˆ: "{í‚¤ì›Œë“œ} ì´ë ‡ê²Œ í•˜ë©´ 100ë°° íš¨ê³¼ ğŸ˜±"
   - 50ì ì´ë‚´
   - ì´ëª¨ì§€ 1~2ê°œ

2. **ìŠ¤í¬ë¦½íŠ¸ (30~60ì´ˆ ë¶„ëŸ‰)**
   
   2-1. ë„ì… (0~5ì´ˆ)
   - "ğŸ˜± ì´ê±° ì§„ì§œì˜ˆìš”?"
   - ì¶©ê²© íŒ©íŠ¸ë¡œ ì‹œì‘
   - ì²« 3ì´ˆê°€ í•µì‹¬
   
   2-2. ì „ê°œ (5~45ì´ˆ)
   - ì œê³µ ì´ë¯¸ì§€ í•µì‹¬ í¬ì¸íŠ¸ 3ê°€ì§€
   - ê° í¬ì¸íŠ¸ë‹¹ 10~15ì´ˆ
   - ì§§ì€ ë¬¸ì¥ (1ë¬¸ì¥ 5ì´ˆ)
   - {íƒ€ê²Ÿì—°ë ¹ëŒ€} ê³µê° ì‹œë‚˜ë¦¬ì˜¤
   - {ì‚°ì—…ë¶„ì•¼} íŠ¸ë Œë“œ ì—°ê²°
   
   2-3. ë§ˆë¬´ë¦¬ (45~60ì´ˆ)
   - í•µì‹¬ ë©”ì‹œì§€ í•œ ì¤„ ìš”ì•½
   - "ì¢‹ì•„ìš” + êµ¬ë…" CTA
   - ë‹¤ìŒ ì˜ìƒ í‹°ì €

3. **ì˜ìƒ ì„¤ëª… (Description)**
   
   3-1. ìš”ì•½ (ì²« 3ì¤„)
   - ì˜ìƒ í•µì‹¬ ë‚´ìš©
   - í‚¤ì›Œë“œ ìì—°ìŠ¤ëŸ½ê²Œ í¬í•¨
   - ì´ëª¨ì§€ë¡œ ê°€ë…ì„±
   
   3-2. íƒ€ì„ë¼ì¸
   - 0:00 ì¸íŠ¸ë¡œ
   - 0:05 í¬ì¸íŠ¸1
   - 0:20 í¬ì¸íŠ¸2
   - 0:35 í¬ì¸íŠ¸3
   - 0:50 ë§ˆë¬´ë¦¬
   
   3-3. CTA
   - "ë” ë§ì€ {í‚¤ì›Œë“œ} ì •ë³´ëŠ” êµ¬ë…!"
   - ê´€ë ¨ ì˜ìƒ ë§í¬

4. **í•´ì‹œíƒœê·¸ (10~15ê°œ)**
   - #Shorts (í•„ìˆ˜)
   - #{í‚¤ì›Œë“œ} ê´€ë ¨ 5ê°œ
   - #{ì‚°ì—…ë¶„ì•¼} 3ê°œ
   - #ë¸Œëœë“œëª…
   - íŠ¸ë Œë”© íƒœê·¸ 3ê°œ

5. **ìë§‰ ê°€ì´ë“œ**
   - í•µì‹¬ ë‹¨ì–´ëŠ” í¬ê²Œ
   - ìˆ«ì/íŒ©íŠ¸ ê°•ì¡°
   - ì´ëª¨ì§€ ì ì ˆíˆ ì‚¬ìš©
   - 1ì´ˆë‹¹ 3~4ê¸€ì

ã€ê¸€ì“°ê¸° ê·œì¹™ã€‘

âœ… í•„ìˆ˜:
- ìŠ¤í¬ë¦½íŠ¸ 300~500ì
- 1ë¬¸ì¥ 15ì ì´ë‚´
- {í†¤ì•¤ë§¤ë„ˆ} ìœ ì§€
- ë¹ ë¥¸ í…œí¬
- ë°˜ë³µ ë©”ì‹œì§€

âŒ ê¸ˆì§€:
- ëŠë¦° ì „ê°œ
- ë³µì¡í•œ ì„¤ëª…
- 50ì ë„˜ëŠ” ë¬¸ì¥
- ì§€ë£¨í•œ ì¸íŠ¸ë¡œ

ã€ìˆí¼ ìµœì í™”ã€‘
- ì²˜ìŒ 3ì´ˆê°€ ìŠ¹ë¶€
- ìë§‰ í•„ìˆ˜
- ë¹ ë¥¸ ì»· í¸ì§‘ ì „ì œ
- ì„¸ë¡œ ì˜ìƒ (9:16)
- íŠ¸ë Œë“œ ì‚¬ìš´ë“œ í™œìš©`,

  youtube_longform: `ë‹¹ì‹ ì€ ì›” ì¡°íšŒìˆ˜ 1ì–µ ì´ìƒì˜ ìœ íŠœë¸Œ ì±„ë„ì„ ìš´ì˜í•˜ëŠ” ì „ë¬¸ í¬ë¦¬ì—ì´í„°ì…ë‹ˆë‹¤.
ì‹œì²­ ìœ ì§€ìœ¨ 70% ì´ìƒ, êµ¬ë… ì „í™˜ìœ¨ 5% ì´ìƒì„ ë‹¬ì„±í•˜ëŠ” ë¡±í¼ ì˜ìƒ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.

ã€ë¸Œëœë“œ ì •ë³´ã€‘
- ë¸Œëœë“œ/ì±„ë„: {ë¸Œëœë“œëª…}
- í•µì‹¬ í‚¤ì›Œë“œ: {í‚¤ì›Œë“œ}
- ì‚°ì—… ë¶„ì•¼: {ì‚°ì—…ë¶„ì•¼}
- íƒ€ê²Ÿ: {íƒ€ê²Ÿì—°ë ¹ëŒ€} {íƒ€ê²Ÿì„±ë³„}
- í†¤ì•¤ë§¤ë„ˆ: {í†¤ì•¤ë§¤ë„ˆ}
- ì˜ˆìƒ ê¸¸ì´: 5-10ë¶„

ã€ì¶œë ¥ êµ¬ì¡°ã€‘

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Œ ì˜ìƒ ë©”íƒ€ë°ì´í„°
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ·ï¸ ì œëª© í›„ë³´ (3ê°œ)
1. [í´ë¦­ë¥  ìµœì í™” - 60ì]
2. [SEO ìµœì í™” - 60ì]
3. [í˜¸ê¸°ì‹¬ ìê·¹ - 60ì]

â±ï¸ ì˜ˆìƒ ê¸¸ì´: [ë¶„:ì´ˆ]
ğŸ¯ íƒ€ê²Ÿ ìœ ì§€ìœ¨: 70%+

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¬ íƒ€ì„ë¼ì¸ ìŠ¤í¬ë¦½íŠ¸
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ã€00:00-00:30ã€‘í›… (Hook)
ğŸ“¹ í™”ë©´: [ì¹´ë©”ë¼/ë°°ê²½/ë¹„ì£¼ì–¼]
ğŸ¤ ëŒ€ì‚¬: "[ì²« 3ì´ˆ ê°•ë ¬í•œ í›…]"
ğŸ“ ìë§‰: "[í‚¤ì›Œë“œ ê°•ì¡°]"
ğŸµ ìŒí–¥: [BGM/íš¨ê³¼ìŒ]
ğŸ’¡ ìœ ì§€ ì „ëµ: [3ê°€ì§€]

ã€00:30-02:00ã€‘ë³¸ë¡  1
ğŸ“Œ ì œëª©: [ì„¹ì…˜ ì œëª©]
ğŸ”‘ í¬ì¸íŠ¸: [3ê°€ì§€]
ğŸ“¹ í™”ë©´: [ì—°ì¶œ/B-roll]
ğŸ¤ ëŒ€ì‚¬: "[ì‹¤ì œ ëŒ€ì‚¬]"
ğŸ’¬ ì°¸ì—¬: [ëŒ“ê¸€ ìœ ë„]

ã€02:00-06:00ã€‘ë³¸ë¡  2, 3
[ë™ì¼ êµ¬ì¡°]

ã€06:00-07:00ã€‘ë§ˆë¬´ë¦¬
ğŸ“Œ ìš”ì•½: [3ê°€ì§€]
ğŸ¯ CTA: [êµ¬ë…/ì¢‹ì•„ìš”]
ğŸ”® ì˜ˆê³ : [ë‹¤ìŒ ì˜ìƒ]

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¥ ì œì‘ ê°€ì´ë“œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“· ì´¬ì˜: [ì¥ë¹„/ì¡°ëª…/ìŒí–¥]
âœ‚ï¸ í¸ì§‘: [ì»·/ê·¸ë˜í”½/ìŒì•…]
ğŸ” SEO: [í‚¤ì›Œë“œ ë°°ì¹˜]
ğŸ–¼ï¸ ì¸ë„¤ì¼: [ë² ìŠ¤íŠ¸ ì»·]
ğŸ“‘ ì±•í„°: [ë§ˆì»¤ ë¦¬ìŠ¤íŠ¸]

ã€ìµœì¢… ì²´í¬ã€‘
âœ“ ì²« 30ì´ˆ í›… ê°•ë ¥
âœ“ 30ì´ˆë§ˆë‹¤ retention hook
âœ“ í‚¤ì›Œë“œ 5-8íšŒ ìì—° ì–¸ê¸‰
âœ“ B-roll íƒ€ì´ë° ëª…ì‹œ
âœ“ 16:9 í™”ë©´ë¹„ ìµœì í™”`,

  shortform_multi: `ë‹¹ì‹ ì€ í‹±í†¡ 1000ë§Œ, ë¦´ìŠ¤ 500ë§Œ íŒ”ë¡œì›Œ ë³´ìœ  ë°”ì´ëŸ´ í¬ë¦¬ì—ì´í„°ì…ë‹ˆë‹¤.
ì™„ì£¼ìœ¨ 80% ì´ìƒì˜ ìˆí¼ ì½˜í…ì¸ ë¥¼ ì œì‘í•©ë‹ˆë‹¤.

ã€ë¸Œëœë“œ ì •ë³´ã€‘
- ë¸Œëœë“œ: {ë¸Œëœë“œëª…}
- í‚¤ì›Œë“œ: {í‚¤ì›Œë“œ}
- ì‚°ì—…: {ì‚°ì—…ë¶„ì•¼}
- íƒ€ê²Ÿ: {íƒ€ê²Ÿì—°ë ¹ëŒ€} {íƒ€ê²Ÿì„±ë³„}
- í†¤: {í†¤ì•¤ë§¤ë„ˆ}
- ê¸¸ì´: 30-60ì´ˆ

ã€ëŒ€ìƒ í”Œë«í¼ã€‘
í‹±í†¡ + ì¸ìŠ¤íƒ€ê·¸ë¨ ë¦´ìŠ¤ + ìœ íŠœë¸Œ ì‡¼ì¸ 

ã€ì¶œë ¥ êµ¬ì¡°ã€‘

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“± ì½˜í…ì¸  ì „ëµ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ’« ë°”ì´ëŸ´ ì ìˆ˜: [1-10]
ğŸ¨ ìŠ¤íƒ€ì¼: êµìœ¡/ì—”í„°/íŠ¸ë Œë“œ

í”Œë«í¼ íŠ¹í™”:
ğŸ“± í‹±í†¡: [ë“€ì—£/ìŠ¤í‹°ì¹˜]
ğŸ“¸ ë¦´ìŠ¤: [ì €ì¥ ìœ ë„]
ğŸ¬ ì‡¼ì¸ : [SEO/ì‹œë¦¬ì¦ˆ]

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â±ï¸ íƒ€ì„ë¼ì¸ (9:16)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ã€00-03ì´ˆã€‘í›…
ğŸ“¹ í™”ë©´: [ìƒ·/ìœ„ì¹˜/ë™ì‘]
ğŸ“ í…ìŠ¤íŠ¸: "[ì˜¤ë²„ë ˆì´]"
ğŸ¤ ëŒ€ì‚¬: "[3ì´ˆ í›…]"
ğŸµ ìŒí–¥: [BGM/íš¨ê³¼ìŒ]
âœ‚ï¸ í¸ì§‘: [ì»·/ì „í™˜]

ã€03-15ì´ˆã€‘ë³¸ë¡  1
ã€15-25ì´ˆã€‘ë³¸ë¡  2
ã€25-35ì´ˆã€‘ë³¸ë¡  3
ã€35-45ì´ˆã€‘CTA

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“± í”Œë«í¼ë³„ ìµœì í™”
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ã€í‹±í†¡ã€‘
ğŸ·ï¸ #í•´ì‹œíƒœê·¸1 #í•´ì‹œíƒœê·¸2 #í•´ì‹œíƒœê·¸3
ğŸ“ ìº¡ì…˜: [100ì]
ğŸµ ì‚¬ìš´ë“œ: [íŠ¸ë Œë“œ]
ğŸ¤ ë“€ì—£: Yes/No

ã€ë¦´ìŠ¤ã€‘
ğŸ·ï¸ #5-10ê°œ
ğŸ“ ìº¡ì…˜: [í›…+ë³¸ë¬¸+CTA]
ğŸ’¾ ì €ì¥: [ìœ ë„ ìš”ì†Œ]
ğŸ“– ìŠ¤í† ë¦¬: [ë¦¬í¬ìŠ¤íŒ… í›…]

ã€ì‡¼ì¸ ã€‘
ğŸ·ï¸ ì œëª©: [SEO 60ì]
ğŸ“ ì„¤ëª…: [í‚¤ì›Œë“œ í¬í•¨]
ğŸ·ï¸ íƒœê·¸: [5ê°œ]
ğŸ”— ì‹œë¦¬ì¦ˆ: [ì—°ê²°]

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ ê¸°ìˆ  ì‚¬ì–‘ (9:16)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ì•ˆì „ ì˜ì—­:
ìƒë‹¨ 10% / í•˜ë‹¨ 15% / ì¢Œìš° 5%

í…ìŠ¤íŠ¸:
ë©”ì¸ 12-15% / ë³´ì¡° 8-10%

ã€ìµœì¢… ì²´í¬ã€‘
âœ“ ì²« 3ì´ˆ í›…
âœ“ 30-60ì´ˆ ë¶„ëŸ‰
âœ“ 9:16 í™”ë©´ë¹„
âœ“ í”Œë«í¼ë³„ í•´ì‹œíƒœê·¸
âœ“ ì•ˆì „ ì˜ì—­ ì¤€ìˆ˜`,

  tiktok: `ë‹¹ì‹ ì€ í‹±í†¡ ì „ë¬¸ ë°”ì´ëŸ´ í¬ë¦¬ì—ì´í„°ì…ë‹ˆë‹¤.
íŠ¸ë Œë“œë¥¼ ì„ ë„í•˜ê³  ë“€ì—£/ìŠ¤í‹°ì¹˜ ìœ ë„ì— ëŠ¥ìˆ™í•©ë‹ˆë‹¤.

ã€ë¸Œëœë“œ ì •ë³´ã€‘
- ë¸Œëœë“œ: {ë¸Œëœë“œëª…}
- í‚¤ì›Œë“œ: {í‚¤ì›Œë“œ}
- íƒ€ê²Ÿ: {íƒ€ê²Ÿì—°ë ¹ëŒ€}
- í†¤: {í†¤ì•¤ë§¤ë„ˆ}

ã€í‹±í†¡ íŠ¹í™” ì „ëµã€‘

1. íŠ¸ë Œë“œ ì‚¬ìš´ë“œ í™œìš©
2. ë“€ì—£/ìŠ¤í‹°ì¹˜ ê°€ëŠ¥ì„±
3. í•´ì‹œíƒœê·¸ ì±Œë¦°ì§€
4. ì²« 1ì´ˆ ê°•ë ¬í•œ í›…
5. ë¹ ë¥¸ ì»· í¸ì§‘

ã€ì¶œë ¥ í˜•ì‹ã€‘

ğŸµ ì¶”ì²œ ì‚¬ìš´ë“œ: [íŠ¸ë Œë“œ ì‚¬ìš´ë“œ]

â±ï¸ íƒ€ì„ë¼ì¸:
00-01ì´ˆ: [ê°•ë ¬í•œ í›…]
01-10ì´ˆ: [ë©”ì¸ ë©”ì‹œì§€]
10-20ì´ˆ: [ìƒì„¸ ì„¤ëª…]
20-30ì´ˆ: [CTA + ë£¨í”„]

ğŸ·ï¸ í•´ì‹œíƒœê·¸ (3-5ê°œ):
#ë©”ì¸í‚¤ì›Œë“œ #íŠ¸ë Œë“œíƒœê·¸ #ì±Œë¦°ì§€íƒœê·¸

ğŸ“ ìº¡ì…˜ (100ì):
[í›… ë¬¸ì¥ + ì°¸ì—¬ ìœ ë„]

ğŸ¤ ë“€ì—£/ìŠ¤í‹°ì¹˜:
[ê°€ëŠ¥/ë¶ˆê°€ëŠ¥ + ìœ ë„ ì „ëµ]`,

  instagram_reels: `ë‹¹ì‹ ì€ ì¸ìŠ¤íƒ€ê·¸ë¨ ë¦´ìŠ¤ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ì €ì¥ìœ¨ê³¼ ê³µìœ ìœ¨ì´ ë†’ì€ ì½˜í…ì¸ ë¥¼ ì œì‘í•©ë‹ˆë‹¤.

ã€ë¸Œëœë“œ ì •ë³´ã€‘
- ë¸Œëœë“œ: {ë¸Œëœë“œëª…}
- í‚¤ì›Œë“œ: {í‚¤ì›Œë“œ}
- íƒ€ê²Ÿ: {íƒ€ê²Ÿì—°ë ¹ëŒ€}
- í†¤: {í†¤ì•¤ë§¤ë„ˆ}

ã€ë¦´ìŠ¤ íŠ¹í™” ì „ëµã€‘

1. ì €ì¥ ìœ ë„ ê°€ì¹˜ ì œê³µ
2. ìŠ¤í† ë¦¬ ë¦¬í¬ìŠ¤íŒ… í›…
3. ë¯¸í•™ì  ë¹„ì£¼ì–¼
4. ë¼ì´í”„ìŠ¤íƒ€ì¼ ì—°ê²°
5. í”„ë¡œí•„ ë°©ë¬¸ ìœ ë„

ã€ì¶œë ¥ í˜•ì‹ã€‘

â±ï¸ íƒ€ì„ë¼ì¸:
00-03ì´ˆ: [ë¹„ì£¼ì–¼ í›…]
03-20ì´ˆ: [ê°€ì¹˜ ì œê³µ]
20-30ì´ˆ: [ì €ì¥ ìœ ë„ CTA]

ğŸ·ï¸ í•´ì‹œíƒœê·¸ (5-10ê°œ):
ëŒ€í˜• 2ê°œ + ì¤‘í˜• 5ê°œ + ë‹ˆì¹˜ 3ê°œ

ğŸ“ ìº¡ì…˜:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[ì²« ì¤„ í›… - ë”ë³´ê¸° í´ë¦­ ìœ ë„]

[ë³¸ë¬¸ 150-300ì]
[ê°ì • ì—°ê²° + ê°€ì¹˜ ì œê³µ]

ğŸ’¾ ì €ì¥í•´ì„œ ë‚˜ì¤‘ì—ë„ ë³´ì„¸ìš”
ğŸ“¤ ì¹œêµ¬ì—ê²Œ ê³µìœ í•˜ê¸°
ğŸ’¬ ëŒ“ê¸€ë¡œ ì˜ê²¬ ë‚¨ê²¨ì£¼ì„¸ìš”

#í•´ì‹œíƒœê·¸ë“¤
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ’¾ ì €ì¥ ìœ ë„ ìš”ì†Œ:
- [íŒ/ë…¸í•˜ìš° ì œê³µ]
- [ë‹¤ìš´ë¡œë“œ/ì €ì¥ ê°€ì¹˜]

ğŸ“– ìŠ¤í† ë¦¬ ë¦¬í¬ìŠ¤íŒ…:
- [ê³µìœ í•˜ê³  ì‹¶ì€ ë¬¸êµ¬]`,

  instagram_feed: `ë‹¹ì‹ ì€ ì¸ìŠ¤íƒ€ê·¸ë¨ í”¼ë“œ í¬ìŠ¤íŠ¸ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ì¹´ë£¨ì…€ê³¼ ë‹¨ì¼ í¬ìŠ¤íŠ¸ë¥¼ ì „ëµì ìœ¼ë¡œ ì„¤ê³„í•©ë‹ˆë‹¤.

ã€ë¸Œëœë“œ ì •ë³´ã€‘
- ë¸Œëœë“œ: {ë¸Œëœë“œëª…}
- í‚¤ì›Œë“œ: {í‚¤ì›Œë“œ}
- íƒ€ê²Ÿ: {íƒ€ê²Ÿì—°ë ¹ëŒ€}
- í†¤: {í†¤ì•¤ë§¤ë„ˆ}

ã€í”¼ë“œ ì „ëµã€‘

1. ìŠ¤ì™€ì´í”„ ìœ ë„ (ì¹´ë£¨ì…€)
2. ì‹œê°ì  ì¼ê´€ì„±
3. ìŠ¤í† ë¦¬í…”ë§
4. í”„ë¡œí•„ ê·¸ë¦¬ë“œ ì¡°í™”
5. ì €ì¥/ê³µìœ  ê°€ì¹˜

ã€ì¹´ë£¨ì…€ êµ¬ì¡° (2-10ì¥)ã€‘

ìŠ¬ë¼ì´ë“œ 1: [ì»¤ë²„ - í›…]
ìŠ¬ë¼ì´ë“œ 2-8: [ë©”ì¸ ì½˜í…ì¸ ]
ìŠ¬ë¼ì´ë“œ 9: [ìš”ì•½]
ìŠ¬ë¼ì´ë“œ 10: [CTA]

ã€ìº¡ì…˜ êµ¬ì¡°ã€‘

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[ì²« ì¤„ ê°•ë ¥ í›…]

[ë³¸ë¬¸ 300-500ì]
- ë¬¸ë‹¨ ë‚˜ëˆ„ê¸°
- ì´ëª¨ì§€ ì ì ˆíˆ
- ìŠ¤í† ë¦¬í…”ë§

[CTA]
ğŸ’¬ ëŒ“ê¸€: [ì§ˆë¬¸]
ğŸ’¾ ì €ì¥: [ê°€ì¹˜]
ğŸ“¤ ê³µìœ : [ì¹œêµ¬ íƒœê·¸]

#í•´ì‹œíƒœê·¸ 15-30ê°œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ã€ë¹„ì£¼ì–¼ ê°€ì´ë“œã€‘
- ìƒ‰ìƒ íŒ”ë ˆíŠ¸: [ë¸Œëœë“œ ì»¬ëŸ¬]
- í°íŠ¸: [ì¼ê´€ì„±]
- ë ˆì´ì•„ì›ƒ: [ê·¸ë¦¬ë“œ ì¡°í™”]`,

  metadata_generation: `ë‹¹ì‹ ì€ ìœ íŠœë¸Œ SEO ì „ë¬¸ê°€ì´ì ì†Œì…œë¯¸ë””ì–´ ë§ˆì¼€íŒ… ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
CTR 15% ì´ìƒ, ê²€ìƒ‰ ë…¸ì¶œ ìµœì í™”ë¥¼ ë‹¬ì„±í•©ë‹ˆë‹¤.

ã€ë¸Œëœë“œ ì •ë³´ã€‘
- ë¸Œëœë“œ: {ë¸Œëœë“œëª…}
- í‚¤ì›Œë“œ: {í‚¤ì›Œë“œ}
- ì‚°ì—…: {ì‚°ì—…ë¶„ì•¼}
- íƒ€ê²Ÿ: {íƒ€ê²Ÿì—°ë ¹ëŒ€}

ã€ì¶œë ¥ êµ¬ì¡°ã€‘

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ–¼ï¸ ì¸ë„¤ì¼ ì „ëµ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

í…ìŠ¤íŠ¸ 3ê°œ:
1. [ì„íŒ©íŠ¸í˜• - 10ì]
2. [ì§ˆë¬¸í˜• - 15ì]
3. [ìˆ«ìí˜• - 8ì]

ë¹„ì£¼ì–¼:
- ì–¼êµ´: [í‘œì • ì œì•ˆ]
- ë°°ê²½: [êµ¬ì„±]
- ê·¸ë˜í”½: [ìš”ì†Œ]

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ·ï¸ ì œëª© ìµœì í™”
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ë¡±í¼ 3ê°œ:
1. SEOí˜•: [í‚¤ì›Œë“œ ìì—° í¬í•¨ 60ì]
2. CTRí˜•: [ê°ì • ìê·¹ 60ì]
3. ë°”ì´ëŸ´í˜•: [ê³µìœ  ìœ ë„ 60ì]

ìˆí¼ 3ê°œ:
1. [í›… ì¤‘ì‹¬ 40ì]
2. [íŠ¸ë Œë“œ ì—°ê³„ 40ì]
3. [ì§ˆë¬¸í˜• 40ì]

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ ì„¤ëª…ê¸€
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ã€ìœ íŠœë¸Œã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[ì²« 2ì¤„ í›… - ê²€ìƒ‰ ë…¸ì¶œ]

[ë³¸ë¬¸ 300-500ì]
[í‚¤ì›Œë“œ 5-8íšŒ ìì—° ë°˜ë³µ]

â° íƒ€ì„ìŠ¤íƒ¬í”„:
0:00 - [ì„¹ì…˜1]
0:30 - [ì„¹ì…˜2]

ğŸ”— ë§í¬:
- [URL1]
- [URL2]

ğŸ’¬ CTA:
êµ¬ë…ê³¼ ì¢‹ì•„ìš” ë¶€íƒë“œë¦½ë‹ˆë‹¤!

#í‚¤ì›Œë“œ1 #í‚¤ì›Œë“œ2
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ã€ì¸ìŠ¤íƒ€ê·¸ë¨ã€‘
[ì²« ì¤„ í›…]
[ë³¸ë¬¸ 150-300ì]
[CTA]
#í•´ì‹œíƒœê·¸ë“¤

ã€í‹±í†¡ã€‘
[ê°„ê²° ìº¡ì…˜ 100ì]
[ì°¸ì—¬ ìœ ë„]
#í•´ì‹œíƒœê·¸3ê°œ

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ·ï¸ íƒœê·¸ & í•´ì‹œíƒœê·¸
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ìœ íŠœë¸Œ íƒœê·¸ (15-20ê°œ):
ì£¼ìš”: [5ê°œ]
ë¡±í…Œì¼: [5-10ê°œ]
íŠ¸ë Œë“œ: [3-5ê°œ]

ì†Œì…œ í•´ì‹œíƒœê·¸:
ëŒ€í˜• (100ë§Œ+): [2-3ê°œ]
ì¤‘í˜• (10-100ë§Œ): [5-7ê°œ]
ë‹ˆì¹˜ (1-10ë§Œ): [3-5ê°œ]
ë¸Œëœë“œ: [1-2ê°œ]

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ˆ SEO ìµœì í™”
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ì£¼ìš” í‚¤ì›Œë“œ: {í‚¤ì›Œë“œ}
ê²€ìƒ‰ëŸ‰: [ì›”ê°„]
ê²½ìŸë„: ë†’ìŒ/ì¤‘ê°„/ë‚®ìŒ
ë‚œì´ë„: [1-10]

ì—°ê´€ í‚¤ì›Œë“œ:
- [í‚¤ì›Œë“œ1]
- [í‚¤ì›Œë“œ2]
- [í‚¤ì›Œë“œ3]

ã€ì„±ê³¼ ì˜ˆì¸¡ã€‘
ì˜ˆìƒ CTR: [%]
ë°”ì´ëŸ´ ì ìˆ˜: [1-10]
ì°¸ì—¬ìœ¨: [%]`,

  // ===================================
  // ì‹ ê·œ í”Œë«í¼: Twitter
  // ===================================
  twitter: `ë‹¹ì‹ ì€ Twitter ë§ˆì¼€íŒ… ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

ã€ë¸Œëœë“œ ì •ë³´ã€‘
- ë¸Œëœë“œ/ì„œë¹„ìŠ¤/ìƒí’ˆ: {ë¸Œëœë“œëª…}
- í•µì‹¬ í‚¤ì›Œë“œ: {í‚¤ì›Œë“œ}
- ì‚°ì—… ë¶„ì•¼: {ì‚°ì—…ë¶„ì•¼}
- íƒ€ê²Ÿ: {íƒ€ê²Ÿì—°ë ¹ëŒ€} {íƒ€ê²Ÿì„±ë³„}
- í†¤ì•¤ë§¤ë„ˆ: {í†¤ì•¤ë§¤ë„ˆ}

**ì ˆëŒ€ì  ì œì•½:**
- **ìµœëŒ€ 280ì** (ê³µë°±, í•´ì‹œíƒœê·¸ í¬í•¨, ì´ˆê³¼ ì ˆëŒ€ ê¸ˆì§€)
- í•œê¸€ ê¸°ì¤€ ì•½ 140ì
- í•´ì‹œíƒœê·¸ í¬í•¨ ì‹œ ê¸€ì ìˆ˜ì— í¬í•¨

ã€ì‘ì„± ìš”êµ¬ì‚¬í•­ã€‘

1. **í›…(Hook)** - ì²« 20ì
   - ìŠ¤í¬ë¡¤ì„ ë©ˆì¶”ê²Œ í•˜ëŠ” ê°•ë ¬í•œ ì‹œì‘
   - ì§ˆë¬¸í˜•, ìˆ«ìí˜•, ì¶©ê²©í˜• ì¤‘ ì„ íƒ
   - ì˜ˆ: "90%ê°€ ë†“ì¹˜ëŠ”...", "ë‹¹ì‹ ë„ ì´ë¬ë‚˜ìš”?", "ê²°ë¡ ë¶€í„° ë§í•˜ë©´..."

2. **í•µì‹¬ ë©”ì‹œì§€** - 60-80ì
   - ë‹¨ í•˜ë‚˜ì˜ ëª…í™•í•œ ë©”ì‹œì§€
   - ì´ë¯¸ì§€ ë‚´ìš©ê³¼ ì—°ê²°
   - {í‚¤ì›Œë“œ} ìì—°ìŠ¤ëŸ½ê²Œ í¬í•¨

3. **CTA** - 20-30ì
   - ëª…í™•í•œ í–‰ë™ ìœ ë„
   - "RTí•˜ë©´...", "ë‹µê¸€ë¡œ ê³µìœ ", "ë§í¬ í™•ì¸" ë“±

4. **í•´ì‹œíƒœê·¸** - 3-5ê°œ (30ì ì´ë‚´)
   - ë©”ì¸ í‚¤ì›Œë“œ + íŠ¸ë Œë”© íƒœê·¸
   - #ë¸Œëœë“œëª… #í‚¤ì›Œë“œ #ì‚°ì—…ë¶„ì•¼

5. **ì´ëª¨í‹°ì½˜** - 2-3ê°œ
   - ê°ì • í‘œí˜„ ë˜ëŠ” ê°•ì¡°ìš©
   - ê³¼ë„í•˜ì§€ ì•Šê²Œ

ã€ì¶œë ¥ í˜•ì‹ã€‘

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¦ íŠ¸ìœ„í„° í¬ìŠ¤íŠ¸
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

[í›… ë¬¸ì¥] ğŸ”¥

[í•µì‹¬ ë©”ì‹œì§€ 2-3ë¬¸ì¥]

[CTA] ğŸ‘‰

#íƒœê·¸1 #íƒœê·¸2 #íƒœê·¸3

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š ê¸€ì ìˆ˜: [ì •í™•í•œ ê¸€ì ìˆ˜]
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âš ï¸ ìµœì¢… ì²´í¬:
âœ“ 280ì ì´ë‚´ (ê³µë°± í¬í•¨) - í•„ìˆ˜!
âœ“ í›… ë¬¸ì¥ ëª…í™•
âœ“ CTA í¬í•¨
âœ“ í•´ì‹œíƒœê·¸ 3-5ê°œ
âœ“ ì´ëª¨í‹°ì½˜ 2-3ê°œ

ã€ê¸ˆì§€ ì‚¬í•­ã€‘
âŒ 280ì ì´ˆê³¼ (ì ˆëŒ€ ë¶ˆê°€)
âŒ ê¸´ ë¬¸ì¥ (TwitterëŠ” ì§§ê³  ê°•ë ¬í•˜ê²Œ)
âŒ ê³¼ë„í•œ ì´ëª¨í‹°ì½˜ (3ê°œ ì´ìƒ)
âŒ í•´ì‹œíƒœê·¸ ë‚¨ë°œ (5ê°œ ì´í•˜)`
};

// ===================================
// ì´ˆê¸°í™”
// ===================================
document.addEventListener('DOMContentLoaded', () => {
  initializeApp();
});

async function initializeApp() {
  // ë°ì´í„° ë¡œë“œ
  loadProfiles();
  loadHistory();
  loadTemplates();
  
  // í™˜ìœ¨ ì¡°íšŒ
  await fetchExchangeRate();
  
  // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
  setupEventListeners();
  
  // ì´ˆê¸° ì½˜í…ì¸  ë¸”ë¡ ìƒì„± (1ê°œ)
  generateContentBlocks();
  
  // ë¹„ìš© ì´ˆê¸°í™”
  updateCostEstimate();
  
  // ë‹¤êµ­ì–´ ì´ˆê¸°í™”
  if (typeof window.i18n !== 'undefined' && typeof window.i18n.init === 'function') {
    window.i18n.init();
  }
  
  // ì˜¨ë³´ë”© ì´ˆê¸°í™” (ì‚¬ìš©ì ë¡œê·¸ì¸ í›„) - ë¹„í™œì„±í™”
  // ì‚¬ìš©ì í”¼ë“œë°±: íŒì—…ì´ ë¶€ë‹´ìŠ¤ëŸ½ë‹¤ëŠ” ì˜ê²¬ìœ¼ë¡œ ë¹„í™œì„±í™”
  /*
  try {
    const { data: { user } } = await supabase.auth.getUser();
    if (user?.id) {
      // ì˜¨ë³´ë”© ì‹œìŠ¤í…œ ì´ˆê¸°í™”
      if (typeof window.initOnboarding === 'function') {
        await window.initOnboarding(user.id);
      }
    }
  } catch (error) {
    console.error('ì˜¨ë³´ë”© ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
  }
  */
}

// ===================================
// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
// ===================================
function setupEventListeners() {
  // ì´ë¯¸ì§€ ì—…ë¡œë“œ
  const uploadArea = document.getElementById('uploadArea');
  const imageInput = document.getElementById('imageInput');

  if (uploadArea) {
    uploadArea.addEventListener('click', () => imageInput.click());
    uploadArea.addEventListener('dragover', handleDragOver);
    uploadArea.addEventListener('dragleave', handleDragLeave);
    uploadArea.addEventListener('drop', handleDrop);
  }

  if (imageInput) {
    imageInput.addEventListener('change', handleImageSelect);
  }

  // í¼ ì œì¶œ
  const contentForm = document.getElementById('contentForm');
  if (contentForm) {
    contentForm.addEventListener('submit', (e) => {
      e.preventDefault();
      handleGenerate();
    });
  }

  // í”„ë¡œí•„ ê´€ë¦¬
  const saveProfileBtn = document.getElementById('saveProfileBtn');
  const loadProfileBtn = document.getElementById('loadProfileBtn');

  if (saveProfileBtn) {
    saveProfileBtn.addEventListener('click', saveProfile);
  }

  if (loadProfileBtn) {
    loadProfileBtn.addEventListener('click', openLoadProfileModal);
  }

  // íˆìŠ¤í† ë¦¬ì™€ í…œí”Œë¦¿ ë²„íŠ¼ì€ 5857ì¤„ì—ì„œ ì²˜ë¦¬ë¨ (ì¤‘ë³µ ì œê±°)

  // í”Œë«í¼ ì„ íƒ ë³€ê²½ ì‹œ ë¹„ìš© ì¬ê³„ì‚° ë° ë°°ì¹˜ ê³„ì‚°
  const platformCheckboxes = document.querySelectorAll('input[name="platform"]');
  platformCheckboxes.forEach((checkbox) => {
    checkbox.addEventListener('change', () => {
      updateCostEstimate();
      updateBatchCalculation();
    });
  });
}

// ===================================
// ì´ë¯¸ì§€ ì—…ë¡œë“œ
// ===================================
function handleDragOver(e) {
  e.preventDefault();
  e.currentTarget.style.borderColor = '#667eea';
  e.currentTarget.style.backgroundColor = '#f0f0ff';
}

function handleDragLeave(e) {
  e.currentTarget.style.borderColor = '#d1d5db';
  e.currentTarget.style.backgroundColor = 'transparent';
}

function handleDrop(e) {
  e.preventDefault();
  e.currentTarget.style.borderColor = '#d1d5db';
  e.currentTarget.style.backgroundColor = 'transparent';

  const files = Array.from(e.dataTransfer.files);
  const imageFiles = files.filter((f) => f.type.startsWith('image/'));

  if (imageFiles.length > 0) {
    processImageFiles(imageFiles);
  }
}

function handleImageSelect(e) {
  const files = Array.from(e.target.files);
  processImageFiles(files);
}

async function processImageFiles(files) {
  if (selectedImages.length + files.length > 100) {
    showToast('âŒ ìµœëŒ€ 100ì¥ê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤', 'error');
    return;
  }

  let totalSize = selectedImages.reduce((sum, img) => sum + img.size, 0);
  for (const file of files) {
    totalSize += file.size;
  }

  const maxSize = 200 * 1024 * 1024; // 200MB
  if (totalSize > maxSize) {
    showToast('âŒ ì´ íŒŒì¼ í¬ê¸°ëŠ” 200MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
    return;
  }

  for (const file of files) {
    const base64 = await fileToBase64(file);
    selectedImages.push({
      name: file.name,
      size: file.size,
      base64: base64,
      url: URL.createObjectURL(file),
    });
  }

  renderImagePreviews();
  updateCostEstimate();
  updateBatchCalculation(); // ë°°ì¹˜ ê³„ì‚° ì—…ë°ì´íŠ¸
}

function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

function renderImagePreviews() {
  const container = document.getElementById('imagePreviewContainer');
  if (!container) return;

  if (selectedImages.length === 0) {
    container.innerHTML = '';
    return;
  }

  container.innerHTML = selectedImages
    .map(
      (img, index) => `
    <div class="image-preview">
      <img src="${img.url}" alt="${img.name}" />
      <button class="remove-image-btn" onclick="removeImage(${index})">
        <i class="fas fa-times"></i>
      </button>
      <button class="edit-image-btn" onclick="openImageEditor(${index})" title="ì´ë¯¸ì§€ í¸ì§‘">
        <i class="fas fa-edit"></i>
      </button>
      <span class="image-name">${img.name}</span>
    </div>
  `
    )
    .join('');
}

function removeImage(index) {
  URL.revokeObjectURL(selectedImages[index].url);
  selectedImages.splice(index, 1);
  renderImagePreviews();
  updateCostEstimate();
  updateBatchCalculation(); // ë°°ì¹˜ ê³„ì‚° ì—…ë°ì´íŠ¸
}

// ===================================
// ì´ë¯¸ì§€ í¸ì§‘
// ===================================
function openImageEditor(index) {
  currentEditImageIndex = index;
  const modal = document.getElementById('imageEditorModal');
  const canvas = document.getElementById('editCanvas');
  const ctx = canvas.getContext('2d');

  const img = new Image();
  img.onload = () => {
    canvas.width = img.width;
    canvas.height = img.height;
    ctx.drawImage(img, 0, 0);
  };
  img.src = selectedImages[index].url;

  modal.classList.remove('hidden');
  modal.style.display = 'flex';
}

function applyImageFilter(filter) {
  const canvas = document.getElementById('editCanvas');
  const ctx = canvas.getContext('2d');
  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const data = imageData.data;

  switch (filter) {
    case 'grayscale':
      for (let i = 0; i < data.length; i += 4) {
        const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
        data[i] = data[i + 1] = data[i + 2] = avg;
      }
      break;
    case 'brightness':
      const brightness = 30;
      for (let i = 0; i < data.length; i += 4) {
        data[i] = Math.min(255, data[i] + brightness);
        data[i + 1] = Math.min(255, data[i + 1] + brightness);
        data[i + 2] = Math.min(255, data[i + 2] + brightness);
      }
      break;
    case 'contrast':
      const contrast = 1.2;
      for (let i = 0; i < data.length; i += 4) {
        data[i] = Math.min(255, Math.max(0, ((data[i] - 128) * contrast) + 128));
        data[i + 1] = Math.min(255, Math.max(0, ((data[i + 1] - 128) * contrast) + 128));
        data[i + 2] = Math.min(255, Math.max(0, ((data[i + 2] - 128) * contrast) + 128));
      }
      break;
  }

  ctx.putImageData(imageData, 0, 0);
  showToast(`âœ… ${filter} í•„í„°ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
}

function compressImage() {
  const canvas = document.getElementById('editCanvas');
  const quality = 0.7; // 70% í’ˆì§ˆ
  
  showToast('ğŸ”„ ì´ë¯¸ì§€ ì••ì¶• ì¤‘...', 'info');
  
  setTimeout(() => {
    const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
    selectedImages[currentEditImageIndex].base64 = compressedBase64;
    selectedImages[currentEditImageIndex].size = Math.floor(compressedBase64.length * 0.75);
    showToast('âœ… ì´ë¯¸ì§€ê°€ 70% í’ˆì§ˆë¡œ ì••ì¶•ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
  }, 300);
}

function saveEditedImage() {
  const canvas = document.getElementById('editCanvas');
  const newBase64 = canvas.toDataURL('image/png');
  
  selectedImages[currentEditImageIndex].base64 = newBase64;
  URL.revokeObjectURL(selectedImages[currentEditImageIndex].url);
  selectedImages[currentEditImageIndex].url = canvas.toDataURL();
  
  renderImagePreviews();
  closeImageEditor();
  showToast('âœ… ì´ë¯¸ì§€ í¸ì§‘ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
}

function closeImageEditor() {
  const modal = document.getElementById('imageEditorModal');
  modal.classList.add('hidden');
  modal.style.display = 'none';
  currentEditImageIndex = null;
}

// ===================================
// ë¹„ìš© ê³„ì‚°
// ===================================
async function fetchExchangeRate() {
  const CACHE_DURATION = 24 * 60 * 60 * 1000; // 24ì‹œê°„
  const cachedRate = localStorage.getItem('exchange_rate');
  const cachedTime = localStorage.getItem('exchange_rate_time');

  if (cachedRate && cachedTime) {
    const timeDiff = Date.now() - parseInt(cachedTime);
    if (timeDiff < CACHE_DURATION) {
      EXCHANGE_RATE = parseFloat(cachedRate);
      lastExchangeUpdate = new Date(parseInt(cachedTime));
      return;
    }
  }

  try {
    const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
    const data = await response.json();
    EXCHANGE_RATE = data.rates.KRW;
    lastExchangeUpdate = new Date();

    localStorage.setItem('exchange_rate', EXCHANGE_RATE.toString());
    localStorage.setItem('exchange_rate_time', Date.now().toString());
  } catch (error) {
    console.error('í™˜ìœ¨ ì¡°íšŒ ì‹¤íŒ¨:', error);
    EXCHANGE_RATE = 1300; // ê¸°ë³¸ê°’
  }
}

function updateCostEstimate() {
  // ğŸ’ ìµœì‹  í¬ë ˆë”§ ì •ë³´ ë™ê¸°í™” (window.userCreditsInfo ìš°ì„  ì‚¬ìš©)
  if (window.userCreditsInfo && window.currentUser) {
    window.currentUser.free_credits = window.userCreditsInfo.free_credits ?? window.currentUser.free_credits ?? 0;
    window.currentUser.paid_credits = window.userCreditsInfo.paid_credits ?? window.currentUser.paid_credits ?? 0;
    console.log('ğŸ’ í•˜ë‹¨ í¬ë ˆë”§ í‘œì‹œ ë™ê¸°í™”:', {
      free: window.currentUser.free_credits,
      paid: window.currentUser.paid_credits,
      total: window.currentUser.free_credits + window.currentUser.paid_credits
    });
  } else if (window.currentUser && window.currentUser.id && !window.currentUser.isGuest) {
    // ğŸ”¥ í¬ë ˆë”§ ì •ë³´ê°€ ì—†ìœ¼ë©´ ì¦‰ì‹œ ë¡œë“œ ì‹œë„
    console.log('âš ï¸ window.userCreditsInfo ì—†ìŒ, í¬ë ˆë”§ ì •ë³´ ë¡œë“œ ì‹œë„');
    if (typeof loadKeywordCreditStatus === 'function') {
      loadKeywordCreditStatus(); // í¬ë ˆë”§ ì •ë³´ ë¡œë“œ
    }
  }
  
  // ê°œë³„ ì½˜í…ì¸  ë¸”ë¡ì˜ ì´ ì´ë¯¸ì§€ ìˆ˜ ê³„ì‚°
  let totalImageCount = 0;
  const contentCount = Object.keys(contentBlocks).length;
  
  Object.values(contentBlocks).forEach(block => {
    totalImageCount += (block.images || []).length;
  });
  
  const platformCheckboxes = document.querySelectorAll('input[name="platform"]:checked');
  const platformCount = platformCheckboxes.length;
  
  // âœ… costEstimate ì—˜ë¦¬ë¨¼íŠ¸ ì¡´ì¬ í™•ì¸ (í•˜ë‹¨ ì¼ê´„ ìƒì„± UI ì œê±°ë¡œ ì¸í•œ null ë°©ì§€)
  const costElement = document.getElementById('costEstimate');
  if (!costElement) {
    console.log('â„¹ï¸ costEstimate ì—˜ë¦¬ë¨¼íŠ¸ ì—†ìŒ (ê°œë³„ ìƒì„± ëª¨ë“œ)');
    return;
  }

  if (totalImageCount === 0 || platformCount === 0 || contentCount === 0) {
    costElement.innerHTML = `
      <div style="padding: 1.5rem; text-align: center; background: #f9fafb; border-radius: 12px; border: 2px dashed #d1d5db;">
        <p style="color: #6b7280; margin: 0;">
          ğŸ“Š ì½˜í…ì¸ ë³„ ì´ë¯¸ì§€ì™€ í”Œë«í¼ì„ ì„ íƒí•˜ë©´ í¬ë ˆë”§ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤
        </p>
      </div>
    `;
    return;
  }

  // ì˜ˆìƒ ì†Œìš” ì‹œê°„ ê³„ì‚°
  const imageAnalysisTime = Math.min(totalImageCount * 3, 5);
  const contentGenerationTime = Math.min(contentCount * platformCount * 10, 30);
  const totalTimeSeconds = imageAnalysisTime + contentGenerationTime;
  const totalTimeMinutes = Math.ceil(totalTimeSeconds / 60);

  // ===================================
  // NEW v11.34.0: í¬ë ˆë”§ ê³„ì‚° (í”Œë«í¼ 1ê°œë‹¹ 1í¬ë ˆë”§)
  // ===================================
  
  // í”Œë«í¼ 1ê°œë‹¹ 1í¬ë ˆë”§ ë¡œì§ (ì½˜í…ì¸  ê°œìˆ˜ Ã— í”Œë«í¼ ê°œìˆ˜)
  const creditsNeeded = contentCount * platformCount;
  
  // ğŸ”¥ í¬ë ˆë”§ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (window.userCreditsInfo ìš°ì„ , ì—†ìœ¼ë©´ currentUser ì‚¬ìš©)
  const freeCredits = window.userCreditsInfo?.free_credits ?? currentUser.free_credits ?? 0;
  const paidCredits = window.userCreditsInfo?.paid_credits ?? currentUser.paid_credits ?? 0;
  const totalCredits = freeCredits + paidCredits;
  
  console.log('ğŸ“Š [updateCostEstimate] í¬ë ˆë”§ ì •ë³´:', {
    source: window.userCreditsInfo ? 'window.userCreditsInfo' : 'currentUser',
    free: freeCredits,
    paid: paidCredits,
    total: totalCredits,
    needed: creditsNeeded,
    sufficient: totalCredits >= creditsNeeded  // âœ… ì¶©ë¶„í•œì§€ ì—¬ë¶€ ì¶”ê°€
  });
  
  let costInfoHTML = '';
  let statusBadge = '';
  let gradientColor = '';
  
  if (currentUser.isGuest) {
    // ë¹„íšŒì›: ë¡œê·¸ì¸ ìœ ë„
    gradientColor = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
    statusBadge = '<span style="background: rgba(255,255,255,0.3); padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; font-weight: 600;">ğŸ” ë¡œê·¸ì¸ í•„ìš”</span>';
    
    costInfoHTML = `
      <div style="background: rgba(255,255,255,0.2); padding: 1.5rem; border-radius: 10px; margin-bottom: 1rem; text-align: center;">
        <div style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem;">
          ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤
        </div>
        <p style="font-size: 0.95rem; opacity: 0.9; margin: 0;">
          ê°€ì…ë§Œ í•´ë„ <strong>ì›” 30í¬ë ˆë”§ ë¬´ë£Œ</strong> ì œê³µ!
        </p>
      </div>
    `;
  } else if (currentUser.tier === 'free' || currentUser.subscription_status === 'free') {
    // ë¬´ë£Œ íšŒì› - 2ì§€ê°‘ í¬ë ˆë”§ ì‹œìŠ¤í…œ
    gradientColor = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
    statusBadge = '<span style="background: rgba(255,255,255,0.3); padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; font-weight: 600;">ğŸ‰ ë¬´ë£Œ íšŒì›</span>';
    
    let creditDisplayText = '';
    if (freeCredits === 0 && paidCredits > 0) {
      creditDisplayText = `${totalCredits}ê°œ (ìœ ë£Œ)`;
    } else if (paidCredits === 0 && freeCredits > 0) {
      creditDisplayText = `${totalCredits}ê°œ (ë¬´ë£Œ)`;
    } else if (freeCredits > 0 && paidCredits > 0) {
      creditDisplayText = `${totalCredits}ê°œ (ë¬´ë£Œ ${freeCredits} + ìœ ë£Œ ${paidCredits})`;
    } else {
      creditDisplayText = `0ê°œ`;
    }
    
    costInfoHTML = `
      <div style="background: rgba(255,255,255,0.2); padding: 1.5rem; border-radius: 10px; margin-bottom: 1rem; text-align: center;">
        <div style="font-size: 1.3rem; font-weight: 600; margin-bottom: 0.8rem; opacity: 0.9;">
          ${creditsNeeded} í¬ë ˆë”§ ì°¨ê°
        </div>
        <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: 0.3rem;">
          í˜„ì¬ ë³´ìœ : ${creditDisplayText}
        </div>
        ${totalCredits < creditsNeeded ? `
          <div style="background: rgba(239, 68, 68, 0.3); border: 1px solid rgba(239, 68, 68, 0.5); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
            <p style="margin: 0; font-size: 0.95rem;">
              âš ï¸ í¬ë ˆë”§ì´ ë¶€ì¡±í•©ë‹ˆë‹¤ (ë³´ìœ : ${totalCredits}ê°œ, í•„ìš”: ${creditsNeeded}ê°œ). <a href="/payment" style="color: white; text-decoration: underline; font-weight: 600;">ì¶©ì „í•˜ê¸°</a>
            </p>
          </div>
        ` : ''}
      </div>
    `;
  } else {
    // ìœ ë£Œ íšŒì›
    gradientColor = 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)';
    statusBadge = '<span style="background: rgba(255,255,255,0.3); padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; font-weight: 600;">â­ ìœ ë£Œ íšŒì›</span>';
    
    let creditDisplayText = '';
    if (freeCredits === 0 && paidCredits > 0) {
      creditDisplayText = `${totalCredits}ê°œ (ìœ ë£Œ)`;
    } else if (paidCredits === 0 && freeCredits > 0) {
      creditDisplayText = `${totalCredits}ê°œ (ë¬´ë£Œ)`;
    } else if (freeCredits > 0 && paidCredits > 0) {
      creditDisplayText = `${totalCredits}ê°œ (ë¬´ë£Œ ${freeCredits} + ìœ ë£Œ ${paidCredits})`;
    } else {
      creditDisplayText = `0ê°œ`;
    }
    
    costInfoHTML = `
      <div style="background: rgba(255,255,255,0.2); padding: 1.5rem; border-radius: 10px; margin-bottom: 1rem; text-align: center;">
        <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: 0.3rem;">
          ${creditsNeeded} í¬ë ˆë”§ ì°¨ê°
        </div>
        <p style="font-size: 1.1rem; opacity: 0.9; margin: 0;">
          í˜„ì¬ ë³´ìœ : <strong>${creditDisplayText}</strong>
        </p>
        ${totalCredits < creditsNeeded ? `
          <div style="background: rgba(239, 68, 68, 0.3); border: 1px solid rgba(239, 68, 68, 0.5); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
            <p style="margin: 0; font-size: 0.95rem;">
              âš ï¸ í¬ë ˆë”§ì´ ë¶€ì¡±í•©ë‹ˆë‹¤ (ë³´ìœ : ${totalCredits}ê°œ, í•„ìš”: ${creditsNeeded}ê°œ). <a href="/payment" style="color: white; text-decoration: underline; font-weight: 600;">ì¶©ì „í•˜ê¸°</a>
            </p>
          </div>
        ` : ''}
      </div>
    `;
  }

  document.getElementById('costEstimate').innerHTML = `
    <div style="padding: 1.5rem; background: ${gradientColor}; border-radius: 12px; color: white; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h3 style="font-size: 1.2rem; font-weight: bold; margin: 0;">
          ğŸ’° ì˜ˆìƒ ì‚¬ìš© í¬ë ˆë”§ ë° ì†Œìš” ì‹œê°„
        </h3>
        ${statusBadge}
      </div>
      
      ${costInfoHTML}
      
      <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
          <span>ğŸ“¸ ë¶„ì„í•  ì´ë¯¸ì§€:</span>
          <span style="font-weight: 600;">${totalImageCount}ì¥</span>
        </div>
        <div style="display: flex; justify-content: space-between;">
          <span>âœ¨ ìƒì„±í•  ì½˜í…ì¸ :</span>
          <span style="font-weight: 600;">${contentCount}ê°œ Ã— ${platformCount}ê°œ í”Œë«í¼</span>
        </div>
      </div>
      
      <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: 8px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <span style="font-size: 1.1rem;">â±ï¸ ì˜ˆìƒ ì†Œìš” ì‹œê°„:</span>
          <span style="font-size: 1.3rem; font-weight: bold;">${totalTimeSeconds}ì´ˆ (ì•½ ${totalTimeMinutes}ë¶„)</span>
        </div>
      </div>
      
      <p style="font-size: 0.85rem; opacity: 0.9; margin-top: 1rem; text-align: center; margin-bottom: 0;">
        ğŸ’¡ í”Œë«í¼ 1ê°œë‹¹ 1í¬ë ˆë”§ (ì„ íƒí•œ í”Œë«í¼ ê°œìˆ˜ë§Œí¼ ì°¨ê°)
      </p>
    </div>
  `;
  
  // ğŸš¨ í¬ë¦¬í‹°ì»¬: ìƒì„± ë²„íŠ¼ ì‹¤ì‹œê°„ ë¹„í™œì„±í™” (API ë¹„ìš© ë‚­ë¹„ ë°©ì§€)
  const generateBtn = document.querySelector('button[type="submit"]');
  const batchGenerateBtn = document.getElementById('batchGenerateBtn');
  
  const isInsufficientCredits = !currentUser.isGuest && currentUser.id && totalCredits < creditsNeeded;
  
  if (generateBtn) {
    generateBtn.disabled = isInsufficientCredits;
    generateBtn.style.opacity = isInsufficientCredits ? '0.5' : '1';
    generateBtn.style.cursor = isInsufficientCredits ? 'not-allowed' : 'pointer';
    
    if (isInsufficientCredits) {
      generateBtn.title = `í¬ë ˆë”§ ë¶€ì¡± (í•„ìš”: ${creditsNeeded}, ë³´ìœ : ${totalCredits})`;
    } else {
      generateBtn.title = '';
    }
  }
  
  if (batchGenerateBtn) {
    batchGenerateBtn.disabled = isInsufficientCredits;
    batchGenerateBtn.style.opacity = isInsufficientCredits ? '0.5' : '1';
    batchGenerateBtn.style.cursor = isInsufficientCredits ? 'not-allowed' : 'pointer';
    
    if (isInsufficientCredits) {
      batchGenerateBtn.title = `í¬ë ˆë”§ ë¶€ì¡± (í•„ìš”: ${creditsNeeded}, ë³´ìœ : ${totalCredits})`;
    } else {
      batchGenerateBtn.title = '';
    }
  }
}

// ===================================
// ë°°ì¹˜ ìƒì„± ê³„ì‚°
// ===================================
function updateBatchCalculation() {
  const contentCountSelect = document.getElementById('contentCount');
  const imagesPerContentSelect = document.getElementById('imagesPerContent');
  
  if (!contentCountSelect || !imagesPerContentSelect) return;
  
  const contentCount = parseInt(contentCountSelect.value) || 1;
  const imagesPerContent = parseInt(imagesPerContentSelect.value) || 5;
  
  // í•„ìš”í•œ ì´ë¯¸ì§€ ìˆ˜ ê³„ì‚°
  const requiredImages = contentCount * imagesPerContent;
  const uploadedImages = selectedImages.length;
  
  // UI ì—…ë°ì´íŠ¸
  document.getElementById('requiredImages').textContent = requiredImages;
  document.getElementById('uploadedImages').textContent = uploadedImages;
  
  // ê²½ê³  ë©”ì‹œì§€
  const warningDiv = document.getElementById('batchWarning');
  const warningText = document.getElementById('batchWarningText');
  
  if (uploadedImages < requiredImages) {
    warningDiv.classList.remove('hidden');
    const shortage = requiredImages - uploadedImages;
    warningText.textContent = `${shortage}ì¥ì˜ ì´ë¯¸ì§€ë¥¼ ë” ì—…ë¡œë“œí•´ì£¼ì„¸ìš”. (í˜„ì¬: ${uploadedImages}ì¥ / í•„ìš”: ${requiredImages}ì¥)`;
  } else {
    warningDiv.classList.add('hidden');
  }
  
  // ë¶„ë°° ë¯¸ë¦¬ë³´ê¸°
  const distributionPreview = document.getElementById('distributionPreview');
  const distributionList = document.getElementById('distributionList');
  
  if (uploadedImages > 0 && contentCount > 1) {
    distributionPreview.classList.remove('hidden');
    
    let previewHTML = '<div class="space-y-1">';
    const platformCheckboxes = document.querySelectorAll('input[name="platform"]:checked');
    const platforms = Array.from(platformCheckboxes).map(cb => {
      const value = cb.value;
      const labels = { blog: 'ë¸”ë¡œê·¸', instagram: 'ì¸ìŠ¤íƒ€', threads: 'ìŠ¤ë ˆë“œ', youtube: 'ìœ íŠœë¸Œ' };
      return labels[value] || value;
    }).join(' + ') || 'ì„ íƒëœ í”Œë«í¼';
    
    // í‚¤ì›Œë“œ ìˆœí™˜ ì •ë³´ ì¶”ê°€
    const keywordsInput = document.getElementById('keywords')?.value.trim() || '';
    const keywordArray = keywordsInput.split(',').map(k => k.trim()).filter(k => k.length > 0);
    
    for (let i = 0; i < contentCount; i++) {
      const startIdx = i * imagesPerContent + 1;
      const endIdx = Math.min((i + 1) * imagesPerContent, uploadedImages);
      const available = endIdx >= startIdx;
      
      // í˜„ì¬ ì½˜í…ì¸ ì˜ í‚¤ì›Œë“œ ê²°ì •
      const currentKeyword = keywordArray.length > 0 
        ? keywordArray[i % keywordArray.length] 
        : '';
      
      previewHTML += `
        <div class="flex items-center justify-between py-2 border-b border-gray-200">
          <div class="flex items-center gap-2">
            <span class="${available ? 'text-gray-700' : 'text-red-500'} font-medium">
              ${platforms} #${i + 1}
            </span>
            ${currentKeyword ? `<span class="px-2 py-0.5 bg-purple-100 text-purple-700 rounded text-xs">${currentKeyword}</span>` : ''}
          </div>
          <span class="${available ? 'text-purple-600' : 'text-red-500'} text-sm">
            ${available ? `ì´ë¯¸ì§€ ${startIdx}~${endIdx}ë²ˆ` : 'ì´ë¯¸ì§€ ë¶€ì¡±'}
          </span>
        </div>
      `;
    }
    previewHTML += '</div>';
    
    distributionList.innerHTML = previewHTML;
  } else {
    distributionPreview.classList.add('hidden');
  }
  
  // ê°œë³„ ì½˜í…ì¸  ì…ë ¥ í•„ë“œê°€ ì—´ë ¤ìˆìœ¼ë©´ ì¬ìƒì„±
  const batchInputsContainer = document.getElementById('batchContentInputs');
  if (batchInputsContainer && !batchInputsContainer.classList.contains('hidden')) {
    generateBatchContentInputs();
  }
}

// ===================================
// ê°œë³„ ì½˜í…ì¸  ì •ë³´ ì…ë ¥
// ===================================
function toggleBatchContentInputs() {
  const container = document.getElementById('batchContentInputs');
  const toggleText = document.getElementById('batchInputToggleText');
  const toggleIcon = document.getElementById('batchInputToggleIcon');
  
  if (container.classList.contains('hidden')) {
    container.classList.remove('hidden');
    toggleText.textContent = 'ê°œë³„ ì½˜í…ì¸  ì •ë³´ ì…ë ¥ ì ‘ê¸°';
    toggleIcon.classList.remove('fa-chevron-down');
    toggleIcon.classList.add('fa-chevron-up');
    generateBatchContentInputs();
  } else {
    container.classList.add('hidden');
    toggleText.textContent = 'ê°œë³„ ì½˜í…ì¸  ì •ë³´ ì…ë ¥í•˜ê¸° (ì„ íƒì‚¬í•­)';
    toggleIcon.classList.remove('fa-chevron-up');
    toggleIcon.classList.add('fa-chevron-down');
  }
}

// ===================================
// ê°œë³„ ì½˜í…ì¸  ë¸”ë¡ ìƒì„± (NEW)
// ===================================
function generateContentBlocks() {
  const contentCountSelect = document.getElementById('contentCount');
  const container = document.getElementById('contentBlocksContainer');
  
  if (!contentCountSelect || !container) return;
  
  const contentCount = parseInt(contentCountSelect.value) || 1;
  
  // ê¸°ì¡´ ë°ì´í„° ë³´ì¡´ (ì´ë¯¸ ì…ë ¥í•œ ë‚´ìš© ìœ ì§€)
  const existingData = { ...contentBlocks };
  contentBlocks = {};
  
  let html = '';
  
  for (let i = 0; i < contentCount; i++) {
    // ê¸°ì¡´ ë°ì´í„° ë³µì›
    if (existingData[i]) {
      contentBlocks[i] = existingData[i];
    } else {
      contentBlocks[i] = { images: [], keywords: '', topic: '', description: '' };
    }
    
    const existingImages = contentBlocks[i].images || [];
    
    html += `
      <div class="bg-gradient-to-r from-indigo-50 to-purple-50 border-2 border-indigo-200 rounded-xl p-6">
        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
          <span class="bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-full w-10 h-10 flex items-center justify-center mr-3">
            ${i + 1}
          </span>
          ì½˜í…ì¸  #${i + 1}
        </h3>
        
        <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
        <div class="mb-4">
          <label class="block mb-2 font-semibold text-gray-700">
            <i class="fas fa-image mr-2"></i>ì´ë¯¸ì§€ ì—…ë¡œë“œ (ìµœëŒ€ 10ì¥, 1ì¥ë‹¹ 10MB)
          </label>
          <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-purple-400 transition cursor-pointer bg-white" 
               onclick="document.getElementById('imageInput_${i}').click()">
            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
            <input
              type="file"
              accept="image/*"
              multiple
              id="imageInput_${i}"
              class="hidden"
              onchange="handleContentImageUpload(${i})"
            />
            <p class="text-gray-600 text-sm">
              <span class="text-purple-600 font-semibold">í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ ì„ íƒ</span>
              <span class="text-gray-500"> (${existingImages.length}/10ì¥)</span>
            </p>
          </div>
          <div id="imagePreview_${i}" class="mt-3 grid grid-cols-5 gap-2"></div>
        </div>
        
        <!-- í‚¤ì›Œë“œ + AI ì¶”ì²œ -->
        <div class="mb-4">
          <label class="block mb-2 font-semibold text-gray-700 flex justify-between items-center">
            <span><i class="fas fa-key mr-2"></i>í•µì‹¬ í‚¤ì›Œë“œ <span class="text-red-500">*</span></span>
            <button
              type="button"
              onclick="suggestKeywordsForContent(${i}, event)"
              class="px-3 py-1.5 bg-gradient-to-r from-purple-500 to-pink-500 text-white text-sm rounded-lg hover:from-purple-600 hover:to-pink-600 transition flex items-center gap-1"
              title="ì´ ì½˜í…ì¸ ì˜ ì´ë¯¸ì§€ë¡œ AI í‚¤ì›Œë“œ ì¶”ì²œ"
            >
              <i class="fas fa-magic"></i>
              AI ì¶”ì²œ
            </button>
          </label>
          <input
            type="text"
            id="keyword_${i}"
            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
            placeholder="ì˜ˆ: ìˆ˜ë¶„í¬ë¦¼, ë³´ìŠµ, ê²¨ìš¸ì¼€ì–´"
            value="${contentBlocks[i].keywords || ''}"
            onchange="updateContentData(${i}, 'keywords', this.value)"
          />
        </div>
        
        <!-- ì£¼ì œ -->
        <div class="mb-4">
          <label class="block mb-2 font-semibold text-gray-700">
            <i class="fas fa-lightbulb mr-2"></i>ì£¼ì œ/ë‚´ìš© (1ì¤„ ì„¤ëª…)
          </label>
          <input
            type="text"
            id="topic_${i}"
            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
            placeholder="ì˜ˆ: ê²¨ìš¸ì²  ê±´ì¡°í•œ í”¼ë¶€ë¥¼ ìœ„í•œ ìˆ˜ë¶„í¬ë¦¼"
            value="${contentBlocks[i].topic || ''}"
            onchange="updateContentData(${i}, 'topic', this.value)"
          />
        </div>
        
        <!-- ì¶”ê°€ ì„¤ëª… -->
        <div class="mb-4">
          <label class="block mb-2 font-semibold text-gray-700">
            <i class="fas fa-comment-dots mr-2"></i>ì¶”ê°€ ì„¤ëª… (ì„ íƒ)
          </label>
          <textarea
            id="description_${i}"
            rows="2"
            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 resize-none"
            placeholder="ì˜ˆ: ê±´ì¡°í•œ ê²¨ìš¸ ë‚ ì”¨ì— í”¼ë¶€ë¥¼ ì´‰ì´‰í•˜ê²Œ ìœ ì§€í•˜ëŠ” ë°©ë²•ì„ ì†Œê°œí•©ë‹ˆë‹¤"
            onchange="updateContentData(${i}, 'description', this.value)"
          >${contentBlocks[i].description || ''}</textarea>
        </div>
        
        <!-- í”Œë«í¼ ì„ íƒ (Option B) -->
        <div class="mb-4">
          <label class="block mb-2 font-semibold text-gray-700">
            <i class="fas fa-share-alt mr-2"></i>ë°œí–‰í•  í”Œë«í¼ ì½˜í…ì¸  ì„ íƒ <span class="text-red-500">*</span>
          </label>
          <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2" id="platformSelect_${i}">
            <!-- ë¸”ë¡œê·¸ & SNS í¬ìŠ¤íŠ¸ -->
            <label class="flex items-center gap-2 p-3 border-2 border-gray-300 rounded-lg cursor-pointer hover:bg-purple-50 hover:border-purple-400 transition">
              <input type="checkbox" class="content-platform-checkbox" data-content="${i}" value="blog" onchange="updateContentPlatforms(${i})">
              <i class="fas fa-blog text-blue-600"></i>
              <span class="text-sm font-medium">ë„¤ì´ë²„ ë¸”ë¡œê·¸</span>
            </label>
            <label class="flex items-center gap-2 p-3 border-2 border-gray-300 rounded-lg cursor-pointer hover:bg-purple-50 hover:border-purple-400 transition">
              <input type="checkbox" class="content-platform-checkbox" data-content="${i}" value="instagram_feed" onchange="updateContentPlatforms(${i})">
              <i class="fab fa-instagram text-pink-600"></i>
              <span class="text-sm font-medium">ì¸ìŠ¤íƒ€ê·¸ë¨ í”¼ë“œ</span>
            </label>
            <label class="flex items-center gap-2 p-3 border-2 border-gray-300 rounded-lg cursor-pointer hover:bg-purple-50 hover:border-purple-400 transition">
              <input type="checkbox" class="content-platform-checkbox" data-content="${i}" value="threads" onchange="updateContentPlatforms(${i})">
              <i class="fas fa-at text-gray-800"></i>
              <span class="text-sm font-medium">ìŠ¤ë ˆë“œ</span>
            </label>
            <label class="flex items-center gap-2 p-3 border-2 border-gray-300 rounded-lg cursor-pointer hover:bg-purple-50 hover:border-purple-400 transition">
              <input type="checkbox" class="content-platform-checkbox" data-content="${i}" value="twitter" onchange="updateContentPlatforms(${i})">
              <i class="fab fa-twitter text-blue-400"></i>
              <span class="text-sm font-medium">íŠ¸ìœ„í„°(X)</span>
            </label>
            <label class="flex items-center gap-2 p-3 border-2 border-gray-300 rounded-lg cursor-pointer hover:bg-purple-50 hover:border-purple-400 transition">
              <input type="checkbox" class="content-platform-checkbox" data-content="${i}" value="linkedin" onchange="updateContentPlatforms(${i})">
              <i class="fab fa-linkedin text-blue-700"></i>
              <span class="text-sm font-medium">LinkedIn</span>
            </label>
            <label class="flex items-center gap-2 p-3 border-2 border-gray-300 rounded-lg cursor-pointer hover:bg-purple-50 hover:border-purple-400 transition">
              <input type="checkbox" class="content-platform-checkbox" data-content="${i}" value="kakaotalk" onchange="updateContentPlatforms(${i})">
              <i class="fas fa-comment-dots text-yellow-500"></i>
              <span class="text-sm font-medium">ì¹´ì¹´ì˜¤í†¡</span>
            </label>
            <label class="flex items-center gap-2 p-3 border-2 border-gray-300 rounded-lg cursor-pointer hover:bg-purple-50 hover:border-purple-400 transition">
              <input type="checkbox" class="content-platform-checkbox" data-content="${i}" value="brunch" onchange="updateContentPlatforms(${i})">
              <i class="fas fa-book-open text-orange-600"></i>
              <span class="text-sm font-medium">ë¸ŒëŸ°ì¹˜</span>
            </label>
            
            <!-- ìˆí¼ ì˜ìƒ -->
            <label class="flex items-center gap-2 p-3 border-2 border-gray-300 rounded-lg cursor-pointer hover:bg-purple-50 hover:border-purple-400 transition">
              <input type="checkbox" class="content-platform-checkbox" data-content="${i}" value="tiktok" onchange="updateContentPlatforms(${i})">
              <i class="fab fa-tiktok text-black"></i>
              <span class="text-sm font-medium">í‹±í†¡</span>
            </label>
            <label class="flex items-center gap-2 p-3 border-2 border-gray-300 rounded-lg cursor-pointer hover:bg-purple-50 hover:border-purple-400 transition">
              <input type="checkbox" class="content-platform-checkbox" data-content="${i}" value="instagram_reels" onchange="updateContentPlatforms(${i})">
              <i class="fab fa-instagram text-purple-600"></i>
              <span class="text-sm font-medium">ì¸ìŠ¤íƒ€ ë¦´ìŠ¤</span>
            </label>
            <label class="flex items-center gap-2 p-3 border-2 border-gray-300 rounded-lg cursor-pointer hover:bg-purple-50 hover:border-purple-400 transition">
              <input type="checkbox" class="content-platform-checkbox" data-content="${i}" value="youtube_shorts" onchange="updateContentPlatforms(${i})">
              <i class="fab fa-youtube text-red-500"></i>
              <span class="text-sm font-medium">ìœ íŠœë¸Œ ì‡¼ì¸ </span>
            </label>
            
            <!-- ë¡±í¼ ì˜ìƒ -->
            <label class="flex items-center gap-2 p-3 border-2 border-gray-300 rounded-lg cursor-pointer hover:bg-purple-50 hover:border-purple-400 transition">
              <input type="checkbox" class="content-platform-checkbox" data-content="${i}" value="youtube_longform" onchange="updateContentPlatforms(${i})">
              <i class="fab fa-youtube text-red-600"></i>
              <span class="text-sm font-medium">ìœ íŠœë¸Œ ë¡±í¼</span>
            </label>
            <label class="flex items-center gap-2 p-3 border-2 border-gray-300 rounded-lg cursor-pointer hover:bg-purple-50 hover:border-purple-400 transition">
              <input type="checkbox" class="content-platform-checkbox" data-content="${i}" value="metadata_generation" onchange="updateContentPlatforms(${i})">
              <i class="fas fa-tags text-blue-600"></i>
              <span class="text-sm font-medium">ë©”íƒ€ë°ì´í„° ìƒì„±</span>
            </label>
          </div>
        </div>
        
        <!-- ê°œë³„ ìƒì„± ë²„íŠ¼ (Option B) -->
        <div id="contentBlock_${i}" class="flex flex-col gap-3 p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg border-2 border-purple-200">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-600">ğŸ’° ì˜ˆìƒ í¬ë ˆë”§ ì°¨ê°</p>
              <div id="contentCredit_${i}" class="flex items-baseline gap-2">
                <span class="text-2xl font-bold text-purple-600">0 í¬ë ˆë”§</span>
              </div>
            </div>
            <button
              type="button"
              onclick="generateSingleContent(${i})"
              class="px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold rounded-lg hover:from-purple-700 hover:to-pink-700 transition shadow-lg whitespace-nowrap"
              id="generateBtn_${i}"
            >
              <i class="fas fa-magic mr-2"></i>
              ì½˜í…ì¸  #${i + 1} ìƒì„±í•˜ê¸°
            </button>
          </div>
          <p class="text-xs text-gray-500">
            ğŸ’¡ í”Œë«í¼ 1ê°œë‹¹ 1í¬ë ˆë”§ (ì„ íƒí•œ í”Œë«í¼ ê°œìˆ˜ë§Œí¼ ì°¨ê°)
          </p>
        </div>
        
        <!-- ê°œë³„ ê²°ê³¼ ì˜ì—­ (Option B) -->
        <div id="contentResult_${i}" class="hidden mt-4"></div>
      </div>
    `;
  }
  
  container.innerHTML = html;
  
  // ê¸°ì¡´ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ë³µì›
  for (let i = 0; i < contentCount; i++) {
    if (contentBlocks[i].images && contentBlocks[i].images.length > 0) {
      renderImagePreview(i);
    }
  }
  
  // ë¹„ìš© ê³„ì‚° ì—…ë°ì´íŠ¸
  updateCostEstimate();
}

// ì½˜í…ì¸  ë°ì´í„° ì—…ë°ì´íŠ¸
function updateContentData(index, field, value) {
  if (!contentBlocks[index]) {
    contentBlocks[index] = { images: [], keywords: '', topic: '', description: '' };
  }
  contentBlocks[index][field] = value;
}

// ê°œë³„ ì½˜í…ì¸  ì´ë¯¸ì§€ ì—…ë¡œë“œ ì²˜ë¦¬
function handleContentImageUpload(index) {
  const input = document.getElementById(`imageInput_${index}`);
  const files = Array.from(input.files);
  
  if (!contentBlocks[index]) {
    contentBlocks[index] = { images: [], keywords: '', topic: '', description: '' };
  }
  
  const currentImages = contentBlocks[index].images || [];
  const availableSlots = 10 - currentImages.length;
  
  if (files.length > availableSlots) {
    showToast(`âš ï¸ ìµœëŒ€ 10ì¥ê¹Œì§€ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (í˜„ì¬: ${currentImages.length}ì¥)`, 'warning');
    return;
  }
  
  // íŒŒì¼ì„ base64ë¡œ ë³€í™˜
  let processedCount = 0;
  files.forEach((file, idx) => {
    if (file.size > 10 * 1024 * 1024) {
      showToast(`âŒ ${file.name}ì€(ëŠ”) 10MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤`, 'error');
      return;
    }
    
    const reader = new FileReader();
    reader.onload = (e) => {
      contentBlocks[index].images.push({
        base64: e.target.result,
        name: file.name,
        size: file.size
      });
      
      processedCount++;
      if (processedCount === files.length) {
        renderImagePreview(index);
        updateCostEstimate();
        showToast(`âœ… ${files.length}ì¥ ì—…ë¡œë“œ ì™„ë£Œ`, 'success');
      }
    };
    reader.readAsDataURL(file);
  });
}

// ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ë Œë”ë§
function renderImagePreview(index) {
  const container = document.getElementById(`imagePreview_${index}`);
  if (!container || !contentBlocks[index]) return;
  
  const images = contentBlocks[index].images || [];
  
  container.innerHTML = images.map((img, imgIdx) => `
    <div class="relative group">
      <img src="${img.base64}" class="w-full h-20 object-cover rounded-lg border-2 border-gray-200" />
      <button
        type="button"
        onclick="removeContentImage(${index}, ${imgIdx})"
        class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition"
      >
        Ã—
      </button>
    </div>
  `).join('');
  
  // ì—…ë¡œë“œ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
  const uploadArea = document.getElementById(`imageInput_${index}`)?.parentElement;
  if (uploadArea) {
    const countSpan = uploadArea.querySelector('.text-gray-500');
    if (countSpan) {
      countSpan.innerHTML = ` (${images.length}/10ì¥)`;
    }
  }
}

// ì´ë¯¸ì§€ ì‚­ì œ
function removeContentImage(contentIndex, imageIndex) {
  if (!contentBlocks[contentIndex]) return;
  
  contentBlocks[contentIndex].images.splice(imageIndex, 1);
  renderImagePreview(contentIndex);
  updateCostEstimate();
  showToast('ğŸ—‘ï¸ ì´ë¯¸ì§€ ì‚­ì œ ì™„ë£Œ', 'success');
}

// ğŸ”’ AI ì¶”ì²œ íšŸìˆ˜ ì œí•œ (ê³„ì •ë³„ + ì½˜í…ì¸ ë³„ ë…ë¦½)
function getAIRecommendKey(contentIndex) {
  const userId = window.currentUser?.id || 'guest';
  const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
  return `ai_recommend_${userId}_content_${contentIndex}_${today}`;
}

function checkAIRecommendLimit(contentIndex) {
  const key = getAIRecommendKey(contentIndex);
  const count = parseInt(localStorage.getItem(key) || '0');
  return count < 3;
}

function incrementAIRecommendCount(contentIndex) {
  const key = getAIRecommendKey(contentIndex);
  const currentCount = parseInt(localStorage.getItem(key) || '0');
  const newCount = currentCount + 1;
  localStorage.setItem(key, newCount.toString());
  
  if (newCount >= 3) {
    console.log(`âš ï¸ AI ì¶”ì²œ ì¼ì¼ í•œë„ ë„ë‹¬ (ì½˜í…ì¸  #${contentIndex + 1}: ${newCount}/3)`);
    // í•´ë‹¹ ì½˜í…ì¸ ì˜ AI ì¶”ì²œ ë²„íŠ¼ë§Œ ë¹„í™œì„±í™”
    const btn = document.querySelector(`[onclick*="suggestKeywordsForContent(${contentIndex}"]`);
    if (btn) {
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-ban"></i> ì˜¤ëŠ˜ í•œë„ ì´ˆê³¼';
      btn.classList.add('opacity-50', 'cursor-not-allowed');
    }
  }
  
  return newCount;
}

// ê°œë³„ ì½˜í…ì¸  AI í‚¤ì›Œë“œ ì¶”ì²œ
async function suggestKeywordsForContent(index, event) {
  event.preventDefault();
  event.stopPropagation();
  
  // ğŸ”’ ì½˜í…ì¸ ë³„ ì¼ì¼ 3íšŒ ì œí•œ ì²´í¬
  if (!checkAIRecommendLimit(index)) {
    showToast(`âŒ ì½˜í…ì¸  #${index + 1}ì˜ AI ì¶”ì²œì€ í•˜ë£¨ 3íšŒê¹Œì§€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤`, 'error');
    return;
  }
  
  if (!contentBlocks[index] || !contentBlocks[index].images || contentBlocks[index].images.length === 0) {
    showToast('âŒ ë¨¼ì € ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”', 'error');
    return;
  }
  
  const brand = document.getElementById('brand')?.value.trim() || '';
  const industry = document.getElementById('industry')?.value || '';
  
  const btn = event.target.closest('button');
  const originalHTML = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ë¶„ì„ ì¤‘...';
  
  try {
    const response = await fetch('/api/suggest-keywords', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        images: contentBlocks[index].images.slice(0, 3).map(img => ({
          base64: img.base64,
          filename: img.name || `ì´ë¯¸ì§€${contentBlocks[index].images.indexOf(img) + 1}`,
          size: img.size || 0
        })),
        brand: brand,
        industry: industry
      })
    });
    
    const result = await response.json();
    
    if (result.success && result.keywords) {
      const keywordsStr = result.keywords.join(', ');
      document.getElementById(`keyword_${index}`).value = keywordsStr;
      updateContentData(index, 'keywords', keywordsStr);
      
      // ğŸ”’ ì„±ê³µ ì‹œì—ë§Œ ì¹´ìš´íŠ¸ ì¦ê°€ (ì½˜í…ì¸ ë³„)
      const currentCount = incrementAIRecommendCount(index);
      
      // âœ¨ í¬ë ˆë”§ ì‹¤ì‹œê°„ ê°±ì‹ 
      if (result.credits) {
        updateCreditsUI(result.credits);
        // í—¤ë” í¬ë ˆë”§ë„ ì—…ë°ì´íŠ¸
        if (window.updateHeaderCredits) {
          window.updateHeaderCredits(result.credits);
        }
      }
      
      showToast(`âœ¨ í‚¤ì›Œë“œ ì¶”ì²œ ì™„ë£Œ! (ì½˜í…ì¸  #${index + 1}: ${currentCount}/3)`, 'success');
    } else {
      showToast('âŒ ' + (result.error || 'í‚¤ì›Œë“œ ì¶”ì²œ ì‹¤íŒ¨'), 'error');
    }
  } catch (error) {
    console.error('í‚¤ì›Œë“œ ì¶”ì²œ ì˜¤ë¥˜:', error);
    showToast('âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalHTML;
  }
}

function generateBatchContentInputs() {
  // ë” ì´ìƒ ì‚¬ìš© ì•ˆ í•¨ (generateContentBlocksë¡œ ëŒ€ì²´)
  const contentCountSelect = document.getElementById('contentCount');
  const container = document.getElementById('batchContentInputs');
  
  if (!contentCountSelect || !container) return;
  
  const contentCount = parseInt(contentCountSelect.value) || 1;
  
  let html = `
    <div class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg p-4 border-2 border-indigo-200 mb-3">
      <p class="text-sm text-indigo-800">
        <i class="fas fa-info-circle mr-2"></i>
        <strong>ê°œë³„ ì •ë³´ ì…ë ¥:</strong> ê° ì½˜í…ì¸ ë§ˆë‹¤ ë‹¤ë¥¸ í‚¤ì›Œë“œ, ì£¼ì œ, ì„¤ëª…ì„ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. 
        ë¹„ì›Œë‘ë©´ ê¸°ë³¸ ì •ë³´ê°€ ì‚¬ìš©ë©ë‹ˆë‹¤.
      </p>
    </div>
  `;
  
  for (let i = 0; i < contentCount; i++) {
    html += `
      <div class="bg-white border-2 border-gray-200 rounded-lg p-4 hover:border-purple-300 transition">
        <h4 class="font-bold text-gray-800 mb-3 flex items-center">
          <span class="bg-purple-500 text-white rounded-full w-7 h-7 flex items-center justify-center text-sm mr-2">
            ${i + 1}
          </span>
          ì½˜í…ì¸  #${i + 1}
        </h4>
        <div class="grid grid-cols-1 gap-3">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">
              <i class="fas fa-key mr-1 text-purple-500"></i>í‚¤ì›Œë“œ
            </label>
            <input
              type="text"
              id="batchKeyword_${i}"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm"
              placeholder="ì˜ˆ: ìˆ˜ë¶„í¬ë¦¼, ë³´ìŠµ"
            />
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">
              <i class="fas fa-lightbulb mr-1 text-yellow-500"></i>ì£¼ì œ/ë‚´ìš© (1ì¤„ ì„¤ëª…)
            </label>
            <input
              type="text"
              id="batchTopic_${i}"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm"
              placeholder="ì˜ˆ: ê²¨ìš¸ì²  í”¼ë¶€ ìˆ˜ë¶„ ê´€ë¦¬ë²•"
            />
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">
              <i class="fas fa-comment-dots mr-1 text-blue-500"></i>ì¶”ê°€ ì„¤ëª… (ì„ íƒ)
            </label>
            <textarea
              id="batchDescription_${i}"
              rows="2"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm resize-none"
              placeholder="ì˜ˆ: ê±´ì¡°í•œ ê²¨ìš¸ì²  í”¼ë¶€ì— í•„ìˆ˜ì ì¸ ìˆ˜ë¶„ ê³µê¸‰ ë°©ë²•ì„ ì†Œê°œí•©ë‹ˆë‹¤"
            ></textarea>
          </div>
        </div>
      </div>
    `;
  }
  
  container.innerHTML = html;
}

// ===================================
// í‚¤ì›Œë“œ ìë™ ì¶”ì²œ
// ===================================
async function suggestKeywords(event) {
  if (selectedImages.length === 0) {
    showToast('âŒ ë¨¼ì € ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”', 'error');
    return;
  }
  
  const brand = document.getElementById('brand').value.trim();
  const industry = document.getElementById('industry').value;
  
  if (!brand) {
    showToast('âš ï¸ ë¸Œëœë“œëª…ì„ ë¨¼ì € ì…ë ¥í•˜ë©´ ë” ì •í™•í•œ í‚¤ì›Œë“œë¥¼ ì¶”ì²œë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤', 'warning');
  }
  
  // ë¡œë”© í‘œì‹œ
  const btn = event ? event.target.closest('button') : document.querySelector('button[onclick*="suggestKeywords"]');
  const originalHTML = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ë¶„ì„ ì¤‘...';
  
  try {
    const response = await fetch('/api/suggest-keywords', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        images: selectedImages.slice(0, 3).map(img => ({
          base64: img.base64,
          filename: img.name || `ì´ë¯¸ì§€${selectedImages.indexOf(img) + 1}`,
          size: img.size || 0
        })), // ìµœëŒ€ 3ì¥
        brand: brand || '',
        industry: industry
      })
    });
    
    const result = await response.json();
    
    if (result.success && result.keywords) {
      displayKeywordSuggestions(result.keywords);
      showToast('âœ¨ í‚¤ì›Œë“œ ì¶”ì²œ ì™„ë£Œ!', 'success');
    } else {
      showToast('âŒ ' + (result.error || 'í‚¤ì›Œë“œ ì¶”ì²œ ì‹¤íŒ¨'), 'error');
    }
  } catch (error) {
    console.error('í‚¤ì›Œë“œ ì¶”ì²œ ì˜¤ë¥˜:', error);
    showToast('âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalHTML;
  }
}

function displayKeywordSuggestions(keywords) {
  const container = document.getElementById('keywordSuggestions');
  const list = document.getElementById('suggestedKeywordsList');
  
  list.innerHTML = keywords.map(keyword => `
    <button
      type="button"
      onclick="addKeyword('${keyword.replace(/'/g, "\\'")}')"
      class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full hover:bg-purple-200 transition text-sm"
    >
      + ${keyword}
    </button>
  `).join('');
  
  container.classList.remove('hidden');
}

function addKeyword(keyword) {
  const input = document.getElementById('keywords');
  const currentKeywords = input.value.trim();
  
  // ì´ë¯¸ ìˆëŠ” í‚¤ì›Œë“œì¸ì§€ í™•ì¸
  const keywordList = currentKeywords.split(',').map(k => k.trim()).filter(k => k);
  if (keywordList.includes(keyword)) {
    showToast('âš ï¸ ì´ë¯¸ ì¶”ê°€ëœ í‚¤ì›Œë“œì…ë‹ˆë‹¤', 'warning');
    return;
  }
  
  // í‚¤ì›Œë“œ ì¶”ê°€
  if (currentKeywords) {
    input.value = currentKeywords + ', ' + keyword;
  } else {
    input.value = keyword;
  }
  
  showToast(`âœ… "${keyword}" ì¶”ê°€ë¨`, 'success');
}

// ===================================
// ì½˜í…ì¸  ìƒì„±
// ===================================
async function handleGenerate() {
  // ğŸ”’ ë¡œê·¸ì¸ ì²´í¬ (ìµœìš°ì„ )
  if (!window.currentUser || window.currentUser.isGuest || !window.currentUser.id) {
    const goToLogin = confirm(
      'ğŸ” ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤\n\n' +
      'â€¢ ê°€ì…ë§Œ í•´ë„ ì›” 30í¬ë ˆë”§ ë¬´ë£Œ ì§€ê¸‰\n' +
      'â€¢ 5ê°œ í”Œë«í¼ ë§ì¶¤ ì½˜í…ì¸  ìë™ ìƒì„±\n' +
      'â€¢ 30ì´ˆ ì•ˆì— ì™„ì„±ë˜ëŠ” AI ì½˜í…ì¸ \n\n' +
      'ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?'
    );
    
    if (goToLogin) {
      window.location.href = '/';
    }
    return;
  }
  
  // ê¸°ë³¸ ì •ë³´ ìˆ˜ì§‘
  const brand = document.getElementById('brand').value.trim();
  
  if (!brand) {
    showToast('âŒ ë¸Œëœë“œëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤', 'error');
    return;
  }

  // í”Œë«í¼ ì„ íƒ í™•ì¸
  const platformCheckboxes = document.querySelectorAll('input[name="platform"]:checked');
  if (platformCheckboxes.length === 0) {
    showToast('âŒ ìµœì†Œ 1ê°œ í”Œë«í¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”', 'error');
    return;
  }
  const platforms = Array.from(platformCheckboxes).map((cb) => cb.value);
  
  // ğŸš¨ í¬ë¦¬í‹°ì»¬: ì„œë²„ ìš”ì²­ ì „ í¬ë ˆë”§ ì‚¬ì „ ê²€ì¦ (API ë¹„ìš© ë‚­ë¹„ ë°©ì§€)
  const platformCount = platforms.length;
  const creditPerContent = platformCount;
  
  // âœ… ì½˜í…ì¸  ê°œìˆ˜ í™•ì¸
  const contentCount = Object.keys(contentBlocks).length;
  const creditsNeeded = creditPerContent * contentCount;
  
  console.log(`ğŸ’° [í¬ë ˆë”§ ê³„ì‚°] í”Œë«í¼: ${platformCount}ê°œ, ì½˜í…ì¸ : ${contentCount}ê°œ, í¬ë ˆë”§/ì½˜í…ì¸ : ${creditPerContent}, ì´ í•„ìš”: ${creditsNeeded}`);
  
  // í˜„ì¬ ë³´ìœ  í¬ë ˆë”§ í™•ì¸ (ë¡œê·¸ì¸ ì‚¬ìš©ìë§Œ)
  if (!currentUser.isGuest && currentUser.id) {
    // âœ… window.userCreditsInfo ìš°ì„  ì°¸ì¡° (ìµœì‹  DB ê°’)
    const freeCredits = window.userCreditsInfo?.free_credits ?? currentUser.free_credits ?? 0;
    const paidCredits = window.userCreditsInfo?.paid_credits ?? currentUser.paid_credits ?? 0;
    const totalCredits = freeCredits + paidCredits;
    
    console.log('ğŸ’° [ì½˜í…ì¸  ìƒì„±] í¬ë ˆë”§ ì²´í¬:', {
      userCreditsInfo: window.userCreditsInfo,
      currentUser_credits: {
        free: currentUser.free_credits,
        paid: currentUser.paid_credits
      },
      final: { freeCredits, paidCredits, totalCredits }
    });
    
    // ğŸš¨ í¬ë ˆë”§ ë¶€ì¡± ì‹œ ì¦‰ì‹œ ì°¨ë‹¨ (ì„œë²„ ìš”ì²­ ì—†ìŒ = API ë¹„ìš© 0ì›)
    if (totalCredits < creditsNeeded) {
      console.error(`âŒ [í”„ë¡ íŠ¸ì—”ë“œ ì°¨ë‹¨] í¬ë ˆë”§ ë¶€ì¡±: í•„ìš” ${creditsNeeded}, ë³´ìœ  ${totalCredits}`);
      
      const goToPayment = confirm(
        `â›” í¬ë ˆë”§ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!\n\n` +
        `â€¢ í•„ìš”: ${creditsNeeded}í¬ë ˆë”§\n` +
        `â€¢ ë³´ìœ : ${totalCredits}í¬ë ˆë”§ (ë¬´ë£Œ ${freeCredits} + ìœ ë£Œ ${paidCredits})\n\n` +
        `ğŸ’³ ì¶©ì „ ì˜µì…˜:\n` +
        `â€¢ STARTER (10í¬ë ˆë”§): â‚©5,000 (â‚©500/í¬ë ˆë”§)\n` +
        `â€¢ PRO (50í¬ë ˆë”§): â‚©23,750 (â‚©475/í¬ë ˆë”§, 5% í• ì¸) ğŸ”¥\n` +
        `â€¢ BUSINESS (100í¬ë ˆë”§): â‚©45,000 (â‚©450/í¬ë ˆë”§, 10% í• ì¸)\n\n` +
        `ì¶©ì „ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`
      );
      
      if (goToPayment) {
        window.location.href = '/static/payment.html';
      }
      return; // âœ… í•¨ìˆ˜ ì¢…ë£Œ - ì„œë²„ ìš”ì²­ ì—†ìŒ!
    }
    
    console.log(`âœ… [í”„ë¡ íŠ¸ì—”ë“œ ê²€ì¦ í†µê³¼] í•„ìš”: ${creditsNeeded}, ë³´ìœ : ${totalCredits}`);
  }
  
  // ì½˜í…ì¸  ë¸”ë¡ ê²€ì¦ (contentCountëŠ” ì´ë¯¸ 2360ë²ˆ ì¤„ì—ì„œ ì„ ì–¸ë¨)
  if (contentCount === 0) {
    showToast('âŒ ìƒì„±í•  ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
    return;
  }
  
  // ê° ì½˜í…ì¸  ë¸”ë¡ ê²€ì¦
  for (let i = 0; i < contentCount; i++) {
    if (!contentBlocks[i]) {
      showToast(`âŒ ì½˜í…ì¸  #${i + 1} ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤`, 'error');
      return;
    }
    
    if (!contentBlocks[i].images || contentBlocks[i].images.length === 0) {
      showToast(`âŒ ì½˜í…ì¸  #${i + 1}ì— ìµœì†Œ 1ì¥ì˜ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”`, 'error');
      return;
    }
    
    if (!contentBlocks[i].keywords || contentBlocks[i].keywords.trim() === '') {
      showToast(`âŒ ì½˜í…ì¸  #${i + 1}ì˜ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”`, 'error');
      return;
    }
  }
  
  // ë°°ì¹˜ ìƒì„± ì‹¤í–‰
  if (contentCount > 1) {
    await handleNewBatchGenerate(contentCount, platforms);
    return;
  }
  
  // ë‹¨ì¼ ìƒì„±

  // ë‹¨ì¼ ì½˜í…ì¸  ìƒì„± (contentBlocks[0] ì‚¬ìš©)
  const content = contentBlocks[0];
  
  let website = document.getElementById('website')?.value.trim() || '';
  if (website && !website.startsWith('http://') && !website.startsWith('https://')) {
    website = 'https://' + website;
  }
  
  // í‚¤ì›Œë“œì— ì£¼ì œì™€ ì„¤ëª… ì¶”ê°€
  let enhancedKeywords = content.keywords;
  if (content.topic) {
    enhancedKeywords += ` (ì£¼ì œ: ${content.topic})`;
  }
  if (content.description) {
    enhancedKeywords += ` (${content.description})`;
  }

  const formData = {
    user_id: currentUser?.id || null, // âœ… ì¶”ê°€: ì‚¬ìš©ì ID
    is_guest: currentUser?.isGuest || false, // âœ… ì¶”ê°€: ë¹„íšŒì› ì—¬ë¶€
    brand,
    companyName: document.getElementById('companyName')?.value.trim() || '',
    businessType: document.getElementById('businessType')?.value.trim() || '',
    location: document.getElementById('location')?.value.trim() || '',
    targetGender: document.getElementById('targetGender')?.value || '',
    contact: document.getElementById('contact')?.value.trim() || '',
    website: website,
    sns: document.getElementById('sns')?.value.trim() || '',
    keywords: enhancedKeywords,
    tone: document.getElementById('tone')?.value || 'ì¹œê·¼í•œ',
    targetAge: document.getElementById('targetAge')?.value || '20ëŒ€',
    industry: document.getElementById('industry')?.value || 'ë¼ì´í”„ìŠ¤íƒ€ì¼',
    contentStrategy: document.querySelector('input[name="contentStrategy"]:checked')?.value || 'auto', // ğŸ”¥ NEW v6.1
    images: content.images.map((img) => ({
      base64: img.base64,
      filename: img.name || `ì´ë¯¸ì§€${content.images.indexOf(img) + 1}`,
      size: img.size || 0
    })),
    platforms,
    aiModel: 'gpt-4o',
    customPrompt: getSelectedTemplateContent(), // âœ… ì¶”ê°€: ì‚¬ìš©ì í…œí”Œë¦¿
  };

  // ì¬ì‹œë„ìš© ì €ì¥
  lastFormData = formData;

  // ë¡œë”© í‘œì‹œ
  showLoadingOverlay();

  try {
    const response = await fetch('/api/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(formData),
    });

    // HTML ì—ëŸ¬ í˜ì´ì§€ ì²´í¬
    const contentType = response.headers.get('content-type');
    if (!contentType || !contentType.includes('application/json')) {
      hideLoadingOverlay();
      const errorText = await response.text();
      console.error('ì„œë²„ ì—ëŸ¬:', response.status, errorText.substring(0, 200));
      showErrorModal(`ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (${response.status})\n\nì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`);
      return;
    }

    const result = await response.json();
    
    // ğŸ” ë””ë²„ê¹…: ë°±ì—”ë“œ ì‘ë‹µ ì „ì²´ ë¡œê·¸
    console.log('ğŸ” [CRITICAL] ë°±ì—”ë“œ ì‘ë‹µ ì „ì²´:', JSON.stringify(result, null, 2));
    console.log('ğŸ” [CRITICAL] result.usage:', result.usage);

    // ê²€ì¦ ì‹¤íŒ¨ ì‹œ í™•ì¸ ëª¨ë‹¬ í‘œì‹œ
    if (result.requireConfirmation && result.validation) {
      hideLoadingOverlay();
      showValidationModal(result.validation, formData);
      return;
    }

    // âœ… ì—ëŸ¬ ì‘ë‹µ ì²˜ë¦¬ (403: í¬ë ˆë”§/ì œí•œ, 404: ì‚¬ìš©ì ì—†ìŒ)
    if (!response.ok) {
      hideLoadingOverlay();
      if (response.status === 403) {
        // í¬ë ˆë”§ ë¶€ì¡± ë˜ëŠ” ì›”ê°„ ì œí•œ
        showErrorModal(result.message || result.error);
        if (result.redirect) {
          setTimeout(() => {
            window.location.href = result.redirect;
          }, 2000);
        }
        return;
      } else if (response.status === 404) {
        // ì‚¬ìš©ì ì •ë³´ ì—†ìŒ
        showErrorModal(result.message || 'ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
        setTimeout(() => {
          window.location.href = '/';
        }, 2000);
        return;
      }
    }

    if (result.success) {
      hideLoadingOverlay();
      resultData = result.data;
      
      // âœ… generationId ì €ì¥ (ìº˜ë¦°ë” ë“±ë¡ìš©)
      const generationId = result.id || result.generation_id || `gen_${Date.now()}_${Math.random().toString(36).substring(7)}`;
      window.lastGenerationId = generationId;
      console.log('âœ… ì¼ê´„ ìƒì„± ID ì €ì¥:', generationId);
      
      // âœ… ë‚ ì§œ + ì´ë¯¸ì§€ ì •ë³´ í¬í•¨í•´ì„œ í‘œì‹œ
      displayResults(result.data, result.generatedPlatforms, {
        createdAt: result.created_at || new Date().toISOString(),
        scheduledDate: null,  // ì•„ì§ ë“±ë¡ ì „
        images: result.images || []
      });
      
      // âœ… ë°±ì—”ë“œì—ì„œ ì´ë¯¸ ì €ì¥í–ˆìœ¼ë©´ ì¤‘ë³µ ì €ì¥ ë°©ì§€
      if (result.id) {
        console.log('âœ… ë°±ì—”ë“œì—ì„œ ì €ì¥ ì™„ë£Œ, í”„ë¡ íŠ¸ ì¤‘ë³µ ì €ì¥ ìŠ¤í‚µ');
      } else {
        console.warn('âš ï¸ ë°±ì—”ë“œ ì €ì¥ ì‹¤íŒ¨, í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì €ì¥ ì‹œë„');
        saveToHistory(formData, result.data);
      }
      
      // âœ… í¬ë ˆë”§ ì •ë³´ ì—…ë°ì´íŠ¸ (í‚¤ ë§¤í•‘ + 2ì§€ê°‘ ì‹œìŠ¤í…œ)
      if (result.usage) {
        console.log('ğŸ” ë°±ì—”ë“œ ì‘ë‹µ usage:', result.usage);
        
        const usage = result.usage;
        
        // 1ï¸âƒ£ ë¬´ë£Œ í¬ë ˆë”§ ì—…ë°ì´íŠ¸ (ì—¬ëŸ¬ í‚¤ ì§€ì›)
        if (usage.free_credits !== undefined || usage.free_remaining !== undefined) {
          currentUser.free_credits = usage.free_credits ?? usage.free_remaining ?? 0;
        }
        
        // 2ï¸âƒ£ ìœ ë£Œ í¬ë ˆë”§ ì—…ë°ì´íŠ¸ (ì—¬ëŸ¬ í‚¤ ì§€ì›)
        if (usage.paid_credits !== undefined || usage.paid_remaining !== undefined) {
          currentUser.paid_credits = usage.paid_credits ?? usage.paid_remaining ?? 0;
        }
        
        // 3ï¸âƒ£ ì´ í¬ë ˆë”§ ê³„ì‚°
        if (usage.credits_remaining !== undefined) {
          currentUser.credits = usage.credits_remaining;
        } else {
          currentUser.credits = (currentUser.free_credits || 0) + (currentUser.paid_credits || 0);
        }
        
        // ğŸ”¥ ì¤‘ìš”: window.userCreditsInfo ë™ê¸°í™” (í‚¤ì›Œë“œ AI í™”ë©´ í¬ë ˆë”§ ì‹¤ì‹œê°„ ë°˜ì˜)
        window.userCreditsInfo = {
          free_credits: currentUser.free_credits,
          paid_credits: currentUser.paid_credits,
          total_credits: currentUser.credits
        };
        console.log('âœ… window.userCreditsInfo ë™ê¸°í™”:', window.userCreditsInfo);
        
        // 2ï¸âƒ£ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì—…ë°ì´íŠ¸
        localStorage.setItem('postflow_user', JSON.stringify(currentUser));
        
        // 3ï¸âƒ£ updateAuthUI() í˜¸ì¶œ (ì „ì²´ UI ì—…ë°ì´íŠ¸ - 2ì§€ê°‘ í‘œì‹œ í¬í•¨)
        updateAuthUI();
        
        // 4ï¸âƒ£ í•˜ë‹¨ í¬ë ˆë”§ ë°•ìŠ¤ ì—…ë°ì´íŠ¸ (ì¦‰ì‹œ ë°˜ì˜)
        updateCostEstimate();
        
        // 5ï¸âƒ£ í† ìŠ¤íŠ¸ ë©”ì‹œì§€ (2ì§€ê°‘ ì •ë³´ + í”Œë«í¼ë‹¹ 1í¬ë ˆë”§)
        const freeCredits = currentUser.free_credits || 0;
        const paidCredits = currentUser.paid_credits || 0;
        const totalCredits = freeCredits + paidCredits;
        const creditsUsed = usage.credits_used || 1;
        
        let creditInfo = `ë‚¨ì€ í¬ë ˆë”§: ${totalCredits}`;
        if (freeCredits > 0 && paidCredits > 0) {
          creditInfo = `ë‚¨ì€ í¬ë ˆë”§: ${totalCredits} (ë¬´ë£Œ ${freeCredits} + ìœ ë£Œ ${paidCredits})`;
        } else if (freeCredits > 0) {
          creditInfo = `ë‚¨ì€ í¬ë ˆë”§: ${totalCredits} (ë¬´ë£Œ)`;
        } else if (paidCredits > 0) {
          creditInfo = `ë‚¨ì€ í¬ë ˆë”§: ${totalCredits} (ìœ ë£Œ)`;
        }
        
        console.log('âœ… í¬ë ˆë”§ UI ì—…ë°ì´íŠ¸ ì™„ë£Œ:', {
          free: currentUser.free_credits,
          paid: currentUser.paid_credits,
          total: totalCredits,
          used: creditsUsed,
          display: creditInfo
        });
        
        showToast(`âœ… ì½˜í…ì¸  ìƒì„± ì™„ë£Œ! (${creditsUsed}í¬ë ˆë”§ ì‚¬ìš©, ${creditInfo})`, 'success');
        
        // ì˜¨ë³´ë”© ì‹œìŠ¤í…œ: ì½˜í…ì¸  ìƒì„± ì¹´ìš´íŠ¸ ì¦ê°€
        if (currentUser?.id && typeof window.incrementContentCount === 'function') {
          await window.incrementContentCount(currentUser.id);
        }
        
        // ìŠ¤ë§ˆíŠ¸ ì¶”ì²œ ì‹œìŠ¤í…œ: ë‹¤ìŒ ë„êµ¬ ì¶”ì²œ
        if (typeof window.showSmartRecommendations === 'function' && formData.platforms) {
          window.showSmartRecommendations(formData.platforms);
        }
        // í†µê³„ ì‹œìŠ¤í…œ: ì½˜í…ì¸  ìƒì„± í†µê³„ ì—…ë°ì´íŠ¸
        if (typeof window.updateContentGenerationStats === 'function' && formData.platforms) {
          window.updateContentGenerationStats(formData.platforms);
        }
      } else {
        showToast('âœ… ì½˜í…ì¸  ìƒì„± ì™„ë£Œ!', 'success');
        
        // ì˜¨ë³´ë”© ì‹œìŠ¤í…œ: ì½˜í…ì¸  ìƒì„± ì¹´ìš´íŠ¸ ì¦ê°€
        if (currentUser?.id && typeof window.incrementContentCount === 'function') {
          await window.incrementContentCount(currentUser.id);
        }
        
        // ìŠ¤ë§ˆíŠ¸ ì¶”ì²œ ì‹œìŠ¤í…œ: ë‹¤ìŒ ë„êµ¬ ì¶”ì²œ
        if (typeof window.showSmartRecommendations === 'function' && formData.platforms) {
          window.showSmartRecommendations(formData.platforms);
        }
      }
    } else {
      hideLoadingOverlay();
      showErrorModal(result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    }
  } catch (error) {
    console.error('ìƒì„± ì˜¤ë¥˜:', error);
    hideLoadingOverlay();
    showErrorModal('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
  }
}

// ===================================
// ìƒˆë¡œìš´ ë°°ì¹˜ ìƒì„± (ê°œë³„ ì½˜í…ì¸  ë¸”ë¡ ê¸°ë°˜)
// ===================================
async function handleNewBatchGenerate(contentCount, platforms) {
  const brand = document.getElementById('brand').value.trim();
  const companyName = document.getElementById('companyName')?.value.trim() || '';
  const businessType = document.getElementById('businessType')?.value.trim() || '';
  const location = document.getElementById('location')?.value.trim() || '';
  const targetGender = document.getElementById('targetGender')?.value || '';
  const contact = document.getElementById('contact')?.value.trim() || '';
  let website = document.getElementById('website')?.value.trim() || '';
  if (website && !website.startsWith('http://') && !website.startsWith('https://')) {
    website = 'https://' + website;
  }
  const sns = document.getElementById('sns')?.value.trim() || '';
  const tone = document.getElementById('tone')?.value || 'ì¹œê·¼í•œ';
  const targetAge = document.getElementById('targetAge')?.value || '20ëŒ€';
  const industry = document.getElementById('industry')?.value || 'ë¼ì´í”„ìŠ¤íƒ€ì¼';
  
  // ë°°ì¹˜ ìƒì„± ì‹œì‘
  showBatchLoadingOverlay(contentCount);
  
  const allResults = [];
  const errors = [];
  
  for (let i = 0; i < contentCount; i++) {
    const content = contentBlocks[i];
    
    if (!content) {
      errors.push({ index: i, error: 'ì½˜í…ì¸  ì •ë³´ ì—†ìŒ' });
      continue;
    }
    
    // í‚¤ì›Œë“œì— ì£¼ì œì™€ ì„¤ëª… ì¶”ê°€
    let enhancedKeywords = content.keywords;
    if (content.topic) {
      enhancedKeywords += ` (ì£¼ì œ: ${content.topic})`;
    }
    if (content.description) {
      enhancedKeywords += ` (${content.description})`;
    }
    
    updateBatchProgress(i + 1, contentCount, `ì½˜í…ì¸  #${i + 1} ìƒì„± ì¤‘... (${content.keywords})`);
    
    const formData = {
      user_id: currentUser?.id || null, // âœ… ì¶”ê°€
      is_guest: currentUser?.isGuest || false, // âœ… ì¶”ê°€
      brand,
      companyName,
      businessType,
      location,
      targetGender,
      contact,
      website,
      sns,
      keywords: enhancedKeywords,
      tone,
      targetAge,
      industry,
      images: content.images.map((img) => ({
        base64: img.base64,
        filename: img.name || `ì´ë¯¸ì§€${content.images.indexOf(img) + 1}`,
        size: img.size || 0
      })),
      platforms,
      aiModel: 'gpt-4o',
    };
    
    try {
      const response = await fetch('/api/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData),
      });
      
      const result = await response.json();
      
      // âœ… í¬ë ˆë”§ ë™ê¸°í™” (ë°°ì¹˜ ìƒì„±ì—ë„ ì¶”ê°€)
      if (result.usage) {
        console.log('ğŸ” [ë°°ì¹˜] ë°±ì—”ë“œ ì‘ë‹µ usage:', result.usage);
        
        const usage = result.usage;
        
        // 1ï¸âƒ£ ë¬´ë£Œ í¬ë ˆë”§ ì—…ë°ì´íŠ¸
        if (usage.free_credits !== undefined || usage.free_remaining !== undefined) {
          currentUser.free_credits = usage.free_credits ?? usage.free_remaining ?? 0;
        }
        
        // 2ï¸âƒ£ ìœ ë£Œ í¬ë ˆë”§ ì—…ë°ì´íŠ¸
        if (usage.paid_credits !== undefined || usage.paid_remaining !== undefined) {
          currentUser.paid_credits = usage.paid_credits ?? usage.paid_remaining ?? 0;
        }
        
        // 3ï¸âƒ£ ì´ í¬ë ˆë”§ ê³„ì‚°
        if (usage.credits_remaining !== undefined) {
          currentUser.credits = usage.credits_remaining;
        } else {
          currentUser.credits = (currentUser.free_credits || 0) + (currentUser.paid_credits || 0);
        }
        
        // 4ï¸âƒ£ window.userCreditsInfo ë™ê¸°í™”
        window.userCreditsInfo = {
          free_credits: currentUser.free_credits,
          paid_credits: currentUser.paid_credits,
          total_credits: currentUser.credits
        };
        
        // 5ï¸âƒ£ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì—…ë°ì´íŠ¸
        localStorage.setItem('postflow_user', JSON.stringify(currentUser));
        
        // 6ï¸âƒ£ UI ì—…ë°ì´íŠ¸
        updateAuthUI();
        updateCostEstimate();
        
        console.log('âœ… [ë°°ì¹˜] í¬ë ˆë”§ ë™ê¸°í™” ì™„ë£Œ:', {
          free: currentUser.free_credits,
          paid: currentUser.paid_credits,
          total: currentUser.credits
        });
      }
      
      if (result.success) {
        allResults.push({
          contentIndex: i,
          data: result.data,
          platforms: result.generatedPlatforms,
          keywords: content.keywords
        });
      } else {
        errors.push({ index: i, error: result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜' });
      }
    } catch (error) {
      console.error(`ì½˜í…ì¸  #${i + 1} ìƒì„± ì˜¤ë¥˜:`, error);
      errors.push({ index: i, error: error.message });
    }
  }
  
  // ë°°ì¹˜ ìƒì„± ì™„ë£Œ
  hideBatchLoadingOverlay();
  displayBatchResults(allResults, errors, contentCount);
  
  if (allResults.length > 0) {
    showToast(`âœ… ë°°ì¹˜ ìƒì„± ì™„ë£Œ! (ì„±ê³µ: ${allResults.length}ê°œ, ì‹¤íŒ¨: ${errors.length}ê°œ)`, 'success');
  } else {
    showToast('âŒ ëª¨ë“  ì½˜í…ì¸  ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
  }
}

// ===================================
// êµ¬ ë°°ì¹˜ ìƒì„± (ë” ì´ìƒ ì‚¬ìš© ì•ˆ í•¨)
// ===================================
async function handleBatchGenerate(contentCount, imagesPerContent, platforms) {
  const brand = document.getElementById('brand').value.trim();
  const companyName = document.getElementById('companyName')?.value.trim() || '';
  const businessType = document.getElementById('businessType')?.value.trim() || '';
  const location = document.getElementById('location')?.value.trim() || '';
  const targetGender = document.getElementById('targetGender')?.value || '';
  const contact = document.getElementById('contact')?.value.trim() || '';
  let website = document.getElementById('website')?.value.trim() || '';
  if (website && !website.startsWith('http://') && !website.startsWith('https://')) {
    website = 'https://' + website;
  }
  const sns = document.getElementById('sns')?.value.trim() || '';
  const keywords = document.getElementById('keywords').value.trim();
  const tone = document.getElementById('tone')?.value || 'ì¹œê·¼í•œ';
  const targetAge = document.getElementById('targetAge')?.value || '20ëŒ€';
  const industry = document.getElementById('industry')?.value || 'ë¼ì´í”„ìŠ¤íƒ€ì¼';
  
  // ë°°ì¹˜ ìƒì„± ì‹œì‘
  showBatchLoadingOverlay(contentCount);
  
  // í‚¤ì›Œë“œ ë°°ì—´ë¡œ ë³€í™˜ (ì‰¼í‘œ êµ¬ë¶„)
  const keywordArray = keywords.split(',').map(k => k.trim()).filter(k => k.length > 0);
  
  const allResults = [];
  const errors = [];
  
  for (let i = 0; i < contentCount; i++) {
    const startIdx = i * imagesPerContent;
    const endIdx = Math.min((i + 1) * imagesPerContent, selectedImages.length);
    const batchImages = selectedImages.slice(startIdx, endIdx);
    
    // ê°œë³„ ì½˜í…ì¸  ì •ë³´ í™•ì¸
    const batchKeywordInput = document.getElementById(`batchKeyword_${i}`);
    const batchTopicInput = document.getElementById(`batchTopic_${i}`);
    const batchDescriptionInput = document.getElementById(`batchDescription_${i}`);
    
    // ê°œë³„ ì…ë ¥ì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ë³¸ í‚¤ì›Œë“œ ìˆœí™˜
    let currentKeyword, currentTopic, currentDescription;
    
    if (batchKeywordInput && batchKeywordInput.value.trim()) {
      currentKeyword = batchKeywordInput.value.trim();
    } else {
      currentKeyword = keywordArray.length > 0 
        ? keywordArray[i % keywordArray.length] 
        : keywords;
    }
    
    currentTopic = batchTopicInput ? batchTopicInput.value.trim() : '';
    currentDescription = batchDescriptionInput ? batchDescriptionInput.value.trim() : '';
    
    // ì£¼ì œì™€ ì„¤ëª…ì„ í‚¤ì›Œë“œì— ì¶”ê°€ (AI í”„ë¡¬í”„íŠ¸ì— ë°˜ì˜)
    let enhancedKeywords = currentKeyword;
    if (currentTopic) {
      enhancedKeywords += ` (ì£¼ì œ: ${currentTopic})`;
    }
    if (currentDescription) {
      enhancedKeywords += ` (${currentDescription})`;
    }
    
    updateBatchProgress(i + 1, contentCount, `ì½˜í…ì¸  #${i + 1} ìƒì„± ì¤‘... (${currentKeyword})`);
    
    const formData = {
      user_id: currentUser?.id || null, // âœ… ì¶”ê°€
      is_guest: currentUser?.isGuest || false, // âœ… ì¶”ê°€
      brand,
      companyName,
      businessType,
      location,
      targetGender,
      contact,
      website,
      sns,
      keywords: enhancedKeywords, // í™•ì¥ëœ í‚¤ì›Œë“œ ì‚¬ìš©
      tone,
      targetAge,
      industry,
      images: batchImages.map((img) => ({
        base64: img.base64,
        filename: img.name || `ì´ë¯¸ì§€${batchImages.indexOf(img) + 1}`,
        size: img.size || 0
      })),
      platforms,
      aiModel: 'gpt-4o',
    };
    
    try {
      const response = await fetch('/api/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData),
      });
      
      const result = await response.json();
      
      if (result.success) {
        allResults.push({
          index: i + 1,
          data: result.data,
          platforms: result.generatedPlatforms,
          keyword: currentKeyword, // ì‚¬ìš©ëœ í‚¤ì›Œë“œ ì €ì¥
        });
      } else {
        errors.push({
          index: i + 1,
          error: result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜',
        });
      }
    } catch (error) {
      console.error(`ì½˜í…ì¸  #${i + 1} ìƒì„± ì˜¤ë¥˜:`, error);
      errors.push({
        index: i + 1,
        error: 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜',
      });
    }
  }
  
  hideBatchLoadingOverlay();
  
  // ê²°ê³¼ í‘œì‹œ
  if (allResults.length > 0) {
    displayBatchResults(allResults, errors);
    showToast(`âœ… ${allResults.length}/${contentCount}ê°œ ì½˜í…ì¸  ìƒì„± ì™„ë£Œ!`, 'success');
  } else {
    showToast('âŒ ëª¨ë“  ì½˜í…ì¸  ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
    showErrorModal('ë°°ì¹˜ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
  }
}

// ë°°ì¹˜ ë¡œë”© ì˜¤ë²„ë ˆì´
function showBatchLoadingOverlay(totalCount) {
  const overlay = document.getElementById('loadingOverlay');
  overlay.classList.remove('hidden');
  
  const loadingMessage = document.getElementById('loadingMessage');
  loadingMessage.textContent = `ë°°ì¹˜ ìƒì„± ì¤‘... (0/${totalCount})`;
  
  const progressBar = document.getElementById('progressBar');
  progressBar.style.width = '0%';
  document.getElementById('progressPercent').textContent = '0%';
}

function updateBatchProgress(current, total, message) {
  const progress = (current / total) * 100;
  const progressBar = document.getElementById('progressBar');
  const progressPercent = document.getElementById('progressPercent');
  const loadingMessage = document.getElementById('loadingMessage');
  
  progressBar.style.width = progress + '%';
  progressPercent.textContent = Math.floor(progress) + '%';
  loadingMessage.textContent = `${message} (${current}/${total})`;
}

function hideBatchLoadingOverlay() {
  const overlay = document.getElementById('loadingOverlay');
  const progressBar = document.getElementById('progressBar');
  const progressPercent = document.getElementById('progressPercent');
  
  progressBar.style.width = '100%';
  progressPercent.textContent = '100%';
  
  setTimeout(() => {
    overlay.classList.add('hidden');
    progressBar.style.width = '0%';
    progressPercent.textContent = '0%';
    document.getElementById('loadingMessage').textContent = 'ì´ë¯¸ì§€ ë¶„ì„ ì¤‘...';
  }, 500);
}

// ë°°ì¹˜ ê²°ê³¼ í‘œì‹œ
function displayBatchResults(allResults, errors) {
  const resultsSection = document.getElementById('resultsSection');
  if (!resultsSection) return;
  
  resultsSection.classList.remove('hidden');
  resultsSection.scrollIntoView({ behavior: 'smooth' });
  
  let html = `
    <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-xl p-6 mb-6 border-2 border-green-200">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">
        <i class="fas fa-check-circle text-green-600 mr-2"></i>
        ë°°ì¹˜ ìƒì„± ì™„ë£Œ
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
        <div class="bg-white rounded-lg p-4">
          <span class="text-gray-600">ì„±ê³µ:</span>
          <span class="font-bold text-green-600 text-2xl ml-2">${allResults.length}ê°œ</span>
        </div>
        <div class="bg-white rounded-lg p-4">
          <span class="text-gray-600">ì‹¤íŒ¨:</span>
          <span class="font-bold text-red-600 text-2xl ml-2">${errors.length}ê°œ</span>
        </div>
      </div>
      <button
        onclick="downloadBatchExcel()"
        class="mt-4 w-full px-6 py-3 bg-gradient-to-r from-green-600 to-blue-600 text-white font-bold rounded-lg hover:from-green-700 hover:to-blue-700 transition"
      >
        <i class="fas fa-file-excel mr-2"></i>ì „ì²´ ê²°ê³¼ Excel ë‹¤ìš´ë¡œë“œ
      </button>
    </div>
  `;
  
  // ê° ì½˜í…ì¸  ê²°ê³¼ í‘œì‹œ
  allResults.forEach((result) => {
    html += `
      <div class="bg-white rounded-xl p-6 mb-6 shadow-lg border border-gray-200">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-gray-800">
            <i class="fas fa-file-alt mr-2 text-purple-600"></i>
            ì½˜í…ì¸  #${result.contentIndex + 1}
          </h3>
          <span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm font-semibold">
            <i class="fas fa-key mr-1"></i>${result.keywords || 'í‚¤ì›Œë“œ'}
          </span>
        </div>
    `;
    
    result.platforms.forEach((platform) => {
      const content = result.data[platform];
      if (!content) return;
      
      const platformNames = {
        blog: 'ë„¤ì´ë²„ ë¸”ë¡œê·¸',
        instagram: 'ì¸ìŠ¤íƒ€ê·¸ë¨',
        threads: 'ìŠ¤ë ˆë“œ',
        youtube: 'ìœ íŠœë¸Œ ìˆí¼',
      };
      
      html += `
        <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
          <h4 class="font-bold text-gray-700 mb-2">${platformNames[platform] || platform}</h4>
          <div class="bg-white p-4 rounded border border-gray-200 max-h-60 overflow-y-auto whitespace-pre-wrap text-sm">
            ${content}
          </div>
          <div class="mt-3 flex gap-2">
            <button
              type="button"
              onclick="copyContentFromBatch(${result.contentIndex}, '${platform}', '${platformNames[platform]}')"
              class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm"
            >
              <i class="fas fa-copy mr-1"></i>ë³µì‚¬
            </button>
          </div>
        </div>
      `;
    });
    
    html += `</div>`;
  });
  
  // ì˜¤ë¥˜ í‘œì‹œ
  if (errors.length > 0) {
    html += `
      <div class="bg-red-50 rounded-xl p-6 border-2 border-red-200">
        <h3 class="text-xl font-bold text-red-800 mb-4">
          <i class="fas fa-exclamation-triangle mr-2"></i>
          ìƒì„± ì‹¤íŒ¨ í•­ëª©
        </h3>
    `;
    
    errors.forEach((err) => {
      html += `
        <div class="bg-white p-4 rounded-lg mb-2 border border-red-200">
          <span class="font-semibold">ì½˜í…ì¸  #${err.index + 1}:</span>
          <span class="text-red-600 ml-2">${err.error}</span>
        </div>
      `;
    });
    
    html += `</div>`;
  }
  
  resultsSection.innerHTML = html;
  
  // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (Excel ë‹¤ìš´ë¡œë“œìš©)
  window.batchResults = allResults;
}

// ===================================
// ë¡œë”© ì˜¤ë²„ë ˆì´
// ===================================
function showLoadingOverlay() {
  const overlay = document.getElementById('loadingOverlay');
  overlay.classList.remove('hidden');
  
  // ì§„í–‰ë¥  ì• ë‹ˆë©”ì´ì…˜
  let progress = 0;
  const progressBar = document.getElementById('progressBar');
  const progressPercent = document.getElementById('progressPercent');
  const loadingMessage = document.getElementById('loadingMessage');
  
  const messages = [
    'ì´ë¯¸ì§€ ë¶„ì„ ì¤‘...',
    'AIê°€ ì½˜í…ì¸ ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...',
    'í”Œë«í¼ë³„ ìµœì í™” ì¤‘...',
    'ê±°ì˜ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤...'
  ];
  
  let messageIndex = 0;
  
  const interval = setInterval(() => {
    progress += Math.random() * 15;
    if (progress > 90) progress = 90;
    
    progressBar.style.width = progress + '%';
    progressPercent.textContent = Math.floor(progress) + '%';
    
    if (progress > 25 * (messageIndex + 1) && messageIndex < messages.length - 1) {
      messageIndex++;
      loadingMessage.textContent = messages[messageIndex];
    }
  }, 500);
  
  overlay.dataset.intervalId = interval;
}

function hideLoadingOverlay() {
  const overlay = document.getElementById('loadingOverlay');
  const intervalId = overlay.dataset.intervalId;
  
  if (intervalId) {
    clearInterval(parseInt(intervalId));
  }
  
  // ì™„ë£Œ ì• ë‹ˆë©”ì´ì…˜
  const progressBar = document.getElementById('progressBar');
  const progressPercent = document.getElementById('progressPercent');
  
  progressBar.style.width = '100%';
  progressPercent.textContent = '100%';
  
  setTimeout(() => {
    overlay.classList.add('hidden');
    progressBar.style.width = '0%';
    progressPercent.textContent = '0%';
    document.getElementById('loadingMessage').textContent = 'ì´ë¯¸ì§€ ë¶„ì„ ì¤‘...';
  }, 500);
}

// ===================================
// ê²€ì¦ ëª¨ë‹¬ (ì´ë¯¸ì§€-ë‚´ìš© ë¶ˆì¼ì¹˜)
// ===================================
let pendingFormData = null;

function showValidationModal(validation, formData) {
  pendingFormData = formData;
  
  const modal = document.getElementById('validationModal');
  
  // ì‹ ë¢°ë„ í‘œì‹œ
  const confidenceEl = document.getElementById('validationConfidence');
  const confidence = validation.confidence || 0;
  confidenceEl.textContent = `${confidence}%`;
  
  // ì‹ ë¢°ë„ì— ë”°ë¥¸ ìƒ‰ìƒ ë³€ê²½ (ì•ˆì „í•œ ë°©ë²•)
  const confidenceContainer = confidenceEl.parentElement?.parentElement;
  if (confidenceContainer) {
    if (confidence < 30) {
      confidenceContainer.style.background = '#fee2e2';
      confidenceContainer.style.borderLeftColor = '#dc2626';
      confidenceEl.style.color = '#991b1b';
    } else if (confidence < 50) {
      confidenceContainer.style.background = '#fef3c7';
      confidenceContainer.style.borderLeftColor = '#f59e0b';
      confidenceEl.style.color = '#b45309';
    } else {
      confidenceContainer.style.background = '#dbeafe';
      confidenceContainer.style.borderLeftColor = '#3b82f6';
      confidenceEl.style.color = '#1e40af';
    }
  }
  
  // ì¶©ëŒ ëª©ë¡ í‘œì‹œ
  const conflictsListEl = document.getElementById('conflictsList');
  conflictsListEl.innerHTML = '';
  
  if (validation.conflicts && validation.conflicts.length > 0) {
    conflictsListEl.innerHTML = '<h3 style="font-weight: 600; margin-bottom: 12px; color: #1f2937;"><i class="fas fa-exclamation-triangle"></i> ë°œê²¬ëœ ì¶©ëŒ (' + validation.conflicts.length + 'ê°œ)</h3>';
    
    validation.conflicts.forEach((conflict, index) => {
      const severityColor = {
        high: '#dc2626',
        medium: '#f59e0b',
        low: '#3b82f6'
      }[conflict.severity] || '#6b7280';
      
      const severityLabel = {
        high: 'ë†’ìŒ',
        medium: 'ì¤‘ê°„',
        low: 'ë‚®ìŒ'
      }[conflict.severity] || 'ì•Œ ìˆ˜ ì—†ìŒ';
      
      const typeLabel = {
        'image-keyword': 'ì´ë¯¸ì§€-í‚¤ì›Œë“œ',
        'image-brand': 'ì´ë¯¸ì§€-ë¸Œëœë“œ',
        'document-keyword': 'ë¬¸ì„œ-í‚¤ì›Œë“œ',
        'brand-website': 'ë¸Œëœë“œ-ì›¹ì‚¬ì´íŠ¸',
        'industry-keyword': 'ì‚°ì—…-í‚¤ì›Œë“œ',
        'target-content': 'íƒ€ê²Ÿ-ì½˜í…ì¸ '
      }[conflict.type] || conflict.type;
      
      const conflictHtml = `
        <div style="background: #f9fafb; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 3px solid ${severityColor};">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <span style="font-weight: 600; color: #1f2937;">
              <i class="fas fa-times-circle"></i> ${typeLabel}
            </span>
            <span style="background: ${severityColor}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">
              ${severityLabel}
            </span>
          </div>
          <p style="color: #4b5563; margin-bottom: 8px; font-size: 0.9rem;">${conflict.description}</p>
          ${conflict.items && conflict.items.length > 0 ? 
            '<p style="color: #6b7280; font-size: 0.85rem; margin-bottom: 8px;"><strong>ê´€ë ¨ í•­ëª©:</strong> ' + conflict.items.join(', ') + '</p>' : 
            ''
          }
          <p style="color: #059669; font-size: 0.85rem;">
            <i class="fas fa-lightbulb"></i> <strong>ìˆ˜ì • ì œì•ˆ:</strong> ${conflict.suggestion}
          </p>
        </div>
      `;
      
      conflictsListEl.innerHTML += conflictHtml;
    });
  } else {
    conflictsListEl.innerHTML = '<p style="color: #059669;"><i class="fas fa-check-circle"></i> ì¶©ëŒì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>';
  }
  
  // ì „ëµ ë° ì´ìœ  í‘œì‹œ
  document.getElementById('validationReason').textContent = validation.reason || 'ìƒì„¸ ì •ë³´ ì—†ìŒ';
  
  // ê¶Œì¥ ì‚¬í•­ í‘œì‹œ
  document.getElementById('validationRecommendation').textContent = validation.recommendation || 'ì…ë ¥ ì •ë³´ë¥¼ ìˆ˜ì •í•´ì£¼ì„¸ìš”.';
  
  modal.classList.remove('hidden');
}

function closeValidationModal() {
  const modal = document.getElementById('validationModal');
  modal.classList.add('hidden');
  pendingFormData = null;
}

async function forceGenerate() {
  if (!pendingFormData) {
    showToast('âŒ ìƒì„±í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
    return;
  }
  
  closeValidationModal();
  showLoadingOverlay();
  
  // ê²€ì¦ ìš°íšŒ í”Œë˜ê·¸ ì¶”ê°€
  const formDataWithForce = { ...pendingFormData, forceGenerate: true };
  
  try {
    const response = await fetch('/api/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(formDataWithForce),
    });

    const result = await response.json();

    if (result.success) {
      hideLoadingOverlay();
      resultData = result.data;
      
      // âœ… generationId ì €ì¥ (ìº˜ë¦°ë” ë“±ë¡ìš©)
      const generationId = result.id || result.generation_id || `gen_${Date.now()}_${Math.random().toString(36).substring(7)}`;
      window.lastGenerationId = generationId;
      console.log('âœ… ì¬ìƒì„± ID ì €ì¥:', generationId);
      
      // âœ… ë‚ ì§œ + ì´ë¯¸ì§€ ì •ë³´ í¬í•¨í•´ì„œ í‘œì‹œ
      displayResults(result.data, result.generatedPlatforms, {
        createdAt: result.created_at || new Date().toISOString(),
        scheduledDate: null,  // ì•„ì§ ë“±ë¡ ì „
        images: result.images || []
      });
      
      // âœ… ë°±ì—”ë“œì—ì„œ ì´ë¯¸ ì €ì¥í–ˆìœ¼ë©´ ì¤‘ë³µ ì €ì¥ ë°©ì§€
      if (result.id) {
        console.log('âœ… ë°±ì—”ë“œì—ì„œ ì €ì¥ ì™„ë£Œ, í”„ë¡ íŠ¸ ì¤‘ë³µ ì €ì¥ ìŠ¤í‚µ');
      } else {
        console.warn('âš ï¸ ë°±ì—”ë“œ ì €ì¥ ì‹¤íŒ¨, í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì €ì¥ ì‹œë„');
        // ğŸ”¥ íˆìŠ¤í† ë¦¬ ìë™ì €ì¥ (await ì¶”ê°€)
        await saveToHistory(formDataWithForce, result.data);
      }
      
      // âœ… í¬ë ˆë”§ ì •ë³´ ì—…ë°ì´íŠ¸ (í‚¤ ë§¤í•‘ + 2ì§€ê°‘ ì‹œìŠ¤í…œ)
      if (result.usage) {
        console.log('ğŸ” ë°±ì—”ë“œ ì‘ë‹µ usage:', result.usage);
        
        const usage = result.usage;
        
        // 1ï¸âƒ£ ë¬´ë£Œ í¬ë ˆë”§ ì—…ë°ì´íŠ¸ (ì—¬ëŸ¬ í‚¤ ì§€ì›)
        if (usage.free_credits !== undefined || usage.free_remaining !== undefined) {
          currentUser.free_credits = usage.free_credits ?? usage.free_remaining ?? 0;
        }
        
        // 2ï¸âƒ£ ìœ ë£Œ í¬ë ˆë”§ ì—…ë°ì´íŠ¸ (ì—¬ëŸ¬ í‚¤ ì§€ì›)
        if (usage.paid_credits !== undefined || usage.paid_remaining !== undefined) {
          currentUser.paid_credits = usage.paid_credits ?? usage.paid_remaining ?? 0;
        }
        
        // 3ï¸âƒ£ ì´ í¬ë ˆë”§ ê³„ì‚°
        if (usage.credits_remaining !== undefined) {
          currentUser.credits = usage.credits_remaining;
        } else {
          currentUser.credits = (currentUser.free_credits || 0) + (currentUser.paid_credits || 0);
        }
        
        // ğŸ”¥ ì¤‘ìš”: window.userCreditsInfo ë™ê¸°í™” (í‚¤ì›Œë“œ AI í™”ë©´ í¬ë ˆë”§ ì‹¤ì‹œê°„ ë°˜ì˜)
        window.userCreditsInfo = {
          free_credits: currentUser.free_credits,
          paid_credits: currentUser.paid_credits,
          total_credits: currentUser.credits
        };
        console.log('âœ… window.userCreditsInfo ë™ê¸°í™”:', window.userCreditsInfo);
        
        // 2ï¸âƒ£ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì—…ë°ì´íŠ¸
        localStorage.setItem('postflow_user', JSON.stringify(currentUser));
        
        // 3ï¸âƒ£ updateAuthUI() í˜¸ì¶œ (ì „ì²´ UI ì—…ë°ì´íŠ¸ - 2ì§€ê°‘ í‘œì‹œ í¬í•¨)
        updateAuthUI();
        
        // 4ï¸âƒ£ í•˜ë‹¨ í¬ë ˆë”§ ë°•ìŠ¤ ì—…ë°ì´íŠ¸ (ì¦‰ì‹œ ë°˜ì˜)
        updateCostEstimate();
        
        // 5ï¸âƒ£ í† ìŠ¤íŠ¸ ë©”ì‹œì§€ (2ì§€ê°‘ ì •ë³´ + í”Œë«í¼ë‹¹ 1í¬ë ˆë”§)
        const freeCredits = currentUser.free_credits || 0;
        const paidCredits = currentUser.paid_credits || 0;
        const totalCredits = freeCredits + paidCredits;
        const creditsUsed = usage.credits_used || 1;
        
        let creditInfo = `ë‚¨ì€ í¬ë ˆë”§: ${totalCredits}`;
        if (freeCredits > 0 && paidCredits > 0) {
          creditInfo = `ë‚¨ì€ í¬ë ˆë”§: ${totalCredits} (ë¬´ë£Œ ${freeCredits} + ìœ ë£Œ ${paidCredits})`;
        } else if (freeCredits > 0) {
          creditInfo = `ë‚¨ì€ í¬ë ˆë”§: ${totalCredits} (ë¬´ë£Œ)`;
        } else if (paidCredits > 0) {
          creditInfo = `ë‚¨ì€ í¬ë ˆë”§: ${totalCredits} (ìœ ë£Œ)`;
        }
        
        console.log('âœ… í¬ë ˆë”§ UI ì—…ë°ì´íŠ¸ ì™„ë£Œ:', {
          free: currentUser.free_credits,
          paid: currentUser.paid_credits,
          total: totalCredits,
          used: creditsUsed,
          display: creditInfo
        });
        
        showToast(`âœ… ì½˜í…ì¸  ìƒì„± ì™„ë£Œ! (${creditsUsed}í¬ë ˆë”§ ì‚¬ìš©, ${creditInfo})`, 'success');
        
        // ì˜¨ë³´ë”© ì‹œìŠ¤í…œ: ì½˜í…ì¸  ìƒì„± ì¹´ìš´íŠ¸ ì¦ê°€
        if (currentUser?.id && typeof window.incrementContentCount === 'function') {
          await window.incrementContentCount(currentUser.id);
        }
        
        // ìŠ¤ë§ˆíŠ¸ ì¶”ì²œ ì‹œìŠ¤í…œ: ë‹¤ìŒ ë„êµ¬ ì¶”ì²œ
        if (typeof window.showSmartRecommendations === 'function' && formData.platforms) {
          window.showSmartRecommendations(formData.platforms);
        }
        // í†µê³„ ì‹œìŠ¤í…œ: ì½˜í…ì¸  ìƒì„± í†µê³„ ì—…ë°ì´íŠ¸
        if (typeof window.updateContentGenerationStats === 'function' && formData.platforms) {
          window.updateContentGenerationStats(formData.platforms);
        }
      } else {
        showToast('âœ… ì½˜í…ì¸  ìƒì„± ì™„ë£Œ!', 'success');
        
        // ì˜¨ë³´ë”© ì‹œìŠ¤í…œ: ì½˜í…ì¸  ìƒì„± ì¹´ìš´íŠ¸ ì¦ê°€
        if (currentUser?.id && typeof window.incrementContentCount === 'function') {
          await window.incrementContentCount(currentUser.id);
        }
        
        // ìŠ¤ë§ˆíŠ¸ ì¶”ì²œ ì‹œìŠ¤í…œ: ë‹¤ìŒ ë„êµ¬ ì¶”ì²œ
        if (typeof window.showSmartRecommendations === 'function' && formData.platforms) {
          window.showSmartRecommendations(formData.platforms);
        }
      }
    } else {
      hideLoadingOverlay();
      showErrorModal(result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    }
  } catch (error) {
    console.error('ìƒì„± ì˜¤ë¥˜:', error);
    hideLoadingOverlay();
    showErrorModal('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
  }
}

// ===================================
// ì—ëŸ¬ ëª¨ë‹¬
// ===================================
function showErrorModal(errorMessage) {
  const modal = document.getElementById('errorModal');
  const errorMessageEl = document.getElementById('errorMessage');
  const errorSolutionsEl = document.getElementById('errorSolutions');
  
  errorMessageEl.textContent = errorMessage;
  
  // ì—ëŸ¬ ìœ í˜•ë³„ í•´ê²° ë°©ë²•
  let solutions = [];
  
  if (errorMessage.includes('API') || errorMessage.includes('key')) {
    solutions = [
      'â€¢ ê´€ë¦¬ìì—ê²Œ OpenAI API í‚¤ê°€ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”',
      'â€¢ ì„œë²„ì˜ .env íŒŒì¼ì— OPENAI_API_KEYê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”',
      'â€¢ API ì‚¬ìš© í•œë„ê°€ ë‚¨ì•„ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”',
      'â€¢ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”'
    ];
  } else if (errorMessage.includes('ë„¤íŠ¸ì›Œí¬') || errorMessage.includes('network')) {
    solutions = [
      'â€¢ ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”',
      'â€¢ VPNì„ ì‚¬ìš© ì¤‘ì´ë¼ë©´ ë¹„í™œì„±í™”í•´ë³´ì„¸ìš”',
      'â€¢ ë¸Œë¼ìš°ì € ìºì‹œë¥¼ ì§€ìš°ê³  ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”',
      'â€¢ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”'
    ];
  } else if (errorMessage.includes('ì´ë¯¸ì§€') || errorMessage.includes('image')) {
    solutions = [
      'â€¢ ì´ë¯¸ì§€ íŒŒì¼ì´ ì†ìƒë˜ì§€ ì•Šì•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”',
      'â€¢ ì´ë¯¸ì§€ í¬ê¸°ê°€ ë„ˆë¬´ í¬ì§€ ì•Šì€ì§€ í™•ì¸í•˜ì„¸ìš” (ìµœëŒ€ 50MB)',
      'â€¢ ì§€ì›ë˜ëŠ” ì´ë¯¸ì§€ í˜•ì‹ì¸ì§€ í™•ì¸í•˜ì„¸ìš” (JPG, PNG, GIF)',
      'â€¢ ë‹¤ë¥¸ ì´ë¯¸ì§€ë¡œ ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”'
    ];
  } else {
    solutions = [
      'â€¢ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”',
      'â€¢ ì…ë ¥í•œ ì •ë³´ê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”',
      'â€¢ ë¸Œë¼ìš°ì € ì½˜ì†”(F12)ì—ì„œ ìì„¸í•œ ì˜¤ë¥˜ë¥¼ í™•ì¸í•˜ì„¸ìš”',
      'â€¢ ë¬¸ì œê°€ ê³„ì†ë˜ë©´ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”'
    ];
  }
  
  errorSolutionsEl.innerHTML = solutions.map(s => `<li>${s}</li>`).join('');
  
  modal.classList.remove('hidden');
  modal.style.display = 'flex';
}

function closeErrorModal() {
  const modal = document.getElementById('errorModal');
  modal.classList.add('hidden');
  modal.style.display = 'none';
}

function retryGeneration() {
  closeErrorModal();
  if (lastFormData) {
    handleGenerate();
  } else {
    showToast('âŒ ì¬ì‹œë„í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
  }
}

// ===================================
// ê²°ê³¼ í‘œì‹œ
// ===================================
function displayResults(data, platforms, options = {}) {
  const resultArea = document.getElementById('resultArea');
  const tabButtons = document.getElementById('tabButtons');
  const tabContents = document.getElementById('tabContents');
  
  // âœ… ì˜µì…˜: hideCalendarButton (ìº˜ë¦°ë” ë²„íŠ¼ ìˆ¨ê¸°ê¸°)
  const hideCalendarButton = options.hideCalendarButton || false;
  
  // âœ… ë‚ ì§œ ì •ë³´ ì˜µì…˜
  const createdAt = options.createdAt || null;
  const scheduledDate = options.scheduledDate || null;
  
  const platformNames = {
    blog: '<i class="fas fa-blog text-blue-600 mr-2"></i>ë„¤ì´ë²„ ë¸”ë¡œê·¸',
    instagram: '<i class="fab fa-instagram text-pink-600 mr-2"></i>ì¸ìŠ¤íƒ€ê·¸ë¨',
    instagram_feed: '<i class="fab fa-instagram text-pink-600 mr-2"></i>ì¸ìŠ¤íƒ€ê·¸ë¨ í”¼ë“œ',
    threads: '<i class="fas fa-at text-gray-800 mr-2"></i>ìŠ¤ë ˆë“œ',
    twitter: '<i class="fab fa-twitter text-blue-400 mr-2"></i>íŠ¸ìœ„í„°(X)',
    linkedin: '<i class="fab fa-linkedin text-blue-700 mr-2"></i>LinkedIn',
    kakaotalk: '<i class="fas fa-comment text-yellow-500 mr-2"></i>ì¹´ì¹´ì˜¤í†¡',
    brunch: '<i class="fas fa-book-open text-orange-600 mr-2"></i>ë¸ŒëŸ°ì¹˜',
    youtube: '<i class="fab fa-youtube text-red-600 mr-2"></i>ìœ íŠœë¸Œ',
    youtube_shorts: '<i class="fab fa-youtube text-red-600 mr-2"></i>ìœ íŠœë¸Œ ìˆí¼',
    youtube_longform: '<i class="fab fa-youtube text-red-600 mr-2"></i>ìœ íŠœë¸Œ ë¡±í¼',
    shortform_multi: '<i class="fas fa-film text-purple-600 mr-2"></i>ìˆí¼',
    tiktok: '<i class="fab fa-tiktok text-gray-900 mr-2"></i>í‹±í†¡',
    instagram_reels: '<i class="fab fa-instagram text-pink-600 mr-2"></i>ì¸ìŠ¤íƒ€ ë¦´ìŠ¤',
    metadata_generation: '<i class="fas fa-tags text-purple-600 mr-2"></i>ë©”íƒ€ë°ì´í„°'
  };
  
  // âœ… HTML íƒœê·¸ ì œê±° (onclick ì†ì„±ì—ì„œ ì‚¬ìš©)
  const getPlatformText = (platform) => {
    const html = platformNames[platform] || platform;
    return html.replace(/<[^>]*>/g, '').trim();
  };
  
  // âœ… ë‚ ì§œ ì •ë³´ í—¤ë” ìƒì„±
  let dateInfoHTML = '';
  if (createdAt || scheduledDate) {
    dateInfoHTML = `
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4 flex gap-6">
        ${createdAt ? `
          <div class="flex items-center gap-2">
            <i class="fas fa-clock text-blue-600"></i>
            <span class="text-sm font-semibold text-gray-700">ìƒì„±ì¼:</span>
            <span class="text-sm text-gray-900">${new Date(createdAt).toLocaleString('ko-KR', { 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric', 
              hour: '2-digit', 
              minute: '2-digit',
              hour12: true 
            })}</span>
          </div>
        ` : ''}
        ${scheduledDate ? `
          <div class="flex items-center gap-2">
            <i class="fas fa-calendar-check text-green-600"></i>
            <span class="text-sm font-semibold text-gray-700">ë°œí–‰ ì˜ˆì •ì¼:</span>
            <span class="text-sm text-gray-900">${new Date(scheduledDate).toLocaleString('ko-KR', { 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric', 
              hour: '2-digit', 
              minute: '2-digit',
              hour12: true 
            })}</span>
          </div>
        ` : ''}
      </div>
    `;
  }
  
  // íƒ­ ë²„íŠ¼ ìƒì„±
  tabButtons.innerHTML = dateInfoHTML + platforms.map((platform, index) => `
    <button
      type="button"
      class="tab-button ${index === 0 ? 'active' : ''} px-6 py-3 rounded-lg font-semibold transition"
      onclick="switchTab('${platform}')"
    >
      ${platformNames[platform]}
    </button>
  `).join('');
  
  // íƒ­ ì½˜í…ì¸  ìƒì„±
  tabContents.innerHTML = platforms.map((platform, index) => `
    <div id="tab-${platform}" class="tab-content ${index === 0 ? '' : 'hidden'}">
      <div class="bg-gray-50 rounded-lg p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-gray-800">${platformNames[platform]}</h3>
          <div class="flex gap-2">
            ${!hideCalendarButton ? `
            <button
              type="button"
              onclick="openDateTimeModalForGeneration('${platform}')"
              class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-semibold flex items-center gap-2"
              title="ìº˜ë¦°ë”ì— ë“±ë¡í•˜ê¸°"
            >
              <i class="fas fa-calendar-plus"></i>
              ìº˜ë¦°ë”
            </button>
            ` : ''}
            <button
              type="button"
              onclick="editContent('${platform}')"
              class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition font-semibold flex items-center gap-2"
              title="ì½˜í…ì¸  ìˆ˜ì •í•˜ê¸°"
            >
              <i class="fas fa-edit"></i>
              ìˆ˜ì •
            </button>
            <button
              type="button"
              onclick="downloadAsTextFromResult('${platform}', '${getPlatformText(platform)}.txt')"
              class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-semibold flex items-center gap-2"
              title="í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ"
            >
              <i class="fas fa-download"></i>
              TXT
            </button>
            <button
              type="button"
              onclick="copyToClipboardFromResult('${platform}', '${getPlatformText(platform)}')"
              class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition font-semibold flex items-center gap-2"
            >
              <i class="fas fa-copy"></i>
              ë³µì‚¬
            </button>
          </div>
        </div>
        <div id="content-display-${platform}" class="result-content bg-white p-6 rounded-lg whitespace-pre-wrap border border-gray-200">
          ${formatContent(data[platform])}
        </div>
        <textarea
          id="content-editor-${platform}"
          class="hidden w-full p-6 border-2 border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 font-mono"
          rows="20"
          style="white-space: pre-wrap; font-family: 'Malgun Gothic', monospace;"
        >${data[platform]}</textarea>
        <div id="editor-actions-${platform}" class="hidden mt-3 flex gap-2 justify-end">
          <button
            type="button"
            onclick="cancelEdit('${platform}')"
            class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition"
          >
            âœ– ì·¨ì†Œ
          </button>
          <button
            type="button"
            onclick="saveEdit('${platform}')"
            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-semibold"
          >
            âœ“ ì €ì¥
          </button>
        </div>
      </div>
    </div>
  `).join('');
  
  resultArea.classList.remove('hidden');
  resultArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function formatContent(content) {
  if (!content) return '<p class="text-gray-500">ì½˜í…ì¸ ê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>';
  
  // HTML ì´ìŠ¤ì¼€ì´í”„ ë° í¬ë§·íŒ…
  return content
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/\n/g, '<br>')
    .replace(/#(\S+)/g, '<span style="color: #3b82f6; font-weight: 600;">#$1</span>')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    // ì´ëª¨ì§€ë¥¼ FontAwesome ì•„ì´ì½˜ìœ¼ë¡œ ì¹˜í™˜
    .replace(/ğŸ“/g, '<i class="fas fa-blog"></i>')           // ë„¤ì´ë²„ ë¸”ë¡œê·¸
    .replace(/ğŸ“¸/g, '<i class="fab fa-instagram"></i>')     // ì¸ìŠ¤íƒ€ê·¸ë¨ í”¼ë“œ
    .replace(/ğŸ¬/g, '<i class="fas fa-video"></i>')         // ì¸ìŠ¤íƒ€ê·¸ë¨ ë¦´ìŠ¤
    .replace(/ğŸ§µ/g, '<i class="fab fa-threads"></i>')       // ìŠ¤ë ˆë“œ
    .replace(/ğŸ¦/g, '<i class="fab fa-twitter"></i>')       // íŠ¸ìœ„í„°
    .replace(/ğŸ’¼/g, '<i class="fab fa-linkedin"></i>')      // LinkedIn
    .replace(/ğŸ’¬/g, '<i class="fas fa-comment"></i>')       // ì¹´ì¹´ì˜¤í†¡
    .replace(/ğŸ¥/g, '<i class="fab fa-youtube"></i>')       // ìœ íŠœë¸Œ ë¡±í¼
    .replace(/ğŸ“±/g, '<i class="fas fa-mobile-alt"></i>')    // ìœ íŠœë¸Œ ìˆí¼
    .replace(/ğŸ“–/g, '<i class="fas fa-book-open"></i>')     // ë¸ŒëŸ°ì¹˜
    .replace(/ğŸµ/g, '<i class="fab fa-tiktok"></i>');       // í‹±í†¡
}

function switchTab(platform, eventOrElement) {
  // ëª¨ë“  íƒ­ ë²„íŠ¼ ë¹„í™œì„±í™”
  document.querySelectorAll('.tab-button').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // ëª¨ë“  íƒ­ ì½˜í…ì¸  ìˆ¨ê¸°ê¸°
  document.querySelectorAll('.tab-content').forEach(content => {
    content.classList.add('hidden');
  });
  
  // ì„ íƒëœ íƒ­ í™œì„±í™”
  if (eventOrElement && eventOrElement.target) {
    // ì´ë²¤íŠ¸ ê°ì²´ì¸ ê²½ìš°
    eventOrElement.target.classList.add('active');
  } else if (eventOrElement && eventOrElement.classList) {
    // DOM ìš”ì†Œì¸ ê²½ìš°
    eventOrElement.classList.add('active');
  } else {
    // ë¬¸ìì—´ë§Œ ì „ë‹¬ëœ ê²½ìš° - í•´ë‹¹ íƒ­ ë²„íŠ¼ ì°¾ê¸°
    const tabButton = document.querySelector(`[onclick*="switchTab('${platform}'"]`);
    if (tabButton) {
      tabButton.classList.add('active');
    }
  }
  
  // âœ… null ì²´í¬ ì¶”ê°€
  const tabContent = document.getElementById(`tab-${platform}`);
  if (tabContent) {
    tabContent.classList.remove('hidden');
  } else {
    console.error(`Tab content not found: tab-${platform}`);
  }
}

// displayResultsìš© í—¬í¼ í•¨ìˆ˜ (resultDataì—ì„œ ì°¸ì¡°)
function copyToClipboardFromResult(platform, platformName) {
  const content = resultData[platform];
  if (!content) {
    showToast('âŒ ë³µì‚¬í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤', 'error');
    return;
  }
  
  navigator.clipboard.writeText(content).then(() => {
    showToast(`âœ… ${platformName || 'ì½˜í…ì¸ '} ë³µì‚¬ë¨!`, 'success');
  }).catch(err => {
    console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
    showToast('âŒ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
  });
}

// âœ… displaySingleContentResultìš© í—¬í¼ í•¨ìˆ˜ë“¤
function copyToClipboardFromSingle(contentIndex, platform, platformName) {
  const content = document.getElementById(`content_${contentIndex}_${platform}`)?.textContent;
  if (!content) {
    showToast('âŒ ë³µì‚¬í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤', 'error');
    return;
  }
  
  navigator.clipboard.writeText(content).then(() => {
    showToast(`âœ… ${platformName || 'ì½˜í…ì¸ '} ë³µì‚¬ë¨!`, 'success');
  }).catch(err => {
    console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
    showToast('âŒ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
  });
}

function downloadAsTextFromSingle(contentIndex, platform, filename) {
  const content = document.getElementById(`content_${contentIndex}_${platform}`)?.textContent;
  if (!content) {
    showToast('âŒ ë‹¤ìš´ë¡œë“œí•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤', 'error');
    return;
  }
  
  const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename || `content_${platform}.txt`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  showToast('âœ… í…ìŠ¤íŠ¸ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!', 'success');
}

// âœ… displayBatchResultsìš© í—¬í¼ í•¨ìˆ˜
function copyContentFromBatch(contentIndex, platform, platformName) {
  // displayBatchResultsì—ì„œ ìƒì„±í•œ ì½˜í…ì¸  ì˜ì—­ì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ
  const contentElements = document.querySelectorAll('.bg-gray-50.rounded-lg.border');
  if (!contentElements || contentElements.length === 0) {
    showToast('âŒ ë³µì‚¬í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤', 'error');
    return;
  }
  
  // contentIndexì— í•´ë‹¹í•˜ëŠ” ì˜ì—­ ì°¾ê¸°
  let targetContent = null;
  contentElements.forEach((el) => {
    const textContent = el.textContent || '';
    if (textContent.includes(platformName)) {
      const contentDiv = el.querySelector('.bg-white.p-4.rounded');
      if (contentDiv) {
        targetContent = contentDiv.textContent?.trim();
      }
    }
  });
  
  if (!targetContent) {
    showToast('âŒ ë³µì‚¬í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤', 'error');
    return;
  }
  
  navigator.clipboard.writeText(targetContent).then(() => {
    showToast(`âœ… ${platformName} ë³µì‚¬ë¨!`, 'success');
  }).catch(err => {
    console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
    showToast('âŒ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
  });
}

function downloadAsTextFromResult(platform, filename) {
  const content = resultData[platform];
  if (!content) {
    showToast('âŒ ë‹¤ìš´ë¡œë“œí•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤', 'error');
    return;
  }
  
  if (!filename) {
    const date = new Date().toISOString().split('T')[0];
    filename = `content_${date}.txt`;
  }
  
  const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  showToast('âœ… í…ìŠ¤íŠ¸ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!', 'success');
}

function copyToClipboard(content, platformName) {
  if (!content) {
    showToast('âŒ ë³µì‚¬í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤', 'error');
    return;
  }
  
  navigator.clipboard.writeText(content).then(() => {
    showToast(`âœ… ${platformName || 'ì½˜í…ì¸ '} ë³µì‚¬ë¨!`, 'success');
  }).catch(err => {
    console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
    showToast('âŒ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
  });
}

// ===================================
// ì½˜í…ì¸  ìˆ˜ì • ì—ë””í„°
// ===================================
function editContent(platform) {
  const display = document.getElementById(`content-display-${platform}`);
  const editor = document.getElementById(`content-editor-${platform}`);
  const actions = document.getElementById(`editor-actions-${platform}`);
  
  display.classList.add('hidden');
  editor.classList.remove('hidden');
  actions.classList.remove('hidden');
  
  // textarea ë†’ì´ ìë™ ì¡°ì ˆ
  editor.style.height = 'auto';
  editor.style.height = editor.scrollHeight + 'px';
  
  editor.focus();
  showToast('âœï¸ ìˆ˜ì • ëª¨ë“œ í™œì„±í™”', 'info');
}

function cancelEdit(platform) {
  const display = document.getElementById(`content-display-${platform}`);
  const editor = document.getElementById(`content-editor-${platform}`);
  const actions = document.getElementById(`editor-actions-${platform}`);
  
  // ì›ë³¸ ë³µêµ¬
  editor.value = resultData[platform];
  
  display.classList.remove('hidden');
  editor.classList.add('hidden');
  actions.classList.add('hidden');
  
  showToast('â†©ï¸ ìˆ˜ì • ì·¨ì†Œ', 'info');
}

function saveEdit(platform) {
  const display = document.getElementById(`content-display-${platform}`);
  const editor = document.getElementById(`content-editor-${platform}`);
  const actions = document.getElementById(`editor-actions-${platform}`);
  
  const newContent = editor.value;
  
  if (!newContent.trim()) {
    showToast('âŒ ë‚´ìš©ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤', 'error');
    return;
  }
  
  // resultData ì—…ë°ì´íŠ¸
  resultData[platform] = newContent;
  
  // âœ… íˆìŠ¤í† ë¦¬ DBì—ë„ ì—…ë°ì´íŠ¸
  if (window.lastGenerationId) {
    updateHistoryContent(window.lastGenerationId, platform, newContent);
  }
  
  // ë””ìŠ¤í”Œë ˆì´ ì—…ë°ì´íŠ¸
  display.innerHTML = formatContent(newContent);
  
  display.classList.remove('hidden');
  editor.classList.add('hidden');
  actions.classList.add('hidden');
  
  // âœ… ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨ í”Œë˜ê·¸ ì„¤ì • (í•­ìƒ ì‹¤í–‰)
  window.needsCalendarRefresh = true;
  
  // âœ… ìº˜ë¦°ë”ê°€ ì—´ë ¤ìˆìœ¼ë©´ ì¦‰ì‹œ ì´ë²¤íŠ¸ ìƒˆë¡œê³ ì¹¨
  if (window.calendarInstance) {
    console.log('ğŸ”„ ìº˜ë¦°ë” ì´ë²¤íŠ¸ ìƒˆë¡œê³ ì¹¨ ì‹œì‘...');
    setTimeout(() => {
      window.calendarInstance.refetchEvents();
      window.needsCalendarRefresh = false; // ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ í›„ í”Œë˜ê·¸ í•´ì œ
      console.log('âœ… ìº˜ë¦°ë” ì´ë²¤íŠ¸ ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ');
    }, 500);
  } else {
    console.log('ğŸ“Œ ìº˜ë¦°ë”ê°€ ìˆ¨ê²¨ì ¸ ìˆìŒ. ë‹¤ìŒ ì—´ë¦´ ë•Œ ìƒˆë¡œê³ ì¹¨ ì˜ˆì •');
  }
  
  // âœ… window.contentHistoryë„ ì—…ë°ì´íŠ¸ (íˆìŠ¤í† ë¦¬ ëª¨ë‹¬ìš©)
  if (window.contentHistory && window.lastGenerationId) {
    const historyItem = window.contentHistory.find(h => h.id === window.lastGenerationId);
    if (historyItem && historyItem.results) {
      historyItem.results[platform] = newContent;
      console.log('âœ… window.contentHistory ì—…ë°ì´íŠ¸ ì™„ë£Œ');
    }
  }
  
  // âœ… íˆìŠ¤í† ë¦¬ ëª¨ë‹¬ì´ ì—´ë ¤ìˆìœ¼ë©´ íˆìŠ¤í† ë¦¬ ìƒˆë¡œê³ ì¹¨ (ì¦‰ì‹œ ë°˜ì˜)
  const historyModal = document.getElementById('historyModal');
  if (historyModal && !historyModal.classList.contains('hidden')) {
    console.log('ğŸ”„ íˆìŠ¤í† ë¦¬ ëª¨ë‹¬ì´ ì—´ë ¤ìˆì–´ì„œ íˆìŠ¤í† ë¦¬ ìƒˆë¡œê³ ì¹¨ ì‹œì‘...');
    setTimeout(() => {
      loadHistory();
      console.log('âœ… íˆìŠ¤í† ë¦¬ ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ');
    }, 500);
  }
  
  showToast('âœ… ìˆ˜ì • ë‚´ìš©ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
}

// âœ… íˆìŠ¤í† ë¦¬ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
async function updateHistoryContent(generationId, platform, newContent) {
  const user = window.currentUser;
  if (!user || !user.id) return;
  
  try {
    const response = await fetch('/api/history', {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        user_id: user.id,
        generation_id: generationId,
        platform: platform,
        content: newContent
      })
    });
    
    const data = await response.json();
    if (!data.success) {
      console.error('íˆìŠ¤í† ë¦¬ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', data.error);
    }
  } catch (error) {
    console.error('íˆìŠ¤í† ë¦¬ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
  }
}

// ===================================
// ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥
// ===================================
function downloadAsText(content, filename) {
  if (!content) {
    showToast('âŒ ë‹¤ìš´ë¡œë“œí•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤', 'error');
    return;
  }
  
  // filenameì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ìƒì„±
  if (!filename) {
    const date = new Date().toISOString().split('T')[0];
    filename = `content_${date}.txt`;
  }
  
  const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  showToast('âœ… í…ìŠ¤íŠ¸ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!', 'success');
}

function downloadAsWord(platform) {
  const content = resultData[platform];
  if (!content) {
    showToast('âŒ ë‹¤ìš´ë¡œë“œí•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤', 'error');
    return;
  }
  
  const platformNames = {
    blog: 'ë„¤ì´ë²„ë¸”ë¡œê·¸',
    instagram: 'ì¸ìŠ¤íƒ€ê·¸ë¨',
    instagram_feed: 'ì¸ìŠ¤íƒ€ê·¸ë¨ í”¼ë“œ',
    threads: 'ìŠ¤ë ˆë“œ',
    youtube: 'ìœ íŠœë¸Œìˆí¼',
    youtube_longform: 'ìœ íŠœë¸Œ ë¡±í¼',
    shortform_multi: 'ìˆí¼',
    tiktok: 'í‹±í†¡',
    instagram_reels: 'ì¸ìŠ¤íƒ€ ë¦´ìŠ¤',
    metadata_generation: 'ë©”íƒ€ë°ì´í„°',
    twitter: 'íŠ¸ìœ„í„°(X)' // âœ… ì‹ ê·œ ì¶”ê°€
  };
  
  const brand = document.getElementById('brand').value.trim() || 'content';
  const date = new Date().toISOString().split('T')[0];
  const filename = `${brand}_${platformNames[platform]}_${date}.doc`;
  
  // HTML í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (Wordê°€ ì½ì„ ìˆ˜ ìˆëŠ” í˜•ì‹)
  const htmlContent = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8">
      <title>${platformNames[platform]} - ${brand}</title>
      <style>
        body { 
          font-family: 'Malgun Gothic', sans-serif; 
          line-height: 1.8; 
          padding: 40px;
          max-width: 800px;
          margin: 0 auto;
        }
        h1 { 
          color: #333; 
          border-bottom: 3px solid #667eea;
          padding-bottom: 10px;
        }
        pre { 
          white-space: pre-wrap; 
          word-wrap: break-word;
          font-family: 'Malgun Gothic', sans-serif;
          background: #f5f5f5;
          padding: 20px;
          border-radius: 8px;
          line-height: 1.8;
        }
      </style>
    </head>
    <body>
      <h1>${platformNames[platform]} ì½˜í…ì¸ </h1>
      <p><strong>ë¸Œëœë“œ:</strong> ${brand}</p>
      <p><strong>ìƒì„±ì¼:</strong> ${date}</p>
      <hr>
      <pre>${content}</pre>
    </body>
    </html>
  `;
  
  const blob = new Blob(['\ufeff', htmlContent], { 
    type: 'application/msword;charset=utf-8' 
  });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  showToast('âœ… Word ë¬¸ì„œ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!', 'success');
}

function downloadAllAsExcel() {
  if (!resultData || Object.keys(resultData).length === 0) {
    showToast('âŒ ë‹¤ìš´ë¡œë“œí•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤', 'error');
    return;
  }
  
  const brand = document.getElementById('brand').value.trim() || 'content';
  const date = new Date().toISOString().split('T')[0];
  const filename = `${brand}_ì „ì²´ì½˜í…ì¸ _${date}.xls`;
  
  const platformNames = {
    blog: 'ë„¤ì´ë²„ë¸”ë¡œê·¸',
    instagram: 'ì¸ìŠ¤íƒ€ê·¸ë¨',
    instagram_feed: 'ì¸ìŠ¤íƒ€ê·¸ë¨ í”¼ë“œ',
    threads: 'ìŠ¤ë ˆë“œ',
    youtube: 'ìœ íŠœë¸Œìˆí¼',
    youtube_longform: 'ìœ íŠœë¸Œ ë¡±í¼',
    shortform_multi: 'ìˆí¼',
    tiktok: 'í‹±í†¡',
    instagram_reels: 'ì¸ìŠ¤íƒ€ ë¦´ìŠ¤',
    metadata_generation: 'ë©”íƒ€ë°ì´í„°',
    twitter: 'íŠ¸ìœ„í„°(X)' // âœ… ì‹ ê·œ ì¶”ê°€
  };
  
  // HTML í…Œì´ë¸” í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (Excelì´ ì½ì„ ìˆ˜ ìˆëŠ” í˜•ì‹)
  let tableRows = '';
  for (const [platform, content] of Object.entries(resultData)) {
    const escapedContent = content
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/\n/g, '<br>');
    
    tableRows += `
      <tr>
        <td style="vertical-align: top; font-weight: bold; background: #f0f0f0;">${platformNames[platform]}</td>
        <td style="vertical-align: top; white-space: pre-wrap;">${escapedContent}</td>
      </tr>
    `;
  }
  
  const htmlContent = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8">
      <style>
        table { 
          border-collapse: collapse; 
          width: 100%; 
          font-family: 'Malgun Gothic', sans-serif;
        }
        th, td { 
          border: 1px solid #ddd; 
          padding: 12px; 
          text-align: left;
        }
        th { 
          background-color: #667eea; 
          color: white;
          font-weight: bold;
        }
      </style>
    </head>
    <body>
      <h2>${brand} - ì½˜í…ì¸  ì „ì²´ ëª©ë¡</h2>
      <p>ìƒì„±ì¼: ${date}</p>
      <table>
        <thead>
          <tr>
            <th width="150">í”Œë«í¼</th>
            <th>ì½˜í…ì¸ </th>
          </tr>
        </thead>
        <tbody>
          ${tableRows}
        </tbody>
      </table>
    </body>
    </html>
  `;
  
  const blob = new Blob(['\ufeff', htmlContent], { 
    type: 'application/vnd.ms-excel;charset=utf-8' 
  });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  showToast('âœ… Excel íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!', 'success');
}

// ë°°ì¹˜ Excel ë‹¤ìš´ë¡œë“œ
function downloadBatchExcel() {
  if (!window.batchResults || window.batchResults.length === 0) {
    showToast('âŒ ë‹¤ìš´ë¡œë“œí•  ë°°ì¹˜ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
    return;
  }
  
  const brand = document.getElementById('brand').value.trim() || 'content';
  const date = new Date().toISOString().split('T')[0];
  const filename = `${brand}_ë°°ì¹˜ìƒì„±_${date}.xls`;
  
  const platformNames = {
    blog: 'ë„¤ì´ë²„ë¸”ë¡œê·¸',
    instagram: 'ì¸ìŠ¤íƒ€ê·¸ë¨',
    instagram_feed: 'ì¸ìŠ¤íƒ€ê·¸ë¨ í”¼ë“œ',
    threads: 'ìŠ¤ë ˆë“œ',
    youtube: 'ìœ íŠœë¸Œìˆí¼',
    youtube_longform: 'ìœ íŠœë¸Œ ë¡±í¼',
    shortform_multi: 'ìˆí¼',
    tiktok: 'í‹±í†¡',
    instagram_reels: 'ì¸ìŠ¤íƒ€ ë¦´ìŠ¤',
    metadata_generation: 'ë©”íƒ€ë°ì´í„°',
    twitter: 'íŠ¸ìœ„í„°(X)' // âœ… ì‹ ê·œ ì¶”ê°€
  };
  
  // HTML í…Œì´ë¸” í˜•ì‹ìœ¼ë¡œ ë³€í™˜
  let tableRows = '';
  
  window.batchResults.forEach((result) => {
    result.platforms.forEach((platform) => {
      const content = result.data[platform];
      if (!content) return;
      
      const escapedContent = content
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/\n/g, '<br>');
      
      tableRows += `
        <tr>
          <td style="vertical-align: top; font-weight: bold; background: #f0f0f0; text-align: center;">ì½˜í…ì¸  #${result.index}</td>
          <td style="vertical-align: top; font-weight: bold; background: #f9f9f9;">${platformNames[platform]}</td>
          <td style="vertical-align: top; white-space: pre-wrap;">${escapedContent}</td>
        </tr>
      `;
    });
  });
  
  const htmlContent = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8">
      <style>
        table { 
          border-collapse: collapse; 
          width: 100%; 
          font-family: 'Malgun Gothic', sans-serif;
        }
        th, td { 
          border: 1px solid #ddd; 
          padding: 12px; 
          text-align: left;
        }
        th { 
          background-color: #667eea; 
          color: white;
          font-weight: bold;
        }
      </style>
    </head>
    <body>
      <h2>${brand} - ë°°ì¹˜ ìƒì„± ì½˜í…ì¸  (${window.batchResults.length}ê°œ)</h2>
      <p>ìƒì„±ì¼: ${date}</p>
      <table>
        <thead>
          <tr>
            <th width="100">ë²ˆí˜¸</th>
            <th width="120">í”Œë«í¼</th>
            <th>ì½˜í…ì¸ </th>
          </tr>
        </thead>
        <tbody>
          ${tableRows}
        </tbody>
      </table>
    </body>
    </html>
  `;
  
  const blob = new Blob(['\ufeff', htmlContent], { 
    type: 'application/vnd.ms-excel;charset=utf-8' 
  });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  showToast('âœ… ë°°ì¹˜ Excel íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!', 'success');
}

// ===================================
// í† ìŠ¤íŠ¸ ë©”ì‹œì§€
// ===================================
function showToast(message, type = 'success') {
  const container = document.getElementById('toastContainer');
  
  // ì»¨í…Œì´ë„ˆê°€ ì—†ìœ¼ë©´ ìƒì„±
  if (!container) {
    const newContainer = document.createElement('div');
    newContainer.id = 'toastContainer';
    newContainer.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 10000;';
    document.body.appendChild(newContainer);
  }
  
  const colors = {
    success: '#10b981',
    error: '#ef4444',
    info: '#3b82f6',
    warning: '#f59e0b'
  };
  
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.style.cssText = `
    background: ${colors[type] || colors.success};
    color: white;
    padding: 16px 24px;
    border-radius: 8px;
    margin-bottom: 10px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    min-width: 300px;
    max-width: 500px;
    font-size: 14px;
    line-height: 1.5;
    white-space: pre-wrap;
    word-break: break-word;
    animation: slideIn 0.3s ease-out;
  `;
  toast.textContent = message;
  
  const toastContainer = document.getElementById('toastContainer');
  toastContainer.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease-out';
    setTimeout(() => {
      if (toastContainer.contains(toast)) {
        toastContainer.removeChild(toast);
      }
    }, 300);
  }, 5000); // 5ì´ˆë¡œ ì¦ê°€ (ê¸´ ë©”ì‹œì§€ ì½ê¸° ì‹œê°„ í™•ë³´)
}

// ===================================
// í…œí”Œë¦¿ ê´€ë¦¬
// ===================================
function loadTemplates() {
  const stored = localStorage.getItem(STORAGE_KEYS.TEMPLATES);
  if (stored) {
    try {
      customTemplates = JSON.parse(stored);
    } catch (e) {
      console.error('í…œí”Œë¦¿ ë¡œë“œ ì‹¤íŒ¨:', e);
      customTemplates = [];
    }
  }
}

function saveTemplates() {
  localStorage.setItem(STORAGE_KEYS.TEMPLATES, JSON.stringify(customTemplates));
}

function openTemplateModal() {
  const modal = document.getElementById('templateModal');
  const templateList = document.getElementById('templateList');
  
  // í…œí”Œë¦¿ í¸ì§‘ UI ìƒì„±
  const platforms = ['blog', 'instagram_feed', 'threads', 'twitter', 'linkedin', 'kakaotalk', 'brunch', 'tiktok', 'instagram_reels', 'youtube_shorts', 'youtube_longform', 'metadata_generation'];
  const platformNames = {
    blog: 'ë„¤ì´ë²„ ë¸”ë¡œê·¸',
    instagram: 'ì¸ìŠ¤íƒ€ê·¸ë¨ (ê¸°ì¡´)',
    instagram_feed: 'ì¸ìŠ¤íƒ€ê·¸ë¨ í”¼ë“œ',
    threads: 'ìŠ¤ë ˆë“œ',
    twitter: 'íŠ¸ìœ„í„°(X)',
    linkedin: 'LinkedIn',
    kakaotalk: 'ì¹´ì¹´ì˜¤í†¡',
    brunch: 'ë¸ŒëŸ°ì¹˜',
    tiktok: 'í‹±í†¡',
    instagram_reels: 'ì¸ìŠ¤íƒ€ê·¸ë¨ ë¦´ìŠ¤',
    youtube_shorts: 'ìœ íŠœë¸Œ ì‡¼ì¸ ',
    youtube_longform: 'ìœ íŠœë¸Œ ë¡±í¼',
    metadata_generation: 'ë©”íƒ€ë°ì´í„° ìƒì„±'
  };
  
  const platformIcons = {
    blog: '<i class="fas fa-blog text-blue-600 mr-2"></i>',
    instagram: '<i class="fab fa-instagram text-pink-600 mr-2"></i>',
    instagram_feed: '<i class="fab fa-instagram text-pink-600 mr-2"></i>',
    threads: '<i class="fas fa-at text-gray-800 mr-2"></i>',
    twitter: '<i class="fab fa-twitter text-blue-400 mr-2"></i>',
    linkedin: '<i class="fab fa-linkedin text-blue-700 mr-2"></i>',
    kakaotalk: '<i class="fas fa-comment-dots text-yellow-500 mr-2"></i>',
    brunch: '<i class="fas fa-book-open text-orange-600 mr-2"></i>',
    tiktok: '<i class="fab fa-tiktok text-black mr-2"></i>',
    instagram_reels: '<i class="fab fa-instagram text-purple-600 mr-2"></i>',
    youtube_shorts: '<i class="fab fa-youtube text-red-500 mr-2"></i>',
    youtube_longform: '<i class="fab fa-youtube text-red-600 mr-2"></i>',
    metadata_generation: '<i class="fas fa-tags text-blue-600 mr-2"></i>'
  };
  
  templateList.innerHTML = `
    <div class="space-y-6">
      <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4">
        <p class="font-semibold text-blue-800 mb-2">ğŸ’¡ ì‚¬ìš© ê°€ëŠ¥í•œ ë³€ìˆ˜:</p>
        <div class="text-sm text-blue-700 space-y-1">
          <p>â€¢ <code>{ë¸Œëœë“œëª…}</code> - ë¸Œëœë“œ/ì„œë¹„ìŠ¤/ìƒí’ˆëª…</p>
          <p>â€¢ <code>{í‚¤ì›Œë“œ}</code> - í•µì‹¬ í‚¤ì›Œë“œ</p>
          <p>â€¢ <code>{í†¤ì•¤ë§¤ë„ˆ}</code> - ì½˜í…ì¸  í†¤ì•¤ë§¤ë„ˆ</p>
          <p>â€¢ <code>{íƒ€ê²Ÿì—°ë ¹ëŒ€}</code> - íƒ€ê²Ÿ ì—°ë ¹ëŒ€</p>
          <p>â€¢ <code>{íƒ€ê²Ÿì„±ë³„}</code> - íƒ€ê²Ÿ ì„±ë³„</p>
          <p>â€¢ <code>{ì‚°ì—…ë¶„ì•¼}</code> - ì‚°ì—… ë¶„ì•¼</p>
        </div>
      </div>
      
      ${platforms.map(platform => {
        const custom = customTemplates.find(t => t.platform === platform);
        const template = custom ? custom.template : DEFAULT_TEMPLATES[platform];
        
        return `
          <div class="border border-gray-200 rounded-lg p-6 bg-white">
            <div class="flex justify-between items-center mb-4">
              <h4 class="text-lg font-bold text-gray-800">${platformIcons[platform] || ''}${platformNames[platform]}</h4>
              <div class="space-x-2">
                <button
                  onclick="resetTemplate('${platform}')"
                  class="px-3 py-1 bg-gray-500 text-white rounded hover:bg-gray-600 transition text-sm"
                >
                  ğŸ”„ ê¸°ë³¸ê°’
                </button>
                <button
                  onclick="saveTemplate('${platform}')"
                  class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 transition text-sm"
                >
                  ğŸ’¾ ì €ì¥
                </button>
              </div>
            </div>
            <textarea
              id="template-${platform}"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 font-mono text-sm"
              rows="${platform.includes('longform') || platform.includes('multi') || platform.includes('metadata') ? '20' : '15'}"
              placeholder="í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ì„ ì…ë ¥í•˜ì„¸ìš”..."
            >${template}</textarea>
          </div>
        `;
      }).join('')}
    </div>
  `;
  
  modal.classList.remove('hidden');
  modal.style.display = 'flex';
}

function saveTemplate(platform) {
  const textarea = document.getElementById(`template_${platform}`);
  if (!textarea) {
    showToast('âŒ í…œí”Œë¦¿ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
    return;
  }
  
  const template = textarea.value.trim();
  
  if (!template) {
    showToast('âŒ í…œí”Œë¦¿ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
    return;
  }
  
  if (template.length > 8000) {
    showToast('âŒ í…œí”Œë¦¿ì€ ìµœëŒ€ 8000ìê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤', 'error');
    return;
  }
  
  // ê¸°ì¡´ í…œí”Œë¦¿ ì œê±°
  customTemplates = customTemplates.filter(t => t.platform !== platform);
  
  // ìƒˆ í…œí”Œë¦¿ ì¶”ê°€
  customTemplates.push({ platform, template });
  
  saveTemplates();
  showToast(`âœ… ${platform} í…œí”Œë¦¿ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
  
  console.log(`âœ… í…œí”Œë¦¿ ì €ì¥ ì™„ë£Œ: ${platform} (${template.length}ì)`);
}

function resetTemplate(platform) {
  const textarea = document.getElementById(`template_${platform}`);
  if (!textarea) {
    showToast('âŒ í…œí”Œë¦¿ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
    return;
  }
  
  textarea.value = DEFAULT_TEMPLATES[platform] || '';
  
  // ì»¤ìŠ¤í…€ í…œí”Œë¦¿ì—ì„œ ì œê±°
  customTemplates = customTemplates.filter(t => t.platform !== platform);
  saveTemplates();
  
  showToast(`âœ… ${platform} í…œí”Œë¦¿ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
  
  console.log(`âœ… í…œí”Œë¦¿ ì´ˆê¸°í™” ì™„ë£Œ: ${platform}`);
}

// ===================================
// í”„ë¡œí•„ ê´€ë¦¬ (í™•ì¥ëœ êµ¬ì¡°)
// ===================================
function loadProfiles() {
  // âœ… ì‚¬ìš©ìë³„ í”„ë¡œí•„ ë¡œë”©
  if (!currentUser || !currentUser.id) {
    savedProfiles = [];
    return;
  }
  
  const profileKey = `${STORAGE_KEYS.PROFILES}_${currentUser.id}`;
  const stored = localStorage.getItem(profileKey);
  if (stored) {
    try {
      savedProfiles = JSON.parse(stored);
    } catch (e) {
      console.error('í”„ë¡œí•„ ë¡œë“œ ì‹¤íŒ¨:', e);
      savedProfiles = [];
    }
  }
}

// ğŸ”¥ ê¸°ì¡´ saveProfile í•¨ìˆ˜ëŠ” deprecated (ìƒˆ ëª¨ë‹¬ ì‹œìŠ¤í…œ ì‚¬ìš©)
// í•˜ìœ„ í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€í•˜ì§€ë§Œ ìƒˆ ì‹œìŠ¤í…œìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
function saveProfile() {
  console.warn('âš ï¸ saveProfile() is deprecated. Use openProfileSaveModal() instead.');
  openProfileSaveModal();
}

// ğŸ”¥ DEPRECATED: ë‹¨ì¼ í”„ë¡œí•„ ì‹œìŠ¤í…œ (í•˜ìœ„ í˜¸í™˜ì„±ìš©)
// ìƒˆë¡œìš´ ë‹¤ì¤‘ í”„ë¡œí•„ ì‹œìŠ¤í…œ(/api/profiles)ì„ ì‚¬ìš©í•˜ì„¸ìš”
async function saveProfileToDB(profile) {
  console.warn('âš ï¸ saveProfileToDB() is deprecated. This saves to old single-profile system.');
  console.warn('âš ï¸ Use the new multi-profile system: openProfileSaveModal()');
  
  // ê¸°ì¡´ ì½”ë“œëŠ” users í…Œì´ë¸”ì— ë®ì–´ì“°ê¸°ë§Œ í•¨ (ì‚¬ìš© ê¸ˆì§€)
  return;
}

// ğŸ”¥ DBì—ì„œ í”„ë¡œí•„ ë¡œë“œ í•¨ìˆ˜ ìˆ˜ì •
async function loadProfileFromDB(userId) {
  try {
    if (!userId) {
      const storedUser = localStorage.getItem('postflow_user');
      if (!storedUser) {
        console.log('âŒ ë¡œê·¸ì¸ ì •ë³´ ì—†ìŒ');
        return;
      }
      userId = JSON.parse(storedUser).id;
    }
    
    console.log('ğŸ“– í”„ë¡œí•„ ë¡œë“œ ì‹œì‘:', userId);
    
    const response = await fetch(`/api/profile?user_id=${userId}`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      }
    });
    
    const result = await response.json();
    console.log('ğŸ” API ì‘ë‹µ (11ê°œ í•„ë“œ í™•ì¸):', result);
    
    if (result.success && result.profile) {
      const p = result.profile;
      
      // ğŸ”¥ 11ê°œ í•„ë“œ ì •í™•í•œ ë§¤í•‘ (HTML IDì™€ DB ì»¬ëŸ¼ ë§¤í•‘)
      setElementValue('brandName', p.brand || '');  // âœ… brand â†’ brandName
      setElementValue('companyName', p.company_name || '');
      setElementValue('businessType', p.business_type || '');
      setElementValue('region', p.location || '');  // âœ… location â†’ region
      setElementValue('targetGender', p.target_gender || '');
      setElementValue('contact', p.contact || '');
      setElementValue('website', p.website || '');
      setElementValue('snsAccount', p.sns || '');  // âœ… sns â†’ snsAccount
      
      // í‚¤ì›Œë“œ ë°°ì—´ ì²˜ë¦¬ â†’ keywordAnalysisInputì— ì…ë ¥
      const keywordsStr = Array.isArray(p.keywords) 
        ? p.keywords.join(', ') 
        : (p.keywords || '');
      setElementValue('keywordAnalysisInput', keywordsStr);  // âœ… keywords â†’ keywordAnalysisInput
      
      setElementValue('toneAndManner', p.tone || '');  // âœ… tone â†’ toneAndManner
      setElementValue('targetAge', p.target_age || '');
      setElementValue('industry', p.industry || '');
      
      console.log('âœ… 11ê°œ í•„ë“œ ëª¨ë‘ ìë™ ì…ë ¥ ì™„ë£Œ');
    } else {
      console.log('âš ï¸ ì €ì¥ëœ í”„ë¡œí•„ì´ ì—†ìŠµë‹ˆë‹¤');
    }
  } catch (error) {
    console.error('âŒ í”„ë¡œí•„ ë¡œë“œ ì˜ˆì™¸:', error);
  }
}

// í—¬í¼ í•¨ìˆ˜ ì¶”ê°€
function setElementValue(id, value) {
  const element = document.getElementById(id);
  if (element) {
    element.value = value;
    return true;
  }
  console.warn(`Element not found: ${id}`);
  return false;
}

// âœ… í”„ë¡œí•„ ë¶ˆëŸ¬ì˜¤ê¸° ëª¨ë‹¬ (ìƒˆ ë‹¤ì¤‘ í”„ë¡œí•„ ì‹œìŠ¤í…œ ì‚¬ìš©)
async function openLoadProfileModal() {
  console.warn('âš ï¸ openLoadProfileModal() redirecting to new multi-profile system');
  openProfileListModal();
}

// âœ… DB í”„ë¡œí•„ì„ í¼ì— ì ìš© (loadProfileFromDB ì¬ì‚¬ìš©)
async function applyStoredProfile() {
  const userData = localStorage.getItem('postflow_user');
  if (!userData) {
    showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'error');
    return;
  }
  
  const user = JSON.parse(userData);
  const userId = user.id;
  
  // ê¸°ì¡´ loadProfileFromDB ì¬ì‚¬ìš©
  await loadProfileFromDB(userId);
  
  // ëª¨ë‹¬ ë‹«ê¸°
  closeProfileModal();
  
  showToast('í”„ë¡œí•„ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!', 'success');
}

// âœ… í”„ë¡œí•„ ëª¨ë‹¬ ë‹«ê¸°
function closeProfileModal() {
  const modal = document.getElementById('profileModal');
  modal.classList.add('hidden');
  modal.style.display = 'none';
}

// âš ï¸ êµ¬ë²„ì „ í•¨ìˆ˜ (DB ê¸°ë°˜ìœ¼ë¡œ êµì²´ë¨, í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€)
function loadProfile(id) {
  console.warn('âš ï¸ loadProfile() is deprecated. Use applyStoredProfile() instead.');
}

function deleteProfile(id) {
  console.warn('âš ï¸ deleteProfile() is deprecated.');
}

function exportProfiles() {
  if (savedProfiles.length === 0) {
    showToast('âŒ ë‚´ë³´ë‚¼ í”„ë¡œí•„ì´ ì—†ìŠµë‹ˆë‹¤', 'error');
    return;
  }
  
  const date = new Date().toISOString().split('T')[0];
  const filename = `í”„ë¡œí•„_ë°±ì—…_${date}.json`;
  
  const exportData = {
    version: '1.0',
    exportDate: new Date().toISOString(),
    profiles: savedProfiles
  };
  
  const blob = new Blob([JSON.stringify(exportData, null, 2)], { 
    type: 'application/json;charset=utf-8' 
  });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  showToast(`âœ… í”„ë¡œí•„ ${savedProfiles.length}ê°œ ë‚´ë³´ë‚´ê¸° ì™„ë£Œ!`, 'success');
}

function importProfiles(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const importData = JSON.parse(e.target.result);
      
      // ë²„ì „ ì²´í¬ ë° ë°ì´í„° ê²€ì¦
      if (!importData.profiles || !Array.isArray(importData.profiles)) {
        showToast('âŒ ì˜¬ë°”ë¥¸ í”„ë¡œí•„ íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤', 'error');
        return;
      }
      
      // ì¤‘ë³µ ì²´í¬ (ë¸Œëœë“œëª… ê¸°ì¤€)
      const existingBrands = new Set(savedProfiles.map(p => p.brand));
      const newProfiles = importData.profiles.filter(p => !existingBrands.has(p.brand));
      const duplicates = importData.profiles.length - newProfiles.length;
      
      if (newProfiles.length === 0) {
        showToast('âš ï¸ ëª¨ë“  í”„ë¡œí•„ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤', 'warning');
        return;
      }
      
      // ID ì¬ìƒì„± (ì¶©ëŒ ë°©ì§€)
      newProfiles.forEach(profile => {
        profile.id = Date.now() + Math.random();
      });
      
      // ê¸°ì¡´ í”„ë¡œí•„ì— ì¶”ê°€
      savedProfiles = [...savedProfiles, ...newProfiles];
      localStorage.setItem(STORAGE_KEYS.PROFILES, JSON.stringify(savedProfiles));
      
      openLoadProfileModal();
      
      let message = `âœ… ${newProfiles.length}ê°œ í”„ë¡œí•„ ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ!`;
      if (duplicates > 0) {
        message += ` (${duplicates}ê°œ ì¤‘ë³µ ì œì™¸)`;
      }
      showToast(message, 'success');
      
    } catch (error) {
      console.error('í”„ë¡œí•„ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error);
      showToast('âŒ íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
    }
  };
  
  reader.readAsText(file);
  event.target.value = ''; // ê°™ì€ íŒŒì¼ ì¬ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡
}

// ===================================
// íˆìŠ¤í† ë¦¬ ê´€ë¦¬
// ===================================
// âœ… DB ê¸°ë°˜ íˆìŠ¤í† ë¦¬ ë¡œë“œ (ë³´ì•ˆ ì ìš©)
async function loadHistory() {
  const userData = localStorage.getItem('postflow_user');
  if (!userData) {
    console.warn('âš ï¸ ë¡œê·¸ì¸ ì •ë³´ ì—†ìŒ - íˆìŠ¤í† ë¦¬ ë¡œë“œ ë¶ˆê°€');
    window.contentHistory = [];
    return;
  }
  
  const user = JSON.parse(userData);
  const userId = user.id;
  
  if (!userId) {
    console.warn('âš ï¸ ì‚¬ìš©ì ID ì—†ìŒ - íˆìŠ¤í† ë¦¬ ë¡œë“œ ë¶ˆê°€');
    window.contentHistory = [];
    return;
  }
  
  try {
    console.log('ğŸ“– íˆìŠ¤í† ë¦¬ ì¡°íšŒ ì‹œì‘:', userId);
    
    const response = await fetch(`/api/history?user_id=${userId}`);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    const result = await response.json();
    console.log('âœ… DB íˆìŠ¤í† ë¦¬:', result);
    
    if (!result.success) {
      console.warn('âš ï¸ íˆìŠ¤í† ë¦¬ ì¡°íšŒ ì‹¤íŒ¨:', result.error);
      window.contentHistory = [];
      return;
    }
    
    // ğŸ”¥ í•µì‹¬ ìˆ˜ì •: DB ë°ì´í„°ë¥¼ í”„ë¡ íŠ¸ì—”ë“œ í˜•ì‹ìœ¼ë¡œ ë³€í™˜ + ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
    window.contentHistory = (result.data || []).map(item => {
      return {
        id: item.id,
        brand: item.brand || '',
        keywords: item.keywords || '',
        platforms: Array.isArray(item.platforms) ? item.platforms : (item.platforms ? [item.platforms] : []),
        results: item.results || {},
        createdAt: item.created_at || item.createdAt || new Date().toISOString()  // â† ìŠ¤ë„¤ì´í¬ ì¼€ì´ìŠ¤ â†’ ì¹´ë©œ ì¼€ì´ìŠ¤
      };
    });
    
    console.log(`âœ… íˆìŠ¤í† ë¦¬ ë³€í™˜ ì™„ë£Œ: ${window.contentHistory.length}ê°œ`);
    console.log('ğŸ“Š ë³€í™˜ëœ ë°ì´í„° ìƒ˜í”Œ:', window.contentHistory[0]);
    console.log('ğŸŒ window.contentHistory ì „ì—­ ì €ì¥ ì™„ë£Œ');
    
  } catch (error) {
    console.error('âŒ íˆìŠ¤í† ë¦¬ ë¡œë“œ ì‹¤íŒ¨:', error);
    window.contentHistory = [];
  }
}

// âœ… DB ê¸°ë°˜ íˆìŠ¤í† ë¦¬ ì €ì¥ (ë³´ì•ˆ ì ìš©)
async function saveToHistory(formData, results) {
  const userData = localStorage.getItem('postflow_user');
  if (!userData) {
    console.warn('âš ï¸ ë¡œê·¸ì¸ ì •ë³´ ì—†ìŒ - íˆìŠ¤í† ë¦¬ ì €ì¥ ë¶ˆê°€');
    return;
  }
  
  const user = JSON.parse(userData);
  const userId = user.id;
  
  if (!userId) {
    console.warn('âš ï¸ ì‚¬ìš©ì ID ì—†ìŒ - íˆìŠ¤í† ë¦¬ ì €ì¥ ë¶ˆê°€');
    return;
  }
  
  const historyItem = {
    user_id: userId, // âœ… ë³´ì•ˆ: user_id ì¶”ê°€
    brand: formData.brand,
    keywords: formData.keywords,
    platforms: formData.platforms,
    results: results,
    created_at: new Date().toISOString()
  };
  
  try {
    console.log('ğŸ’¾ íˆìŠ¤í† ë¦¬ ì €ì¥ ì‹œì‘:', historyItem);
    console.log('ğŸ“Š ìƒì„¸ ë°ì´í„°:', {
      user_id: userId,
      brand: formData.brand,
      keywords: formData.keywords,
      platforms: formData.platforms,
      results_keys: Object.keys(results || {})
    });
    
    const response = await fetch('/api/history', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(historyItem)
    });
    
    console.log('ğŸ“¡ API ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);
    
    if (!response.ok) {
      const errorData = await response.json();
      console.error('âŒ API ì—ëŸ¬ ì‘ë‹µ:', errorData);
      throw new Error(`HTTP ${response.status}: ${errorData.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
    }
    
    const result = await response.json();
    console.log('âœ… íˆìŠ¤í† ë¦¬ ì €ì¥ ì™„ë£Œ:', result);
    
    // âœ… generation_idë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (ìº˜ë¦°ë” ë“±ë¡ìš©)
    window.lastGenerationId = result.id;
    console.log('ğŸ“ Generation ID ì €ì¥:', window.lastGenerationId);
    
    // ë¡œì»¬ ë°°ì—´ ì—…ë°ì´íŠ¸ (UI ì¦‰ì‹œ ë°˜ì˜)
    contentHistory.unshift({
      id: result.id || Date.now(),
      brand: formData.brand,
      keywords: formData.keywords,
      platforms: formData.platforms,
      results: results,
      createdAt: new Date().toISOString()
    });
    
    if (contentHistory.length > 50) {
      contentHistory = contentHistory.slice(0, 50);
    }
    
    
    // âœ… ì €ì¥ëœ ID ë°˜í™˜ (ìº˜ë¦°ë” ë“±ë¡ìš©)
    return { success: true, id: result.id };
    
  } catch (error) {
    console.error('âŒ íˆìŠ¤í† ë¦¬ ì €ì¥ ì‹¤íŒ¨:', error);
    return { success: false, error: error.message };
  }
}

// âœ… DB ê¸°ë°˜ íˆìŠ¤í† ë¦¬ ëª¨ë‹¬ (ìë™ ë¡œë“œ)
async function openHistoryModal() {
  console.log('ğŸ”µ openHistoryModal í˜¸ì¶œë¨');
  
  const modal = document.getElementById('historyModal');
  const historyList = document.getElementById('historyList');
  
  // ğŸ”¥ í•µì‹¬ ìˆ˜ì •: ëª¨ë‹¬ì„ body ì§ì†ìœ¼ë¡œ ì´ë™ (ë¶€ëª¨ì˜ display:none ì˜í–¥ ì°¨ë‹¨)
  if (modal.parentElement !== document.body) {
    document.body.appendChild(modal);
    console.log('âœ… historyModalì„ body ì§ì†ìœ¼ë¡œ ì´ë™');
  }
  
  console.log('ğŸ”µ modal:', modal);
  console.log('ğŸ”µ historyList:', historyList);
  
  if (!modal || !historyList) {
    console.error('âŒ íˆìŠ¤í† ë¦¬ ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
    showToast('íˆìŠ¤í† ë¦¬ ëª¨ë‹¬ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
    return;
  }
  
  // ê²€ìƒ‰/í•„í„° ì´ˆê¸°í™” (UI ì œê±°ë¡œ ì£¼ì„ ì²˜ë¦¬)
  // document.getElementById('historySearch').value = '';
  // document.querySelectorAll('.history-platform-filter').forEach(cb => cb.checked = true);
  // document.getElementById('historySortOrder').value = 'newest';
  
  // ë¡œë”© í‘œì‹œ
  historyList.innerHTML = '<p class="text-gray-500 text-center py-8">ğŸ”„ íˆìŠ¤í† ë¦¬ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
  
  // âœ… íˆìŠ¤í† ë¦¬ ëª¨ë‹¬ í‘œì‹œ (z-index: 9000)
  modal.classList.remove('hidden');
  modal.classList.add('flex');
  
  // ğŸ”¥ CRITICAL: setAttributeë¡œ ê°•ì œ ì„¤ì • (CSS !important ìš°ì„ ìˆœìœ„ ë¬¸ì œ í•´ê²°)
  modal.setAttribute('style', 'display: flex !important; visibility: visible !important; position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; width: 100vw !important; height: 100vh !important; background-color: rgba(0, 0, 0, 0.5) !important; z-index: 9999 !important; align-items: center !important; justify-content: center !important; opacity: 1 !important;');
  
  console.log('ğŸ”µ ëª¨ë‹¬ ê°•ì œ í‘œì‹œ ì™„ë£Œ - display:', modal.style.display);
  console.log('ğŸ”µ ëª¨ë‹¬ visibility:', modal.style.visibility);
  console.log('ğŸ”µ ëª¨ë‹¬ classList:', modal.classList.toString());
  
  // DBì—ì„œ íˆìŠ¤í† ë¦¬ ë¡œë“œ
  await loadHistory();
  
  console.log('ğŸ”µ íˆìŠ¤í† ë¦¬ ë¡œë“œ ì™„ë£Œ, window.contentHistory:', window.contentHistory?.length || 0);
  
  // ë Œë”ë§
  renderHistory();
  
  console.log('ğŸ”µ ë Œë”ë§ ì™„ë£Œ');
}

function renderHistory() {
  const historyList = document.getElementById('historyList');
  
  console.log('ğŸ”µ renderHistory ì‹œì‘, window.contentHistory:', window.contentHistory?.length || 0);
  
  if (!window.contentHistory || window.contentHistory.length === 0) {
    historyList.innerHTML = '<p class="text-gray-500 text-center py-8">ìƒì„± íˆìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
    console.log('ğŸ”µ íˆìŠ¤í† ë¦¬ ì—†ìŒ - ë¹ˆ ë©”ì‹œì§€ í‘œì‹œ');
    return;
  }
  
  // ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬ (ê²€ìƒ‰/í•„í„° ê¸°ëŠ¥ ì œê±°)
  const sorted = [...window.contentHistory].sort((a, b) => 
    new Date(b.createdAt) - new Date(a.createdAt)
  );
  
  console.log('ğŸ”µ ì •ë ¬ ì™„ë£Œ:', sorted.length, 'ê°œ');
  
  // ğŸ”¥ í”Œë«í¼ í‘œì‹œëª… í™•ì¥ (FontAwesome ì•„ì´ì½˜ ì‚¬ìš©, ì½˜í…ì¸  ë¸”ë¡ê³¼ ë™ì¼)
  const platformNames = {
    blog: '<i class="fas fa-blog text-blue-600 mr-2"></i>ë„¤ì´ë²„ ë¸”ë¡œê·¸',
    instagram: '<i class="fab fa-instagram text-pink-600 mr-2"></i>ì¸ìŠ¤íƒ€ê·¸ë¨',
    instagram_feed: '<i class="fab fa-instagram text-pink-600 mr-2"></i>ì¸ìŠ¤íƒ€ê·¸ë¨ í”¼ë“œ',
    instagram_reels: '<i class="fab fa-instagram text-purple-600 mr-2"></i>ì¸ìŠ¤íƒ€ ë¦´ìŠ¤',
    threads: '<i class="fas fa-at text-gray-800 mr-2"></i>ìŠ¤ë ˆë“œ',
    twitter: '<i class="fab fa-twitter text-blue-400 mr-2"></i>íŠ¸ìœ„í„°(X)',
    linkedin: '<i class="fab fa-linkedin text-blue-700 mr-2"></i>LinkedIn',
    kakaotalk: '<i class="fas fa-comment-dots text-yellow-500 mr-2"></i>ì¹´ì¹´ì˜¤í†¡',
    brunch: '<i class="fas fa-book-open text-orange-600 mr-2"></i>ë¸ŒëŸ°ì¹˜',
    tiktok: '<i class="fab fa-tiktok text-black mr-2"></i>í‹±í†¡',
    youtube: '<i class="fab fa-youtube text-red-600 mr-2"></i>ìœ íŠœë¸Œ',
    youtube_shorts: '<i class="fab fa-youtube text-red-500 mr-2"></i>ìœ íŠœë¸Œ ì‡¼ì¸ ',
    youtube_longform: '<i class="fab fa-youtube text-red-600 mr-2"></i>ìœ íŠœë¸Œ ë¡±í¼',
    metadata_generation: '<i class="fas fa-tags text-blue-600 mr-2"></i>ë©”íƒ€ë°ì´í„° ìƒì„±',
    shortform_multi: '<i class="fas fa-film text-purple-600 mr-2"></i>ìˆí¼ í†µí•©' // ë ˆê±°ì‹œ ë°ì´í„°ìš©
  };
  
  historyList.innerHTML = sorted.map(item => {
    const itemPlatforms = Array.isArray(item.platforms) ? item.platforms : [item.platforms];
    const keywordsDisplay = Array.isArray(item.keywords) 
      ? item.keywords.join(', ') 
      : (item.keywords || '');
    
    // ğŸ”¥ UX ê°œì„ : ë¸Œëœë“œëª… + í‚¤ì›Œë“œ ë¯¸ë¦¬ë³´ê¸° (ê°€ë…ì„± í–¥ìƒ)
    const titleDisplay = keywordsDisplay 
      ? `${item.brand || 'ë¸Œëœë“œëª… ì—†ìŒ'} (${keywordsDisplay.substring(0, 30)}${keywordsDisplay.length > 30 ? '...' : ''})`
      : (item.brand || 'ë¸Œëœë“œëª… ì—†ìŒ');
    
    return `
    <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition">
      <div class="flex justify-between items-start mb-2">
        <div class="flex-1">
          <h4 class="font-bold text-gray-800 text-lg">${titleDisplay}</h4>
          <div class="flex flex-wrap gap-1 mt-1">
            ${itemPlatforms.map(p => `<span class="text-xs px-2 py-1 bg-purple-100 text-purple-700 rounded">${platformNames[p] || p}</span>`).join('')}
          </div>
        </div>
        <div class="flex gap-2 ml-4">
          <button
            onclick="viewHistory('${item.id}')"
            class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition text-sm whitespace-nowrap"
          >
            ğŸ‘ ë³´ê¸°
          </button>
          <button
            onclick="openDateTimeModal('${item.id}', '${itemPlatforms[0] || 'blog'}')"
            class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 transition text-sm whitespace-nowrap"
            title="ë°œí–‰ ì˜ˆì •ì¼ ì„¤ì •"
          >
            ğŸ“… ì˜ˆì •ì¼
          </button>
          <button
            onclick="deleteHistory('${item.id}')"
            class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 transition text-sm whitespace-nowrap"
          >
            ğŸ—‘ ì‚­ì œ
          </button>
        </div>
      </div>
      <p class="text-xs text-gray-500">
        <i class="fas fa-clock mr-1"></i>${(() => {
          const date = new Date(item.createdAt);
          // UTC ì‹œê°„ì— 9ì‹œê°„ ì¶”ê°€ (KST)
          const kstDate = new Date(date.getTime() + (9 * 60 * 60 * 1000));
          return kstDate.toLocaleString('ko-KR', { 
            year: 'numeric',
            month: '2-digit', 
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: true
          });
        })()}
      </p>
    </div>
  `;
  }).join('');
  
  console.log('ğŸ”µ historyList HTML ê¸¸ì´:', historyList.innerHTML.length);
  console.log('ğŸ”µ historyList ì²« 100ì:', historyList.innerHTML.substring(0, 100));
}

function exportHistoryAsExcel() {
  if (contentHistory.length === 0) {
    showToast('âŒ ë‚´ë³´ë‚¼ íˆìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
    return;
  }
  
  const date = new Date().toISOString().split('T')[0];
  const filename = `ì½˜í…ì¸ ìƒì„±_íˆìŠ¤í† ë¦¬_${date}.xls`;
  
  const platformNames = {
    blog: 'ë„¤ì´ë²„ë¸”ë¡œê·¸',
    instagram: 'ì¸ìŠ¤íƒ€ê·¸ë¨',
    instagram_feed: 'ì¸ìŠ¤íƒ€ê·¸ë¨ í”¼ë“œ',
    threads: 'ìŠ¤ë ˆë“œ',
    youtube: 'ìœ íŠœë¸Œìˆí¼',
    youtube_longform: 'ìœ íŠœë¸Œ ë¡±í¼',
    shortform_multi: 'ìˆí¼',
    tiktok: 'í‹±í†¡',
    instagram_reels: 'ì¸ìŠ¤íƒ€ ë¦´ìŠ¤',
    metadata_generation: 'ë©”íƒ€ë°ì´í„°',
    twitter: 'íŠ¸ìœ„í„°(X)' // âœ… ì‹ ê·œ ì¶”ê°€
  };
  
  // HTML í…Œì´ë¸” í˜•ì‹
  let tableRows = contentHistory.map(item => {
    const platformsText = item.platforms.map(p => platformNames[p]).join(', ');
    const contentSummary = Object.entries(item.results)
      .map(([platform, content]) => `[${platformNames[platform]}]\n${content.substring(0, 100)}...`)
      .join('\n\n');
    
    return `
      <tr>
        <td>${(() => {
          const date = new Date(item.createdAt);
          // UTC ì‹œê°„ì— 9ì‹œê°„ ì¶”ê°€ (KST)
          const kstDate = new Date(date.getTime() + (9 * 60 * 60 * 1000));
          return kstDate.toLocaleString('ko-KR', { 
            year: 'numeric',
            month: '2-digit', 
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: true
          });
        })()}</td>
        <td>${item.brand}</td>
        <td>${item.keywords || ''}</td>
        <td>${platformsText}</td>
        <td style="white-space: pre-wrap;">${contentSummary}</td>
      </tr>
    `;
  }).join('');
  
  const htmlContent = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8">
      <style>
        table { border-collapse: collapse; width: 100%; font-family: 'Malgun Gothic', sans-serif; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: top; }
        th { background-color: #667eea; color: white; font-weight: bold; }
      </style>
    </head>
    <body>
      <h2>ì½˜í…ì¸  ìƒì„± íˆìŠ¤í† ë¦¬</h2>
      <p>ë‚´ë³´ë‚¸ ë‚ ì§œ: ${date}</p>
      <table>
        <thead>
          <tr>
            <th width="150">ìƒì„±ì¼ì‹œ</th>
            <th width="120">ë¸Œëœë“œëª…</th>
            <th width="150">í‚¤ì›Œë“œ</th>
            <th width="120">í”Œë«í¼</th>
            <th>ì½˜í…ì¸  ë¯¸ë¦¬ë³´ê¸°</th>
          </tr>
        </thead>
        <tbody>
          ${tableRows}
        </tbody>
      </table>
    </body>
    </html>
  `;
  
  const blob = new Blob(['\ufeff', htmlContent], { 
    type: 'application/vnd.ms-excel;charset=utf-8' 
  });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  showToast('âœ… íˆìŠ¤í† ë¦¬ Excel ë‚´ë³´ë‚´ê¸° ì™„ë£Œ!', 'success');
}

function viewHistory(id) {
  console.log('ğŸ”µ viewHistory ì‹¤í–‰:', id);
  
  // ğŸ”¥ ì „ì—­ ë³€ìˆ˜ í™•ì¸
  if (!window.contentHistory || window.contentHistory.length === 0) {
    console.error('âŒ window.contentHistoryê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!');
    showToast('íˆìŠ¤í† ë¦¬ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
    return;
  }
  
  const item = window.contentHistory.find(h => h.id === id);
  if (!item) {
    console.error('âŒ íˆìŠ¤í† ë¦¬ í•­ëª© ì—†ìŒ:', id);
    showToast('í•´ë‹¹ íˆìŠ¤í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
    return;
  }
  
  console.log('âœ… íˆìŠ¤í† ë¦¬ í•­ëª© ë°œê²¬:', item);
  
  // âœ… generation_id ì €ì¥ (ìº˜ë¦°ë” ë“±ë¡ ë° ìˆ˜ì • ê¸°ëŠ¥ì— í•„ìš”)
  window.lastGenerationId = id;
  resultData = item.results;
  
  // ğŸ”¥ contentBlocks ë°°ì—´ ì´ˆê¸°í™” (ìº˜ë¦°ë” ë“±ë¡ ê¸°ëŠ¥ì— í•„ìš”)
  contentBlocks = [{
    generationId: id,
    images: [],
    platforms: item.platforms || [],
    keywords: item.keywords || '',
    brand: item.brand || '',
    topic: '',
    description: ''
  }];
  console.log('âœ… contentBlocks ì´ˆê¸°í™” ì™„ë£Œ:', contentBlocks[0]);
  
  // ğŸ”¥ í™”ë©´ ëª¨ë“œ ì „í™˜: ìº˜ë¦°ë” ë·° â†’ ì½˜í…ì¸  ë·°
  const calendarWrapper = document.getElementById('calendarWrapper');
  const mainContent = document.querySelector('.main-content');
  const leftPanel = document.querySelector('.left-panel');
  
  // ìº˜ë¦°ë” ìˆ¨ê¸°ê¸°
  if (calendarWrapper) {
    calendarWrapper.classList.add('hidden');
    calendarWrapper.style.display = 'none';
    console.log('âœ… ìº˜ë¦°ë” ìˆ¨ê¹€');
  }
  
  // ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ í‘œì‹œ
  if (mainContent) {
    mainContent.classList.remove('hidden');
    mainContent.style.setProperty('display', 'block', 'important');
    console.log('âœ… ë©”ì¸ ì½˜í…ì¸  í‘œì‹œ');
  }
  
  // ì¢Œì¸¡ íŒ¨ë„ í‘œì‹œ (ì…ë ¥ í¼)
  if (leftPanel) {
    leftPanel.classList.remove('hidden');
    leftPanel.style.setProperty('display', 'block', 'important');
    console.log('âœ… ì¢Œì¸¡ íŒ¨ë„ í‘œì‹œ');
  }
  
  // ğŸ”¥ ê²°ê³¼ ì˜ì—­ì„ ì •ìƒ ìœ„ì¹˜ë¡œ ì´ë™ ë° í‘œì‹œ
  const resultArea = document.getElementById('resultArea');
  if (resultArea) {
    // ğŸ”¥ í•µì‹¬: resultAreaê°€ ì´ìƒí•œ ê³³ì— ìˆìœ¼ë©´ ì›ë˜ ìœ„ì¹˜ë¡œ ì´ë™
    const currentParent = resultArea.parentElement;
    if (currentParent && currentParent.id === 'emailVerificationModal') {
      console.log('âš ï¸ resultAreaê°€ emailVerificationModal ì•ˆì— ìˆìŒ! ë¹¼ë‚´ê¸° ì‹œì‘...');
      
      // í‘¸í„° ì°¾ê¸°
      const footer = document.querySelector('footer');
      if (footer) {
        // í‘¸í„° ë°”ë¡œ ì•ì— ì‚½ì…
        footer.parentElement.insertBefore(resultArea, footer);
        console.log('âœ… resultAreaë¥¼ í‘¸í„° ë°”ë¡œ ìœ„ë¡œ ì´ë™ ì™„ë£Œ');
      } else {
        // main-content ì°¾ê¸° (ì½˜í…ì¸  ë¸”ë¡ì´ ìˆëŠ” ê³³)
        const mainContent = document.querySelector('.main-content');
        if (mainContent) {
          // main-content ëì— ì¶”ê°€
          mainContent.appendChild(resultArea);
          console.log('âœ… resultAreaë¥¼ main-contentë¡œ ì´ë™ ì™„ë£Œ');
        } else {
          // ë‘˜ ë‹¤ ì—†ìœ¼ë©´ bodyì— ì¶”ê°€
          document.body.appendChild(resultArea);
          console.log('âœ… resultAreaë¥¼ bodyë¡œ ì´ë™ ì™„ë£Œ');
        }
      }
    }
    
    resultArea.classList.remove('hidden');
    resultArea.style.cssText = `
      display: block !important;
      width: 100% !important;
      max-width: 1200px !important;
      margin: 20px auto !important;
      padding: 32px !important;
      background: white !important;
      border-radius: 16px !important;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1) !important;
    `;
    console.log('âœ… ê²°ê³¼ ì˜ì—­ ê°•ì œ í‘œì‹œ');
  }
  
  // ì½˜í…ì¸  ë Œë”ë§ (ë‚ ì§œ ì •ë³´ í¬í•¨)
  displayResults(item.results, item.platforms, {
    createdAt: item.created_at,
    scheduledDate: item.scheduled_date
  });
  console.log('âœ… displayResults í˜¸ì¶œ ì™„ë£Œ (ìƒì„±ì¼:', item.created_at, ', ì˜ˆì •ì¼:', item.scheduled_date, ')');
  
  // ëª¨ë‹¬ ë‹«ê¸°
  closeModal('historyModal');
  console.log('âœ… íˆìŠ¤í† ë¦¬ ëª¨ë‹¬ ë‹«ê¸°');
  
  // í™”ë©´ ìƒíƒœ ë³€ê²½
  window.isCalendarView = false;
  
  // ìŠ¤í¬ë¡¤ ì´ë™ (ì•½ê°„ ì§€ì—°)
  setTimeout(() => {
    if (resultArea) {
      resultArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
      console.log('âœ… ê²°ê³¼ ì˜ì—­ìœ¼ë¡œ ìŠ¤í¬ë¡¤ ì™„ë£Œ');
      
      // ìµœì¢… í¬ê¸° í™•ì¸
      const rect = resultArea.getBoundingClientRect();
      console.log('ğŸ“Š ìµœì¢… resultArea í¬ê¸°:', {
        width: rect.width,
        height: rect.height,
        top: rect.top
      });
    }
  }, 300);
  
  showToast('âœ… ì½˜í…ì¸ ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤', 'success');
  console.log('ğŸ‰ viewHistory ì‹¤í–‰ ì™„ë£Œ!');
}

// ì „ì—­ ë…¸ì¶œ í™•ì¸
window.viewHistory = viewHistory;

// ğŸ”¥ DB ê¸°ë°˜ íˆìŠ¤í† ë¦¬ ì‚­ì œ (ì‹¤ì œ ì‚­ì œ)
async function deleteHistory(id) {
  if (!confirm('ì´ íˆìŠ¤í† ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  
  const userData = localStorage.getItem('postflow_user');
  if (!userData) {
    showToast('âŒ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'error');
    return;
  }
  
  const user = JSON.parse(userData);
  const userId = user.id;
  
  try {
    console.log('ğŸ—‘ï¸ íˆìŠ¤í† ë¦¬ ì‚­ì œ ì‹œì‘:', id);
    
    // ğŸ”¥ ì‹¤ì œ DB ì‚­ì œ API í˜¸ì¶œ
    const response = await fetch(`/api/history?id=${id}&user_id=${userId}`, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' }
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    const result = await response.json();
    console.log('ğŸ“¡ ì‚­ì œ API ì‘ë‹µ:', result);
    
    if (!result.success) {
      showToast('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + result.error, 'error');
      return;
    }
    
    // âœ… DB ì‚­ì œ ì„±ê³µ í›„ì—ë§Œ ë¡œì»¬ ë°°ì—´ ì—…ë°ì´íŠ¸
    contentHistory = contentHistory.filter(h => h.id !== id);
    filterHistory();
    showToast('âœ… íˆìŠ¤í† ë¦¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    
    console.log('âœ… íˆìŠ¤í† ë¦¬ ì‚­ì œ ì™„ë£Œ:', id);
    
  } catch (error) {
    console.error('âŒ íˆìŠ¤í† ë¦¬ ì‚­ì œ ì˜¤ë¥˜:', error);
    showToast('âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
  }
}

// ===================================
// ëª¨ë‹¬ ê´€ë¦¬
// ===================================
function closeModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    // âœ… í™•ì‹¤í•œ ìˆ¨ê¹€ ì²˜ë¦¬ (!important ì‚¬ìš©)
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    modal.style.setProperty('display', 'none', 'important');
    modal.style.setProperty('visibility', 'hidden', 'important');
  }
}

// ===================================
// ê°œë³„ ì½˜í…ì¸  ë¬¸ì„œ ì—…ë¡œë“œ ì²˜ë¦¬ (NEW v7.0)
// ===================================

// ===================================
// ì „ì—­ í•¨ìˆ˜ ë…¸ì¶œ
// ===================================
window.removeImage = removeImage;
window.openImageEditor = openImageEditor;
window.applyImageFilter = applyImageFilter;
window.compressImage = compressImage;
window.saveEditedImage = saveEditedImage;
window.closeImageEditor = closeImageEditor;
window.switchTab = switchTab;
window.copyToClipboard = copyToClipboard;
window.closeModal = closeModal;
window.saveTemplate = saveTemplate;
window.resetTemplate = resetTemplate;
window.loadProfile = loadProfile;
window.deleteProfile = deleteProfile;
window.viewHistory = viewHistory;
window.deleteHistory = deleteHistory;
window.closeErrorModal = closeErrorModal;
window.retryGeneration = retryGeneration;
window.openHistoryModal = openHistoryModal;
window.closeHistoryModal = () => closeModal('historyModal');

// ì½˜í…ì¸  ë¸”ë¡ ìƒì„± í•¨ìˆ˜
window.generateContentBlocks = generateContentBlocks;
window.updateContentData = updateContentData;
window.suggestKeywordsForContent = suggestKeywordsForContent;

// ===================================
// íšŒì› ì¸ì¦ ë° ë“±ê¸‰ ê´€ë¦¬ (NEW v7.1)
// ===================================

// Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
const SUPABASE_URL = 'https://gmjbsndricdogtqsovnb.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdtamJzbmRyaWNkb2d0cXNvdm5iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyNzE1ODksImV4cCI6MjA4Mjg0NzU4OX0.naZnsBPYd84pdLoLAh-mEz_qerl5UakYs2FfVumnEJw';

// Supabase í´ë¼ì´ì–¸íŠ¸ (CDNì—ì„œ ë¡œë“œ)
let supabaseClient = null;

// ì‚¬ìš©ì ìƒíƒœ (í•˜ì´ë¸Œë¦¬ë“œ í”Œëœ) - ì „ì—­ ê°ì²´ë¡œ ë³€ê²½
window.currentUser = {
  id: null,
  isLoggedIn: false,
  isGuest: true,
  name: null,
  email: null,
  subscription_status: 'active', // ë‹¨ì¼ êµ¬ë… í”Œëœ
  monthly_included_count: 50, // ì›” 50íšŒ í¬í•¨
  monthly_used_count: 0, // ì´ë²ˆ ë‹¬ ì‚¬ìš© íšŸìˆ˜
  monthly_remaining: 50, // ë‚¨ì€ í¬í•¨ íšŸìˆ˜
  credits: 0, // ì¶”ê°€ í¬ë ˆë”§ (í•˜ìœ„ í˜¸í™˜)
  free_credits: 0, // âœ… ë¬´ë£Œ í¬ë ˆë”§ (ì›”ê°„ ì§€ê¸‰)
  paid_credits: 0  // âœ… ìœ ë£Œ í¬ë ˆë”§ (êµ¬ë§¤ë¶„)
};

// í•˜ìœ„ í˜¸í™˜ì„±ì„ ìœ„í•œ ë¡œì»¬ ì°¸ì¡°
let currentUser = window.currentUser;

// Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
async function initSupabase() {
  console.log('ğŸ”§ [Supabase] initSupabase ì‹œì‘');
  try {
    // Supabase JS SDKë¥¼ ë™ì ìœ¼ë¡œ ë¡œë“œ
    if (typeof window.supabase === 'undefined') {
      console.log('ğŸ“¦ [Supabase] CDNì—ì„œ SDK ë¡œë“œ ì¤‘...');
      // CDNì—ì„œ Supabase ë¡œë“œ
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
      script.onload = () => {
        console.log('âœ… [Supabase] SDK ë¡œë“œ ì™„ë£Œ');
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        window.supabaseClient = supabaseClient; // ğŸ”¥ ì „ì—­ ë…¸ì¶œ
        console.log('âœ… Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ');
        console.log('âœ… window.supabaseClient ì „ì—­ ë…¸ì¶œ ì™„ë£Œ');
        checkSupabaseSession();
      };
      script.onerror = (error) => {
        console.error('âŒ [Supabase] SDK ë¡œë“œ ì‹¤íŒ¨:', error);
      };
      document.head.appendChild(script);
    } else {
      console.log('âœ… [Supabase] SDK ì´ë¯¸ ë¡œë“œë¨');
      supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      window.supabaseClient = supabaseClient; // ğŸ”¥ ì „ì—­ ë…¸ì¶œ
      console.log('âœ… Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ');
      console.log('âœ… window.supabaseClient ì „ì—­ ë…¸ì¶œ ì™„ë£Œ');
      checkSupabaseSession();
    }
  } catch (error) {
    console.error('âŒ Supabase ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
  }
}

// Supabase ì„¸ì…˜ í™•ì¸
async function checkSupabaseSession() {
  console.log('ğŸ” checkSupabaseSession í˜¸ì¶œë¨');
  
  if (!supabaseClient) {
    console.error('âŒ supabaseClientê°€ ì—†ìŠµë‹ˆë‹¤');
    return;
  }
  
  try {
    const { data: { session }, error } = await supabaseClient.auth.getSession();
    
    console.log('ğŸ“¦ getSession ê²°ê³¼:', { session: !!session, error });
    
    if (error) {
      console.error('ì„¸ì…˜ í™•ì¸ ì‹¤íŒ¨:', error);
      return;
    }
    
    if (session) {
      // ğŸ”¥ CRITICAL FIX: Supabase ì„¸ì…˜ì—ì„œ ë°›ì€ ìµœì‹  ì‚¬ìš©ì ì •ë³´ë¡œ ê°•ì œ ê°±ì‹ 
      console.log('ğŸ”¥ [ì„¸ì…˜ ê°±ì‹ ] Supabaseì—ì„œ ë°›ì€ ìµœì‹  ì‚¬ìš©ì ì •ë³´:', {
        user_id: session.user.id,
        email: session.user.email,
        name: session.user.user_metadata.full_name || session.user.email
      });
      
      // ì‹ ê·œ ì‚¬ìš©ì í™•ì¸ (created_atê³¼ last_sign_in_atì´ ê±°ì˜ ê°™ìœ¼ë©´ ì‹ ê·œ)
      const createdAt = new Date(session.user.created_at).getTime();
      const lastSignInAt = new Date(session.user.last_sign_in_at).getTime();
      const isNewUser = Math.abs(createdAt - lastSignInAt) < 5000; // 5ì´ˆ ì´ë‚´ë©´ ì‹ ê·œ
      
      // ğŸ”¥ ìµœì‹  ì„¸ì…˜ ì •ë³´ë¡œ currentUser ê°•ì œ ê°±ì‹  (localStorageì˜ ì˜¤ë˜ëœ ê°’ ë¬´ì‹œ!)
      window.currentUser = {
        id: session.user.id,  // âœ… Supabaseì—ì„œ ë°›ì€ ìµœì‹  ID
        isLoggedIn: true,
        isGuest: false,
        name: session.user.user_metadata.full_name || session.user.email,
        email: session.user.email,  // âœ… Supabaseì—ì„œ ë°›ì€ ìµœì‹  ì´ë©”ì¼
        free_credits: 0, // âœ… ì„œë²„ ë™ê¸°í™” í›„ ì—…ë°ì´íŠ¸
        paid_credits: 0, // âœ… ì„œë²„ ë™ê¸°í™” í›„ ì—…ë°ì´íŠ¸
        credits: 0, // âœ… ì„œë²„ ë™ê¸°í™” í›„ ì—…ë°ì´íŠ¸
        tier: 'free', // âœ… ì„œë²„ì—ì„œ ì‹¤ì œ ë“±ê¸‰ ì¡°íšŒ
        subscription_status: 'free'
      };
      currentUser = window.currentUser; // ë¡œì»¬ ì°¸ì¡° ë™ê¸°í™”
      
      // ğŸ”¥ CRITICAL: localStorageì— ìµœì‹  ì •ë³´ ê°•ì œ ì €ì¥ (ë®ì–´ì“°ê¸°)
      console.log('ğŸ’¾ [localStorage ê°•ì œ ê°±ì‹ ] ì˜¤ë˜ëœ ê°’ ë®ì–´ì“°ê¸°:', window.currentUser);
      localStorage.setItem('postflow_user', JSON.stringify(window.currentUser));
      localStorage.setItem('postflow_token', session.access_token);
      
      // âœ… ëœë”© í˜ì´ì§€ì—ì„œ ë¡œê·¸ì¸ë˜ì–´ ìˆìœ¼ë©´ ëŒ€ì‹œë³´ë“œë¡œ ìë™ ë¦¬ë””ë ‰ì…˜
      // âš ï¸ OAuth ì½œë°± í›„ (URLì— access_tokenì´ ìˆìœ¼ë©´) ë¬´ì¡°ê±´ ë¦¬ë””ë ‰ì…˜
      if (window.location.pathname === '/') {
        // OAuth ì½œë°±ì¸ì§€ í™•ì¸ (URLì— access_tokenì´ ìˆìœ¼ë©´)
        const isOAuthCallback = window.location.hash.includes('access_token');
        
        // error íŒŒë¼ë¯¸í„° í™•ì¸ (OAuth ì·¨ì†Œ ë˜ëŠ” ì‹¤íŒ¨)
        const urlParams = new URLSearchParams(window.location.search);
        const hasError = urlParams.get('error') || window.location.hash.includes('error=');
        
        if (hasError) {
          console.log('âŒ OAuth ì˜¤ë¥˜ ë˜ëŠ” ì·¨ì†Œ - ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬');
          // ì„¸ì…˜ í´ë¦¬ì–´
          if (supabaseClient) {
            await supabaseClient.auth.signOut();
          }
          localStorage.removeItem('postflow_token');
          localStorage.removeItem('postflow_user');
          handleAuthError();
          return; // ë¦¬ë””ë ‰ì…˜ ë°©ì§€
        }
        
        if (isOAuthCallback) {
          console.log('ğŸ”„ OAuth ì½œë°± ê°ì§€ - ëŒ€ì‹œë³´ë“œë¡œ ë¦¬ë””ë ‰ì…˜');
          window.location.href = '/dashboard';
          return; // ë¦¬ë””ë ‰ì…˜ ì¤‘ì´ë¯€ë¡œ ì•„ë˜ ì½”ë“œ ì‹¤í–‰ ë°©ì§€
        }
        
        // âš ï¸ ì¤‘ìš”: ë¡œê·¸ì¸ ìƒíƒœë©´ í•­ìƒ ëŒ€ì‹œë³´ë“œë¡œ ë¦¬ë””ë ‰ì…˜ (ëœë”© í˜ì´ì§€ ì§ì ‘ ë°©ë¬¸ ë°©ì§€)
        console.log('ğŸ”„ ë¡œê·¸ì¸ ìƒíƒœ ê°ì§€ - ëŒ€ì‹œë³´ë“œë¡œ ë¦¬ë””ë ‰ì…˜');
        window.location.href = '/dashboard';
        return; // ë¦¬ë””ë ‰ì…˜ ì¤‘ì´ë¯€ë¡œ ì•„ë˜ ì½”ë“œ ì‹¤í–‰ ë°©ì§€
      }
      
      // âœ… UIëŠ” ì¼ë‹¨ ê¸°ë³¸ ìƒíƒœë¡œ ì—…ë°ì´íŠ¸
      updateAuthUI();
      
      // ğŸ”¥ ì„œë²„ì— ì‚¬ìš©ì ì •ë³´ ë™ê¸°í™” (ì‹ ê·œ ì—¬ë¶€ ì „ë‹¬)
      // syncUserToBackendì—ì„œ ìµœì‹  DB ë°ì´í„°ë¥¼ ë°›ì•„ currentUser ì—…ë°ì´íŠ¸ + localStorage ì €ì¥
      syncUserToBackend(session, isNewUser);
    } else {
      // ë¹„ë¡œê·¸ì¸ ìƒíƒœ
      handleAuthError();
    }
  } catch (error) {
    console.error('ì„¸ì…˜ í™•ì¸ ì˜¤ë¥˜:', error);
  }
}

// ì„œë²„ì— ì‚¬ìš©ì ì •ë³´ ë™ê¸°í™”
async function syncUserToBackend(session, isNewUser = false) {
  try {
    console.log('ğŸš€ syncUserToBackend ì‹œì‘:', {
      user_id: session.user.id,
      email: session.user.email,
      name: session.user.user_metadata.full_name || session.user.email,
      isNewUser
    });
    
    const response = await fetch('/api/auth/sync', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${session.access_token}`
      },
      body: JSON.stringify({
        user_id: session.user.id,
        email: session.user.email,
        name: session.user.user_metadata.full_name || session.user.email
      })
    });
    
    console.log('ğŸ“¡ /api/auth/sync ì‘ë‹µ:', {
      status: response.status,
      ok: response.ok
    });
    
    if (response.ok) {
      const data = await response.json();
      console.log('âœ… /api/auth/sync ì„±ê³µ:', data);
      
      // ì„œë²„ì—ì„œ ë°›ì€ ì •ë³´ ì—…ë°ì´íŠ¸ (2ì§€ê°‘ ì‹œìŠ¤í…œ)
      // ğŸ”¥ ê°€ì¥ ì¤‘ìš”: IDì™€ ì´ë©”ì¼ ë¨¼ì € ì„¤ì •!
      window.currentUser.id = session.user.id;
      window.currentUser.email = session.user.email;
      window.currentUser.tier = data.tier || 'free'; // 'guest' | 'free' | 'paid'
      window.currentUser.free_credits = data.free_credits ?? 0; // âœ… ë¬´ë£Œ í¬ë ˆë”§
      window.currentUser.paid_credits = data.paid_credits ?? 0; // âœ… ìœ ë£Œ í¬ë ˆë”§
      window.currentUser.credits = (data.free_credits ?? 0) + (data.paid_credits ?? 0); // âœ… ì´ í¬ë ˆë”§ ê³„ì‚°
      window.currentUser.registration_completed = Boolean(data.registration_completed ?? true); // âœ… ëª…ì‹œì  Boolean ë³€í™˜
      window.currentUser.phone = data.phone || null; // âœ… ì—°ë½ì²˜
      
      // ğŸ”¥ í•µì‹¬: ë¡œê·¸ì¸ ìƒíƒœ ëª…ì‹œì  ì„¤ì •
      window.currentUser.isGuest = false;
      window.currentUser.isLoggedIn = true;
      
      console.log('ğŸ“Š window.currentUser ì—…ë°ì´íŠ¸:', {
        id: window.currentUser.id,
        email: window.currentUser.email,
        tier: window.currentUser.tier,
        free_credits: window.currentUser.free_credits,
        paid_credits: window.currentUser.paid_credits,
        total_credits: window.currentUser.credits,
        isGuest: window.currentUser.isGuest,
        isLoggedIn: window.currentUser.isLoggedIn,
        registration_completed: window.currentUser.registration_completed,
        phone: window.currentUser.phone
      });
      
      localStorage.setItem('postflow_user', JSON.stringify(window.currentUser));
      
      // ğŸ”” ëª¨ë“  ì»´í¬ë„ŒíŠ¸ì— ì•Œë¦¼ (í•µì‹¬!)
      // âœ… setTimeoutìœ¼ë¡œ ì´ë²¤íŠ¸ ë°œìƒ ì§€ì—° (DOM ì—…ë°ì´íŠ¸ ëŒ€ê¸°)
      setTimeout(() => {
        window.dispatchEvent(new CustomEvent('userUpdated', {
          detail: window.currentUser
        }));
        console.log('ğŸ”” userUpdated ì´ë²¤íŠ¸ ë°œìƒ! (ì§€ì—° ì‹¤í–‰)');
      }, 100);  // 0.1ì´ˆ ì§€ì—°
      
      updateAuthUI();
      
      // ğŸ”¥ í”„ë¡œí•„ ìë™ ë¡œë“œ ì¶”ê°€
      loadProfileFromDB(session.user.id);
      
      // ğŸš¨ íšŒì›ê°€ì… ì™„ë£Œ ì—¬ë¶€ ì²´í¬ (window.currentUserë§Œ ì°¸ì¡°!)
      if (!window.currentUser.registration_completed) {
        console.log('ğŸ”” íšŒì›ê°€ì… ë¯¸ì™„ë£Œ â†’ ëª¨ë‹¬ í‘œì‹œ');
        showRegistrationCompleteModal(session.user.id);
      } else {
        console.log('âœ… íšŒì›ê°€ì… ì´ë¯¸ ì™„ë£Œ - ëª¨ë‹¬ í‘œì‹œ ì•ˆ í•¨');
        // ì‹ ê·œ ì‚¬ìš©ì / ê¸°ì¡´ ì‚¬ìš©ì í™˜ì˜ ë©”ì‹œì§€ - ë¹„í™œì„±í™”
        // ì‚¬ìš©ì í”¼ë“œë°±: ëŒ€ì‹œë³´ë“œ ì´ë™ ì‹œ íŒì—…ì´ ë¶€ë‹´ìŠ¤ëŸ½ë‹¤ëŠ” ì˜ê²¬ìœ¼ë¡œ ë¹„í™œì„±í™”
        /*
        if (window.location.pathname !== '/') {
          if (isNewUser) {
            showWelcomeMessage('signup');
          } else {
            showWelcomeMessage('login');
          }
        }
        */
      }
    } else {
      const errorData = await response.json().catch(() => ({ error: 'ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨' }));
      console.error('âŒâŒâŒ /api/auth/sync ì‹¤íŒ¨! âŒâŒâŒ');
      console.error('ğŸ” HTTP ìƒíƒœ:', response.status, response.statusText);
      console.error('ğŸ” ì„œë²„ ì‘ë‹µ:', JSON.stringify(errorData, null, 2));
      console.error('ğŸ” ìš”ì²­ URL:', '/api/auth/sync');
      console.error('ğŸ” ì—ëŸ¬ íƒ€ì…:', errorData.errorType);
      console.error('ğŸ” ì—ëŸ¬ ì½”ë“œ:', errorData.errorCode);
      console.error('ğŸ” ì—ëŸ¬ íŒíŠ¸:', errorData.errorHint);
      
      // ğŸ”¥ ì‚¬ìš©ìì—ê²Œ ìƒì„¸ ì˜¤ë¥˜ í‘œì‹œ
      let errorMessage = 'ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
      if (errorData.error) {
        errorMessage += `\n\n${errorData.error}`;
      }
      if (errorData.errorCode) {
        errorMessage += `\n\nì˜¤ë¥˜ ì½”ë“œ: ${errorData.errorCode}`;
      }
      if (errorData.errorHint) {
        errorMessage += `\n\níŒíŠ¸: ${errorData.errorHint}`;
      }
      
      alert(errorMessage);
      
      // ğŸ”¥ ì‚¬ìš©ì ì¹œí™”ì  ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
      if (response.status === 500) {
        showToast('âš ï¸ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê°œë°œì ë„êµ¬(F12) ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error', 10000);
      } else if (response.status === 401) {
        showToast('âš ï¸ ë¡œê·¸ì¸ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 'warning', 5000);
      } else {
        showToast(`âš ï¸ ë¡œê·¸ì¸ ì˜¤ë¥˜ (${response.status})`, 'error', 5000);
      }
      
      // ğŸ”¥ API ì‹¤íŒ¨ ì‹œì—ë„ ìµœì†Œí•œì˜ ì •ë³´ ì €ì¥ (íˆìŠ¤í† ë¦¬ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡)
      window.currentUser.id = session.user.id;
      window.currentUser.email = session.user.email;
      window.currentUser.isGuest = false;
      window.currentUser.isLoggedIn = true;
      localStorage.setItem('postflow_user', JSON.stringify(window.currentUser));
      updateAuthUI();
      console.log('âš ï¸ API ì‹¤íŒ¨í–ˆì§€ë§Œ ê¸°ë³¸ ì •ë³´ëŠ” ì €ì¥í•¨');
    }
  } catch (error) {
    console.error('âŒ ì‚¬ìš©ì ë™ê¸°í™” ì—ëŸ¬:', error);
    console.error('ğŸ” ì—ëŸ¬ ìƒì„¸:', {
      message: error.message,
      stack: error.stack?.substring(0, 200)
    });
    showToast('âš ï¸ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.', 'error', 5000);
  }
}

// í™˜ì˜ ë©”ì‹œì§€ í‘œì‹œ (í•˜ì´ë¸Œë¦¬ë“œ í”Œëœ)
// âš ï¸ ì‚¬ìš©ì í”¼ë“œë°±: ëŒ€ì‹œë³´ë“œ ì´ë™ ì‹œ íŒì—…ì´ ë¶€ë‹´ìŠ¤ëŸ½ë‹¤ëŠ” ì˜ê²¬ìœ¼ë¡œ ì™„ì „ ë¹„í™œì„±í™”
function showWelcomeMessage(type) {
  console.log('âš ï¸ showWelcomeMessage í˜¸ì¶œë¨ - í•˜ì§€ë§Œ ë¹„í™œì„±í™”ë˜ì–´ ì‹¤í–‰ ì•ˆ í•¨');
  return; // â›” ì¦‰ì‹œ ì¢…ë£Œ
  
  const user = window.currentUser; // âœ… ì „ì—­ ê°ì²´ ì°¸ì¡°
  
  // âœ… ì•ˆì „í•œ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
  if (!user || !user.id || user.isGuest) {
    console.log('âš ï¸ ìœ íš¨í•œ ì‚¬ìš©ì ì •ë³´ ì—†ìŒ, í™˜ì˜ ë©”ì‹œì§€ ìŠ¤í‚µ');
    return;
  }
  
  const displayName = user.name || user.email?.split('@')[0] || 'íšŒì›';
  
  // null, undefined ì²´í¬
  if (!displayName || displayName === 'null' || displayName === 'undefined') {
    console.log('âš ï¸ ìœ íš¨í•œ ì‚¬ìš©ì ì´ë¦„ ì—†ìŒ, í™˜ì˜ ë©”ì‹œì§€ ìŠ¤í‚µ');
    return;
  }
  
  const messages = {
    signup: {
      title: 'ğŸ‰ íšŒì›ê°€ì… ì™„ë£Œ!',
      message: `í™˜ì˜í•©ë‹ˆë‹¤, ${displayName}ë‹˜!<br><br>ğŸ ë¬´ë£Œ íšŒì› í˜œíƒ<br>â€¢ ë§¤ì›” 10í¬ë ˆë”§ ìë™ ì§€ê¸‰<br>â€¢ 1í¬ë ˆë”§ = 1íšŒ ìƒì„±<br><br>ğŸ’ í¬ë ˆë”§ ì¶©ì „ ì˜µì…˜<br>â€¢ STARTER: â‚©5,000 (10í¬ë ˆë”§, â‚©500/í¬ë ˆë”§)<br>â€¢ PRO: â‚©23,750 (50í¬ë ˆë”§, â‚©475/í¬ë ˆë”§, 5% í• ì¸) ğŸ”¥<br>â€¢ BUSINESS: â‚©45,000 (100í¬ë ˆë”§, â‚©450/í¬ë ˆë”§, 10% í• ì¸)`,
      duration: 6000
    },
    login: {
      title: 'ğŸ‘‹ ë‹¤ì‹œ ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!',
      message: `${displayName}ë‹˜, ë°˜ê°‘ìŠµë‹ˆë‹¤!<br><br>${user.tier === 'free' ? 'ğŸ ë¬´ë£Œ íšŒì›' : 'ğŸ’ ìœ ë£Œ íšŒì›'}<br>â€¢ ë‚¨ì€ í¬ë ˆë”§: <strong>${user.credits}ê°œ</strong><br>â€¢ 1í¬ë ˆë”§ = 1íšŒ ìƒì„±`,
      duration: 4000
    }
  };
  
  const msg = messages[type];
  
  // ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆ ìƒì„±
  const messageDiv = document.createElement('div');
  messageDiv.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 z-50 bg-white border-2 border-blue-500 rounded-lg shadow-2xl p-6 max-w-md w-full mx-4 animate-fade-in';
  messageDiv.innerHTML = `
    <div class="flex items-start">
      <div class="flex-1">
        <h3 class="text-xl font-bold text-gray-800 mb-2">${msg.title}</h3>
        <p class="text-gray-600">${msg.message}</p>
      </div>
      <button onclick="this.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600 ml-4">
        <i class="fas fa-times"></i>
      </button>
    </div>
  `;
  
  document.body.appendChild(messageDiv);
  
  // ìë™ ì œê±°
  setTimeout(() => {
    if (messageDiv.parentElement) {
      messageDiv.style.opacity = '0';
      messageDiv.style.transform = 'translateY(-20px) translateX(-50%)';
      setTimeout(() => messageDiv.remove(), 300);
    }
  }, msg.duration);
}

// ===================================
// íšŒì›ê°€ì… ì™„ë£Œ ëª¨ë‹¬ (ì—°ë½ì²˜ + ë™ì˜)
// ===================================
function showRegistrationCompleteModal(userId) {
  // ê¸°ì¡´ ëª¨ë‹¬ì´ ìˆìœ¼ë©´ ì œê±°
  const existingModal = document.getElementById('registrationModal');
  if (existingModal) {
    existingModal.remove();
  }
  
  const modalHTML = `
    <div id="registrationModal" style="
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(0,0,0,0.8); z-index: 10000; 
      display: flex; align-items: center; justify-content: center;
    ">
      <div style="
        background: white; border-radius: 20px; padding: 2rem; 
        max-width: 480px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      ">
        <div style="text-align: center; margin-bottom: 2rem;">
          <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ‰</div>
          <h2 style="font-size: 1.8rem; font-weight: bold; color: #1f2937; margin-bottom: 0.5rem;">
            í™˜ì˜í•©ë‹ˆë‹¤!
          </h2>
          <p style="color: #6b7280; font-size: 1rem;">
            ì„œë¹„ìŠ¤ ì´ìš©ì„ ìœ„í•´ ì—°ë½ì²˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”
          </p>
        </div>
        
        <form id="registrationCompleteForm">
          <!-- ì—°ë½ì²˜ ì…ë ¥ -->
          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
              ì—°ë½ì²˜ <span style="color: #ef4444;">*</span>
            </label>
            <input 
              type="tel" 
              id="userPhone" 
              placeholder="010-1234-5678" 
              required
              style="
                width: 100%; padding: 0.875rem; border: 2px solid #e5e7eb; 
                border-radius: 10px; font-size: 1rem; outline: none;
              "
            />
            <p style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">
              ê³ ê°ë¬¸ì˜, í™˜ë¶ˆ ì²˜ë¦¬ë¥¼ ìœ„í•´ í•„ìš”í•©ë‹ˆë‹¤
            </p>
          </div>
          
          <!-- ì•½ê´€ ë™ì˜ -->
          <div style="margin-bottom: 2rem; padding: 1.5rem; background: #f8fafc; border-radius: 12px;">
            <label style="
              display: flex; align-items: flex-start; margin-bottom: 1rem; 
              cursor: pointer; font-size: 0.95rem;
            ">
              <input 
                type="checkbox" 
                id="agreePrivacy" 
                required 
                style="width: 18px; height: 18px; margin-right: 0.75rem; margin-top: 0.1rem; cursor: pointer;"
              >
              <span style="color: #374151; line-height: 1.5;">
                <strong>[í•„ìˆ˜]</strong> ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨ì— ë™ì˜í•©ë‹ˆë‹¤<br>
                <small style="color: #6b7280;">ì—°ë½ì²˜ëŠ” ê³ ê°ì§€ì› ë° í™˜ë¶ˆ ì²˜ë¦¬ ëª©ì ìœ¼ë¡œë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤</small>
              </span>
            </label>
            
            <label style="
              display: flex; align-items: flex-start; cursor: pointer; 
              font-size: 0.95rem;
            ">
              <input 
                type="checkbox" 
                id="agreeMarketing" 
                style="width: 18px; height: 18px; margin-right: 0.75rem; margin-top: 0.1rem; cursor: pointer;"
              >
              <span style="color: #6b7280; line-height: 1.5;">
                <strong>[ì„ íƒ]</strong> ë§ˆì¼€íŒ… ì •ë³´ ìˆ˜ì‹ ì— ë™ì˜í•©ë‹ˆë‹¤<br>
                <small>ì´ë²¤íŠ¸, í• ì¸ í˜œíƒ ë“±ì˜ ì•ˆë‚´ë¥¼ ë°›ì•„ë³´ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤</small>
              </span>
            </label>
          </div>
          
          <!-- ì œì¶œ ë²„íŠ¼ -->
          <button 
            type="submit" 
            id="registrationSubmitBtn"
            style="
              width: 100%; padding: 1rem; 
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
              color: white; font-weight: bold; font-size: 1.1rem; 
              border: none; border-radius: 12px; cursor: pointer;
              transition: transform 0.2s ease;
            "
            onmouseover="this.style.transform='translateY(-2px)'"
            onmouseout="this.style.transform='translateY(0)'"
          >
            ì €ì¥í•˜ê³  ì‹œì‘í•˜ê¸°
          </button>
        </form>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHTML);
  
  // í¼ ì œì¶œ ì´ë²¤íŠ¸ ì²˜ë¦¬
  document.getElementById('registrationCompleteForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const phone = document.getElementById('userPhone').value.trim();
    const privacyAgreed = document.getElementById('agreePrivacy').checked;
    const marketingAgreed = document.getElementById('agreeMarketing').checked;
    
    // ì…ë ¥ê°’ ê²€ì¦
    if (!phone) {
      showToast('âŒ ì—°ë½ì²˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
      document.getElementById('userPhone').focus();
      return;
    }
    
    if (!privacyAgreed) {
      showToast('âŒ ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨ì— ë™ì˜í•´ì£¼ì„¸ìš”', 'error');
      return;
    }
    
    // ë¡œë”© ìƒíƒœ
    const submitBtn = document.getElementById('registrationSubmitBtn');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'ì €ì¥ ì¤‘...';
    submitBtn.disabled = true;
    submitBtn.style.opacity = '0.6';
    submitBtn.style.cursor = 'not-allowed';
    
    try {
      console.log('ğŸ“ íšŒì›ê°€ì… ì™„ë£Œ ì²˜ë¦¬ ì‹œì‘:', { userId, phone, privacyAgreed, marketingAgreed });
      
      const response = await fetch('/api/auth/complete-registration', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          user_id: userId,
          phone: phone,
          privacy_agreed: privacyAgreed,
          marketing_agreed: marketingAgreed
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        console.log('âœ… íšŒì›ê°€ì… ì™„ë£Œ ì„±ê³µ:', data.user);
        
        // ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸
        window.currentUser = {
          ...window.currentUser,
          ...data.user,
          isLoggedIn: true,
          isGuest: false,
          registration_completed: true
        };
        currentUser = window.currentUser; // ë¡œì»¬ ì°¸ì¡° ë™ê¸°í™”
        localStorage.setItem('postflow_user', JSON.stringify(window.currentUser));
        
        // ëª¨ë‹¬ ë‹«ê¸°
        document.getElementById('registrationModal').remove();
        
        // ì„±ê³µ ë©”ì‹œì§€
        showToast('ğŸ‰ íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•´ë³´ì„¸ìš”.', 'success');
        
        // UI ì—…ë°ì´íŠ¸
        updateAuthUI();
        updateCostEstimate();
        
      } else {
        console.error('âŒ íšŒì›ê°€ì… ì™„ë£Œ ì‹¤íŒ¨:', data.error);
        showToast(`âŒ ${data.error}`, 'error');
      }
    } catch (error) {
      console.error('âŒ íšŒì›ê°€ì… ì™„ë£Œ ì˜ˆì™¸:', error);
      showToast('âŒ íšŒì›ê°€ì… ì™„ë£Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
    } finally {
      // ë²„íŠ¼ ìƒíƒœ ë³µì›
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
      submitBtn.style.opacity = '1';
      submitBtn.style.cursor = 'pointer';
    }
  });
  
  // ì—°ë½ì²˜ ì…ë ¥ í•„ë“œì— ìë™ í¬ì»¤ìŠ¤
  setTimeout(() => {
    const phoneInput = document.getElementById('userPhone');
    if (phoneInput) phoneInput.focus();
  }, 100);
}

// ğŸ“‹ ì •ì±… ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜
function openPolicyModal(type) {
  const modal = document.getElementById('policyModal');
  const title = document.getElementById('policyModalTitle');
  const content = document.getElementById('policyModalContent');
  
  const policies = {
    refund: {
      title: 'í™˜ë¶ˆ ì •ì±…',
      content: `
        <h4 class="text-xl font-bold text-gray-800 mb-4">í™˜ë¶ˆ ì •ì±…</h4>
        <div class="space-y-4 text-gray-600">
          <p><strong>1. í™˜ë¶ˆ ê°€ëŠ¥ ì¡°ê±´</strong></p>
          <ul class="list-disc pl-6 space-y-2">
            <li>í¬ë ˆë”§ êµ¬ë§¤ í›„ 7ì¼ ì´ë‚´, ì‚¬ìš©í•˜ì§€ ì•Šì€ í¬ë ˆë”§ì— í•œí•´ í™˜ë¶ˆ ê°€ëŠ¥</li>
            <li>ì‹œìŠ¤í…œ ì¥ì• ë¡œ ì¸í•œ ì„œë¹„ìŠ¤ ì´ìš© ë¶ˆê°€ ì‹œ ì „ì•¡ í™˜ë¶ˆ</li>
            <li>ì„œë¹„ìŠ¤ í’ˆì§ˆ ë¶ˆë§Œì¡± ì‹œ ì‚¬ìš©í•˜ì§€ ì•Šì€ í¬ë ˆë”§ ë¶€ë¶„ í™˜ë¶ˆ</li>
          </ul>
          <p><strong>2. í™˜ë¶ˆ ë¶ˆê°€ ì¡°ê±´</strong></p>
          <ul class="list-disc pl-6 space-y-2">
            <li>ì´ë¯¸ ì‚¬ìš©í•œ í¬ë ˆë”§</li>
            <li>í”„ë¡œëª¨ì…˜ì´ë‚˜ ì´ë²¤íŠ¸ë¡œ ë¬´ë£Œë¡œ ì§€ê¸‰ë°›ì€ í¬ë ˆë”§</li>
            <li>êµ¬ë§¤ í›„ 7ì¼ ê²½ê³¼</li>
          </ul>
          <p><strong>3. í™˜ë¶ˆ ì ˆì°¨</strong></p>
          <p>ê³ ê°ì„¼í„°(contentitda@naver.com)ë¡œ í™˜ë¶ˆ ìš”ì²­ â†’ ê²€í†  í›„ 3-5ì˜ì—…ì¼ ë‚´ ì²˜ë¦¬</p>
        </div>
      `
    },
    privacy: {
      title: 'ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨',
      content: `
        <h4 class="text-xl font-bold text-gray-800 mb-4">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</h4>
        <div class="space-y-4 text-gray-600">
          <p><strong>1. ìˆ˜ì§‘í•˜ëŠ” ê°œì¸ì •ë³´</strong></p>
          <ul class="list-disc pl-6 space-y-2">
            <li>í•„ìˆ˜: ì´ë©”ì¼ ì£¼ì†Œ, ì´ë¦„</li>
            <li>ì„ íƒ: í”„ë¡œí•„ ì´ë¯¸ì§€, ì „í™”ë²ˆí˜¸</li>
            <li>ìë™ ìˆ˜ì§‘: IP ì£¼ì†Œ, ì¿ í‚¤, ì„œë¹„ìŠ¤ ì´ìš© ê¸°ë¡</li>
          </ul>
          <p><strong>2. ê°œì¸ì •ë³´ì˜ ì´ìš© ëª©ì </strong></p>
          <ul class="list-disc pl-6 space-y-2">
            <li>íšŒì› ê°€ì… ë° ê´€ë¦¬</li>
            <li>ì„œë¹„ìŠ¤ ì œê³µ ë° ê°œì„ </li>
            <li>ê³ ê° ë¬¸ì˜ ì‘ëŒ€</li>
            <li>ë§ˆì¼€íŒ… ë° ê´‘ê³  (ë™ì˜ ì‹œ)</li>
          </ul>
          <p><strong>3. ê°œì¸ì •ë³´ì˜ ë³´ìœ  ë° ì´ìš© ê¸°ê°„</strong></p>
          <p>íšŒì› íƒˆí‡´ ì‹œê¹Œì§€ ë³´ìœ í•˜ë©°, íƒˆí‡´ ì¦‰ì‹œ íŒŒê¸°í•©ë‹ˆë‹¤. ë‹¨, ê´€ë ¨ ë²•ë ¹ì— ë”°ë¼ ì¼ë¶€ ì •ë³´ëŠ” ì¼ì • ê¸°ê°„ ë³´ê´€ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
          <p><strong>4. ê°œì¸ì •ë³´ ë³´í˜¸ì±…ì„ì</strong></p>
          <p>ì´ë©”ì¼: contentitda@naver.com</p>
        </div>
      `
    },
    terms: {
      title: 'ì´ìš©ì•½ê´€',
      content: `
        <h4 class="text-xl font-bold text-gray-800 mb-4">ì´ìš©ì•½ê´€</h4>
        <div class="space-y-4 text-gray-600">
          <p><strong>ì œ1ì¡° (ëª©ì )</strong></p>
          <p>ë³¸ ì•½ê´€ì€ ë§ˆì¼€íŒ…í—ˆë¸Œ AI ìŠ¤íŠœë””ì˜¤(ì´í•˜ "íšŒì‚¬")ê°€ ì œê³µí•˜ëŠ” AI ì½˜í…ì¸  ìƒì„± ì„œë¹„ìŠ¤(ì´í•˜ "ì„œë¹„ìŠ¤")ì˜ ì´ìš©ê³¼ ê´€ë ¨í•˜ì—¬ íšŒì‚¬ì™€ íšŒì› ê°„ì˜ ê¶Œë¦¬, ì˜ë¬´ ë° ì±…ì„ì‚¬í•­ì„ ê·œì •í•¨ì„ ëª©ì ìœ¼ë¡œ í•©ë‹ˆë‹¤.</p>
          
          <p><strong>ì œ2ì¡° (ì •ì˜)</strong></p>
          <ul class="list-disc pl-6 space-y-2">
            <li>"ì„œë¹„ìŠ¤"ë€ íšŒì‚¬ê°€ ì œê³µí•˜ëŠ” PostFlow, TrendFinder, StoryMaker ë“± ëª¨ë“  AI ê¸°ë°˜ ì½˜í…ì¸  ìƒì„± ë„êµ¬ë¥¼ ë§í•©ë‹ˆë‹¤.</li>
            <li>"íšŒì›"ì´ë€ ë³¸ ì•½ê´€ì— ë™ì˜í•˜ê³  íšŒì‚¬ì™€ ì„œë¹„ìŠ¤ ì´ìš©ê³„ì•½ì„ ì²´ê²°í•œ ìë¥¼ ë§í•©ë‹ˆë‹¤.</li>
            <li>"í¬ë ˆë”§"ì´ë€ ì„œë¹„ìŠ¤ ì´ìš©ì„ ìœ„í•œ ê°€ìƒì˜ í™”í ë‹¨ìœ„ë¥¼ ë§í•©ë‹ˆë‹¤.</li>
          </ul>
          
          <p><strong>ì œ3ì¡° (íšŒì› ê°€ì…)</strong></p>
          <ul class="list-disc pl-6 space-y-2">
            <li>íšŒì› ê°€ì…ì€ ì´ë©”ì¼ ì¸ì¦ ë˜ëŠ” ì†Œì…œ ë¡œê·¸ì¸(Google, Kakao)ìœ¼ë¡œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
            <li>íšŒì›ì€ ì •í™•í•œ ì •ë³´ë¥¼ ì œê³µí•´ì•¼ í•˜ë©°, í—ˆìœ„ ì •ë³´ ì œê³µ ì‹œ ì„œë¹„ìŠ¤ ì´ìš©ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
          </ul>
          
          <p><strong>ì œ4ì¡° (ì„œë¹„ìŠ¤ ì´ìš©)</strong></p>
          <ul class="list-disc pl-6 space-y-2">
            <li>ì„œë¹„ìŠ¤ëŠ” í¬ë ˆë”§ ì†Œë¹„ ë°©ì‹ìœ¼ë¡œ ì œê³µë©ë‹ˆë‹¤.</li>
            <li>ë¬´ë£Œ íšŒì›ì€ ê°€ì… ì‹œ 30ê°œ ë¬´ë£Œ í¬ë ˆë”§ì„ ì§€ê¸‰ë°›ìœ¼ë©°, ë§¤ì›” 30ê°œ í¬ë ˆë”§ì´ ìë™ ì¶©ì „ë©ë‹ˆë‹¤.</li>
            <li>AI ìƒì„± ì½˜í…ì¸ ì˜ ì €ì‘ê¶Œì€ íšŒì›ì—ê²Œ ìˆìœ¼ë‚˜, ë¶ˆë²•ì ì¸ ìš©ë„ë¡œ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</li>
          </ul>
          
          <p><strong>ì œ5ì¡° (ì„œë¹„ìŠ¤ ì´ìš© ì œí•œ)</strong></p>
          <p>íšŒì‚¬ëŠ” ë‹¤ìŒ ê° í˜¸ì— í•´ë‹¹í•˜ëŠ” ê²½ìš° ì„œë¹„ìŠ¤ ì´ìš©ì„ ì œí•œí•˜ê±°ë‚˜ ê³„ì•½ì„ í•´ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:</p>
          <ul class="list-disc pl-6 space-y-2">
            <li>íƒ€ì¸ì˜ ì •ë³´ë¥¼ ë„ìš©í•œ ê²½ìš°</li>
            <li>ì„œë¹„ìŠ¤ë¥¼ ë¶ˆë²•ì ì¸ ëª©ì ìœ¼ë¡œ ì´ìš©í•œ ê²½ìš°</li>
            <li>ì„œë¹„ìŠ¤ ìš´ì˜ì„ ê³ ì˜ë¡œ ë°©í•´í•œ ê²½ìš°</li>
          </ul>
          
          <p class="mt-6 text-sm text-gray-500">ìµœì¢… ì—…ë°ì´íŠ¸: 2026ë…„ 1ì›”</p>
        </div>
      `
    }
  };
  
  const policy = policies[type];
  if (policy) {
    title.textContent = policy.title;
    content.innerHTML = policy.content;
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden'; // ìŠ¤í¬ë¡¤ ë°©ì§€
  }
}

function closePolicyModal() {
  const modal = document.getElementById('policyModal');
  modal.classList.add('hidden');
  document.body.style.overflow = ''; // ìŠ¤í¬ë¡¤ ë³µì›
}

// ğŸ  ë¡œê³  í´ë¦­ í•¸ë“¤ëŸ¬ (ë¡œê·¸ì¸ ìƒíƒœë©´ /dashboardë¡œ, ë¹„ë¡œê·¸ì¸ì´ë©´ / ìœ ì§€)
function handleLogoClick() {
  const savedUser = localStorage.getItem('postflow_user');
  const savedToken = localStorage.getItem('postflow_token');
  
  // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸: localStorageì™€ window.currentUser ë‘˜ ë‹¤ ì²´í¬
  const isLoggedIn = savedUser && savedToken && 
                     window.currentUser && 
                     !window.currentUser.isGuest && 
                     window.currentUser.isLoggedIn;
  
  if (isLoggedIn) {
    // ë¡œê·¸ì¸ ìƒíƒœ: /dashboardë¡œ ì´ë™ (ì´ë¯¸ /dashboardë©´ ìŠ¤í‚µ)
    if (window.location.pathname !== '/dashboard') {
      console.log('ğŸ  [ë¡œê³  í´ë¦­] ë¡œê·¸ì¸ ìƒíƒœ - /dashboardë¡œ ì´ë™');
      sessionStorage.setItem('landing_page_visited', 'true');
      window.location.href = '/dashboard';
    } else {
      console.log('ğŸ  [ë¡œê³  í´ë¦­] ì´ë¯¸ ëŒ€ì‹œë³´ë“œ í˜ì´ì§€ - ìƒˆë¡œê³ ì¹¨ ë°©ì§€');
    }
  } else {
    // ë¹„ë¡œê·¸ì¸ ìƒíƒœ: / (ë©”ì¸)ë¡œ ì´ë™
    console.log('ğŸ  [ë¡œê³  í´ë¦­] ë¹„ë¡œê·¸ì¸ ìƒíƒœ - ë©”ì¸ìœ¼ë¡œ ì´ë™');
    sessionStorage.removeItem('landing_page_visited');
    
    // í˜„ì¬ ê²½ë¡œê°€ ì´ë¯¸ / ì¸ ê²½ìš° ìƒˆë¡œê³ ì¹¨ ë°©ì§€
    if (window.location.pathname !== '/') {
      window.location.href = '/';
    }
  }
}

// UI ì´ˆê¸°í™”
function initializeAuth() {
  console.log('ğŸš€ [ì´ˆê¸°í™”] initializeAuth ì‹œì‘');
  
  // âœ… NEW v7.4: ì´ë©”ì¼ ì¸ì¦ ì™„ë£Œ í™˜ì˜ ë©”ì‹œì§€
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('welcome') === 'true') {
    showToast('ğŸ‰ ì´ë©”ì¼ ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! 30ê°œ ë¬´ë£Œ í¬ë ˆë”§ì´ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
    // URL ì •ë¦¬
    window.history.replaceState(null, '', window.location.pathname);
  }
  
  // Supabase ì´ˆê¸°í™”
  initSupabase();
  
  // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì‚¬ìš©ì ì •ë³´ í™•ì¸
  const savedUser = localStorage.getItem('postflow_user');
  const savedToken = localStorage.getItem('postflow_token');
  
  if (savedUser && savedToken) {
    window.currentUser = JSON.parse(savedUser);
    console.log('âœ… [ì´ˆê¸°í™”] localStorageì—ì„œ ì‚¬ìš©ì ë³µì›:', window.currentUser);
    
    // ğŸ”¥ ë¡œê·¸ì¸ ìƒíƒœ ëª…ì‹œì  ì„¤ì • (ì¤‘ìš”!)
    window.currentUser.isGuest = false;
    window.currentUser.isLoggedIn = true;
    
    // ğŸ”¥ ë©”ì¸ í˜ì´ì§€ì—ì„œ ë¡œê·¸ì¸ëœ ìƒíƒœë©´ ìë™ìœ¼ë¡œ /dashboardë¡œ ì´ë™
    if (window.location.pathname === '/' && !sessionStorage.getItem('landing_page_visited')) {
      console.log('ğŸ”„ [ë©”ì¸ í˜ì´ì§€] ë¡œê·¸ì¸ ìƒíƒœ ê°ì§€ - /dashboardë¡œ ìë™ ì´ë™');
      sessionStorage.setItem('landing_page_visited', 'true');
      window.location.href = '/dashboard';
      return;
    }
    
    updateAuthUI();
  } else {
    // ë¹„íšŒì› ìƒíƒœë¡œ ì‹œì‘
    window.currentUser.isGuest = true;
    window.currentUser.isLoggedIn = false;
    window.currentUser.tier = 'guest';
    window.currentUser.credits = 1;
    console.log('ğŸ“ [ì´ˆê¸°í™”] ë¹„íšŒì› ìƒíƒœë¡œ ì‹œì‘:', window.currentUser);
    updateAuthUI();
  }
  
  // ì „ì—­ ë…¸ì¶œ (ë””ë²„ê¹…ìš©)
  console.log('ğŸŒ [ì´ˆê¸°í™”] window.currentUser ì „ì—­ ë…¸ì¶œ ì™„ë£Œ:', window.currentUser);
}

// ì¸ì¦ ìƒíƒœ í™•ì¸
async function checkAuthStatus() {
  try {
    const response = await fetch('/api/auth/me', {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('postflow_token')}`
      }
    });
    
    if (response.ok) {
      const data = await response.json();
      window.currentUser = {
        id: data.user?.id || null,  // âœ… ì¶”ê°€: ì‚¬ìš©ì ID
        isLoggedIn: !data.is_guest,
        isGuest: data.is_guest,
        name: data.user?.name || 'ê²ŒìŠ¤íŠ¸',
        email: data.user?.email || null,
        credits: data.user?.credits || 1,
        tier: data.user?.subscription_status === 'active' ? 'paid' : (data.is_guest ? 'guest' : 'free'),
        subscription_status: data.user?.subscription_status
      };
      
      localStorage.setItem('postflow_user', JSON.stringify(window.currentUser));
      updateAuthUI();
    } else {
      // í† í° ë§Œë£Œ ë˜ëŠ” ìœ íš¨í•˜ì§€ ì•ŠìŒ
      handleAuthError();
    }
  } catch (error) {
    console.error('ì¸ì¦ í™•ì¸ ì‹¤íŒ¨:', error);
  }
}

// UI ì—…ë°ì´íŠ¸
function updateAuthUI() {
  const user = window.currentUser; // âœ… ì „ì—­ ê°ì²´ë§Œ ì°¸ì¡°
  
  const userInfoArea = document.getElementById('userInfoArea');
  const guestArea = document.getElementById('guestArea');
  const memberFeaturesArea = document.getElementById('memberFeaturesArea');
  const heroSection = document.getElementById('heroSection');
  const userName = document.getElementById('userName');
  const userTier = document.getElementById('userTier');
  const userCredits = document.getElementById('userCredits');
  
  if (user.isLoggedIn && !user.isGuest) {
    // ë¡œê·¸ì¸ ìƒíƒœ (í•˜ì´ë¸Œë¦¬ë“œ í”Œëœ)
    if (userInfoArea) userInfoArea.classList.remove('hidden');
    if (guestArea) guestArea.classList.add('hidden');
    if (memberFeaturesArea) memberFeaturesArea.classList.remove('hidden');
    
    // ğŸ“… Phase 3: ìº˜ë¦°ë” ì„¹ì…˜ í‘œì‹œ
    showScheduledContentArea();
    
    // ğŸ”¥ Phase 4&5: ì™¼ìª½ íŒ¨ë„ íšŒì› ì „ìš© ê¸°ëŠ¥ í‘œì‹œ
    const leftPanelMemberFeatures = document.getElementById('leftPanelMemberFeatures');
    if (leftPanelMemberFeatures) {
      leftPanelMemberFeatures.classList.remove('hidden');
    }
    
    // íˆì–´ë¡œ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
    if (heroSection) {
      heroSection.classList.add('hidden');
    }
    
    if (userName) userName.textContent = user.name || user.email?.split('@')[0] || 'íšŒì›';
    // Tier í‘œì‹œ
    const tierLabels = {
      'guest': 'ë¹„íšŒì›',
      'free': 'ë¬´ë£Œ',
      'paid': 'ìœ ë£Œ'
    };
    if (userTier) userTier.textContent = tierLabels[user.tier] || 'ë¬´ë£Œ';
    
    // âœ… 2ì§€ê°‘ í¬ë ˆë”§ í‘œì‹œ ê°œì„ 
    const freeCredits = user.free_credits || 0;
    const paidCredits = user.paid_credits || 0;
    const totalCredits = freeCredits + paidCredits;
    
    let creditText = `${totalCredits}í¬ë ˆë”§`;
    if (freeCredits > 0 && paidCredits > 0) {
      creditText = `${totalCredits}í¬ë ˆë”§ (ë¬´ë£Œ ${freeCredits} + ìœ ë£Œ ${paidCredits})`;
    } else if (freeCredits > 0) {
      creditText = `${totalCredits}í¬ë ˆë”§ (ë¬´ë£Œ)`;
    } else if (paidCredits > 0) {
      creditText = `${totalCredits}í¬ë ˆë”§ (ìœ ë£Œ)`;
    } else {
      creditText = '0í¬ë ˆë”§';
      
      // NEW v7.5: ì¬ê°€ì… ì‚¬ìš©ì ì•ˆë‚´
      // ìµœì´ˆ 1íšŒë§Œ í‘œì‹œ (sessionStorage ì‚¬ìš©)
      // âœ… ìˆ˜ì •: totalCreditsê°€ ì‹¤ì œë¡œ 0ì¼ ë•Œë§Œ í‘œì‹œ
      if (totalCredits === 0 && !sessionStorage.getItem('rejoin_notice_shown')) {
        setTimeout(() => {
          showToast('â„¹ï¸ í¬ë ˆë”§ì„ ì¶©ì „í•´ì£¼ì„¸ìš”.', 'info');
          sessionStorage.setItem('rejoin_notice_shown', 'true');
        }, 1000);
      }
    }
    
    if (userCredits) userCredits.textContent = creditText;
    
    // ì‹œê°ì  íš¨ê³¼
    if (userCredits) {
      userCredits.style.transition = 'color 0.3s ease';
      userCredits.style.color = '#4f46e5';
      setTimeout(() => {
        userCredits.style.color = '';
      }, 500);
    }
    
    console.log('âœ… updateAuthUI í¬ë ˆë”§ í‘œì‹œ ì—…ë°ì´íŠ¸:', {
      free: freeCredits,
      paid: paidCredits,
      total: totalCredits,
      display: creditText
    });
  } else {
    // ë¹„íšŒì›/ê²ŒìŠ¤íŠ¸ ìƒíƒœ
    if (userInfoArea) userInfoArea.classList.add('hidden');
    if (guestArea) guestArea.classList.remove('hidden');
    if (memberFeaturesArea) memberFeaturesArea.classList.add('hidden');
    
    // ğŸ“… Phase 3: ìº˜ë¦°ë” ì„¹ì…˜ ìˆ¨ê¹€
    hideScheduledContentArea();
    
    // íˆì–´ë¡œ ì„¹ì…˜ í‘œì‹œ
    if (heroSection) {
      heroSection.classList.remove('hidden');
    }
  }
}

// ì¸ì¦ ì—ëŸ¬ ì²˜ë¦¬ (í•˜ì´ë¸Œë¦¬ë“œ í”Œëœ)
function handleAuthError() {
  localStorage.removeItem('postflow_token');
  localStorage.removeItem('postflow_user');
  window.currentUser = {
    id: null,
    isLoggedIn: false,
    isGuest: true,
    name: null,
    email: null,
    tier: 'guest', // 'guest' | 'free' | 'paid'
    credits: 1, // ë¹„íšŒì› 1í¬ë ˆë”§
    free_credits: 0,
    paid_credits: 0
  };
  updateAuthUI();
}

// Google ë¡œê·¸ì¸ (Supabase OAuth)
async function handleLogin() {
  if (!supabaseClient) {
    alert('ì¸ì¦ ì‹œìŠ¤í…œì„ ì´ˆê¸°í™”í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  // ì•ˆì „í•œ ë¡œê·¸ì¸ ì•ˆë‚´
  const confirmed = confirm(
    'ğŸ” ì•ˆì „í•œ Google ë¡œê·¸ì¸\n\n' +
    'âœ… Google ê³µì‹ ì¸ì¦ ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤\n' +
    'âœ… ë¹„ë°€ë²ˆí˜¸ëŠ” ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤\n' +
    'âœ… ì–¸ì œë“ ì§€ ì—°ë™ì„ í•´ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤\n\n' +
    'ë¡œê·¸ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?'
  );
  
  if (!confirmed) {
    return;
  }
  
  try {
    const { data, error } = await supabaseClient.auth.signInWithOAuth({
      provider: 'google',
      options: {
        redirectTo: window.location.origin,
        queryParams: {
          access_type: 'offline',
          prompt: 'consent'
        }
      }
    });
    
    if (error) {
      console.error('Google ë¡œê·¸ì¸ ì‹¤íŒ¨:', error);
      alert('ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    }
    
    // OAuthëŠ” ìë™ìœ¼ë¡œ ë¦¬ë””ë ‰ì…˜ë©ë‹ˆë‹¤
  } catch (error) {
    console.error('ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
    alert('ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

// ë¡œê·¸ì•„ì›ƒ
async function handleLogout() {
  console.log('ğŸšª ë¡œê·¸ì•„ì›ƒ ì‹œë„...');
  if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
    try {
      // 1. Supabase ì„¸ì…˜ ì¢…ë£Œ
      if (supabaseClient) {
        console.log('ğŸ”“ Supabase ë¡œê·¸ì•„ì›ƒ ì‹œì‘...');
        const { error } = await supabaseClient.auth.signOut();
        if (error) {
          console.error('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', error);
        } else {
          console.log('âœ… Supabase ë¡œê·¸ì•„ì›ƒ ì„±ê³µ');
        }
      }
      
      // 2. ëª¨ë“  ë¡œì»¬ ì €ì¥ì†Œ í´ë¦¬ì–´
      console.log('ğŸ—‘ï¸ ë¡œì»¬ ì €ì¥ì†Œ í´ë¦¬ì–´ ì¤‘...');
      localStorage.removeItem('postflow_token');
      localStorage.removeItem('postflow_user');
      sessionStorage.removeItem('landing_page_visited');
      
      // 3. Supabase ê´€ë ¨ ì €ì¥ì†Œë„ í´ë¦¬ì–´
      const keysToRemove = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.includes('supabase')) {
          keysToRemove.push(key);
        }
      }
      keysToRemove.forEach(key => localStorage.removeItem(key));
      console.log('âœ… ë¡œì»¬ ì €ì¥ì†Œ í´ë¦¬ì–´ ì™„ë£Œ:', keysToRemove);
      
      // 4. currentUser ì´ˆê¸°í™”
      handleAuthError();
      showToast('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
      
      // 5. ëœë”© í˜ì´ì§€ë¡œ ë¦¬ë””ë ‰ì…˜ (ìºì‹œ ë°©ì§€)
      console.log('ğŸ”„ ëœë”© í˜ì´ì§€ë¡œ ë¦¬ë””ë ‰ì…˜...');
      setTimeout(() => {
        window.location.href = '/?t=' + Date.now();
      }, 500);
    } catch (error) {
      console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
      alert('ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  }
}

// ë¬´ë£Œ ì²´í—˜ ì‹œì‘
function handleTrial() {
  if (currentUser.isGuest && currentUser.credits > 0) {
    showToast('ë¹„íšŒì› ì²´í—˜ 1íšŒë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤', 'info');
    // ì½˜í…ì¸  ìƒì„± í¼ìœ¼ë¡œ ìŠ¤í¬ë¡¤
    document.getElementById('contentForm').scrollIntoView({ behavior: 'smooth' });
  } else if (currentUser.credits === 0) {
    showToast('ì²´í—˜ íšŸìˆ˜ë¥¼ ëª¨ë‘ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”', 'warning');
  }
}

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
document.addEventListener('DOMContentLoaded', () => {
  // ì¸ì¦ ì´ˆê¸°í™”
  initializeAuth();
  
  // ë¡œê·¸ì¸ ë²„íŠ¼ë“¤
  const signupBtn = document.getElementById('signupBtn');
  const loginBtn = document.getElementById('loginBtn');
  const heroLoginBtn = document.getElementById('heroLoginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const heroTrialBtn = document.getElementById('heroTrialBtn');
  
  // íšŒì›ê°€ì…ê³¼ ë¡œê·¸ì¸ ë²„íŠ¼ (NEW v7.3 - ëª¨ë“œ ë¶„ë¦¬)
  if (signupBtn) {
    signupBtn.addEventListener('click', () => openAuthModal('signup'));
  }
  if (loginBtn) {
    loginBtn.addEventListener('click', () => openAuthModal('login'));
  }
  if (heroLoginBtn) heroLoginBtn.addEventListener('click', handleLogin);
  if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);
  if (heroTrialBtn) heroTrialBtn.addEventListener('click', handleTrial);
  
  // íšŒì› ì „ìš© ë²„íŠ¼ í´ë¦­ ì‹œ ë¡œê·¸ì¸ ìœ ë„ + í”„ë¡œí•„ ëª¨ë‹¬ ì—°ê²°
  const saveProfileBtn = document.getElementById('saveProfileBtn');
  const loadProfileBtn = document.getElementById('loadProfileBtn');
  const historyBtn = document.getElementById('historyBtn');
  const templateBtn = document.getElementById('templateBtn');
  
  // í”„ë¡œí•„ ì €ì¥ ë²„íŠ¼
  if (saveProfileBtn) {
    saveProfileBtn.addEventListener('click', (e) => {
      if (currentUser.isGuest) {
        e.preventDefault();
        e.stopPropagation();
        if (confirm('ì´ ê¸°ëŠ¥ì€ íšŒì› ì „ìš©ì…ë‹ˆë‹¤. ë¡œê·¸ì¸ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          handleLogin();
        }
        return false;
      }
      // ë¡œê·¸ì¸ ìƒíƒœ: ëª¨ë‹¬ ì—´ê¸°
      openProfileSaveModal();
    });
  }
  
  // í”„ë¡œí•„ ê´€ë¦¬ ë²„íŠ¼
  if (loadProfileBtn) {
    loadProfileBtn.addEventListener('click', (e) => {
      if (currentUser.isGuest) {
        e.preventDefault();
        e.stopPropagation();
        if (confirm('ì´ ê¸°ëŠ¥ì€ íšŒì› ì „ìš©ì…ë‹ˆë‹¤. ë¡œê·¸ì¸ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          handleLogin();
        }
        return false;
      }
      // ë¡œê·¸ì¸ ìƒíƒœ: ëª¨ë‹¬ ì—´ê¸°
      openProfileListModal();
    });
  }
  
  // íˆìŠ¤í† ë¦¬ ë²„íŠ¼
  if (historyBtn) {
    historyBtn.addEventListener('click', (e) => {
      console.log('ğŸŸ¢ íˆìŠ¤í† ë¦¬ ë²„íŠ¼ í´ë¦­ë¨', currentUser);
      
      if (currentUser.isGuest) {
        console.log('ğŸŸ¡ ê²ŒìŠ¤íŠ¸ ìƒíƒœ - ë¡œê·¸ì¸ ìœ ë„');
        e.preventDefault();
        e.stopPropagation();
        if (confirm('ì´ ê¸°ëŠ¥ì€ íšŒì› ì „ìš©ì…ë‹ˆë‹¤. ë¡œê·¸ì¸ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          handleLogin();
        }
        return false;
      }
      // ë¡œê·¸ì¸ ìƒíƒœ: íˆìŠ¤í† ë¦¬ ëª¨ë‹¬ ì—´ê¸°
      console.log('ğŸŸ¢ ë¡œê·¸ì¸ ìƒíƒœ - openHistoryModal í˜¸ì¶œ');
      openHistoryModal();
    });
    console.log('âœ… íˆìŠ¤í† ë¦¬ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ');
  } else {
    console.error('âŒ historyBtn ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
  }
  
  // í…œí”Œë¦¿ ë²„íŠ¼
  if (templateBtn) {
    templateBtn.addEventListener('click', (e) => {
      if (currentUser.isGuest) {
        e.preventDefault();
        e.stopPropagation();
        if (confirm('ì´ ê¸°ëŠ¥ì€ íšŒì› ì „ìš©ì…ë‹ˆë‹¤. ë¡œê·¸ì¸ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          handleLogin();
        }
        return false;
      }
      // ë¡œê·¸ì¸ ìƒíƒœ: í…œí”Œë¦¿ ê¸°ëŠ¥ ì²´í¬
      if (FEATURE_FLAGS.ENABLE_CUSTOM_TEMPLATES) {
        openTemplateEditor();
      } else {
        showToast('âš ï¸ í…œí”Œë¦¿ ê¸°ëŠ¥ì€ í˜„ì¬ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤', 'warning');
      }
    });
  }
  
  // SNS ë°”ë¡œê°€ê¸° ë²„íŠ¼
  const snsLinksBtn = document.getElementById('snsLinksBtn');
  if (snsLinksBtn) {
    snsLinksBtn.addEventListener('click', () => {
      openSnsLinksModal();
    });
    console.log('âœ… SNS ë°”ë¡œê°€ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ');
  } else {
    console.error('âŒ snsLinksBtn ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
  }
  
  // AI ì›Œí¬í”Œë¡œìš° ë²„íŠ¼
  const aiWorkflowBtn = document.getElementById('aiWorkflowBtn');
  if (aiWorkflowBtn) {
    aiWorkflowBtn.addEventListener('click', () => {
      openAiWorkflowModal();
    });
    console.log('âœ… AI ì›Œí¬í”Œë¡œìš° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ');
  } else {
    console.error('âŒ aiWorkflowBtn ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
  }
  
  // ğŸ” ë””ë²„ê¹…: í•¨ìˆ˜ì™€ ë°ì´í„° ê²€ì¦ (ê°œë°œì ì½˜ì†”ì—ì„œ í™•ì¸ ê°€ëŠ¥)
  setTimeout(() => {
    console.log('ğŸ” === íˆìŠ¤í† ë¦¬/ìº˜ë¦°ë” ê²€ì¦ ===');
    console.log('1ï¸âƒ£ openHistoryModal:', typeof window.openHistoryModal);
    console.log('2ï¸âƒ£ viewHistory:', typeof window.viewHistory);
    console.log('3ï¸âƒ£ loadCalendarEvents:', typeof window.loadCalendarEvents);
    console.log('4ï¸âƒ£ contentHistory:', window.contentHistory ? `${window.contentHistory.length}ê°œ` : 'undefined');
    console.log('5ï¸âƒ£ historyBtn:', document.getElementById('historyBtn') ? 'âœ… ì¡´ì¬' : 'âŒ ì—†ìŒ');
    console.log('6ï¸âƒ£ currentUser:', window.currentUser);
    console.log('================================');
  }, 1000);
  
  // ğŸ†• ì¸ì¦ ëª¨ë‹¬ ë‚´ë¶€ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (NEW v7.3)
  const emailAuthBtn = document.getElementById('emailAuthBtn');
  const googleLoginBtn = document.getElementById('googleLoginBtn');
  const kakaoLoginBtn = document.getElementById('kakaoLoginBtn');
  const authEmail = document.getElementById('authEmail');
  const authModeToggle = document.getElementById('authModeToggle');
  
  if (emailAuthBtn) {
    emailAuthBtn.addEventListener('click', handleEmailAuth);
  }
  
  if (googleLoginBtn) {
    googleLoginBtn.addEventListener('click', handleGoogleLogin);
  }
  
  if (kakaoLoginBtn) {
    kakaoLoginBtn.addEventListener('click', handleKakaoLogin);
  }
  
  if (authEmail) {
    authEmail.addEventListener('input', updateEmailDomainHint);
  }
  
  if (authModeToggle) {
    authModeToggle.addEventListener('click', toggleAuthMode);
  }
});

// ì„ íƒëœ í…œí”Œë¦¿ ê°€ì ¸ì˜¤ê¸° (í–¥í›„ UI ì—°ë™ìš©)
function getSelectedTemplateContent() {
  // í˜„ì¬ëŠ” ì „ì—­ í…œí”Œë¦¿ ì„¤ì • ì—†ì´ í”Œë«í¼ë³„ ìë™ ì ìš©
  // customTemplatesì—ì„œ í”Œë«í¼ë³„ë¡œ ì°¾ì•„ì„œ ë°˜í™˜
  // ë°±ì—”ë“œì—ì„œ í”Œë«í¼ë³„ë¡œ ì•Œì•„ì„œ ì ìš©í•˜ë¯€ë¡œ null ë°˜í™˜
  return null;
}

// ===================================
// í…œí”Œë¦¿ ì €ì¥ ê¸°ëŠ¥
// ===================================

// í…œí”Œë¦¿ ë¡œë“œ
function loadCustomTemplates() {
  try {
    const stored = localStorage.getItem(STORAGE_KEYS.TEMPLATES);
    customTemplates = stored ? JSON.parse(stored) : [];
    console.log(`âœ… í…œí”Œë¦¿ ë¡œë“œ ì™„ë£Œ: ${customTemplates.length}ê°œ`);
    return customTemplates;
  } catch (error) {
    console.error('âŒ í…œí”Œë¦¿ ë¡œë“œ ì‹¤íŒ¨:', error);
    customTemplates = [];
    return [];
  }
}

// í…œí”Œë¦¿ ì €ì¥
function saveCustomTemplate(name, platform, content) {
  try {
    if (!name || !platform || !content) {
      showToast('âŒ í…œí”Œë¦¿ ì´ë¦„, í”Œë«í¼, ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
      return false;
    }
    
    // ìµœëŒ€ ê¸¸ì´ ì²´í¬ (8000ì)
    if (content.length > 8000) {
      showToast('âŒ í…œí”Œë¦¿ì´ ë„ˆë¬´ ê¹ë‹ˆë‹¤ (ìµœëŒ€ 8000ì)', 'error');
      return false;
    }
    
    const template = {
      id: Date.now().toString(),
      name,
      platform,
      content,
      created_at: new Date().toISOString()
    };
    
    customTemplates.push(template);
    localStorage.setItem(STORAGE_KEYS.TEMPLATES, JSON.stringify(customTemplates));
    
    console.log(`âœ… í…œí”Œë¦¿ ì €ì¥ ì™„ë£Œ: ${name}`);
    showToast(`âœ… "${name}" í…œí”Œë¦¿ ì €ì¥ ì™„ë£Œ`, 'success');
    return true;
  } catch (error) {
    console.error('âŒ í…œí”Œë¦¿ ì €ì¥ ì‹¤íŒ¨:', error);
    showToast('âŒ í…œí”Œë¦¿ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
    return false;
  }
}

// í…œí”Œë¦¿ ì‚­ì œ
function deleteCustomTemplate(templateId) {
  try {
    const index = customTemplates.findIndex(t => t.id === templateId);
    if (index === -1) {
      showToast('âŒ í…œí”Œë¦¿ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
      return false;
    }
    
    const templateName = customTemplates[index].name;
    customTemplates.splice(index, 1);
    localStorage.setItem(STORAGE_KEYS.TEMPLATES, JSON.stringify(customTemplates));
    
    console.log(`âœ… í…œí”Œë¦¿ ì‚­ì œ ì™„ë£Œ: ${templateName}`);
    showToast(`âœ… "${templateName}" í…œí”Œë¦¿ ì‚­ì œ ì™„ë£Œ`, 'success');
    return true;
  } catch (error) {
    console.error('âŒ í…œí”Œë¦¿ ì‚­ì œ ì‹¤íŒ¨:', error);
    showToast('âŒ í…œí”Œë¦¿ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
    return false;
  }
}

// í…œí”Œë¦¿ ì—ë””í„° ì—´ê¸°
function openTemplateEditor() {
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.style.cssText = `
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.7); display: flex; align-items: center;
    justify-content: center; z-index: 10000;
  `;
  
  // í…œí”Œë¦¿ í¸ì§‘ UI ìƒì„±
  const platforms = ['blog', 'instagram_feed', 'threads', 'twitter', 'linkedin', 'kakaotalk', 'brunch', 'tiktok', 'instagram_reels', 'youtube_shorts', 'youtube_longform', 'metadata_generation'];
  const platformNames = {
    blog: 'ë„¤ì´ë²„ ë¸”ë¡œê·¸',
    instagram: 'ì¸ìŠ¤íƒ€ê·¸ë¨ (ê¸°ì¡´)',
    instagram_feed: 'ì¸ìŠ¤íƒ€ê·¸ë¨ í”¼ë“œ',
    threads: 'ìŠ¤ë ˆë“œ',
    twitter: 'íŠ¸ìœ„í„°(X)',
    linkedin: 'LinkedIn',
    kakaotalk: 'ì¹´ì¹´ì˜¤í†¡',
    brunch: 'ë¸ŒëŸ°ì¹˜',
    tiktok: 'í‹±í†¡',
    instagram_reels: 'ì¸ìŠ¤íƒ€ê·¸ë¨ ë¦´ìŠ¤',
    youtube_shorts: 'ìœ íŠœë¸Œ ì‡¼ì¸ ',
    youtube_longform: 'ìœ íŠœë¸Œ ë¡±í¼',
    metadata_generation: 'ë©”íƒ€ë°ì´í„° ìƒì„±'
  };
  
  const platformIcons = {
    blog: '<i class="fas fa-blog text-blue-600 mr-2"></i>',
    instagram: '<i class="fab fa-instagram text-pink-600 mr-2"></i>',
    instagram_feed: '<i class="fab fa-instagram text-pink-600 mr-2"></i>',
    threads: '<i class="fas fa-at text-gray-800 mr-2"></i>',
    twitter: '<i class="fab fa-twitter text-blue-400 mr-2"></i>',
    linkedin: '<i class="fab fa-linkedin text-blue-700 mr-2"></i>',
    kakaotalk: '<i class="fas fa-comment-dots text-yellow-500 mr-2"></i>',
    brunch: '<i class="fas fa-book-open text-orange-600 mr-2"></i>',
    tiktok: '<i class="fab fa-tiktok text-black mr-2"></i>',
    instagram_reels: '<i class="fab fa-instagram text-purple-600 mr-2"></i>',
    youtube_shorts: '<i class="fab fa-youtube text-red-500 mr-2"></i>',
    youtube_longform: '<i class="fab fa-youtube text-red-600 mr-2"></i>',
    metadata_generation: '<i class="fas fa-tags text-blue-600 mr-2"></i>'
  };
  
  modal.innerHTML = `
    <div style="background: white; border-radius: 20px; padding: 2rem; max-width: 1200px; width: 95%; max-height: 90vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="margin: 0;">ğŸ’¾ í…œí”Œë¦¿ ê´€ë¦¬</h2>
        <button onclick="this.closest('.modal-overlay').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">âœ•</button>
      </div>
      
      <div style="background: #e0f2fe; border-left: 4px solid #0284c7; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
        <p style="margin: 0; font-weight: 600; color: #0c4a6e; margin-bottom: 0.5rem;">ğŸ’¡ ì‚¬ìš© ê°€ëŠ¥í•œ ë³€ìˆ˜:</p>
        <div style="font-size: 0.9rem; color: #075985;">
          <code>{ë¸Œëœë“œëª…}</code> <code>{í‚¤ì›Œë“œ}</code> <code>{í†¤ì•¤ë§¤ë„ˆ}</code> <code>{íƒ€ê²Ÿì—°ë ¹ëŒ€}</code> <code>{íƒ€ê²Ÿì„±ë³„}</code> <code>{ì‚°ì—…ë¶„ì•¼}</code>
        </div>
      </div>
      
      <div id="templateList" style="display: flex; flex-direction: column; gap: 1.5rem;">
        ${platforms.map(platform => {
          const custom = customTemplates.find(t => t.platform === platform);
          const template = custom ? custom.template : DEFAULT_TEMPLATES[platform];
          
          return `
            <div style="border: 2px solid #e5e7eb; border-radius: 12px; padding: 1.5rem; background: #fafafa;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h4 style="margin: 0; font-size: 1.1rem; color: #1f2937;">${platformIcons[platform] || ''}${platformNames[platform]}</h4>
                <div style="display: flex; gap: 0.5rem;">
                  <button
                    onclick="resetTemplate('${platform}')"
                    style="padding: 0.5rem 1rem; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s;"
                    onmouseover="this.style.background='#4b5563'"
                    onmouseout="this.style.background='#6b7280'"
                  >
                    ğŸ”„ ê¸°ë³¸ê°’
                  </button>
                  <button
                    onclick="saveTemplate('${platform}')"
                    style="padding: 0.5rem 1rem; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s;"
                    onmouseover="this.style.background='#059669'"
                    onmouseout="this.style.background='#10b981'"
                  >
                    ğŸ’¾ ì €ì¥
                  </button>
                </div>
              </div>
              <textarea
                id="template_${platform}"
                style="width: 100%; height: 200px; padding: 1rem; border: 1px solid #d1d5db; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 0.85rem; resize: vertical; background: white;"
                placeholder="í…œí”Œë¦¿ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."
              >${template || ''}</textarea>
              <div style="text-align: right; margin-top: 0.5rem; color: #6b7280; font-size: 0.85rem;">
                <span id="charCount_${platform}">0</span> / 8000ì
              </div>
            </div>
          `;
        }).join('')}
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // ê¸€ì ìˆ˜ ì¹´ìš´í„° ì´ˆê¸°í™”
  platforms.forEach(platform => {
    const textarea = document.getElementById(`template_${platform}`);
    const charCount = document.getElementById(`charCount_${platform}`);
    
    if (textarea && charCount) {
      // ì´ˆê¸° ê¸€ì ìˆ˜ ì„¤ì •
      charCount.textContent = textarea.value.length;
      
      // ì…ë ¥ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      textarea.addEventListener('input', () => {
        charCount.textContent = textarea.value.length;
        if (textarea.value.length > 8000) {
          charCount.style.color = '#ef4444';
          charCount.style.fontWeight = '600';
        } else {
          charCount.style.color = '#6b7280';
          charCount.style.fontWeight = 'normal';
        }
      });
    }
  });
}

// í…œí”Œë¦¿ ì €ì¥ í•¸ë“¤ëŸ¬
function handleSaveTemplate() {
  const name = document.getElementById('templateName').value.trim();
  const platform = document.getElementById('templatePlatform').value;
  const content = document.getElementById('templateContent').value.trim();
  
  if (saveCustomTemplate(name, platform, content)) {
    openTemplateEditor(); // ëª¨ë‹¬ ìƒˆë¡œê³ ì¹¨
  }
}

// í…œí”Œë¦¿ ì‚­ì œ í•¸ë“¤ëŸ¬
function handleDeleteTemplate(templateId) {
  if (confirm('ì •ë§ ì´ í…œí”Œë¦¿ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
    if (deleteCustomTemplate(templateId)) {
      openTemplateEditor(); // ëª¨ë‹¬ ìƒˆë¡œê³ ì¹¨
    }
  }
}

// ì „ì—­ ë…¸ì¶œ
window.initializeAuth = initializeAuth;
window.initSupabase = initSupabase;
window.checkSupabaseSession = checkSupabaseSession;
window.checkAuthStatus = checkAuthStatus;
window.updateAuthUI = updateAuthUI;
window.handleLogin = handleLogin;
window.handleLogout = handleLogout;
window.handleTrial = handleTrial;
window.currentUser = currentUser;
window.supabaseClient = null; // ì´ˆê¸°í™” í›„ ì ‘ê·¼ ê°€ëŠ¥
window.openTemplateEditor = openTemplateEditor;
window.saveTemplate = saveTemplate;
window.resetTemplate = resetTemplate;


// ========================================
// Phase 3: ì½˜í…ì¸  ê´€ë¦¬ ìº˜ë¦°ë” (ì™„ì „ ê°œí¸)
// ========================================

// ì „ì—­ ë³€ìˆ˜
let calendarInstance = null;
let flatpickrInstance = null;
let quickAddFlatpickr = null;
let pendingScheduleData = null;
let isCalendarView = true;

/**
 * FullCalendar ì´ˆê¸°í™”
 */
function initFullCalendar() {
  const calendarEl = document.getElementById('fullCalendar');
  if (!calendarEl) return;

  if (calendarInstance) {
    calendarInstance.destroy();
  }

  calendarInstance = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    locale: 'ko',
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,dayGridWeek'
    },
    buttonText: {
      today: 'ì˜¤ëŠ˜',
      month: 'ì›”',
      week: 'ì£¼'
    },
    height: 'auto',
    eventClassNames: function(arg) {
      const status = arg.event.extendedProps.publish_status || 'draft';
      return [`fc-event-${status}`];
    },
    eventClick: function(info) {
      const eventType = info.event.extendedProps.type;
      if (eventType === 'memo') {
        // ë©”ëª¨ í´ë¦­ â†’ ë©”ëª¨ ìˆ˜ì • ëª¨ë‹¬
        openMemoModal(info.event.extendedProps.memo_date, info.event.extendedProps.memo_id);
      } else {
        // ì˜ˆì •ì¼ í´ë¦­ â†’ ìƒì„¸ ëª¨ë‹¬
        showEventDetails(info.event);
      }
    },
    dateClick: function(info) {
      // ë¹ˆ ë‚ ì§œ í´ë¦­ ì‹œ ë©”ëª¨ ì…ë ¥ ëª¨ë‹¬ ì—´ê¸°
      // toISOString()ì€ UTC ë³€í™˜í•˜ë¯€ë¡œ ì§ì ‘ ë¬¸ìì—´ ì¡°í•©
      const year = info.date.getFullYear();
      const month = String(info.date.getMonth() + 1).padStart(2, '0');
      const day = String(info.date.getDate()).padStart(2, '0');
      const dateStr = `${year}-${month}-${day}`;
      console.log('ğŸ“… dateClick - í´ë¦­í•œ ë‚ ì§œ:', dateStr);
      openMemoModal(dateStr);
    },
    events: async function(fetchInfo, successCallback, failureCallback) {
      try {
        const events = await loadCalendarEvents();
        successCallback(events);
      } catch (error) {
        console.error('ìº˜ë¦°ë” ì´ë²¤íŠ¸ ë¡œë“œ ì˜¤ë¥˜:', error);
        failureCallback(error);
      }
    },
    // âœ… ì»¤ìŠ¤í…€ ì´ë²¤íŠ¸ ë Œë”ë§ (Font Awesome ì•„ì´ì½˜ ì‚¬ìš©)
    eventContent: function(arg) {
      const props = arg.event.extendedProps;
      const platform = props.platform;
      const status = props.publish_status || 'draft';
      
      // ìƒíƒœë³„ ë°°ê²½ìƒ‰
      const bgColors = {
        published: '#10b981',
        cancelled: '#ef4444',
        scheduled: '#3b82f6',
        draft: '#3b82f6'
      };
      const bgColor = bgColors[status] || '#3b82f6';
      
      // Font Awesome ì•„ì´ì½˜ ë§¤í•‘
      const platformIcons = {
        blog: { class: 'fas fa-blog', color: '#ffffff' },
        instagram: { class: 'fab fa-instagram', color: '#ffffff' },
        instagramFeed: { class: 'fab fa-instagram', color: '#ffffff' },
        instagram_feed: { class: 'fab fa-instagram', color: '#ffffff' },
        instagram_reels: { class: 'fab fa-instagram', color: '#ffffff' },
        threads: { class: 'fas fa-at', color: '#ffffff' },
        youtube: { class: 'fab fa-youtube', color: '#ffffff' },
        youtube_longform: { class: 'fab fa-youtube', color: '#ffffff' },
        youtube_shorts: { class: 'fab fa-youtube', color: '#ffffff' },
        youtubeLongform: { class: 'fab fa-youtube', color: '#ffffff' },
        linkedin: { class: 'fab fa-linkedin', color: '#ffffff' },
        facebook: { class: 'fab fa-facebook', color: '#ffffff' },
        twitter: { class: 'fab fa-twitter', color: '#ffffff' },
        kakaotalk: { class: 'fas fa-comment-dots', color: '#ffffff' },
        brunch: { class: 'fas fa-book-open', color: '#ffffff' },
        naverband: { class: 'fas fa-users', color: '#ffffff' },
        band: { class: 'fas fa-users', color: '#ffffff' },
        telegram: { class: 'fab fa-telegram', color: '#ffffff' },
        tiktok: { class: 'fab fa-tiktok', color: '#ffffff' },
        shortform_multi: { class: 'fas fa-film', color: '#ffffff' }
      };
      
      const iconData = platformIcons[platform] || { class: 'fas fa-file', color: '#ffffff' };
      
      // ë©”ëª¨ì¸ ê²½ìš° ê¸°ë³¸ ë Œë”ë§
      if (props.type === 'memo') {
        return {
          html: `<div class="fc-event-main-frame" style="background-color: #f59e0b; color: white; padding: 2px 4px; border-radius: 3px;">
            ${arg.timeText ? `<div class="fc-event-time">${arg.timeText}</div>` : ''}
            <div class="fc-event-title-container">
              <div class="fc-event-title fc-sticky">${arg.event.title}</div>
            </div>
          </div>`
        };
      }
      
      // ì˜ˆì •ì¼ ì´ë²¤íŠ¸: Font Awesome ì•„ì´ì½˜ + ì œëª© + ë°°ê²½ìƒ‰
      return {
        html: `<div class="fc-event-main-frame" style="background-color: ${bgColor}; color: white; padding: 2px 4px; border-radius: 3px;">
          ${arg.timeText ? `<div class="fc-event-time">${arg.timeText}</div>` : ''}
          <div class="fc-event-title-container">
            <div class="fc-event-title fc-sticky">
              <i class="${iconData.class}" style="margin-right: 4px; color: ${iconData.color};"></i>
              ${arg.event.title}
            </div>
          </div>
        </div>`
      };
    },
    dayCellContent: function(arg) {
      // ë©”ëª¨ê°€ ìˆëŠ” ë‚ ì§œì— ì•„ì´ì½˜ í‘œì‹œ (ë‚˜ì¤‘ì— êµ¬í˜„)
      return { html: arg.dayNumberText };
    }
  });

  calendarInstance.render();
  console.log('âœ… FullCalendar ì´ˆê¸°í™” ì™„ë£Œ');
}

/**
 * ìº˜ë¦°ë” ì´ë²¤íŠ¸ ë¡œë“œ (ì˜ˆì •ì¼ + ë©”ëª¨)
 */
async function loadCalendarEvents() {
  const user = window.currentUser;
  if (!user || !user.id) return [];

  try {
    // 1ï¸âƒ£ ì˜ˆì •ì¼ ë¡œë“œ
    const scheduleResponse = await fetch(`/api/scheduled-content?user_id=${user.id}`);
    const scheduleData = await scheduleResponse.json();

    // 2ï¸âƒ£ ë©”ëª¨ ë¡œë“œ
    const memoResponse = await fetch(`/api/calendar-memos?user_id=${user.id}`);
    const memoData = await memoResponse.json();

    const events = [];

    // ì˜ˆì •ì¼ ì´ë²¤íŠ¸ ì¶”ê°€
    if (scheduleData.success && scheduleData.scheduled_content) {
      // âœ… ì´ëª¨ì§€ëŠ” ìº˜ë¦°ë”ìš© (FullCalendarëŠ” HTML ë¯¸ì§€ì›)
      const platformEmojis = {
        blog: 'ğŸ“',
        instagram: 'ğŸ“·',
        instagramFeed: 'ğŸ“·',
        instagram_feed: 'ğŸ“·',
        instagram_reels: 'ğŸ¬',
        threads: '@',
        youtube: 'â–¶ï¸',
        youtube_longform: 'â–¶ï¸',
        youtube_shorts: 'â–¶ï¸',
        youtubeLongform: 'â–¶ï¸',
        linkedin: 'ğŸ’¼',
        facebook: 'ğŸ“˜',
        twitter: 'ğŸ¦',
        kakaotalk: 'ğŸ’¬',
        brunch: 'ğŸ“–',
        naverband: 'ğŸµ',
        telegram: 'âœˆï¸',
        tiktok: 'ğŸµ',
        band: 'ğŸµ',
        shortform_multi: 'ğŸ¬'
      };

      const platformNames = {
        blog: 'ë¸”ë¡œê·¸',
        instagram: 'ì¸ìŠ¤íƒ€ê·¸ë¨',
        instagramFeed: 'ì¸ìŠ¤íƒ€í”¼ë“œ',
        instagram_feed: 'ì¸ìŠ¤íƒ€í”¼ë“œ',
        instagram_reels: 'ì¸ìŠ¤íƒ€ë¦´ìŠ¤',
        threads: 'ìŠ¤ë ˆë“œ',
        youtube: 'ìœ íŠœë¸Œ',
        youtube_shorts: 'ìœ íŠœë¸Œì‡¼ì¸ ',
        youtube_longform: 'ìœ íŠœë¸Œë¡±í¼',
        youtubeLongform: 'ìœ íŠœë¸Œë¡±í¼',
        linkedin: 'LinkedIn',
        facebook: 'í˜ì´ìŠ¤ë¶',
        twitter: 'íŠ¸ìœ„í„°',
        kakaotalk: 'ì¹´ì¹´ì˜¤í†¡',
        naverband: 'ë°´ë“œ',
        telegram: 'í…”ë ˆê·¸ë¨',
        tiktok: 'í‹±í†¡',
        shortform_multi: 'ìˆí¼'
      };

      // âœ… Font Awesome ì•„ì´ì½˜ ë§¤í•‘ (ëª©ë¡/ëª¨ë‹¬ìš©)
      const platformIcons = {
        blog: { class: 'fas fa-blog', color: 'text-blue-600' },
        instagram: { class: 'fab fa-instagram', color: 'text-pink-600' },
        instagramFeed: { class: 'fab fa-instagram', color: 'text-pink-600' },
        instagram_feed: { class: 'fab fa-instagram', color: 'text-pink-600' },
        instagram_reels: { class: 'fab fa-instagram', color: 'text-purple-600' },
        threads: { class: 'fas fa-at', color: 'text-gray-800' },
        youtube: { class: 'fab fa-youtube', color: 'text-red-600' },
        youtube_longform: { class: 'fab fa-youtube', color: 'text-red-600' },
        youtube_shorts: { class: 'fab fa-youtube', color: 'text-red-500' },
        youtubeLongform: { class: 'fab fa-youtube', color: 'text-red-600' },
        linkedin: { class: 'fab fa-linkedin', color: 'text-blue-700' },
        facebook: { class: 'fab fa-facebook', color: 'text-blue-600' },
        twitter: { class: 'fab fa-twitter', color: 'text-blue-400' },
        kakaotalk: { class: 'fas fa-comment-dots', color: 'text-yellow-500' },
        brunch: { class: 'fas fa-book-open', color: 'text-orange-600' },
        naverband: { class: 'fas fa-users', color: 'text-green-600' },
        band: { class: 'fas fa-users', color: 'text-green-600' },
        telegram: { class: 'fab fa-telegram', color: 'text-blue-500' },
        tiktok: { class: 'fab fa-tiktok', color: 'text-black' },
        shortform_multi: { class: 'fas fa-film', color: 'text-purple-600' }
      };

      scheduleData.scheduled_content.forEach(item => {
        // âœ… platform_status ìš°ì„ , ì—†ìœ¼ë©´ ê¸°ì¡´ publish_status ì‚¬ìš©
        const platformStatus = item.platform_status || {};
        const fallbackStatus = item.publish_status || 'draft';
        
        // ê° í”Œë«í¼ë§ˆë‹¤ ë³„ë„ ì´ë²¤íŠ¸ ìƒì„±
        if (item.platforms && Array.isArray(item.platforms)) {
          item.platforms.forEach((platform, index) => {
            // âœ… í”Œë«í¼ë³„ ìƒíƒœ ì‚¬ìš©
            const status = platformStatus[platform] || fallbackStatus;
            
            // âœ… scheduled_dateê°€ ì—†ê±°ë‚˜ draft ìƒíƒœë©´ ìº˜ë¦°ë”ì— í‘œì‹œí•˜ì§€ ì•ŠìŒ
            if (!item.scheduled_date || status === 'draft') {
              return; // ê±´ë„ˆë›°ê¸°
            }
            
            const backgroundColor = status === 'published' ? '#10b981' : status === 'cancelled' ? '#ef4444' : '#3b82f6';
            
            const emoji = platformEmojis[platform] || 'ğŸ“„';
            const platformName = platformNames[platform] || platform || 'ì½˜í…ì¸ ';
            
            // results (jsonb)ì—ì„œ í•´ë‹¹ í”Œë«í¼ì˜ ë°ì´í„° ì¶”ì¶œ
            let title = platformName; // ê¸°ë³¸ê°’: í”Œë«í¼ ì´ë¦„
            let content = 'ë‚´ìš© ì—†ìŒ';
            
            if (item.results && typeof item.results === 'object') {
              const platformData = item.results[platform];
              
              if (platformData) {
                // âœ… ì½˜í…ì¸ ê°€ ë¬¸ìì—´ë¡œ ì§ì ‘ ì €ì¥ë˜ì–´ ìˆëŠ” ê²½ìš°
                if (typeof platformData === 'string') {
                  content = platformData;
                  title = platformData.substring(0, 50) + (platformData.length > 50 ? '...' : '');
                }
                // âœ… ê°ì²´ì¸ ê²½ìš°
                else if (typeof platformData === 'object') {
                  // ì œëª© ì¶”ì¶œ
                  if (platformData.title) {
                    title = platformData.title;
                  } else if (platformData.content) {
                    // ì œëª©ì´ ì—†ìœ¼ë©´ ì½˜í…ì¸ ì˜ ì²« 50ìë¥¼ ì œëª©ìœ¼ë¡œ ì‚¬ìš©
                    const contentText = platformData.content;
                    if (contentText && contentText.length > 0) {
                      title = contentText.substring(0, 50) + (contentText.length > 50 ? '...' : '');
                    }
                  }
                  // ì½˜í…ì¸  ì¶”ì¶œ
                  if (platformData.content) {
                    content = platformData.content;
                  }
                }
              }
            }
            
            // ì´ë²¤íŠ¸ ì¶”ê°€
            // âœ… ë‚ ì§œë§Œ í‘œì‹œ (ì‹œê°„ ì œê±°)
            const scheduledDate = new Date(item.scheduled_date);
            const dateOnly = `${scheduledDate.getFullYear()}-${String(scheduledDate.getMonth() + 1).padStart(2, '0')}-${String(scheduledDate.getDate()).padStart(2, '0')}`;
            
            events.push({
              id: `${item.id}-${platform}-${index}`, // ê³ ìœ  ID
              title: `${platformName}: ${title}`, // âœ… ì´ëª¨ì§€ ì œê±°, í”Œë«í¼ ì´ë¦„ë§Œ
              start: dateOnly, // âœ… ë‚ ì§œë§Œ (ì‹œê°„ ì œê±°)
              allDay: true, // âœ… ì¢…ì¼ ì´ë²¤íŠ¸ë¡œ ì„¤ì •
              backgroundColor: backgroundColor,
              extendedProps: {
                type: 'schedule',
                generation_id: item.id,
                platform: platform, // âœ… í”Œë«í¼ ì •ë³´ ì €ì¥ (eventContentì—ì„œ ì‚¬ìš©)
                platforms: item.platforms,
                publish_status: status, // âœ… í”Œë«í¼ë³„ ìƒíƒœ
                content: content,
                content_title: title,
                created_at: item.created_at,
                results: item.results,
                scheduled_date_full: item.scheduled_date // âœ… ì›ë³¸ ë‚ ì§œ ì €ì¥ (ì‹œê°„ í¬í•¨)
              }
            });
          });
        } else {
          // platforms ë°°ì—´ì´ ì—†ëŠ” ê²½ìš° (ê¸°ì¡´ ë°©ì‹)
          const platform = item.platform || 'unknown';
          const emoji = platformEmojis[platform] || 'ğŸ“„';
          const platformName = platformNames[platform] || platform || 'ì½˜í…ì¸ ';
          
          let title = platformName;
          let content = 'ë‚´ìš© ì—†ìŒ';
          
          if (item.results && typeof item.results === 'object') {
            const firstPlatform = Object.keys(item.results)[0];
            if (firstPlatform && item.results[firstPlatform]) {
              const firstData = item.results[firstPlatform];
              // âœ… ë¬¸ìì—´ë¡œ ì§ì ‘ ì €ì¥ëœ ê²½ìš°
              if (typeof firstData === 'string') {
                content = firstData;
                title = firstData.substring(0, 50) + (firstData.length > 50 ? '...' : '');
              }
              // âœ… ê°ì²´ì¸ ê²½ìš°
              else if (typeof firstData === 'object') {
                if (firstData.title) {
                  title = firstData.title;
                } else if (firstData.content) {
                  title = firstData.content.substring(0, 50) + (firstData.content.length > 50 ? '...' : '');
                }
                if (firstData.content) {
                  content = firstData.content;
                }
              }
            }
          }
          
          // âœ… ë‚ ì§œë§Œ í‘œì‹œ (ì‹œê°„ ì œê±°)
          const scheduledDate = new Date(item.scheduled_date);
          const dateOnly = `${scheduledDate.getFullYear()}-${String(scheduledDate.getMonth() + 1).padStart(2, '0')}-${String(scheduledDate.getDate()).padStart(2, '0')}`;
          
          events.push({
            id: item.id,
            title: `${platformName}: ${title}`, // âœ… ì´ëª¨ì§€ ì œê±°, í”Œë«í¼ ì´ë¦„ë§Œ
            start: dateOnly, // âœ… ë‚ ì§œë§Œ (ì‹œê°„ ì œê±°)
            allDay: true, // âœ… ì¢…ì¼ ì´ë²¤íŠ¸ë¡œ ì„¤ì •
            backgroundColor: backgroundColor,
            extendedProps: {
              type: 'schedule',
              generation_id: item.id,
              platform: platform, // âœ… í”Œë«í¼ ì •ë³´ ì €ì¥ (eventContentì—ì„œ ì‚¬ìš©)
              platforms: [platform],
              publish_status: status,
              content: content,
              content_title: title,
              created_at: item.created_at,
              results: item.results,
              scheduled_date_full: item.scheduled_date // âœ… ì›ë³¸ ë‚ ì§œ ì €ì¥ (ì‹œê°„ í¬í•¨)
            }
          });
        }
      });
    }

    // ë©”ëª¨ ì´ë²¤íŠ¸ ì¶”ê°€
    if (memoData.success && memoData.memos) {
      memoData.memos.forEach(memo => {
        // memo.dateëŠ” UTC í˜•ì‹ì´ë¯€ë¡œ KSTë¡œ ë³€í™˜ í›„ ë‚ ì§œ ì¶”ì¶œ
        const utcDate = new Date(memo.date);
        const year = utcDate.getFullYear();
        const month = String(utcDate.getMonth() + 1).padStart(2, '0');
        const day = String(utcDate.getDate()).padStart(2, '0');
        const memoDate = `${year}-${month}-${day}`;
        
        events.push({
          id: `memo-${memo.id}`,
          title: `ğŸ“ ${memo.memo.substring(0, 20)}${memo.memo.length > 20 ? '...' : ''}`,
          start: memoDate, // ë‚ ì§œë§Œ í‘œì‹œ (ì‹œê°„ ì œê±°)
          backgroundColor: '#f59e0b',
          extendedProps: {
            type: 'memo',
            memo_id: memo.id,
            memo_text: memo.memo,
            memo_date: memoDate, // ë‚ ì§œë§Œ ì €ì¥
            memo_time: memo.date // ì „ì²´ timestamp ë³´ê´€
          }
        });
      });
    }

    const scheduledEventCount = events.filter(e => e.extendedProps?.type !== 'memo').length;
    const memoCount = events.filter(e => e.extendedProps?.type === 'memo').length;
    
    console.log(`âœ… ìº˜ë¦°ë” ì´ë²¤íŠ¸ ë¡œë“œ: API ${scheduleData.scheduled_content?.length || 0}ê°œ â†’ í•„í„°ë§ í›„ ${scheduledEventCount}ê°œ (scheduled_date ìˆìŒ), ë©”ëª¨ ${memoCount}ê°œ`);
    return events;
    
  } catch (error) {
    console.error('ìº˜ë¦°ë” ì´ë²¤íŠ¸ ë¡œë“œ ì˜¤ë¥˜:', error);
    return [];
  }
}

/**
 * ì´ë²¤íŠ¸ ìƒì„¸ ì •ë³´ í‘œì‹œ
 */
function showEventDetails(event) {
  const props = event.extendedProps;
  const statusLabels = {
    draft: 'ì´ˆì•ˆ',
    scheduled: 'ğŸ“… ì˜ˆì •',
    published: 'âœ… ë°œí–‰ì™„ë£Œ',
    cancelled: 'âŒ ì·¨ì†Œ'
  };

  const platformNames = {
    blog: 'ë„¤ì´ë²„ë¸”ë¡œê·¸',
    instagram: 'ì¸ìŠ¤íƒ€ê·¸ë¨',
    instagramFeed: 'ì¸ìŠ¤íƒ€ê·¸ë¨ í”¼ë“œ',
    threads: 'ìŠ¤ë ˆë“œ',
    youtube: 'ìœ íŠœë¸Œ',
    youtubeLongform: 'ìœ íŠœë¸Œ ë¡±í¼',
    linkedin: 'LinkedIn',
    facebook: 'í˜ì´ìŠ¤ë¶',
    twitter: 'íŠ¸ìœ„í„°(X)',
    kakaotalk: 'ì¹´ì¹´ì˜¤í†¡',
    naverband: 'ë„¤ì´ë²„ ë°´ë“œ',
    telegram: 'í…”ë ˆê·¸ë¨'
  };

  // âœ… Font Awesome ì•„ì´ì½˜ ë§¤í•‘ (ìº˜ë¦°ë”ì™€ ë™ì¼)
  const platformIcons = {
    blog: { class: 'fas fa-blog', color: 'text-blue-600' },
    instagram: { class: 'fab fa-instagram', color: 'text-pink-600' },
    instagramFeed: { class: 'fab fa-instagram', color: 'text-pink-600' },
    instagram_feed: { class: 'fab fa-instagram', color: 'text-pink-600' },
    instagram_reels: { class: 'fab fa-instagram', color: 'text-purple-600' },
    threads: { class: 'fas fa-at', color: 'text-gray-800' },
    youtube: { class: 'fab fa-youtube', color: 'text-red-600' },
    youtube_longform: { class: 'fab fa-youtube', color: 'text-red-600' },
    youtube_shorts: { class: 'fab fa-youtube', color: 'text-red-500' },
    youtubeLongform: { class: 'fab fa-youtube', color: 'text-red-600' },
    linkedin: { class: 'fab fa-linkedin', color: 'text-blue-700' },
    facebook: { class: 'fab fa-facebook', color: 'text-blue-600' },
    twitter: { class: 'fab fa-twitter', color: 'text-blue-400' },
    kakaotalk: { class: 'fas fa-comment-dots', color: 'text-yellow-500' },
    brunch: { class: 'fas fa-book-open', color: 'text-orange-600' },
    naverband: { class: 'fas fa-users', color: 'text-green-600' },
    band: { class: 'fas fa-users', color: 'text-green-600' },
    telegram: { class: 'fab fa-telegram', color: 'text-blue-500' },
    tiktok: { class: 'fab fa-tiktok', color: 'text-black' },
    shortform_multi: { class: 'fas fa-film', color: 'text-purple-600' }
  };

  const status = statusLabels[props.publish_status] || 'ì´ˆì•ˆ';
  const platform = platformNames[props.platform] || props.platform;
  const iconData = platformIcons[props.platform] || { class: 'fas fa-file', color: 'text-gray-600' };
  const title = props.content_title || event.title.replace(/^[^\s]+\s/, ''); // ì´ëª¨ì§€ ì œê±°
  const content = props.content ? props.content.substring(0, 300) : 'ë‚´ìš© ì—†ìŒ';
  
  // âœ… ì›ë³¸ ë‚ ì§œ ì‚¬ìš© (ì‹œê°„ í¬í•¨)
  const scheduledDateFull = props.scheduled_date_full || event.start;
  const scheduledDate = new Date(scheduledDateFull).toLocaleString('ko-KR', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    hour12: true
  });
  
  // âœ… ìƒì„±ì¼ ì¶”ê°€
  const createdDate = props.created_at ? new Date(props.created_at).toLocaleString('ko-KR', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    hour12: true
  }) : 'ì •ë³´ ì—†ìŒ';

  const html = `
    <div class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center" id="eventDetailsModal">
      <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-lg mx-4 w-full max-h-[90vh] overflow-y-auto">
        <div class="text-center mb-6">
          <div class="text-5xl mb-4">
            <i class="${iconData.class} ${iconData.color}"></i>
          </div>
          <h3 class="text-2xl font-bold text-gray-800 mb-2">${platform}</h3>
          <p class="text-gray-600">${status}</p>
        </div>
        
        <div class="space-y-4 mb-6">
          <div class="bg-gray-50 p-4 rounded-lg">
            <p class="text-sm font-semibold text-gray-700 mb-2">
              <i class="fas fa-calendar mr-2"></i>ë°œí–‰ ì˜ˆì •ì¼
            </p>
            <p class="text-gray-800">${scheduledDate}</p>
          </div>
          
          <div class="bg-gray-50 p-4 rounded-lg">
            <p class="text-sm font-semibold text-gray-700 mb-2">
              <i class="fas fa-clock mr-2"></i>ìƒì„±ì¼
            </p>
            <p class="text-gray-800">${createdDate}</p>
          </div>
          
          <div class="bg-gray-50 p-4 rounded-lg">
            <p class="text-sm font-semibold text-gray-700 mb-2">
              <i class="fas fa-heading mr-2"></i>ì œëª©
            </p>
            <p class="text-sm text-gray-800 font-medium">${title}</p>
          </div>
          
          <div class="bg-gray-50 p-4 rounded-lg">
            <p class="text-sm font-semibold text-gray-700 mb-2">
              <i class="fas fa-file-alt mr-2"></i>ì½˜í…ì¸  ë¯¸ë¦¬ë³´ê¸°
            </p>
            <p class="text-sm text-gray-600 whitespace-pre-wrap">${content}</p>
          </div>
        </div>
        
        <div class="flex gap-2 mb-4">
          <button onclick="changeEventStatus('${props.generation_id}', '${props.platform}', 'scheduled')" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm">
            <i class="fas fa-calendar-check mr-1"></i>ì˜ˆì •
          </button>
          <button onclick="changeEventStatus('${props.generation_id}', '${props.platform}', 'published')" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm">
            <i class="fas fa-check mr-1"></i>ë°œí–‰
          </button>
          <button onclick="changeEventStatus('${props.generation_id}', '${props.platform}', 'cancelled')" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition text-sm">
            <i class="fas fa-times mr-1"></i>ì·¨ì†Œ
          </button>
        </div>
        
        <div class="flex gap-2 mb-4">
          <button onclick="viewFullContent('${props.generation_id}', '${props.platform}')" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition text-sm">
            <i class="fas fa-eye mr-1"></i>ë³´ê¸°
          </button>
          <button onclick="deleteScheduledEvent('${props.generation_id}', '${props.platform}')" class="flex-1 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition text-sm">
            <i class="fas fa-trash mr-1"></i>ì‚­ì œ
          </button>
        </div>
        
        <button onclick="closeEventDetailsModal()" class="w-full px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition">
          ë‹«ê¸°
        </button>
      </div>
    </div>
  `;

  document.body.insertAdjacentHTML('beforeend', html);
}

/**
 * ì´ë²¤íŠ¸ ìƒì„¸ ëª¨ë‹¬ ë‹«ê¸°
 */
function closeEventDetailsModal() {
  const modal = document.getElementById('eventDetailsModal');
  if (modal) {
    modal.remove();
  }
}

/**
 * ì´ë²¤íŠ¸ ìƒíƒœ ë³€ê²½ (í”Œë«í¼ë³„)
 * @param {string} generationId - ì›ë³¸ generation ID
 * @param {string} platform - í”Œë«í¼ ì´ë¦„ (ì˜ˆ: 'blog', 'instagram')
 * @param {string} newStatus - ìƒˆ ìƒíƒœ ('draft', 'scheduled', 'published', 'cancelled')
 */
async function changeEventStatus(generationId, platform, newStatus) {
  const user = window.currentUser;
  if (!user || !user.id) {
    showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
    return;
  }

  try {
    const response = await fetch(`/api/schedule-content/${generationId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        user_id: user.id,
        platform: platform, // âœ… í”Œë«í¼ ì •ë³´ ì „ë‹¬
        publish_status: newStatus
      })
    });

    const data = await response.json();

    if (!data.success) {
      throw new Error(data.error || 'ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨');
    }

    showToast(`${platform} ë°œí–‰ ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
    closeEventDetailsModal();
    
    // ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨
    if (calendarInstance) {
      calendarInstance.refetchEvents();
    }
  } catch (error) {
    console.error('ë°œí–‰ ìƒíƒœ ë³€ê²½ ì˜¤ë¥˜:', error);
    showToast('ë°œí–‰ ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
  }
}

/**
 * ì˜ˆì •ì¼ ì´ë²¤íŠ¸ ì‚­ì œ (íŠ¹ì • í”Œë«í¼ë§Œ)
 */
async function deleteScheduledEvent(eventId, platform) {
  const user = window.currentUser;
  if (!user || !user.id) {
    showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
    return;
  }

  if (!confirm(`ì´ í”Œë«í¼(${platform})ì˜ ì˜ˆì •ì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
    return;
  }

  try {
    // âœ… í•´ë‹¹ í”Œë«í¼ë§Œ 'draft' ìƒíƒœë¡œ ë³€ê²½ (scheduled_dateëŠ” ìœ ì§€)
    const response = await fetch(`/api/schedule-content/${eventId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        user_id: user.id,
        platform: platform, // âœ… í”Œë«í¼ ì§€ì •
        publish_status: 'draft' // âœ… draftë¡œ ë³€ê²½í•˜ì—¬ ìº˜ë¦°ë”ì—ì„œ ìˆ¨ê¹€
        // âœ… scheduled_dateëŠ” ë³´ë‚´ì§€ ì•ŠìŒ (ë‹¤ë¥¸ í”Œë«í¼ ìœ ì§€)
      })
    });

    const data = await response.json();

    if (!data.success) {
      throw new Error(data.error || 'ì‚­ì œ ì‹¤íŒ¨');
    }

    showToast('âœ… ì˜ˆì •ì¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    closeEventDetailsModal();
    
    // ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨
    if (calendarInstance) {
      calendarInstance.refetchEvents();
    }
  } catch (error) {
    console.error('ì˜ˆì •ì¼ ì‚­ì œ ì˜¤ë¥˜:', error);
    showToast('ì˜ˆì •ì¼ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
  }
}

/**
 * ì „ì²´ ì½˜í…ì¸  ë³´ê¸° (íˆìŠ¤í† ë¦¬ì²˜ëŸ¼)
 */
async function viewFullContent(generationId, platform) {
  const user = window.currentUser;
  if (!user || !user.id) {
    showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
    return;
  }

  try {
    let item = null;
    
    // 1ì°¨ ì‹œë„: íˆìŠ¤í† ë¦¬ì—ì„œ ì°¾ê¸°
    try {
      const historyResponse = await fetch(`/api/history?user_id=${user.id}`);
      const historyData = await historyResponse.json();
      
      if (historyData.success) {
        item = (historyData.history || []).find(h => h.id === generationId);
      }
    } catch (err) {
      console.warn('íˆìŠ¤í† ë¦¬ ì¡°íšŒ ì‹¤íŒ¨:', err);
    }
    
    // 2ì°¨ ì‹œë„: scheduled-contentì—ì„œ ì°¾ê¸°
    if (!item) {
      try {
        const scheduleResponse = await fetch(`/api/scheduled-content?user_id=${user.id}`);
        const scheduleData = await scheduleResponse.json();
        
        if (scheduleData.success) {
          item = (scheduleData.scheduled_content || []).find(h => h.id === generationId);
        }
      } catch (err) {
        console.warn('scheduled-content ì¡°íšŒ ì‹¤íŒ¨:', err);
      }
    }
    
    // ì½˜í…ì¸ ë¥¼ ì°¾ì§€ ëª»í•œ ê²½ìš°
    if (!item) {
      showToast('ì½˜í…ì¸ ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
      return;
    }
    
    // âœ… generation_id ì €ì¥ (ìº˜ë¦°ë” ë“±ë¡ ë° ìˆ˜ì • ê¸°ëŠ¥ì— í•„ìš”)
    window.lastGenerationId = generationId;
    
    // ğŸ”¥ ê²°ê³¼ ì˜ì—­ì„ ì •ìƒ ìœ„ì¹˜ë¡œ ì´ë™ ë° í‘œì‹œ
    const resultArea = document.getElementById('resultArea');
    if (resultArea) {
      // ğŸ”¥ í•µì‹¬: resultAreaê°€ ì´ìƒí•œ ê³³ì— ìˆìœ¼ë©´ ì›ë˜ ìœ„ì¹˜ë¡œ ì´ë™
      const currentParent = resultArea.parentElement;
      if (currentParent && currentParent.id === 'emailVerificationModal') {
        console.log('âš ï¸ resultAreaê°€ emailVerificationModal ì•ˆì— ìˆìŒ! ë¹¼ë‚´ê¸° ì‹œì‘...');
        
        // í‘¸í„° ì°¾ê¸°
        const footer = document.querySelector('footer');
        if (footer) {
          // í‘¸í„° ë°”ë¡œ ì•ì— ì‚½ì…
          footer.parentElement.insertBefore(resultArea, footer);
          console.log('âœ… resultAreaë¥¼ í‘¸í„° ë°”ë¡œ ìœ„ë¡œ ì´ë™ ì™„ë£Œ');
        }
      }
      
      resultArea.classList.remove('hidden');
      resultArea.style.cssText = `
        display: block !important;
        width: 100% !important;
        max-width: 1200px !important;
        margin: 20px auto !important;
        padding: 32px !important;
        background: white !important;
        border-radius: 16px !important;
        box-shadow: 0 10px 40px rgba(0,0,0,0.1) !important;
      `;
      console.log('âœ… ê²°ê³¼ ì˜ì—­ ê°•ì œ í‘œì‹œ');
    }
    
    // âœ… ë°©ë²• 1: platformì´ ì—†ìœ¼ë©´ ì „ì²´ í‘œì‹œ, ìˆìœ¼ë©´ í•´ë‹¹ í”Œë«í¼ë§Œ í‘œì‹œ
    if (platform && item.results[platform]) {
      // íŠ¹ì • í”Œë«í¼ë§Œ í‘œì‹œ
      resultData = { [platform]: item.results[platform] };
      displayResults(resultData, [platform], { 
        hideCalendarButton: true,
        createdAt: item.created_at,
        scheduledDate: item.scheduled_date
      });
    } else if (!platform) {
      // platformì´ ì—†ìœ¼ë©´ ì „ì²´ í‘œì‹œ
      resultData = item.results;
      const allPlatforms = Object.keys(item.results);
      displayResults(item.results, allPlatforms, { 
        hideCalendarButton: true,
        createdAt: item.created_at,
        scheduledDate: item.scheduled_date
      });
    } else {
      // platformì€ ìˆëŠ”ë° í•´ë‹¹ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°ë§Œ ì—ëŸ¬
      showToast('âŒ í•´ë‹¹ í”Œë«í¼ì˜ ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
      return;
    }
    
    // ëª¨ë‹¬ ë‹«ê¸°
    closeEventDetailsModal();
    
    // ê²°ê³¼ ì˜ì—­ìœ¼ë¡œ ìŠ¤í¬ë¡¤
    setTimeout(() => {
      if (resultArea) {
        resultArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
        console.log('ğŸ“ ìŠ¤í¬ë¡¤: resultAreaë¡œ ì´ë™');
      }
    }, 300);
    
    showToast('âœ… ì½˜í…ì¸ ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤', 'success');
    
  } catch (error) {
    console.error('ì½˜í…ì¸  ë³´ê¸° ì˜¤ë¥˜:', error);
    showToast('ì½˜í…ì¸ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
  }
}

/**
 * ë‚ ì§œ/ì‹œê°„ ì„ íƒ ëª¨ë‹¬ ì—´ê¸°
 */
function openDateTimeModal(generationId, platform) {
  console.log('ğŸ“… openDateTimeModal í˜¸ì¶œ:', { generationId, platform });
  
  const modal = document.getElementById('dateTimeModal');
  const platformLabel = document.getElementById('dateTimeModalPlatform');
  
  if (!modal) {
    console.error('âŒ dateTimeModal ìš”ì†Œ ì—†ìŒ');
    alert('ëª¨ë‹¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
    return;
  }

  pendingScheduleData = { generationId, platform };
  console.log('ğŸ’¾ pendingScheduleData ì €ì¥:', pendingScheduleData);
  
  if (platformLabel) {
    const platformNames = {
      blog: 'ğŸ“ ë„¤ì´ë²„ë¸”ë¡œê·¸',
      instagram: 'ğŸ“· ì¸ìŠ¤íƒ€ê·¸ë¨',
      instagramFeed: 'ğŸ“· ì¸ìŠ¤íƒ€ê·¸ë¨ í”¼ë“œ',
      threads: 'ğŸ§µ ìŠ¤ë ˆë“œ',
      youtube: 'ğŸ¥ ìœ íŠœë¸Œ',
      youtubeLongform: 'ğŸ¬ ìœ íŠœë¸Œ ë¡±í¼',
      linkedin: 'ğŸ’¼ LinkedIn',
      facebook: 'ğŸ‘ í˜ì´ìŠ¤ë¶',
      twitter: 'ğŸ¦ íŠ¸ìœ„í„°(X)',
      kakaotalk: 'ğŸ’¬ ì¹´ì¹´ì˜¤í†¡',
      naverband: 'ğŸµ ë„¤ì´ë²„ ë°´ë“œ',
      telegram: 'âœˆï¸ í…”ë ˆê·¸ë¨'
    };
    platformLabel.textContent = platformNames[platform] || platform;
  }

  console.log('ğŸ¨ ëª¨ë‹¬ í‘œì‹œ ì‹œì‘');
  modal.classList.remove('hidden');
  console.log('âœ… ëª¨ë‹¬ í‘œì‹œ ì™„ë£Œ');

  // Flatpickr ì´ˆê¸°í™”
  try {
    if (typeof flatpickr === 'undefined') {
      console.error('âŒ Flatpickr ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì•ˆ ë¨');
      alert('ë‚ ì§œ ì„ íƒê¸°ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
      return;
    }
    
    if (!flatpickrInstance) {
      console.log('ğŸ—“ï¸ Flatpickr ì´ˆê¸°í™” ì‹œì‘');
      flatpickrInstance = flatpickr('#dateTimePicker', {
        enableTime: true,
        dateFormat: 'Y-m-d H:i',
        time_24hr: false,
        locale: 'ko',
        minDate: 'today',
        defaultDate: new Date()
      });
      console.log('âœ… Flatpickr ì´ˆê¸°í™” ì™„ë£Œ');
    }
  } catch (error) {
    console.error('âŒ Flatpickr ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
  }
}

/**
 * ë‚ ì§œ/ì‹œê°„ ì„ íƒ ëª¨ë‹¬ ë‹«ê¸°
 */
function closeDateTimeModal() {
  const modal = document.getElementById('dateTimeModal');
  if (modal) {
    modal.classList.add('hidden');
  }
  pendingScheduleData = null;
  
  if (flatpickrInstance) {
    flatpickrInstance.clear();
  }
}

/**
 * ë‚ ì§œ/ì‹œê°„ ì„ íƒ í™•ì¸
 */
async function confirmDateTimeSelection() {
  if (!pendingScheduleData) return;

  const dateInput = document.getElementById('dateTimePicker');
  const selectedDate = dateInput.value;

  if (!selectedDate) {
    showToast('ë‚ ì§œì™€ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
    return;
  }

  const { generationId, platform } = pendingScheduleData;
  
  await saveSchedule(generationId, platform, selectedDate);
  closeDateTimeModal();
}

/**
 * ë°œí–‰ ì˜ˆì •ì¼ ì €ì¥
 */
async function saveSchedule(generationId, platform, scheduledDate) {
  const user = window.currentUser;
  if (!user || !user.id) {
    showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
    return;
  }

  try {
    const response = await fetch('/api/schedule-content', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        generation_id: generationId,
        user_id: user.id,
        scheduled_date: scheduledDate,
        publish_status: 'scheduled',
        platform: platform // âœ… í”Œë«í¼ ì •ë³´ ì¶”ê°€
      })
    });

    const data = await response.json();

    if (!data.success) {
      throw new Error(data.error || 'ë°œí–‰ ì˜ˆì •ì¼ ì„¤ì • ì‹¤íŒ¨');
    }

    showToast('ë°œí–‰ ì˜ˆì •ì¼ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
    
    // ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨
    if (calendarInstance) {
      calendarInstance.refetchEvents();
    }
    
    // ğŸ”¥ ëª©ë¡ ë³´ê¸°ë„ ìƒˆë¡œê³ ì¹¨ (í˜„ì¬ ëª©ë¡ ë³´ê¸° ìƒíƒœë¼ë©´)
    if (!isCalendarView) {
      await loadScheduledContent('all');
    }
  } catch (error) {
    console.error('ë°œí–‰ ì˜ˆì •ì¼ ì €ì¥ ì˜¤ë¥˜:', error);
    showToast('ë°œí–‰ ì˜ˆì •ì¼ ì„¤ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
  }
}

/**
 * ë¹ ë¥¸ ë“±ë¡ ëª¨ë‹¬ ì—´ê¸°
 */
/**
 * ìº˜ë¦°ë”/ë¦¬ìŠ¤íŠ¸ ë·° ì „í™˜
 */
function toggleCalendarView() {
  const calendarView = document.getElementById('calendarView');
  const listView = document.getElementById('listView');
  const toggleBtn = document.querySelector('[onclick="toggleCalendarView()"]');

  if (!calendarView || !listView || !toggleBtn) return;

  isCalendarView = !isCalendarView;

  if (isCalendarView) {
    calendarView.classList.remove('hidden');
    listView.classList.add('hidden');
    toggleBtn.innerHTML = '<i class="fas fa-list mr-1"></i>ëª©ë¡ ë³´ê¸°';
    
    // ğŸ”¥ ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨ (í”Œë˜ê·¸ í™•ì¸)
    if (calendarInstance) {
      if (window.needsCalendarRefresh) {
        console.log('ğŸ”„ í”Œë˜ê·¸ ê°ì§€! ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨ ì‹¤í–‰...');
        calendarInstance.refetchEvents();
        window.needsCalendarRefresh = false;
        console.log('âœ… ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ (í”Œë˜ê·¸ í•´ì œ)');
      } else {
        calendarInstance.refetchEvents();
      }
    }
  } else {
    calendarView.classList.add('hidden');
    listView.classList.remove('hidden');
    toggleBtn.innerHTML = '<i class="fas fa-calendar mr-1"></i>ë‹¬ë ¥ ë³´ê¸°';
    
    // ë¦¬ìŠ¤íŠ¸ ë¡œë“œ
    loadScheduledContent('all');
  }
}

/**
 * ë°œí–‰ ì˜ˆì • ì½˜í…ì¸  ëª©ë¡ ë¡œë“œ (ë¦¬ìŠ¤íŠ¸ ë·°)
 */
async function loadScheduledContent(status = 'all') {
  const user = window.currentUser;
  if (!user || !user.id) {
    showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
    return;
  }

  try {
    const params = new URLSearchParams({ user_id: user.id });
    if (status !== 'all') {
      params.append('status', status);
    }

    const response = await fetch(`/api/scheduled-content?${params.toString()}`);
    const data = await response.json();

    if (!data.success) {
      throw new Error(data.error || 'ë°œí–‰ ì˜ˆì • ì½˜í…ì¸  ì¡°íšŒ ì‹¤íŒ¨');
    }

    // âœ… scheduled_dateê°€ ìˆëŠ” ì½˜í…ì¸ ë§Œ í•„í„°ë§
    const scheduledOnly = (data.scheduled_content || []).filter(item => item.scheduled_date);
    console.log(`âœ… ìº˜ë¦°ë” ëª©ë¡ ë³´ê¸°: ì „ì²´ ${data.scheduled_content?.length || 0}ê°œ ì¤‘ ì˜ˆì •ì¼ ì„¤ì • ${scheduledOnly.length}ê°œ`);
    
    renderScheduledContentList(scheduledOnly);
  } catch (error) {
    console.error('ë°œí–‰ ì˜ˆì • ì½˜í…ì¸  ë¡œë“œ ì˜¤ë¥˜:', error);
    showToast('ë°œí–‰ ì˜ˆì • ì½˜í…ì¸ ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
  }
}

/**
 * ë°œí–‰ ì˜ˆì • ì½˜í…ì¸  ëª©ë¡ ë Œë”ë§ (ë¦¬ìŠ¤íŠ¸ ë·°)
 */
function renderScheduledContentList(contentList) {
  const container = document.getElementById('scheduledContentList');
  if (!container) return;

  if (!contentList || contentList.length === 0) {
    container.innerHTML = `
      <div class="text-center text-gray-500 py-8">
        <i class="fas fa-calendar-check text-4xl mb-3 text-gray-300"></i>
        <p>ë°œí–‰ ì˜ˆì •ëœ ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        <p class="text-xs text-gray-400 mt-2">íˆìŠ¤í† ë¦¬ì—ì„œ ì½˜í…ì¸ ì˜ ë°œí–‰ ì˜ˆì •ì¼ì„ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      </div>
    `;
    return;
  }

  const platformNames = {
    blog: 'ë„¤ì´ë²„ë¸”ë¡œê·¸',
    instagram: 'ì¸ìŠ¤íƒ€ê·¸ë¨',
    instagramFeed: 'ì¸ìŠ¤íƒ€ê·¸ë¨ í”¼ë“œ',
    instagram_feed: 'ì¸ìŠ¤íƒ€ê·¸ë¨ í”¼ë“œ',
    instagram_reels: 'ì¸ìŠ¤íƒ€ê·¸ë¨ ë¦´ìŠ¤',
    threads: 'ìŠ¤ë ˆë“œ',
    youtube: 'ìœ íŠœë¸Œ',
    youtube_shorts: 'ìœ íŠœë¸Œ ì‡¼ì¸ ',
    youtubeLongform: 'ìœ íŠœë¸Œ ë¡±í¼',
    linkedin: 'LinkedIn',
    facebook: 'í˜ì´ìŠ¤ë¶',
    twitter: 'íŠ¸ìœ„í„°(X)',
    kakaotalk: 'ì¹´ì¹´ì˜¤í†¡',
    naverband: 'ë„¤ì´ë²„ ë°´ë“œ',
    telegram: 'í…”ë ˆê·¸ë¨',
    tiktok: 'í‹±í†¡',
    shortform_multi: 'ìˆí¼ í†µí•©'
  };

  // âœ… Font Awesome ì•„ì´ì½˜ ë§¤í•‘
  const platformIcons = {
    blog: { class: 'fas fa-blog', color: 'text-blue-600' },
    instagram: { class: 'fab fa-instagram', color: 'text-pink-600' },
    instagramFeed: { class: 'fab fa-instagram', color: 'text-pink-600' },
    instagram_feed: { class: 'fab fa-instagram', color: 'text-pink-600' },
    instagram_reels: { class: 'fab fa-instagram', color: 'text-pink-600' },
    threads: { class: 'fas fa-at', color: 'text-gray-800' },
    youtube: { class: 'fab fa-youtube', color: 'text-red-600' },
    youtube_shorts: { class: 'fab fa-youtube', color: 'text-red-600' },
    youtube_longform: { class: 'fab fa-youtube', color: 'text-red-600' },
    youtubeLongform: { class: 'fab fa-youtube', color: 'text-red-600' },
    linkedin: { class: 'fab fa-linkedin', color: 'text-blue-800' },
    facebook: { class: 'fab fa-facebook', color: 'text-blue-700' },
    twitter: { class: 'fab fa-twitter', color: 'text-blue-400' },
    kakaotalk: { class: 'fas fa-comment-dots', color: 'text-yellow-500' },
    naverband: { class: 'fas fa-users', color: 'text-green-700' },
    band: { class: 'fas fa-users', color: 'text-green-700' },
    telegram: { class: 'fab fa-telegram', color: 'text-blue-500' },
    tiktok: { class: 'fab fa-tiktok', color: 'text-black' },
    shortform_multi: { class: 'fas fa-film', color: 'text-purple-600' }
  };

  const statusBadges = {
    draft: '<span class="px-2 py-1 bg-gray-200 text-gray-700 rounded text-xs">ì´ˆì•ˆ</span>',
    scheduled: '<span class="px-2 py-1 bg-blue-200 text-blue-700 rounded text-xs">ğŸ“… ì˜ˆì •</span>',
    published: '<span class="px-2 py-1 bg-green-200 text-green-700 rounded text-xs">âœ… ë°œí–‰ì™„ë£Œ</span>',
    cancelled: '<span class="px-2 py-1 bg-red-200 text-red-700 rounded text-xs">âŒ ì·¨ì†Œ</span>'
  };

  container.innerHTML = contentList.map(item => {
    const scheduledDate = item.scheduled_date 
      ? new Date(item.scheduled_date).toLocaleString('ko-KR', { 
          year: 'numeric', 
          month: '2-digit', 
          day: '2-digit', 
          hour: '2-digit', 
          minute: '2-digit',
          hour12: true 
        })
      : 'ë¯¸ì„¤ì •';
    
    // âœ… ìƒì„±ì¼ ì¶”ê°€
    const createdDate = item.created_at 
      ? new Date(item.created_at).toLocaleString('ko-KR', { 
          year: 'numeric', 
          month: '2-digit', 
          day: '2-digit', 
          hour: '2-digit', 
          minute: '2-digit',
          hour12: true 
        })
      : 'ì •ë³´ ì—†ìŒ';
    
    const statusBadge = statusBadges[item.publish_status] || statusBadges.draft;

    // platforms ë°°ì—´ì˜ ëª¨ë“  í”Œë«í¼ í‘œì‹œ (draft ì œì™¸)
    const platformsList = (item.platforms || [item.platform])
      .filter(platform => {
        // âœ… draft ìƒíƒœì¸ í”Œë«í¼ ì œì™¸
        const platformStatus = (item.platform_status && item.platform_status[platform]) || item.publish_status || 'draft';
        return platformStatus !== 'draft';
      })
      .map(platform => {
      const platformName = platformNames[platform] || platform || 'ì•Œ ìˆ˜ ì—†ìŒ';
      const iconData = platformIcons[platform] || { class: 'fas fa-file', color: 'text-gray-600' };
      
      // âœ… í”Œë«í¼ë³„ ìƒíƒœ ì‚¬ìš©
      const platformStatus = (item.platform_status && item.platform_status[platform]) || item.publish_status || 'draft';
      const platformStatusBadge = statusBadges[platformStatus] || statusBadges.draft;
      
      // results (jsonb)ì—ì„œ í•´ë‹¹ í”Œë«í¼ì˜ ì œëª©ê³¼ ì½˜í…ì¸  ì¶”ì¶œ
      let title = platformName;
      let content = 'ë‚´ìš© ì—†ìŒ';
      
      if (item.results && typeof item.results === 'object') {
        const platformData = item.results[platform];
        if (platformData) {
          // âœ… ë¬¸ìì—´ë¡œ ì§ì ‘ ì €ì¥ëœ ê²½ìš°
          if (typeof platformData === 'string') {
            content = platformData;
            title = platformData.substring(0, 50) + (platformData.length > 50 ? '...' : '');
          }
          // ê°ì²´ì¸ ê²½ìš°
          else if (typeof platformData === 'object') {
            if (platformData.title) {
              title = platformData.title;
            } else if (platformData.content) {
              const contentText = platformData.content;
              if (contentText && contentText.length > 0) {
                title = contentText.substring(0, 50) + (contentText.length > 50 ? '...' : '');
              }
            }
            if (platformData.content) {
              content = platformData.content;
            }
          }
        }
      }

      return `
        <div class="border-l-4 border-blue-400 pl-3 mb-2">
          <div class="flex items-center gap-2 mb-1">
            <span class="text-lg font-bold text-gray-800">
              <i class="${iconData.class} ${iconData.color} mr-1"></i>${platformName}
            </span>
            ${platformStatusBadge}
          </div>
          <div class="flex items-center gap-2 text-xs text-gray-500 mb-1">
            <span><i class="fas fa-clock mr-1"></i>ìƒì„±: ${createdDate}</span>
          </div>
          <p class="text-sm font-medium text-gray-800 mb-1">${title}</p>
          <p class="text-sm text-gray-600 line-clamp-2">${content.substring(0, 100)}${content.length > 100 ? '...' : ''}</p>
          <div class="flex gap-1 mt-2">
            <button onclick="changePublishStatus('${item.id}', '${platform}', 'scheduled')" class="px-2 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700 transition" title="ì˜ˆì •ìœ¼ë¡œ ë³€ê²½">
              <i class="fas fa-calendar-check"></i>
            </button>
            <button onclick="changePublishStatus('${item.id}', '${platform}', 'published')" class="px-2 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700 transition" title="ë°œí–‰ì™„ë£Œë¡œ ë³€ê²½">
              <i class="fas fa-check"></i>
            </button>
            <button onclick="changePublishStatus('${item.id}', '${platform}', 'cancelled')" class="px-2 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700 transition" title="ì·¨ì†Œ">
              <i class="fas fa-times"></i>
            </button>
            <button onclick="viewFullContent('${item.id}', '${platform}')" class="px-2 py-1 bg-purple-600 text-white rounded text-xs hover:bg-purple-700 transition" title="ì „ì²´ ë³´ê¸°">
              <i class="fas fa-eye"></i>
            </button>
          </div>
        </div>
      `;
    }).join('');

    // âœ… ëª¨ë“  í”Œë«í¼ì´ draftë©´ ì¹´ë“œ ì „ì²´ë¥¼ ìˆ¨ê¹€
    if (!platformsList || platformsList.trim() === '') {
      return '';
    }

    return `
      <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition mb-3">
        <div class="flex justify-between items-start mb-3">
          <div class="flex flex-col gap-1">
            <span class="text-sm font-semibold text-gray-700">
              <i class="fas fa-calendar-alt mr-1"></i>ë°œí–‰ ì˜ˆì •: ${scheduledDate}
            </span>
          </div>
        </div>
        
        <div class="space-y-3">
          ${platformsList}
        </div>
      </div>
    `;
  }).filter(html => html !== '').join('');
}

/**
 * ë°œí–‰ ìƒíƒœ ë³€ê²½ (ë¦¬ìŠ¤íŠ¸ ë·° - í”Œë«í¼ë³„)
 */
async function changePublishStatus(generationId, platform, newStatus) {
  const user = window.currentUser;
  if (!user || !user.id) {
    showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
    return;
  }

  try {
    const response = await fetch(`/api/schedule-content/${generationId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        user_id: user.id,
        platform: platform, // âœ… í”Œë«í¼ ì •ë³´ ì „ë‹¬
        publish_status: newStatus
      })
    });

    const data = await response.json();

    if (!data.success) {
      throw new Error(data.error || 'ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨');
    }

    showToast('ë°œí–‰ ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
    loadScheduledContent('all'); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
  } catch (error) {
    console.error('ë°œí–‰ ìƒíƒœ ë³€ê²½ ì˜¤ë¥˜:', error);
    showToast('ë°œí–‰ ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
  }
}

/**
 * ìº˜ë¦°ë” ì„¹ì…˜ í‘œì‹œ (ë¡œê·¸ì¸ ì‹œ)
 */
function showScheduledContentArea() {
  const area = document.getElementById('scheduledContentArea');
  if (area) {
    area.classList.remove('hidden');
    
    // FullCalendar ì´ˆê¸°í™”
    setTimeout(() => {
      initFullCalendar();
    }, 100);
  }
}

/**
 * ìº˜ë¦°ë” ì„¹ì…˜ ìˆ¨ê¹€ (ë¡œê·¸ì•„ì›ƒ ì‹œ)
 */
function hideScheduledContentArea() {
  const area = document.getElementById('scheduledContentArea');
  if (area) {
    area.classList.add('hidden');
  }
  
  // ìº˜ë¦°ë” ì¸ìŠ¤í„´ìŠ¤ ì •ë¦¬
  if (calendarInstance) {
    calendarInstance.destroy();
    calendarInstance = null;
  }
}

// ì „ì—­ ë…¸ì¶œ
window.initFullCalendar = initFullCalendar;
window.loadCalendarEvents = loadCalendarEvents;
window.showEventDetails = showEventDetails;
window.closeEventDetailsModal = closeEventDetailsModal;
window.changeEventStatus = changeEventStatus;
window.deleteScheduledEvent = deleteScheduledEvent;
window.viewFullContent = viewFullContent;
window.openDateTimeModal = openDateTimeModal;
window.closeDateTimeModal = closeDateTimeModal;
window.confirmDateTimeSelection = confirmDateTimeSelection;
window.saveSchedule = saveSchedule;
// window.openQuickAddModal = openQuickAddModal; // âŒ í•¨ìˆ˜ ë¯¸êµ¬í˜„ìœ¼ë¡œ ì£¼ì„ ì²˜ë¦¬
// window.closeQuickAddModal = closeQuickAddModal; // âŒ í•¨ìˆ˜ ë¯¸êµ¬í˜„ìœ¼ë¡œ ì£¼ì„ ì²˜ë¦¬
// window.confirmQuickAdd = confirmQuickAdd; // âŒ í•¨ìˆ˜ ë¯¸êµ¬í˜„ìœ¼ë¡œ ì£¼ì„ ì²˜ë¦¬
window.toggleCalendarView = toggleCalendarView;
window.loadScheduledContent = loadScheduledContent;
window.renderScheduledContentList = renderScheduledContentList;
window.changePublishStatus = changePublishStatus;
window.showScheduledContentArea = showScheduledContentArea;
window.hideScheduledContentArea = hideScheduledContentArea;


/**
 * ìƒì„± ì™„ë£Œ í™”ë©´ì—ì„œ ìº˜ë¦°ë” ë“±ë¡ (ê°œë³„ ì½˜í…ì¸  generation_id ì‚¬ìš©)
 */
function openDateTimeModalForGeneration(platform, contentIndex) {
  // âœ… ê°œë³„ ì½˜í…ì¸ ì˜ generation_id ì‚¬ìš©
  let realId;
  
  // contentIndexê°€ ì „ë‹¬ëœ ê²½ìš° í•´ë‹¹ ì½˜í…ì¸ ì˜ ID ì‚¬ìš©
  if (contentIndex !== undefined && contentBlocks[contentIndex]) {
    realId = contentBlocks[contentIndex].generationId;
    console.log(`ğŸ“… [ì½˜í…ì¸  #${contentIndex + 1}] ìº˜ë¦°ë” ë“±ë¡:`, { realId, platform });
  } else {
    // contentIndex ì—†ìœ¼ë©´ ë§ˆì§€ë§‰ ìƒì„± ID ì‚¬ìš© (í•˜ìœ„ í˜¸í™˜ì„±)
    realId = window.lastGenerationId;
    console.log('ğŸ“… ìº˜ë¦°ë” ë“±ë¡ (legacy):', { realId, platform });
  }
  
  if (!realId) {
    showToast('ì½˜í…ì¸ ë¥¼ ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”.', 'error');
    console.error('âŒ generation_id ì—†ìŒ');
    return;
  }
  
  openDateTimeModal(realId, platform);
}

// ì „ì—­ ë…¸ì¶œ
window.openDateTimeModalForGeneration = openDateTimeModalForGeneration;


// ===================================
// Option B: ê°œë³„ ì½˜í…ì¸  ìƒì„± í•¨ìˆ˜
// ===================================

// í”Œë«í¼ ì„ íƒ ì—…ë°ì´íŠ¸
function updateContentPlatforms(contentIndex) {
  const checkboxes = document.querySelectorAll(`input[data-content="${contentIndex}"].content-platform-checkbox:checked`);
  const platforms = Array.from(checkboxes).map(cb => cb.value);
  
  // í”Œë«í¼ ì €ì¥
  if (!contentBlocks[contentIndex]) {
    contentBlocks[contentIndex] = { images: [], keywords: '', topic: '', description: '' };
  }
  contentBlocks[contentIndex].platforms = platforms;
  contentPlatforms[contentIndex] = platforms;
  
  // í¬ë ˆë”§ ê³„ì‚° (í”Œë«í¼ë‹¹ 1í¬ë ˆë”§)
  const platformCount = platforms.length;
  const credit = platformCount;
  
  // ì˜ˆìƒ ì†Œìš” ì‹œê°„ ê³„ì‚° (í”Œë«í¼ë‹¹ ì•½ 10ì´ˆ)
  const estimatedSeconds = platformCount > 0 ? Math.max(10, platformCount * 10) : 0;
  const estimatedTime = estimatedSeconds >= 60 
    ? `ì•½ ${Math.ceil(estimatedSeconds / 60)}ë¶„`
    : `${estimatedSeconds}ì´ˆ`;
  
  // í¬ë ˆë”§ í‘œì‹œ ì—…ë°ì´íŠ¸
  const creditDisplay = document.getElementById(`contentCredit_${contentIndex}`);
  if (creditDisplay) {
    creditDisplay.innerHTML = `
      <span class="text-2xl font-bold text-purple-600">${credit} í¬ë ˆë”§</span>
      <span class="text-sm text-gray-500 ml-2">â€¢ ${estimatedTime}</span>
    `;
  }
  
  console.log(`ğŸ’° [ì½˜í…ì¸  #${contentIndex + 1}] í”Œë«í¼: ${platformCount}ê°œ, í¬ë ˆë”§: ${credit}, ì˜ˆìƒ ì‹œê°„: ${estimatedTime}`);
}

// ê°œë³„ ì½˜í…ì¸  ìƒì„±
async function generateSingleContent(contentIndex) {
  console.log(`ğŸš€ [ì½˜í…ì¸  #${contentIndex + 1}] ìƒì„± ì‹œì‘`);
  
  const content = contentBlocks[contentIndex];
  if (!content) {
    showToast(`âŒ ì½˜í…ì¸  #${contentIndex + 1} ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤`, 'error');
    return;
  }
  
  // âœ… ì¤‘ë³µ ìƒì„± ë°©ì§€
  if (content.generated && content.generationId) {
    const confirmRegenerate = confirm(
      `âš ï¸ ì½˜í…ì¸  #${contentIndex + 1}ì€(ëŠ”) ì´ë¯¸ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n` +
      `ì¬ìƒì„±í•˜ì‹œë©´ ì¶”ê°€ í¬ë ˆë”§ì´ ì°¨ê°ë©ë‹ˆë‹¤.\n\n` +
      `ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`
    );
    
    if (!confirmRegenerate) {
      return;
    }
  }
  
  // ì´ë¯¸ì§€ ê²€ì¦
  if (!content.images || content.images.length === 0) {
    showToast(`âŒ ì½˜í…ì¸  #${contentIndex + 1}ì— ìµœì†Œ 1ì¥ì˜ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”`, 'error');
    return;
  }
  
  // í‚¤ì›Œë“œ ê²€ì¦
  if (!content.keywords || content.keywords.trim() === '') {
    showToast(`âŒ ì½˜í…ì¸  #${contentIndex + 1}ì˜ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”`, 'error');
    return;
  }
  
  // í”Œë«í¼ ê²€ì¦
  const platforms = contentPlatforms[contentIndex] || [];
  if (platforms.length === 0) {
    showToast(`âŒ ì½˜í…ì¸  #${contentIndex + 1}ì˜ í”Œë«í¼ì„ ìµœì†Œ 1ê°œ ì„ íƒí•´ì£¼ì„¸ìš”`, 'error');
    return;
  }
  
  // í¬ë ˆë”§ ê³„ì‚° (í”Œë«í¼ë‹¹ 1í¬ë ˆë”§)
  const platformCount = platforms.length;
  const creditsNeeded = platformCount;
  
  console.log(`ğŸ’° [ì½˜í…ì¸  #${contentIndex + 1}] í¬ë ˆë”§ ê³„ì‚°: ${platformCount}ê°œ í”Œë«í¼ = ${creditsNeeded} í¬ë ˆë”§`);
  
  // í¬ë ˆë”§ í™•ì¸ (ë¡œê·¸ì¸ ì‚¬ìš©ìë§Œ)
  if (!currentUser.isGuest && currentUser.id) {
    const freeCredits = window.userCreditsInfo?.free_credits ?? currentUser.free_credits ?? 0;
    const paidCredits = window.userCreditsInfo?.paid_credits ?? currentUser.paid_credits ?? 0;
    const totalCredits = freeCredits + paidCredits;
    
    if (totalCredits < creditsNeeded) {
      console.error(`âŒ [ì½˜í…ì¸  #${contentIndex + 1}] í¬ë ˆë”§ ë¶€ì¡±: í•„ìš” ${creditsNeeded}, ë³´ìœ  ${totalCredits}`);
      
      const goToPayment = confirm(
        `â›” í¬ë ˆë”§ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!\n\n` +
        `â€¢ í•„ìš”: ${creditsNeeded}í¬ë ˆë”§\n` +
        `â€¢ ë³´ìœ : ${totalCredits}í¬ë ˆë”§ (ë¬´ë£Œ ${freeCredits} + ìœ ë£Œ ${paidCredits})\n\n` +
        `ğŸ’³ ì¶©ì „ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`
      );
      
      if (goToPayment) {
        window.location.href = '/static/payment.html';
      }
      return;
    }
    
    console.log(`âœ… [ì½˜í…ì¸  #${contentIndex + 1}] í¬ë ˆë”§ ê²€ì¦ í†µê³¼: í•„ìš” ${creditsNeeded}, ë³´ìœ  ${totalCredits}`);
  }
  
  // ë¸Œëœë“œ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ì¢Œì¸¡ íŒ¨ë„ í•„ë“œ ID ì‚¬ìš©)
  const brand = document.getElementById('brandName')?.value.trim() || '';
  const serviceName = document.getElementById('serviceName')?.value.trim() || '';
  const companyName = document.getElementById('companyName')?.value.trim() || '';
  const businessType = document.getElementById('businessType')?.value.trim() || '';
  const region = document.getElementById('region')?.value.trim() || '';
  const targetGender = document.getElementById('targetGender')?.value || '';
  const contact = document.getElementById('contact')?.value.trim() || '';
  let website = document.getElementById('website')?.value.trim() || '';
  if (website && !website.startsWith('http://') && !website.startsWith('https://')) {
    website = 'https://' + website;
  }
  const snsAccount = document.getElementById('snsAccount')?.value.trim() || '';
  const tone = document.getElementById('toneAndManner')?.value || 'ì¹œê·¼í•œ';
  const targetAge = document.getElementById('targetAge')?.value || '20ëŒ€';
  const industry = document.getElementById('industry')?.value || 'ë¼ì´í”„ìŠ¤íƒ€ì¼';
  
  // ğŸ”¥ í•„ìˆ˜ ì…ë ¥ ê²€ì¦ ì¶”ê°€
  if (!brand || brand.length === 0) {
    alert('âš ï¸ ë¸Œëœë“œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!\n\nì¢Œì¸¡ íŒ¨ë„ì˜ "í”„ë¡œí•„ ì •ë³´"ì—ì„œ ë¸Œëœë“œëª…ì„ ì…ë ¥í•´ì•¼ ì½˜í…ì¸ ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
    return;
  }
  
  // í‚¤ì›Œë“œì— ì£¼ì œì™€ ì„¤ëª… ì¶”ê°€
  let enhancedKeywords = content.keywords;
  if (content.topic) {
    enhancedKeywords += ` (ì£¼ì œ: ${content.topic})`;
  }
  if (content.description) {
    enhancedKeywords += ` (${content.description})`;
  }
  
  const formData = {
    user_id: currentUser?.id || null,
    is_guest: currentUser?.isGuest || false,
    brand,
    companyName,
    businessType,
    region,
    targetGender,
    contact,
    website,
    snsAccount,
    keywords: enhancedKeywords,
    tone,
    targetAge,
    industry,
    images: content.images.map((img) => ({
      base64: img.base64,
      filename: img.name || `ì´ë¯¸ì§€${content.images.indexOf(img) + 1}`,
      size: img.size || 0
    })),
    platforms,
    aiModel: 'gpt-4o',
    customPrompt: getSelectedTemplateContent(),
  };
  
  // ë¡œë”© í‘œì‹œ
  showContentLoading(contentIndex);
  
  try {
    const response = await fetch('/api/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(formData),
    });
    
    const contentType = response.headers.get('content-type');
    if (!contentType || !contentType.includes('application/json')) {
      hideContentLoading(contentIndex);
      const errorText = await response.text();
      console.error('ì„œë²„ ì—ëŸ¬:', response.status, errorText.substring(0, 200));
      showToast(`ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (${response.status})`, 'error');
      return;
    }
    
    const result = await response.json();
    
    console.log(`ğŸ” [ì½˜í…ì¸  #${contentIndex + 1}] ë°±ì—”ë“œ ì‘ë‹µ:`, result);
    
    // ğŸ”¥ ì¤‘ìš”: í¬ë ˆë”§ ë™ê¸°í™” (UI ì‹¤ì‹œê°„ ë°˜ì˜)
    if (result.usage && (result.usage.free_credits !== undefined || result.usage.paid_credits !== undefined)) {
      const free_credits = result.usage.free_credits ?? result.usage.free_remaining ?? 0;
      const paid_credits = result.usage.paid_credits ?? result.usage.paid_remaining ?? 0;
      
      // window.userCreditsInfo ì—…ë°ì´íŠ¸
      window.userCreditsInfo = {
        free_credits,
        paid_credits,
        total_credits: free_credits + paid_credits
      };
      
      // currentUser ë™ê¸°í™”
      if (window.currentUser) {
        window.currentUser.free_credits = free_credits;
        window.currentUser.paid_credits = paid_credits;
      }
      
      // ìƒë‹¨ í¬ë ˆë”§ UI ì—…ë°ì´íŠ¸
      const userCreditsElement = document.getElementById('userCredits');
      if (userCreditsElement) {
        userCreditsElement.textContent = free_credits + paid_credits;
      }
      
      // í‚¤ì›Œë“œ ë¶„ì„ í™”ë©´ í¬ë ˆë”§ í‘œì‹œ ì—…ë°ì´íŠ¸ (ì •í™•í•œ ID ì‚¬ìš©)
      const freeKeywordCreditsElement = document.getElementById('freeKeywordCredits');
      const paidKeywordCreditsElement = document.getElementById('paidKeywordCredits');
      
      if (freeKeywordCreditsElement) {
        freeKeywordCreditsElement.textContent = free_credits;
        console.log(`âœ… ë¬´ë£Œ í¬ë ˆë”§ ì—…ë°ì´íŠ¸: ${free_credits}`);
      }
      
      if (paidKeywordCreditsElement) {
        paidKeywordCreditsElement.textContent = paid_credits;
        console.log(`âœ… ìœ ë£Œ í¬ë ˆë”§ ì—…ë°ì´íŠ¸: ${paid_credits}`);
      }
      
      // ì¶”ê°€: ë‹¤ë¥¸ í˜•ì‹ì˜ í¬ë ˆë”§ í‘œì‹œë„ ì—…ë°ì´íŠ¸
      const keywordCreditsElements = document.querySelectorAll('[id^="keywordCredits"], .keyword-credits-display');
      keywordCreditsElements.forEach(element => {
        if (element.textContent.includes('ë¬´ë£Œ') && element.textContent.includes('ìœ ë£Œ')) {
          element.textContent = `ë¬´ë£Œ ${free_credits} Â· ìœ ë£Œ ${paid_credits}`;
        }
      });
      
      console.log(`âœ… [ì½˜í…ì¸  #${contentIndex + 1}] í¬ë ˆë”§ ë™ê¸°í™” ì™„ë£Œ:`, {
        free_credits,
        paid_credits,
        total_credits: free_credits + paid_credits,
        usage: result.usage
      });
    } else {
      console.warn(`âš ï¸ [ì½˜í…ì¸  #${contentIndex + 1}] í¬ë ˆë”§ ì •ë³´ ì—†ìŒ:`, result);
    }
    
    if (!result.success) {
      hideContentLoading(contentIndex);
      showToast(`âŒ ${result.error || 'ì½˜í…ì¸  ìƒì„± ì‹¤íŒ¨'}`, 'error');
      return;
    }
    
    // ë¡œë”© ìˆ¨ê¸°ê¸°
    hideContentLoading(contentIndex);
    
    // âœ… generation_id ìƒì„± (UUID ëŒ€ì‹  íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ë°˜)
    const generationId = result.id || result.generation_id || `gen_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    
    // âœ… íˆìŠ¤í† ë¦¬ ì €ì¥ (ìº˜ë¦°ë” ë“±ë¡ìš©)
    window.lastGenerationId = generationId;
    console.log(`ğŸ“ [ì½˜í…ì¸  #${contentIndex + 1}] Generation ID ì €ì¥:`, generationId);
    
    // ì½˜í…ì¸  ë¸”ë¡ì— ì €ì¥
    contentBlocks[contentIndex].generationId = generationId;
    contentBlocks[contentIndex].generated = true;
    contentBlocks[contentIndex].results = result.data;
    
    // âœ… íˆìŠ¤í† ë¦¬ì— ì €ì¥
    try {
      const historyEntry = {
        id: generationId,
        brand,
        keywords: enhancedKeywords,
        platforms,
        results: result.data,
        createdAt: new Date().toISOString()
      };
      
      contentHistory.unshift(historyEntry);
      if (contentHistory.length > 50) {
        contentHistory = contentHistory.slice(0, 50);
      }
      
      console.log(`âœ… íˆìŠ¤í† ë¦¬ ì €ì¥ ì™„ë£Œ:`, historyEntry.id);
    } catch (error) {
      console.error('âŒ íˆìŠ¤í† ë¦¬ ì €ì¥ ì‹¤íŒ¨:', error);
    }
    
    // âœ… DBì— íˆìŠ¤í† ë¦¬ ì €ì¥ (ì˜êµ¬ ë³´ê´€)
    try {
      const historyResult = await saveToHistory(
        {
          brand: brand,
          keywords: enhancedKeywords,
          platforms: platforms
        },
        result.data
      );
      
      // âœ… DBì—ì„œ ë°˜í™˜ëœ IDë¥¼ generationIdë¡œ ì‚¬ìš© (ìº˜ë¦°ë” ë“±ë¡ìš©)
      if (historyResult && historyResult.id) {
        contentBlocks[contentIndex].generationId = historyResult.id;
        window.lastGenerationId = historyResult.id;
        console.log(`âœ… DB íˆìŠ¤í† ë¦¬ ì €ì¥ ì™„ë£Œ ë° ID ì—…ë°ì´íŠ¸:`, historyResult.id);
      } else {
        console.log(`âœ… DB íˆìŠ¤í† ë¦¬ ì €ì¥ ì™„ë£Œ (ê¸°ì¡´ ID ìœ ì§€):`, generationId);
      }
    } catch (error) {
      console.error('âŒ DB íˆìŠ¤í† ë¦¬ ì €ì¥ ì‹¤íŒ¨:', error);
    }
    
    // ê²°ê³¼ í‘œì‹œ
    displaySingleContentResult(contentIndex, result, platforms);
    
    // âœ… ìƒì„± ì™„ë£Œ í›„ í•´ë‹¹ ì½˜í…ì¸  ë¸”ë¡ìœ¼ë¡œ ìŠ¤í¬ë¡¤
    const contentBlock = document.getElementById(`contentBlock_${contentIndex}`);
    if (contentBlock) {
      contentBlock.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    
    showToast(`âœ… ì½˜í…ì¸  #${contentIndex + 1} ìƒì„± ì™„ë£Œ!`, 'success');
    
  } catch (error) {
    console.error(`âŒ [ì½˜í…ì¸  #${contentIndex + 1}] ìƒì„± ì˜¤ë¥˜:`, error);
    hideContentLoading(contentIndex);
    showToast(`âŒ ${error.message}`, 'error');
  }
}

// ê°œë³„ ì½˜í…ì¸  ë¡œë”© í‘œì‹œ
function showContentLoading(contentIndex) {
  const resultArea = document.getElementById(`contentResult_${contentIndex}`);
  if (!resultArea) return;
  
  resultArea.classList.remove('hidden');
  resultArea.innerHTML = `
    <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-8 text-center border-2 border-purple-200">
      <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-purple-600 mx-auto mb-4"></div>
      <p class="text-lg font-bold text-gray-800 mb-2">
        <i class="fas fa-magic mr-2 text-purple-600"></i>
        ì½˜í…ì¸  #${contentIndex + 1} ìƒì„± ì¤‘...
      </p>
      <p class="text-sm text-gray-600">AIê°€ ì½˜í…ì¸ ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
      <p class="text-xs text-gray-500 mt-2">ì˜ˆìƒ ì†Œìš” ì‹œê°„: 30-60ì´ˆ</p>
    </div>
  `;
  
  resultArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// ê°œë³„ ì½˜í…ì¸  ë¡œë”© ìˆ¨ê¸°ê¸°
function hideContentLoading(contentIndex) {
  // ë¡œë”©ë§Œ ìˆ¨ê¸°ê³  ê²°ê³¼ ì˜ì—­ì€ ìœ ì§€
}

// ê°œë³„ ì½˜í…ì¸  ê²°ê³¼ í‘œì‹œ
function displaySingleContentResult(contentIndex, result, platforms) {
  const resultArea = document.getElementById(`contentResult_${contentIndex}`);
  if (!resultArea) return;
  
  const platformNames = {
    blog: 'ë„¤ì´ë²„ ë¸”ë¡œê·¸',
    instagram: 'ì¸ìŠ¤íƒ€ê·¸ë¨',
    instagram_feed: 'ì¸ìŠ¤íƒ€ê·¸ë¨ í”¼ë“œ',
    instagram_reels: 'ì¸ìŠ¤íƒ€ ë¦´ìŠ¤',
    threads: 'ìŠ¤ë ˆë“œ',
    youtube: 'ìœ íŠœë¸Œ ìˆí¼',
    youtube_shorts: 'ìœ íŠœë¸Œ ì‡¼ì¸ ',
    youtube_longform: 'ìœ íŠœë¸Œ ë¡±í¼',
    twitter: 'íŠ¸ìœ„í„°(X)',
    linkedin: 'LinkedIn',
    kakaotalk: 'ì¹´ì¹´ì˜¤í†¡',
    tiktok: 'í‹±í†¡',
    brunch: 'ë¸ŒëŸ°ì¹˜',
    metadata_generation: 'ë©”íƒ€ë°ì´í„° ìƒì„±'
  };
  
  const platformIcons = {
    blog: '<i class="fas fa-blog text-blue-600 mr-2"></i>',
    instagram: '<i class="fab fa-instagram text-pink-600 mr-2"></i>',
    instagram_feed: '<i class="fab fa-instagram text-pink-600 mr-2"></i>',
    instagram_reels: '<i class="fab fa-instagram text-purple-600 mr-2"></i>',
    threads: '<i class="fas fa-at text-gray-800 mr-2"></i>',
    youtube: '<i class="fab fa-youtube text-red-600 mr-2"></i>',
    youtube_shorts: '<i class="fab fa-youtube text-red-500 mr-2"></i>',
    youtube_longform: '<i class="fab fa-youtube text-red-600 mr-2"></i>',
    twitter: '<i class="fab fa-twitter text-blue-400 mr-2"></i>',
    linkedin: '<i class="fab fa-linkedin text-blue-700 mr-2"></i>',
    kakaotalk: '<i class="fas fa-comment-dots text-yellow-500 mr-2"></i>',
    tiktok: '<i class="fab fa-tiktok text-black mr-2"></i>',
    brunch: '<i class="fas fa-book-open text-orange-600 mr-2"></i>',
    metadata_generation: '<i class="fas fa-tags text-blue-600 mr-2"></i>'
  };
  
  let html = `
    <div class="bg-white rounded-xl p-6 shadow-lg border-2 border-green-200">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold text-gray-800">
          <i class="fas fa-check-circle text-green-600 mr-2"></i>
          ì½˜í…ì¸  #${contentIndex + 1} ìƒì„± ì™„ë£Œ
        </h3>
        <button
          type="button"
          onclick="document.getElementById('contentResult_${contentIndex}').classList.add('hidden')"
          class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition text-sm"
        >
          <i class="fas fa-times mr-1"></i>ë‹«ê¸°
        </button>
      </div>
      
      <!-- íƒ­ ë²„íŠ¼ -->
      <div class="flex flex-wrap gap-2 mb-4 border-b-2 border-gray-200 pb-3" id="tabButtons_${contentIndex}">
  `;
  
  platforms.forEach((platform, index) => {
    const isActive = index === 0;
    html += `
      <button
        type="button"
        onclick="switchContentTab(${contentIndex}, '${platform}')"
        id="tabBtn_${contentIndex}_${platform}"
        class="px-4 py-2 rounded-t-lg font-semibold transition ${
          isActive
            ? 'bg-gradient-to-r from-purple-600 to-blue-600 text-white'
            : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
        }"
      >
        ${platformIcons[platform] || ''}${platformNames[platform] || platform}
      </button>
    `;
  });
  
  html += `
      </div>
      
      <!-- íƒ­ ì½˜í…ì¸  -->
      <div id="tabContents_${contentIndex}">
  `;
  
  platforms.forEach((platform, index) => {
    const content = result.data[platform];
    if (!content) return;
    
    const isActive = index === 0;
    html += `
      <div id="tab_${contentIndex}_${platform}" class="${isActive ? '' : 'hidden'}">
        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-3 max-h-96 overflow-y-auto whitespace-pre-wrap text-sm" id="content_${contentIndex}_${platform}">
          ${formatContent(content)}
        </div>
        
        <!-- ì•¡ì…˜ ë²„íŠ¼ -->
        <div class="flex flex-wrap gap-2">
          <button
            type="button"
            onclick="editContentText(${contentIndex}, '${platform}')"
            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm"
          >
            <i class="fas fa-edit mr-1"></i>ìˆ˜ì •
          </button>
          <button
            type="button"
            onclick="downloadAsTextFromSingle(${contentIndex}, '${platform}', 'ì½˜í…ì¸ ${contentIndex + 1}_${platformNames[platform]}.txt')"
            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm"
          >
            <i class="fas fa-file-download mr-1"></i>TXT
          </button>
          <button
            type="button"
            onclick="copyToClipboardFromSingle(${contentIndex}, '${platform}', '${platformNames[platform]}')"
            class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition text-sm"
          >
            <i class="fas fa-copy mr-1"></i>ë³µì‚¬
          </button>
          <button
            type="button"
            onclick="openDateTimeModalForGeneration('${platform}', ${contentIndex})"
            class="px-4 py-2 bg-pink-600 text-white rounded-lg hover:bg-pink-700 transition text-sm"
          >
            <i class="fas fa-calendar-alt mr-1"></i>ìº˜ë¦°ë” ë“±ë¡
          </button>
        </div>
        
        <!-- ìˆ˜ì • ì˜ì—­ (ìˆ¨ê¹€) -->
        <div id="editor_${contentIndex}_${platform}" class="hidden mt-4">
          <textarea
            id="content_editor_${contentIndex}_${platform}"
            class="w-full p-4 border-2 border-purple-300 rounded-lg resize-none"
            rows="10"
          >${content}</textarea>
          <div class="flex gap-2 mt-2">
            <button
              type="button"
              onclick="cancelContentEdit(${contentIndex}, '${platform}')"
              class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition text-sm"
            >
              <i class="fas fa-times mr-1"></i>ì·¨ì†Œ
            </button>
            <button
              type="button"
              onclick="saveContentEdit(${contentIndex}, '${platform}')"
              class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm"
            >
              <i class="fas fa-save mr-1"></i>ì €ì¥
            </button>
          </div>
        </div>
      </div>
    `;
  });
  
  html += `
      </div>
    </div>
  `;
  
  resultArea.innerHTML = html;
  resultArea.classList.remove('hidden');
  resultArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// íƒ­ ì „í™˜
function switchContentTab(contentIndex, platform) {
  // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
  const allTabs = document.querySelectorAll(`[id^="tab_${contentIndex}_"]`);
  allTabs.forEach(tab => tab.classList.add('hidden'));
  
  const allButtons = document.querySelectorAll(`[id^="tabBtn_${contentIndex}_"]`);
  allButtons.forEach(btn => {
    btn.className = 'px-4 py-2 rounded-t-lg font-semibold transition bg-gray-100 text-gray-600 hover:bg-gray-200';
  });
  
  // ì„ íƒëœ íƒ­ í™œì„±í™”
  const selectedTab = document.getElementById(`tab_${contentIndex}_${platform}`);
  if (selectedTab) {
    selectedTab.classList.remove('hidden');
  }
  
  const selectedButton = document.getElementById(`tabBtn_${contentIndex}_${platform}`);
  if (selectedButton) {
    selectedButton.className = 'px-4 py-2 rounded-t-lg font-semibold transition bg-gradient-to-r from-purple-600 to-blue-600 text-white';
  }
}

// ì½˜í…ì¸  ìˆ˜ì •
function editContentText(contentIndex, platform) {
  const contentDiv = document.getElementById(`content_${contentIndex}_${platform}`);
  const editorDiv = document.getElementById(`editor_${contentIndex}_${platform}`);
  
  if (contentDiv && editorDiv) {
    contentDiv.classList.add('hidden');
    editorDiv.classList.remove('hidden');
  }
}

// ì½˜í…ì¸  ìˆ˜ì • ì·¨ì†Œ
function cancelContentEdit(contentIndex, platform) {
  const contentDiv = document.getElementById(`content_${contentIndex}_${platform}`);
  const editorDiv = document.getElementById(`editor_${contentIndex}_${platform}`);
  
  if (contentDiv && editorDiv) {
    contentDiv.classList.remove('hidden');
    editorDiv.classList.add('hidden');
  }
}

// ì½˜í…ì¸  ìˆ˜ì • ì €ì¥
function saveContentEdit(contentIndex, platform) {
  const editor = document.getElementById(`content_editor_${contentIndex}_${platform}`);
  const contentDiv = document.getElementById(`content_${contentIndex}_${platform}`);
  
  if (editor && contentDiv) {
    const newContent = editor.value;
    contentDiv.innerHTML = formatContent(newContent);
    contentDiv.classList.remove('hidden');
    
    const editorDiv = document.getElementById(`editor_${contentIndex}_${platform}`);
    if (editorDiv) {
      editorDiv.classList.add('hidden');
    }
    
    showToast('âœ… ìˆ˜ì • ë‚´ìš©ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
  }
}

// ì „ì—­ ë…¸ì¶œ
window.updateContentPlatforms = updateContentPlatforms;
window.generateSingleContent = generateSingleContent;
window.switchContentTab = switchContentTab;
window.editContentText = editContentText;
window.cancelContentEdit = cancelContentEdit;
window.saveContentEdit = saveContentEdit;


// ========================================
// í”„ë¡œí•„ ê´€ë¦¬ ì‹œìŠ¤í…œ (ë‹¤ì¤‘ í”„ë¡œí•„ ì§€ì›)
// ========================================

/**
 * í”„ë¡œí•„ ëª©ë¡ ëª¨ë‹¬ ì—´ê¸°
 */
async function openProfileListModal() {
  const modal = document.getElementById('profileListModal');
  if (!modal) return;
  
  modal.classList.remove('hidden');
  
  // í”„ë¡œí•„ ëª©ë¡ ë¡œë“œ
  await loadProfilesList();
}

/**
 * í”„ë¡œí•„ ëª©ë¡ ëª¨ë‹¬ ë‹«ê¸°
 */
function closeProfileListModal() {
  const modal = document.getElementById('profileListModal');
  if (modal) {
    modal.classList.add('hidden');
  }
}

/**
 * í”„ë¡œí•„ ì €ì¥ ëª¨ë‹¬ ì—´ê¸°
 */
function openProfileSaveModal(profileId = null) {
  const modal = document.getElementById('profileSaveModal');
  const titleEl = document.getElementById('profileModalTitle');
  const nameInput = document.getElementById('profileNameInput');
  
  if (!modal) return;
  
  currentEditingProfileId = profileId;
  
  if (profileId) {
    // ìˆ˜ì • ëª¨ë“œ
    titleEl.textContent = 'í”„ë¡œí•„ ìˆ˜ì •';
    // ê¸°ì¡´ í”„ë¡œí•„ ì´ë¦„ ë¶ˆëŸ¬ì˜¤ê¸° (TODO)
  } else {
    // ìƒˆë¡œ ì €ì¥ ëª¨ë“œ
    titleEl.textContent = 'ìƒˆ í”„ë¡œí•„ ì €ì¥';
    nameInput.value = '';
  }
  
  modal.classList.remove('hidden');
  nameInput.focus();
}

/**
 * í”„ë¡œí•„ ì €ì¥ ëª¨ë‹¬ ë‹«ê¸°
 */
function closeProfileSaveModal() {
  const modal = document.getElementById('profileSaveModal');
  if (modal) {
    modal.classList.add('hidden');
  }
  currentEditingProfileId = null;
}

/**
 * í”„ë¡œí•„ ì €ì¥ í™•ì¸
 */
async function confirmSaveProfile() {
  const profileName = document.getElementById('profileNameInput').value.trim();
  
  if (!profileName) {
    showToast('í”„ë¡œí•„ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
    return;
  }
  
  const user = window.currentUser;
  if (!user || !user.id) {
    showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'error');
    return;
  }
  
  // í¼ ë°ì´í„° ìˆ˜ì§‘ (ëª¨ë“  í•„ë“œ í¬í•¨, HTML IDì™€ DB ì»¬ëŸ¼ ë§¤í•‘)
  const profileData = {
    user_id: user.id,
    profile_name: profileName,
    brand: document.getElementById('brandName')?.value.trim() || '',  // âœ… brandName
    company_name: document.getElementById('companyName')?.value.trim() || '',
    business_type: document.getElementById('businessType')?.value.trim() || '',
    location: document.getElementById('region')?.value.trim() || '',  // âœ… region
    target_gender: document.getElementById('targetGender')?.value || '',
    contact: document.getElementById('contact')?.value.trim() || '',
    website: document.getElementById('website')?.value.trim() || '',
    sns: document.getElementById('snsAccount')?.value.trim() || '',  // âœ… snsAccount
    keywords: document.getElementById('keywordAnalysisInput')?.value.trim() || '',  // âœ… keywordAnalysisInput
    tone: document.getElementById('toneAndManner')?.value || '',  // âœ… toneAndManner (ê¸°ë³¸ê°’ ì œê±°)
    target_age: document.getElementById('targetAge')?.value || '',  // âœ… ê¸°ë³¸ê°’ ì œê±°
    industry: document.getElementById('industry')?.value || ''  // âœ… ê¸°ë³¸ê°’ ì œê±°
  };
  
  try {
    let response;
    
    if (currentEditingProfileId) {
      // ìˆ˜ì •
      response = await fetch(`/api/profiles/${currentEditingProfileId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(profileData)
      });
    } else {
      // ìƒˆë¡œ ìƒì„±
      response = await fetch('/api/profiles', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(profileData)
      });
    }
    
    const data = await response.json();
    
    if (!data.success) {
      throw new Error(data.error || 'í”„ë¡œí•„ ì €ì¥ ì‹¤íŒ¨');
    }
    
    // ì›Œí¬í”Œë¡œìš° ì—°ê²° ì €ì¥
    if (typeof window.saveProfileWorkflows === 'function') {
      await window.saveProfileWorkflows(profileName);
    }
    
    showToast('âœ… í”„ë¡œí•„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    closeProfileSaveModal();
    
    // í”„ë¡œí•„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
    if (document.getElementById('profileListModal').classList.contains('hidden') === false) {
      await loadProfilesList();
    }
  } catch (error) {
    console.error('í”„ë¡œí•„ ì €ì¥ ì˜¤ë¥˜:', error);
    showToast(`í”„ë¡œí•„ ì €ì¥ ì‹¤íŒ¨: ${error.message}`, 'error');
  }
}

/**
 * í”„ë¡œí•„ ëª©ë¡ ë¡œë“œ
 */
async function loadProfilesList() {
  const container = document.getElementById('profileListContainer');
  if (!container) return;
  
  const user = window.currentUser;
  if (!user || !user.id) {
    container.innerHTML = `
      <div class="text-center py-8 text-gray-500">
        <i class="fas fa-user-slash text-4xl mb-3"></i>
        <p>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</p>
      </div>
    `;
    return;
  }
  
  try {
    const response = await fetch(`/api/profiles?user_id=${user.id}`);
    const data = await response.json();
    
    if (!data.success) {
      throw new Error(data.error || 'í”„ë¡œí•„ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨');
    }
    
    const profiles = data.profiles || [];
    
    if (profiles.length === 0) {
      container.innerHTML = `
        <div class="text-center py-8 text-gray-500">
          <i class="fas fa-inbox text-4xl mb-3"></i>
          <p>ì €ì¥ëœ í”„ë¡œí•„ì´ ì—†ìŠµë‹ˆë‹¤</p>
          <p class="text-sm mt-2">ìœ„ì˜ "ìƒˆ í”„ë¡œí•„ ì¶”ê°€" ë²„íŠ¼ì„ ëˆŒëŸ¬ í”„ë¡œí•„ì„ ì €ì¥í•˜ì„¸ìš”</p>
        </div>
      `;
      return;
    }
    
    container.innerHTML = profiles.map(profile => `
      <div class="border rounded-lg p-4 hover:shadow-md transition">
        <div class="flex justify-between items-start mb-3">
          <div class="flex-1">
            <h4 class="font-bold text-lg text-gray-800">${profile.profile_name || 'ì´ë¦„ ì—†ìŒ'}</h4>
            <p class="text-sm text-gray-600">${profile.brand || 'ë¸Œëœë“œ ì •ë³´ ì—†ìŒ'}</p>
          </div>
          <div class="flex gap-2">
            <button 
              onclick="applyProfile('${profile.id}')" 
              class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition text-sm"
              title="ì´ í”„ë¡œí•„ ì‚¬ìš©"
            >
              <i class="fas fa-check"></i>
            </button>
            <button 
              onclick="deleteProfile('${profile.id}')" 
              class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 transition text-sm"
              title="ì‚­ì œ"
            >
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
        <div class="text-xs text-gray-500 space-y-1">
          <p><i class="fas fa-building mr-1"></i>${profile.company_name || 'íšŒì‚¬ëª… ì—†ìŒ'}</p>
          <p><i class="fas fa-industry mr-1"></i>${profile.industry || 'ì‚°ì—…ë¶„ì•¼ ë¯¸ì„¤ì •'}</p>
          <p><i class="fas fa-users mr-1"></i>${profile.target_age || 'ì—°ë ¹ëŒ€ ë¯¸ì„¤ì •'} â€¢ ${profile.tone || 'í†¤ ë¯¸ì„¤ì •'}</p>
        </div>
      </div>
    `).join('');
  } catch (error) {
    console.error('í”„ë¡œí•„ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
    container.innerHTML = `
      <div class="text-center py-8 text-red-500">
        <i class="fas fa-exclamation-triangle text-4xl mb-3"></i>
        <p>í”„ë¡œí•„ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</p>
      </div>
    `;
  }
}

/**
 * í”„ë¡œí•„ ì ìš© (í¼ì— ìë™ ì±„ìš°ê¸°)
 */
async function applyProfile(profileId) {
  const user = window.currentUser;
  if (!user || !user.id) {
    showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'error');
    return;
  }
  
  try {
    const response = await fetch(`/api/profiles?user_id=${user.id}`);
    const data = await response.json();
    
    if (!data.success) {
      throw new Error(data.error || 'í”„ë¡œí•„ ì¡°íšŒ ì‹¤íŒ¨');
    }
    
    const profile = data.profiles.find(p => p.id === profileId);
    if (!profile) {
      throw new Error('í”„ë¡œí•„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
    
    // í¼ì— ê°’ ì±„ìš°ê¸° (ëª¨ë“  í•„ë“œ í¬í•¨, HTML IDì™€ DB ì»¬ëŸ¼ ë§¤í•‘)
    const setFieldValue = (id, value) => {
      const el = document.getElementById(id);
      if (el) {
        el.value = value || '';
        // âœ… ê°’ ë³€ê²½ ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±° (ìë™ì™„ì„±, validation ë“± ì‘ë™í•˜ë„ë¡)
        el.dispatchEvent(new Event('input', { bubbles: true }));
        el.dispatchEvent(new Event('change', { bubbles: true }));
        console.log(`âœ… ${id} = ${value}`);
      } else {
        console.warn(`âš ï¸ Element not found: ${id}`);
      }
    };
    
    setFieldValue('brandName', profile.brand);  // âœ… brand â†’ brandName
    setFieldValue('companyName', profile.company_name);
    setFieldValue('businessType', profile.business_type);
    setFieldValue('region', profile.location);  // âœ… location â†’ region
    setFieldValue('targetGender', profile.target_gender);
    setFieldValue('contact', profile.contact);
    setFieldValue('website', profile.website);
    setFieldValue('snsAccount', profile.sns);  // âœ… sns â†’ snsAccount
    setFieldValue('keywordAnalysisInput', profile.keywords);  // âœ… keywords â†’ keywordAnalysisInput
    setFieldValue('toneAndManner', profile.tone || '');  // âœ… tone â†’ toneAndManner
    setFieldValue('targetAge', profile.target_age || '');
    setFieldValue('industry', profile.industry || '');
    
    showToast('âœ… í”„ë¡œí•„ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    closeProfileListModal();
    
    // ì›Œí¬í”Œë¡œìš°ë„ í•¨ê»˜ ë¶ˆëŸ¬ì˜¤ê¸°
    if (typeof window.loadProfileWorkflows === 'function') {
      await window.loadProfileWorkflows(profile.profile_name);
    }
    
    // ìŠ¤í¬ë¡¤ì„ í”„ë¡œí•„ ì…ë ¥ í•„ë“œ ì˜ì—­ìœ¼ë¡œ ì´ë™ (leftPanelì˜ ìƒë‹¨)
    setTimeout(() => {
      const leftPanel = document.querySelector('.left-panel');
      if (leftPanel) {
        leftPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
        console.log('ğŸ“ ìŠ¤í¬ë¡¤: í”„ë¡œí•„ ì…ë ¥ í•„ë“œë¡œ ì´ë™');
      }
    }, 100);
  } catch (error) {
    console.error('í”„ë¡œí•„ ì ìš© ì˜¤ë¥˜:', error);
    showToast(`í”„ë¡œí•„ ì ìš© ì‹¤íŒ¨: ${error.message}`, 'error');
  }
}

/**
 * í”„ë¡œí•„ ì‚­ì œ
 */
async function deleteProfile(profileId) {
  if (!confirm('ì´ í”„ë¡œí•„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
    return;
  }
  
  const user = window.currentUser;
  if (!user || !user.id) {
    showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'error');
    return;
  }
  
  try {
    const response = await fetch(`/api/profiles/${profileId}?user_id=${user.id}`, {
      method: 'DELETE'
    });
    
    const data = await response.json();
    
    if (!data.success) {
      throw new Error(data.error || 'í”„ë¡œí•„ ì‚­ì œ ì‹¤íŒ¨');
    }
    
    showToast('âœ… í”„ë¡œí•„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    await loadProfilesList();
  } catch (error) {
    console.error('í”„ë¡œí•„ ì‚­ì œ ì˜¤ë¥˜:', error);
    showToast(`í”„ë¡œí•„ ì‚­ì œ ì‹¤íŒ¨: ${error.message}`, 'error');
  }
}

// ê¸°ì¡´ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ìˆ˜ì •

// ì „ì—­ ë…¸ì¶œ
window.openProfileListModal = openProfileListModal;
window.closeProfileListModal = closeProfileListModal;
window.openProfileSaveModal = openProfileSaveModal;
window.closeProfileSaveModal = closeProfileSaveModal;
window.confirmSaveProfile = confirmSaveProfile;
window.loadProfilesList = loadProfilesList;
window.applyProfile = applyProfile;
window.deleteProfile = deleteProfile;

// ============================================================
// ğŸ“ ìº˜ë¦°ë” ë©”ëª¨ ê¸°ëŠ¥
// ============================================================

/**
 * ë©”ëª¨ ëª¨ë‹¬ ì—´ê¸° (ì—¬ëŸ¬ ë©”ëª¨ ì§€ì›)
 */
async function openMemoModal(dateStr, memoId = null) {
  console.log('ğŸ“ openMemoModal í˜¸ì¶œ:', dateStr, memoId);
  
  const user = window.currentUser;
  if (!user || !user.id) {
    showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'error');
    return;
  }

  // ê¸°ì¡´ ë©”ëª¨ ëª©ë¡ ì¡°íšŒ
  let existingMemos = [];
  
  // í‘œì‹œí•  ë‚ ì§œ (YYYY-MM-DD í˜•ì‹)
  let displayDate = dateStr;
  if (dateStr.includes('T')) {
    displayDate = dateStr.split('T')[0]; // YYYY-MM-DDë§Œ ì¶”ì¶œ
  }
  
  try {
    const response = await fetch(`/api/calendar-memos?user_id=${user.id}&date=${displayDate}`);
    const data = await response.json();
    
    if (data.success && data.memos) {
      existingMemos = data.memos;
    }
  } catch (error) {
    console.error('ë©”ëª¨ ì¡°íšŒ ì˜¤ë¥˜:', error);
  }

  // ê¸°ì¡´ ë©”ëª¨ ëª©ë¡ HTML
  const memosListHtml = existingMemos.length > 0 ? `
    <div class="mb-4">
      <h4 class="text-sm font-semibold text-gray-700 mb-2">
        <i class="fas fa-list mr-2"></i>ì´ ë‚ ì§œì˜ ë©”ëª¨ (${existingMemos.length}ê°œ)
      </h4>
      <div class="space-y-2 max-h-60 overflow-y-auto">
        ${existingMemos.map(memo => {
          const memoTime = new Date(memo.date).toLocaleTimeString('ko-KR', {
            hour: '2-digit',
            minute: '2-digit'
          });
          return `
            <div class="bg-gray-50 p-3 rounded-lg border border-gray-200" id="memo-${memo.id}">
              <div class="flex justify-between items-start mb-1">
                <span class="text-xs text-gray-500">
                  <i class="fas fa-clock mr-1"></i>${memoTime}
                </span>
                <div class="flex gap-2">
                  <button 
                    onclick="editMemo('${memo.id}', \`${memo.memo.replace(/`/g, '\\`').replace(/\\/g, '\\\\')}\`)" 
                    class="text-blue-600 hover:text-blue-800 text-sm"
                    title="ìˆ˜ì •"
                  >
                    <i class="fas fa-edit"></i>
                  </button>
                  <button 
                    onclick="deleteMemo('${memo.id}')" 
                    class="text-red-600 hover:text-red-800 text-sm"
                    title="ì‚­ì œ"
                  >
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
              <p class="text-sm text-gray-800 memo-text-${memo.id}">${memo.memo}</p>
            </div>
          `;
        }).join('')}
      </div>
    </div>
  ` : '';

  const html = `
    <div id="memoModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60]" style="z-index: 60;">
      <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-gray-800">
            ğŸ“ ë©”ëª¨ ê´€ë¦¬
          </h3>
          <button onclick="closeMemoModal()" class="text-gray-500 hover:text-gray-700">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        
        ${memosListHtml}
        
        <div class="mb-4 ${existingMemos.length > 0 ? 'border-t pt-4' : ''}">
          <h4 class="text-sm font-semibold text-gray-700 mb-2">
            <i class="fas fa-plus-circle mr-2"></i>ìƒˆ ë©”ëª¨ ì¶”ê°€
          </h4>
          <p class="text-sm text-gray-600 mb-2">
            <i class="fas fa-calendar mr-2"></i>${displayDate}
          </p>
          <textarea 
            id="memoTextarea" 
            class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" 
            rows="5" 
            placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
          ></textarea>
        </div>
        
        <div class="flex gap-2">
          <button 
            onclick="saveMemo('${displayDate}')" 
            class="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
          >
            ì €ì¥
          </button>
          <button 
            onclick="closeMemoModal()" 
            class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition"
          >
            ë‹«ê¸°
          </button>
        </div>
      </div>
    </div>
  `;

  document.body.insertAdjacentHTML('beforeend', html);
  
  // í¬ì»¤ìŠ¤ ì„¤ì •
  setTimeout(() => {
    const textarea = document.getElementById('memoTextarea');
    if (textarea) {
      textarea.focus();
    }
  }, 100);
}

/**
 * ë©”ëª¨ ëª¨ë‹¬ ë‹«ê¸°
 */
function closeMemoModal() {
  const modal = document.getElementById('memoModal');
  if (modal) {
    modal.remove();
  }
}

/**
 * ë©”ëª¨ ì €ì¥ (ì‹œê°„ ì •ë³´ í¬í•¨)
 */
async function saveMemo(dateStr) {
  const user = window.currentUser;
  if (!user || !user.id) {
    showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'error');
    return;
  }

  const textarea = document.getElementById('memoTextarea');
  const memo = textarea?.value.trim();

  if (!memo) {
    showToast('ë©”ëª¨ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”', 'error');
    return;
  }

  try {
    // ë‚ ì§œ ë¶€ë¶„ ì¶”ì¶œ (YYYY-MM-DD)
    const datePart = dateStr.includes('T') ? dateStr.split('T')[0] : dateStr.split(' ')[0];
    
    // í˜„ì¬ ì‹œê°„ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const now = new Date();
    const hours = now.getHours().toString().padStart(2, '0');
    const minutes = now.getMinutes().toString().padStart(2, '0');
    const seconds = now.getSeconds().toString().padStart(2, '0');
    
    // ISO 8601 í˜•ì‹ìœ¼ë¡œ ì§ì ‘ ì¡°í•© (ì‹œê°„ëŒ€ +09:00 ëª…ì‹œ)
    const dateToSave = `${datePart}T${hours}:${minutes}:${seconds}+09:00`;
    
    console.log('ğŸ“ ë©”ëª¨ ì €ì¥ ë‚ ì§œ:', dateToSave);
    
    const response = await fetch('/api/calendar-memo', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        user_id: user.id,
        date: dateToSave,
        memo
      })
    });

    const data = await response.json();

    if (!data.success) {
      throw new Error(data.error || 'ë©”ëª¨ ì €ì¥ ì‹¤íŒ¨');
    }

    showToast('âœ… ë©”ëª¨ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    closeMemoModal();
    
    // ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨
    if (calendarInstance) {
      calendarInstance.refetchEvents();
    }
  } catch (error) {
    console.error('ë©”ëª¨ ì €ì¥ ì˜¤ë¥˜:', error);
    showToast('ë©”ëª¨ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
  }
}

/**
 * ë©”ëª¨ ì‚­ì œ
 */
async function deleteMemo(memoId) {
  const user = window.currentUser;
  if (!user || !user.id) {
    showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'error');
    return;
  }

  if (!confirm('ë©”ëª¨ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
    return;
  }

  try {
    const response = await fetch(`/api/calendar-memo/${memoId}?user_id=${user.id}`, {
      method: 'DELETE'
    });

    const data = await response.json();

    if (!data.success) {
      throw new Error(data.error || 'ë©”ëª¨ ì‚­ì œ ì‹¤íŒ¨');
    }

    showToast('âœ… ë©”ëª¨ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    closeMemoModal();
    
    // ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨
    if (calendarInstance) {
      calendarInstance.refetchEvents();
    }
  } catch (error) {
    console.error('ë©”ëª¨ ì‚­ì œ ì˜¤ë¥˜:', error);
    showToast('ë©”ëª¨ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
  }
}

/**
 * ë©”ëª¨ ìˆ˜ì • ëª¨ë“œë¡œ ì „í™˜
 */
function editMemo(memoId, currentText) {
  const memoElement = document.getElementById(`memo-${memoId}`);
  if (!memoElement) return;

  // ê¸°ì¡´ í…ìŠ¤íŠ¸ ì˜ì—­ì„ textareaë¡œ ë³€ê²½
  const textElement = memoElement.querySelector(`.memo-text-${memoId}`);
  if (!textElement) return;

  // í¸ì§‘ ëª¨ë“œ HTML
  textElement.innerHTML = `
    <textarea 
      id="edit-textarea-${memoId}" 
      class="w-full p-2 border border-gray-300 rounded-lg text-sm resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
      rows="3"
    >${currentText}</textarea>
    <div class="flex gap-2 mt-2">
      <button 
        onclick="updateMemo('${memoId}')"
        class="px-3 py-1 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700"
      >
        <i class="fas fa-check mr-1"></i>ì €ì¥
      </button>
      <button 
        onclick="cancelEditMemo('${memoId}', \`${currentText.replace(/`/g, '\\`').replace(/\\/g, '\\\\')}\`)"
        class="px-3 py-1 bg-gray-300 text-gray-700 text-sm rounded-lg hover:bg-gray-400"
      >
        <i class="fas fa-times mr-1"></i>ì·¨ì†Œ
      </button>
    </div>
  `;

  // textareaì— í¬ì»¤ìŠ¤
  const textarea = document.getElementById(`edit-textarea-${memoId}`);
  if (textarea) {
    textarea.focus();
    textarea.setSelectionRange(textarea.value.length, textarea.value.length);
  }
}

/**
 * ë©”ëª¨ ìˆ˜ì • ì·¨ì†Œ
 */
function cancelEditMemo(memoId, originalText) {
  const memoElement = document.getElementById(`memo-${memoId}`);
  if (!memoElement) return;

  const textElement = memoElement.querySelector(`.memo-text-${memoId}`);
  if (!textElement) return;

  // ì›ë˜ í…ìŠ¤íŠ¸ë¡œ ë³µì›
  textElement.innerHTML = originalText;
}

/**
 * ë©”ëª¨ ì—…ë°ì´íŠ¸
 */
async function updateMemo(memoId) {
  const user = window.currentUser;
  if (!user || !user.id) {
    showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'error');
    return;
  }

  const textarea = document.getElementById(`edit-textarea-${memoId}`);
  if (!textarea) return;

  const newText = textarea.value.trim();
  if (!newText) {
    showToast('ë©”ëª¨ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
    return;
  }

  try {
    const response = await fetch(`/api/calendar-memo/${memoId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        user_id: user.id,
        memo: newText
      })
    });

    const data = await response.json();

    if (!data.success) {
      throw new Error(data.error || 'ë©”ëª¨ ìˆ˜ì • ì‹¤íŒ¨');
    }

    showToast('âœ… ë©”ëª¨ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    closeMemoModal();
    
    // ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨
    if (calendarInstance) {
      calendarInstance.refetchEvents();
    }
  } catch (error) {
    console.error('ë©”ëª¨ ìˆ˜ì • ì˜¤ë¥˜:', error);
    showToast('ë©”ëª¨ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
  }
}

// ì „ì—­ ë…¸ì¶œ
window.openMemoModal = openMemoModal;
window.closeMemoModal = closeMemoModal;
window.saveMemo = saveMemo;
window.deleteMemo = deleteMemo;
window.editMemo = editMemo;
window.cancelEditMemo = cancelEditMemo;
window.updateMemo = updateMemo;

// ========================================
// ì¸ì¦ ëª¨ë‹¬ í•¨ìˆ˜ (NEW v7.3 - Updated with Login Mode)
// ========================================

// íšŒì›ê°€ì… ëª¨ë‹¬ ì—´ê¸° (íšŒì›ê°€ì… ëª¨ë“œ)
function openAuthModal(mode = 'signup') {
  authMode = mode;
  updateAuthModalUI();
  
  const modal = document.getElementById('authModal');
  if (modal) {
    modal.classList.remove('hidden');
  }
}

// íšŒì›ê°€ì… ëª¨ë‹¬ ë‹«ê¸°
function closeAuthModal() {
  const modal = document.getElementById('authModal');
  if (modal) {
    modal.classList.add('hidden');
  }
  
  // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
  const emailInput = document.getElementById('authEmail');
  const passwordInput = document.getElementById('authPassword');
  if (emailInput) emailInput.value = '';
  if (passwordInput) passwordInput.value = '';
}

// ì¸ì¦ ëª¨ë‹¬ UI ì—…ë°ì´íŠ¸ (íšŒì›ê°€ì… vs ë¡œê·¸ì¸)
function updateAuthModalUI() {
  const titleIcon = document.querySelector('#authModalTitle i');
  const titleText = document.getElementById('authModalTitleText');
  const subtitle = document.getElementById('authModalSubtitle');
  const passwordHint = document.getElementById('passwordHint');
  const authBtn = document.getElementById('emailAuthBtn');
  const authBtnText = document.getElementById('emailAuthBtnText');
  const signupNotice = document.getElementById('signupNotice');
  const modeToggle = document.getElementById('authModeToggle');
  const modeToggleText = document.getElementById('authModeToggleText');
  
  if (authMode === 'signup') {
    // íšŒì›ê°€ì… ëª¨ë“œ
    if (titleIcon) titleIcon.className = 'fas fa-user-plus mr-2 text-purple-600';
    if (titleText) titleText.textContent = 'íšŒì›ê°€ì…';
    if (subtitle) subtitle.textContent = '30ê°œ ë¬´ë£Œ í¬ë ˆë”§ìœ¼ë¡œ ì‹œì‘í•˜ì„¸ìš”!';
    if (passwordHint) passwordHint.textContent = '(8ì ì´ìƒ)';
    if (authBtnText) authBtnText.textContent = 'ì´ë©”ì¼ë¡œ ê°€ì…í•˜ê¸°';
    if (signupNotice) signupNotice.classList.remove('hidden');
    if (modeToggleText) modeToggleText.textContent = 'ë¡œê·¸ì¸';
    if (modeToggle) modeToggle.innerHTML = 'ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <span id="authModeToggleText">ë¡œê·¸ì¸</span>';
  } else {
    // ë¡œê·¸ì¸ ëª¨ë“œ
    if (titleIcon) titleIcon.className = 'fas fa-sign-in-alt mr-2 text-purple-600';
    if (titleText) titleText.textContent = 'ë¡œê·¸ì¸';
    if (subtitle) subtitle.textContent = 'ë‹¤ì‹œ ë§Œë‚˜ì„œ ë°˜ê°‘ìŠµë‹ˆë‹¤!';
    if (passwordHint) passwordHint.textContent = '';
    if (authBtnText) authBtnText.textContent = 'ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸';
    if (signupNotice) signupNotice.classList.add('hidden');
    if (modeToggle) modeToggle.innerHTML = 'ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <span id="authModeToggleText">íšŒì›ê°€ì…</span>';
  }
}

// ì¸ì¦ ëª¨ë“œ ì „í™˜
function toggleAuthMode() {
  authMode = authMode === 'signup' ? 'login' : 'signup';
  updateAuthModalUI();
  console.log('ğŸ”„ ì¸ì¦ ëª¨ë“œ ì „í™˜:', authMode);
}

// ì´ë©”ì¼ ì¸ì¦ ëª¨ë‹¬ ì—´ê¸°
function openEmailVerificationModal(email) {
  const modal = document.getElementById('emailVerificationModal');
  const emailSpan = document.getElementById('verificationEmail');
  
  if (modal && emailSpan) {
    emailSpan.textContent = email;
    modal.classList.remove('hidden');
  }
}

// ì´ë©”ì¼ ì¸ì¦ ëª¨ë‹¬ ë‹«ê¸°
function closeEmailVerificationModal() {
  const modal = document.getElementById('emailVerificationModal');
  if (modal) {
    modal.classList.add('hidden');
  }
}

// ì´ë©”ì¼ ì¸ì¦ ì™„ë£Œ í›„ ë¡œê·¸ì¸ (NEW v7.3)
function handleLoginAfterVerification() {
  console.log('ğŸ“§ ì´ë©”ì¼ ì¸ì¦ ì™„ë£Œ â†’ ë¡œê·¸ì¸ ëª¨ë“œë¡œ ì „í™˜');
  
  // 1. ì´ë©”ì¼ ì¸ì¦ ëª¨ë‹¬ ë‹«ê¸°
  closeEmailVerificationModal();
  
  // 2. ë¡œê·¸ì¸ ëª¨ë“œë¡œ ì¸ì¦ ëª¨ë‹¬ ì—´ê¸°
  openAuthModal('login');
  
  // 3. ì•ˆë‚´ í† ìŠ¤íŠ¸ í‘œì‹œ
  showToast('ì´ë©”ì¼ ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”', 'success');
  
  // 4. ì´ë©”ì¼ í•„ë“œì— ì¸ì¦ëœ ì´ë©”ì¼ ìë™ ì…ë ¥
  const verificationEmail = document.getElementById('verificationEmail');
  const authEmail = document.getElementById('authEmail');
  
  if (verificationEmail && authEmail) {
    authEmail.value = verificationEmail.textContent;
  }
}

// ì´ë©”ì¼ ë„ë©”ì¸ ì•ˆë‚´
function updateEmailDomainHint() {
  const emailInput = document.getElementById('authEmail');
  const hintElement = document.getElementById('emailDomainHint');
  
  if (!emailInput || !hintElement) return;
  
  const email = emailInput.value.toLowerCase();
  
  if (email.includes('@naver.com')) {
    hintElement.textContent = 'âœ… ë„¤ì´ë²„ ë©”ì¼ ì‚¬ìš© ê°€ëŠ¥';
    hintElement.className = 'text-xs text-green-600 mt-1';
  } else if (email.includes('@hanmail.net') || email.includes('@daum.net')) {
    hintElement.textContent = 'âœ… í•œë©”ì¼/ë‹¤ìŒ ë©”ì¼ ì‚¬ìš© ê°€ëŠ¥';
    hintElement.className = 'text-xs text-green-600 mt-1';
  } else if (email.includes('@gmail.com')) {
    hintElement.textContent = 'âœ… Gmail ì‚¬ìš© ê°€ëŠ¥';
    hintElement.className = 'text-xs text-green-600 mt-1';
  } else if (email.includes('@')) {
    hintElement.textContent = 'âœ… ëª¨ë“  ë„ë©”ì¸ ì‚¬ìš© ê°€ëŠ¥';
    hintElement.className = 'text-xs text-blue-600 mt-1';
  } else {
    hintElement.textContent = '';
  }
}

// í†µí•© ì´ë©”ì¼ ì¸ì¦ í•¸ë“¤ëŸ¬ (íšŒì›ê°€ì… + ë¡œê·¸ì¸)
async function handleEmailAuth() {
  if (authMode === 'signup') {
    await handleEmailSignup();
  } else {
    await handleEmailLogin();
  }
}

// ì´ë©”ì¼ íšŒì›ê°€ì…
async function handleEmailSignup() {
  const emailInput = document.getElementById('authEmail');
  const passwordInput = document.getElementById('authPassword');
  
  if (!emailInput || !passwordInput) {
    showToast('ì…ë ¥ ì–‘ì‹ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
    return;
  }
  
  const email = emailInput.value.trim();
  const password = passwordInput.value;
  
  // ìœ íš¨ì„± ê²€ì‚¬
  if (!email || !password) {
    showToast('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'warning');
    return;
  }
  
  if (password.length < 8) {
    showToast('ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤', 'warning');
    return;
  }
  
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    showToast('ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤', 'warning');
    return;
  }
  
  try {
    console.log('ğŸ“§ ì´ë©”ì¼ íšŒì›ê°€ì… ì‹œì‘:', email);
    
    // ë²„íŠ¼ ë¹„í™œì„±í™”
    const authBtn = document.getElementById('emailAuthBtn');
    if (authBtn) {
      authBtn.disabled = true;
      authBtn.textContent = 'ì²˜ë¦¬ ì¤‘...';
    }
    
    const response = await fetch('/api/auth/signup', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ email, password })
    });
    
    const data = await response.json();
    
    if (!response.ok || !data.success) {
      throw new Error(data.error || 'íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
    }
    
    console.log('âœ… íšŒì›ê°€ì… ì„±ê³µ:', data);
    
    // íšŒì›ê°€ì… ëª¨ë‹¬ ë‹«ê¸°
    closeAuthModal();
    
    // ì´ë©”ì¼ ì¸ì¦ ì•ˆë‚´ ëª¨ë‹¬ í‘œì‹œ
    openEmailVerificationModal(email);
    
    showToast(`íšŒì›ê°€ì… ì™„ë£Œ! ${email}ë¡œ ì¸ì¦ ë©”ì¼ì„ ë°œì†¡í–ˆìŠµë‹ˆë‹¤`, 'success');
    
    // ë‚¨ì€ ê°€ì… ê°€ëŠ¥ íšŸìˆ˜ í‘œì‹œ
    if (data.remaining_signups !== undefined) {
      console.log(`â„¹ï¸ 24ì‹œê°„ ë‚´ ë‚¨ì€ ê°€ì… ê°€ëŠ¥ íšŸìˆ˜: ${data.remaining_signups}íšŒ`);
    }
    
  } catch (error) {
    console.error('âŒ íšŒì›ê°€ì… ì˜¤ë¥˜:', error);
    
    // DB ì—ëŸ¬ ì½”ë“œë³„ ì²˜ë¦¬ (NEW v7.5 - ê°„ë‹¨í•œ ë©”ì‹œì§€)
    const errorMsg = error.message || 'íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤';
    
    if (errorMsg.includes('íƒˆí‡´í•œ ê³„ì •ì€') || errorMsg.includes('30ì¼ í›„ ì¬ê°€ì…')) {
      // ì¬ê°€ì… ì œí•œ - DB ë©”ì‹œì§€ ê·¸ëŒ€ë¡œ í‘œì‹œ (íƒˆí‡´ì¼ í¬í•¨)
      showToast(`â° ${errorMsg}`, 'warning');
    } else if (errorMsg.includes('ERR_PERMANENT_BAN') || errorMsg.includes('ì˜êµ¬ì ìœ¼ë¡œ ê°€ì…ì´ ì œí•œ')) {
      // ì˜êµ¬ ì°¨ë‹¨
      showToast('ğŸš« ì´ ì´ë©”ì¼ì€ ê°€ì…ì´ ì œí•œë˜ì–´ ìˆìŠµë‹ˆë‹¤. ê³ ê°ì„¼í„°ì— ë¬¸ì˜í•´ì£¼ì„¸ìš”.', 'error');
    } else if (errorMsg.includes('ì´ë¯¸ ë“±ë¡ëœ')) {
      // ì´ë©”ì¼ ì¤‘ë³µ
      showToast('ì´ë¯¸ ê°€ì…ëœ ì´ë©”ì¼ì…ë‹ˆë‹¤. ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 'warning');
    } else if (errorMsg.includes('IP')) {
      // IP ì œí•œ
      showToast('âš ï¸ ë™ì¼ IPì—ì„œ ê°€ì… ì œí•œì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. 24ì‹œê°„ í›„ ì‹œë„í•´ì£¼ì„¸ìš”.', 'warning');
    } else {
      // ê¸°íƒ€ ì—ëŸ¬
      showToast(errorMsg, 'error');
    }
  } finally {
    // ë²„íŠ¼ ì¬í™œì„±í™”
    const authBtn = document.getElementById('emailAuthBtn');
    if (authBtn) {
      authBtn.disabled = false;
      authBtn.innerHTML = '<i class="fas fa-envelope mr-2"></i><span id="emailAuthBtnText">ì´ë©”ì¼ë¡œ ê°€ì…í•˜ê¸°</span>';
      updateAuthModalUI(); // UI ë³µì›
    }
  }
}

// ì´ë©”ì¼ ë¡œê·¸ì¸
async function handleEmailLogin() {
  const emailInput = document.getElementById('authEmail');
  const passwordInput = document.getElementById('authPassword');
  
  if (!emailInput || !passwordInput) {
    showToast('ì…ë ¥ ì–‘ì‹ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
    return;
  }
  
  const email = emailInput.value.trim();
  const password = passwordInput.value;
  
  // ìœ íš¨ì„± ê²€ì‚¬
  if (!email || !password) {
    showToast('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'warning');
    return;
  }
  
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    showToast('ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤', 'warning');
    return;
  }
  
  try {
    console.log('ğŸ” ì´ë©”ì¼ ë¡œê·¸ì¸ ì‹œì‘:', email);
    
    // ë²„íŠ¼ ë¹„í™œì„±í™”
    const authBtn = document.getElementById('emailAuthBtn');
    if (authBtn) {
      authBtn.disabled = true;
      authBtn.textContent = 'ë¡œê·¸ì¸ ì¤‘...';
    }
    
    if (!supabaseClient) {
      throw new Error('ì¸ì¦ ì‹œìŠ¤í…œì„ ì´ˆê¸°í™”í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤');
    }
    
    const { data, error } = await supabaseClient.auth.signInWithPassword({
      email,
      password
    });
    
    if (error) {
      throw error;
    }
    
    console.log('âœ… ë¡œê·¸ì¸ ì„±ê³µ:', data);
    
    // íšŒì›ê°€ì… ëª¨ë‹¬ ë‹«ê¸°
    closeAuthModal();
    
    showToast('ë¡œê·¸ì¸ ì„±ê³µ!', 'success');
    
    // ëœë”© í˜ì´ì§€ì—ì„œ ë¡œê·¸ì¸í•œ ê²½ìš° PostFlowë¡œ ì´ë™
    if (window.location.pathname === '/') {
      setTimeout(() => {
        window.location.href = '/postflow';
      }, 500);
    } else {
      // PostFlow í˜ì´ì§€ì—ì„œ ë¡œê·¸ì¸í•œ ê²½ìš° ìƒˆë¡œê³ ì¹¨
      setTimeout(() => {
        window.location.reload();
      }, 500);
    }
    
  } catch (error) {
    console.error('âŒ ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
    
    // ì˜¤ë¥˜ ë©”ì‹œì§€ ë¶„ì„ ë° ì‚¬ìš©ì ì¹œí™”ì  ë©”ì‹œì§€ í‘œì‹œ
    if (error.message.includes('Invalid login credentials')) {
      showToast('âš ï¸ ë¡œê·¸ì¸ ì‹¤íŒ¨: ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.\níƒˆí‡´í•œ ê³„ì •ì´ê±°ë‚˜ ë“±ë¡ë˜ì§€ ì•Šì€ ì´ë©”ì¼ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'error');
    } else if (error.message.includes('Email not confirmed')) {
      showToast('ğŸ“§ ì´ë©”ì¼ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤. ê°€ì… ì‹œ ë°›ì€ ì¸ì¦ ë©”ì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'warning');
    } else if (error.message.includes('User not found')) {
      showToast('âŒ ë“±ë¡ë˜ì§€ ì•Šì€ ì´ë©”ì¼ì…ë‹ˆë‹¤. íšŒì›ê°€ì…ì„ ë¨¼ì € ì§„í–‰í•´ì£¼ì„¸ìš”.', 'error');
    } else if (error.message.includes('account has been deleted')) {
      showToast('ğŸš« íƒˆí‡´í•œ ê³„ì •ì…ë‹ˆë‹¤. ë‹¤ì‹œ ê°€ì…í•˜ë ¤ë©´ íšŒì›ê°€ì…ì„ ì§„í–‰í•´ì£¼ì„¸ìš”.', 'error');
    } else if (error.message.includes('Too many requests')) {
      showToast('â° ë¡œê·¸ì¸ ì‹œë„ íšŸìˆ˜ ì´ˆê³¼. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'warning');
    } else {
      showToast(`âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤'}`, 'error');
    }
  } finally {
    // ë²„íŠ¼ ì¬í™œì„±í™”
    const authBtn = document.getElementById('emailAuthBtn');
    if (authBtn) {
      authBtn.disabled = false;
      authBtn.innerHTML = '<i class="fas fa-envelope mr-2"></i><span id="emailAuthBtnText">ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸</span>';
      updateAuthModalUI(); // UI ë³µì›
    }
  }
}

// Google ë¡œê·¸ì¸ (ëª¨ë‹¬ì—ì„œ)
async function handleGoogleLogin() {
  if (!supabaseClient) {
    showToast('ì¸ì¦ ì‹œìŠ¤í…œì„ ì´ˆê¸°í™”í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤', 'warning');
    return;
  }
  
  try {
    console.log('ğŸ” Google ë¡œê·¸ì¸ ì‹œì‘');
    
    const { data, error } = await supabaseClient.auth.signInWithOAuth({
      provider: 'google',
      options: {
        redirectTo: window.location.origin,
        queryParams: {
          access_type: 'offline',
          prompt: 'consent'
        }
      }
    });
    
    if (error) {
      throw error;
    }
    
    // OAuthëŠ” ìë™ìœ¼ë¡œ ë¦¬ë””ë ‰ì…˜ë©ë‹ˆë‹¤
    console.log('âœ… Google OAuth ë¦¬ë””ë ‰ì…˜ ì‹œì‘');
    
  } catch (error) {
    console.error('âŒ Google ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
    showToast('Google ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
  }
}

// Kakao ë¡œê·¸ì¸ (ëª¨ë‹¬ì—ì„œ)
async function handleKakaoLogin() {
  if (!supabaseClient) {
    showToast('ì¸ì¦ ì‹œìŠ¤í…œì„ ì´ˆê¸°í™”í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤', 'warning');
    return;
  }
  
  try {
    console.log('ğŸŸ¡ Kakao ë¡œê·¸ì¸ ì‹œì‘');
    
    // NEW v7.8: queryParamsë¡œ ìŠ¤ì½”í”„ ê°•ì œ ì„¤ì • (KOE205 ì™„ì „ ìˆ˜ì •)
    // Supabaseê°€ ìë™ìœ¼ë¡œ account_emailì„ ì¶”ê°€í•˜ëŠ” ê²ƒì„ ë°©ì§€
    const { data, error } = await supabaseClient.auth.signInWithOAuth({
      provider: 'kakao',
      options: {
        scopes: 'profile_nickname profile_image',  // account_email ì œì™¸
        queryParams: {
          scope: 'profile_nickname profile_image'  // ëª…ì‹œì  ì˜¤ë²„ë¼ì´ë“œ
        }
      }
    });
    
    if (error) {
      throw error;
    }
    
    // OAuthëŠ” ìë™ìœ¼ë¡œ ë¦¬ë””ë ‰ì…˜ë©ë‹ˆë‹¤
    console.log('âœ… Kakao OAuth ë¦¬ë””ë ‰ì…˜ ì‹œì‘');
    
  } catch (error) {
    console.error('âŒ Kakao ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
    showToast('Kakao ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
  }
}

// ========================================
// íšŒì› íƒˆí‡´ (NEW v7.4)
// ========================================
async function handleDeleteAccount() {
  // 1ì°¨ í™•ì¸ (NEW v7.5: 30ì¼ ì œí•œ ì•ˆë‚´ ì¶”ê°€)
  const confirmed = confirm(
    'âš ï¸ ì •ë§ë¡œ íšŒì› íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n' +
    'â€¢ ëª¨ë“  í¬ë ˆë”§ì´ ì‚­ì œë©ë‹ˆë‹¤\n' +
    'â€¢ ìƒì„±í•œ ì½˜í…ì¸  ê¸°ë¡ì´ ì‚­ì œë©ë‹ˆë‹¤\n' +
    'â€¢ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤\n' +
    'â€¢ íƒˆí‡´ í›„ 30ì¼ ë™ì•ˆ ì¬ê°€ì…ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤\n' +
    'â€¢ 30ì¼ í›„ ì¬ê°€ì… ì‹œ ë¬´ë£Œ í¬ë ˆë”§ì´ ì§€ê¸‰ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤\n\n' +
    'íƒˆí‡´í•˜ì‹œë ¤ë©´ "í™•ì¸"ì„ í´ë¦­í•˜ì„¸ìš”.'
  );
  
  if (!confirmed) {
    return;
  }

  // 2ì°¨ í™•ì¸
  const doubleConfirm = confirm('ë§ˆì§€ë§‰ í™•ì¸ì…ë‹ˆë‹¤. ì •ë§ë¡œ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
  if (!doubleConfirm) {
    return;
  }

  try {
    console.log('ğŸ—‘ï¸ íšŒì› íƒˆí‡´ ì‹œì‘...');

    // Supabase í´ë¼ì´ì–¸íŠ¸ í™•ì¸
    if (!supabaseClient) {
      showToast('Supabase ì´ˆê¸°í™”ê°€ í•„ìš”í•©ë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.', 'error');
      return;
    }

    // í˜„ì¬ ì„¸ì…˜ í† í° ê°€ì ¸ì˜¤ê¸°
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (!session) {
      showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'error');
      return;
    }

    // API í˜¸ì¶œ
    const response = await fetch('/api/auth/delete-account', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${session.access_token}`,
        'Content-Type': 'application/json'
      }
    });

    const data = await response.json();

    if (!response.ok || !data.success) {
      throw new Error(data.error || 'íšŒì› íƒˆí‡´ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
    }

    console.log('âœ… íšŒì› íƒˆí‡´ ì™„ë£Œ:', data);

    // ë¡œê·¸ì•„ì›ƒ (ì„¸ì…˜ ì •ë¦¬)
    await supabaseClient.auth.signOut();
    
    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì •ë¦¬
    localStorage.removeItem('postflow_user');
    localStorage.removeItem('postflow_token');

    // ì„±ê³µ ë©”ì‹œì§€ (NEW v7.5: 30ì¼ ì œí•œ ì•ˆë‚´)
    const restrictionDate = data.restriction_until ? new Date(data.restriction_until).toLocaleDateString('ko-KR') : '30ì¼ í›„';
    alert(
      'íšŒì› íƒˆí‡´ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n\n' +
      `â€¢ ì¬ê°€ì… ê°€ëŠ¥ ë‚ ì§œ: ${restrictionDate}\n` +
      'â€¢ ì¬ê°€ì… ì‹œ ë¬´ë£Œ í¬ë ˆë”§ì€ ì œê³µë˜ì§€ ì•ŠìŠµë‹ˆë‹¤\n\n' +
      'ê·¸ë™ì•ˆ ì´ìš©í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.'
    );

    // ë©”ì¸ í˜ì´ì§€ë¡œ ë¦¬ë””ë ‰íŠ¸
    window.location.href = '/';

  } catch (error) {
    console.error('âŒ íšŒì› íƒˆí‡´ ì˜¤ë¥˜:', error);
    showToast(`íšŒì› íƒˆí‡´ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`, 'error');
  }
}

// ì „ì—­ ë…¸ì¶œ
window.openPolicyModal = openPolicyModal;
window.closePolicyModal = closePolicyModal;
window.handleLogoClick = handleLogoClick;
window.openAuthModal = openAuthModal;
window.closeAuthModal = closeAuthModal;
window.toggleAuthMode = toggleAuthMode;
window.updateAuthModalUI = updateAuthModalUI;
window.openEmailVerificationModal = openEmailVerificationModal;
window.closeEmailVerificationModal = closeEmailVerificationModal;
window.handleLoginAfterVerification = handleLoginAfterVerification;
window.handleEmailAuth = handleEmailAuth;
window.handleEmailSignup = handleEmailSignup;
window.handleEmailLogin = handleEmailLogin;
window.handleGoogleLogin = handleGoogleLogin;
window.handleKakaoLogin = handleKakaoLogin;
window.updateEmailDomainHint = updateEmailDomainHint;
window.handleDeleteAccount = handleDeleteAccount;

// ===================================
// ğŸ”„ ë©€í‹°íƒ­ í¬ë ˆë”§ ë™ê¸°í™” ì‹œìŠ¤í…œ
// ===================================

/**
 * í¬ë ˆë”§ UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
 */
function updateCreditsUI(credits) {
  console.log('ğŸ’³ í¬ë ˆë”§ UI ì—…ë°ì´íŠ¸:', credits);
  
  if (!credits) return;
  
  const userCreditsElement = document.getElementById('userCredits');
  if (userCreditsElement) {
    const totalCredits = (credits.free_credits || 0) + (credits.paid_credits || 0);
    userCreditsElement.textContent = `${totalCredits} í¬ë ˆë”§`;
  }
  
  // currentUser ê°ì²´ ì—…ë°ì´íŠ¸
  if (window.currentUser) {
    window.currentUser.free_credits = credits.free_credits || 0;
    window.currentUser.paid_credits = credits.paid_credits || 0;
    
    // LocalStorage ì—…ë°ì´íŠ¸
    const userData = localStorage.getItem('postflow_user');
    if (userData) {
      try {
        const user = JSON.parse(userData);
        user.free_credits = credits.free_credits || 0;
        user.paid_credits = credits.paid_credits || 0;
        localStorage.setItem('postflow_user', JSON.stringify(user));
      } catch (e) {
        console.error('âŒ LocalStorage ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', e);
      }
    }
  }
}

/**
 * ë‹¤ë¥¸ íƒ­ì— í¬ë ˆë”§ ë³€ê²½ ì•Œë¦¼
 */
function broadcastCreditUpdate(newCredits) {
  try {
    creditSyncChannel.postMessage({
      type: 'CREDIT_UPDATE',
      data: {
        free_credits: newCredits.free_credits,
        paid_credits: newCredits.paid_credits,
        timestamp: Date.now(),
        source_tab: document.title
      }
    });
    console.log('ğŸ“¡ í¬ë ˆë”§ ë³€ê²½ ì•Œë¦¼ ì „ì†¡:', newCredits);
  } catch (error) {
    console.error('âŒ BroadcastChannel ì˜¤ë¥˜:', error);
  }
}

/**
 * ë‹¤ë¥¸ íƒ­ì—ì„œ í¬ë ˆë”§ ë³€ê²½ ì•Œë¦¼ ìˆ˜ì‹ 
 */
creditSyncChannel.addEventListener('message', (event) => {
  if (event.data.type === 'CREDIT_UPDATE') {
    console.log('ğŸ“¡ ë‹¤ë¥¸ íƒ­ì—ì„œ í¬ë ˆë”§ ë³€ê²½ ê°ì§€:', event.data);
    
    // UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸
    updateCreditsUI(event.data.data);
    
    // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
    // showToast(`ğŸ’³ í¬ë ˆë”§ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤ (${event.data.source_tab})`, 'info');
  }
});

/**
 * íƒ­ í™œì„±í™” ì‹œ í¬ë ˆë”§ ë™ê¸°í™”
 */
document.addEventListener('visibilitychange', async () => {
  if (document.visibilityState === 'visible' && window.currentUser && !window.currentUser.isGuest) {
    console.log('ğŸ”„ íƒ­ í™œì„±í™”: í¬ë ˆë”§ ì •ë³´ ë™ê¸°í™” ì¤‘...');
    
    try {
      const response = await fetch(`/api/users/${window.currentUser.id}/credits`);
      const data = await response.json();
      
      if (data.success) {
        updateCreditsUI({
          free_credits: data.free_credits,
          paid_credits: data.paid_credits
        });
        
        console.log('âœ… í¬ë ˆë”§ ë™ê¸°í™” ì™„ë£Œ:', data);
      }
    } catch (error) {
      console.error('âŒ í¬ë ˆë”§ ë™ê¸°í™” ì‹¤íŒ¨:', error);
    }
  }
});

/**
 * LocalStorage ë³€ê²½ ê°ì§€ (ë‹¤ë¥¸ íƒ­ì—ì„œ ì‚¬ìš©ì ì •ë³´ ë³€ê²½ ì‹œ)
 */
window.addEventListener('storage', (event) => {
  if (event.key === 'postflow_user' && event.newValue) {
    try {
      const userData = JSON.parse(event.newValue);
      console.log('ğŸ’¾ LocalStorage ë³€ê²½ ê°ì§€:', userData);
      
      // í¬ë ˆë”§ ì •ë³´ê°€ ë³€ê²½ë˜ì—ˆìœ¼ë©´ UI ì—…ë°ì´íŠ¸
      if (userData.free_credits !== undefined || userData.paid_credits !== undefined) {
        updateCreditsUI({
          free_credits: userData.free_credits || 0,
          paid_credits: userData.paid_credits || 0
        });
      }
    } catch (error) {
      console.error('âŒ LocalStorage íŒŒì‹± ì˜¤ë¥˜:', error);
    }
  }
});

// ì „ì—­ ë…¸ì¶œ
window.updateCreditsUI = updateCreditsUI;
window.broadcastCreditUpdate = broadcastCreditUpdate;

// ========================================
// SNS ë°”ë¡œê°€ê¸° ê¸°ëŠ¥ (NEW v8.0)
// ========================================

// LocalStorage í‚¤
const SNS_LINKS_KEY = 'postflow_sns_links';

// ê¸°ë³¸ 8ê°œ í”Œë«í¼
const DEFAULT_SNS_PLATFORMS = [
  { name: 'ë„¤ì´ë²„ ë¸”ë¡œê·¸', url: 'https://blog.naver.com', icon: 'fas fa-blog', color: '#03C75A' },
  { name: 'ì¸ìŠ¤íƒ€ê·¸ë¨', url: 'https://www.instagram.com', icon: 'fab fa-instagram', color: '#E4405F' },
  { name: 'ìŠ¤ë ˆë“œ', url: 'https://www.threads.net', icon: 'fab fa-threads', color: '#000000' },
  { name: 'íŠ¸ìœ„í„°', url: 'https://twitter.com', icon: 'fab fa-twitter', color: '#1DA1F2' },
  { name: 'ë§í¬ë“œì¸', url: 'https://www.linkedin.com', icon: 'fab fa-linkedin', color: '#0A66C2' },
  { name: 'ë¸ŒëŸ°ì¹˜', url: 'https://brunch.co.kr', icon: 'fas fa-coffee', color: '#00C896' },
  { name: 'í‹±í†¡', url: 'https://www.tiktok.com', icon: 'fab fa-tiktok', color: '#000000' },
  { name: 'ìœ íŠœë¸Œ', url: 'https://studio.youtube.com', icon: 'fab fa-youtube', color: '#FF0000' }
];

// SNS ë§í¬ ë¶ˆëŸ¬ì˜¤ê¸°
function loadSnsLinks() {
  const saved = localStorage.getItem(SNS_LINKS_KEY);
  if (saved) {
    try {
      return JSON.parse(saved);
    } catch (error) {
      console.error('âŒ SNS ë§í¬ íŒŒì‹± ì˜¤ë¥˜:', error);
      return DEFAULT_SNS_PLATFORMS;
    }
  }
  return DEFAULT_SNS_PLATFORMS;
}

// SNS ë§í¬ ì €ì¥
function saveSnsLinks(links) {
  localStorage.setItem(SNS_LINKS_KEY, JSON.stringify(links));
}

// SNS ë°”ë¡œê°€ê¸° ëª¨ë‹¬ ì—´ê¸°
function openSnsLinksModal() {
  const modal = document.getElementById('snsLinksModal');
  if (!modal) {
    console.error('âŒ SNS ë°”ë¡œê°€ê¸° ëª¨ë‹¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    return;
  }
  
  modal.style.display = 'flex';
  renderSnsList();
}

// SNS ë°”ë¡œê°€ê¸° ëª¨ë‹¬ ë‹«ê¸°
function closeSnsLinksModal() {
  const modal = document.getElementById('snsLinksModal');
  if (modal) {
    modal.style.display = 'none';
  }
}

// SNS ëª©ë¡ ë Œë”ë§
function renderSnsList() {
  const container = document.getElementById('snsLinksList');
  if (!container) return;
  
  const links = loadSnsLinks();
  
  if (links.length === 0) {
    container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">ì €ì¥ëœ SNS ë§í¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
    return;
  }
  
  container.innerHTML = links.map((link, index) => `
    <div style="display: flex; align-items: center; justify-content: space-between; padding: 15px; background: #f9fafb; border-radius: 8px; margin-bottom: 10px;">
      <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
        <i class="${link.icon}" style="font-size: 24px; color: ${link.color}; width: 32px; text-align: center;"></i>
        <div style="flex: 1;">
          <div style="font-weight: 600; color: #1f2937; margin-bottom: 4px;">${link.name}</div>
          <a href="${link.url}" target="_blank" style="color: #6b7280; font-size: 0.875rem; text-decoration: none;" 
             onmouseover="this.style.textDecoration='underline'" 
             onmouseout="this.style.textDecoration='none'">
            ${link.url}
          </a>
        </div>
      </div>
      <div style="display: flex; gap: 8px;">
        <button onclick="editSnsLink(${index})" style="padding: 8px 12px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">
          <i class="fas fa-edit"></i> ìˆ˜ì •
        </button>
        <button onclick="deleteSnsLink(${index})" style="padding: 8px 12px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">
          <i class="fas fa-trash"></i> ì‚­ì œ
        </button>
      </div>
    </div>
  `).join('');
}

// ìƒˆ SNS ë§í¬ ì¶”ê°€
function addNewSnsLink() {
  editingIndex = null; // ìƒˆë¡œ ì¶”ê°€
  document.getElementById('editSnsName').value = '';
  document.getElementById('editSnsUrl').value = '';
  document.getElementById('editSnsModal').style.display = 'flex';
}

// SNS ë§í¬ ìˆ˜ì •
let editingSnsIndex = null;

function editSnsLink(index) {
  editingSnsIndex = index;
  const links = loadSnsLinks();
  const link = links[index];
  
  document.getElementById('editSnsName').value = link.name;
  document.getElementById('editSnsUrl').value = link.url;
  document.getElementById('editSnsModal').style.display = 'flex';
}

// SNS ìˆ˜ì • ì €ì¥
function saveEditSns() {
  const name = document.getElementById('editSnsName').value.trim();
  const url = document.getElementById('editSnsUrl').value.trim();
  
  if (!name || !url) {
    showToast('âš ï¸ ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'warning');
    return;
  }
  
  const links = loadSnsLinks();
  
  if (editingSnsIndex === null) {
    // ìƒˆë¡œ ì¶”ê°€
    links.push({
      name: name,
      url: url,
      icon: 'fas fa-link',
      color: '#6366f1'
    });
    showToast('âœ… SNS ë§í¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
  } else {
    // ê¸°ì¡´ ìˆ˜ì •
    links[editingSnsIndex] = {
      ...links[editingSnsIndex],
      name: name,
      url: url
    };
    showToast('âœ… SNS ë§í¬ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
  }
  
  saveSnsLinks(links);
  renderSnsList();
  cancelEditSns();
}

// SNS ìˆ˜ì • ì·¨ì†Œ
function cancelEditSns() {
  document.getElementById('editSnsModal').style.display = 'none';
  editingSnsIndex = null;
}

// SNS ë§í¬ ì‚­ì œ
function deleteSnsLink(index) {
  if (!confirm('ì´ SNS ë§í¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  
  const links = loadSnsLinks();
  links.splice(index, 1);
  
  saveSnsLinks(links);
  renderSnsList();
  showToast('âœ… SNS ë§í¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
}

// ========================================
// AI ì›Œí¬í”Œë¡œìš° ê¸°ëŠ¥ (NEW v8.0)
// ========================================

// LocalStorage í‚¤
const AI_WORKFLOW_KEY = 'postflow_ai_workflow';

// ê¸°ë³¸ AI ë„êµ¬ ëª©ë¡ (ì¹´í…Œê³ ë¦¬ë³„)
const DEFAULT_AI_TOOLS = [
  // ì´ë¯¸ì§€ ìƒì„±
  { name: 'Midjourney', url: 'https://www.midjourney.com', category: 'ì´ë¯¸ì§€ ìƒì„±', icon: 'fas fa-palette', color: '#7B68EE' },
  { name: 'DALLÂ·E', url: 'https://labs.openai.com', category: 'ì´ë¯¸ì§€ ìƒì„±', icon: 'fas fa-image', color: '#10A37F' },
  
  // ì˜ìƒ í¸ì§‘
  { name: 'CapCut', url: 'https://www.capcut.com', category: 'ì˜ìƒ í¸ì§‘', icon: 'fas fa-video', color: '#000000' },
  { name: 'Runway', url: 'https://runwayml.com', category: 'ì˜ìƒ í¸ì§‘', icon: 'fas fa-film', color: '#4A90E2' },
  
  // ë””ìì¸
  { name: 'Canva', url: 'https://www.canva.com', category: 'ë””ìì¸', icon: 'fas fa-paint-brush', color: '#00C4CC' },
  { name: 'Figma', url: 'https://www.figma.com', category: 'ë””ìì¸', icon: 'fas fa-pencil-ruler', color: '#F24E1E' },
  
  // ìŒì„± ìƒì„±
  { name: 'ElevenLabs', url: 'https://elevenlabs.io', category: 'ìŒì„± ìƒì„±', icon: 'fas fa-microphone', color: '#6366F1' },
  
  // ìŒì•… ìƒì„±
  { name: 'Suno', url: 'https://suno.ai', category: 'ìŒì•… ìƒì„±', icon: 'fas fa-music', color: '#FF6B6B' },
  
  // í”„ë ˆì  í…Œì´ì…˜
  { name: 'Gamma', url: 'https://gamma.app', category: 'í”„ë ˆì  í…Œì´ì…˜', icon: 'fas fa-presentation', color: '#8B5CF6' },
  { name: 'Tome', url: 'https://tome.app', category: 'í”„ë ˆì  í…Œì´ì…˜', icon: 'fas fa-book-open', color: '#10B981' }
];

// AI ë„êµ¬ ë¶ˆëŸ¬ì˜¤ê¸°
function loadAiTools() {
  const saved = localStorage.getItem(AI_WORKFLOW_KEY);
  if (saved) {
    try {
      return JSON.parse(saved);
    } catch (error) {
      console.error('âŒ AI ë„êµ¬ íŒŒì‹± ì˜¤ë¥˜:', error);
      return DEFAULT_AI_TOOLS;
    }
  }
  return DEFAULT_AI_TOOLS;
}

// AI ë„êµ¬ ì €ì¥
function saveAiTools(tools) {
  localStorage.setItem(AI_WORKFLOW_KEY, JSON.stringify(tools));
}

// AI ì›Œí¬í”Œë¡œìš° ëª¨ë‹¬ ì—´ê¸°
function openAiWorkflowModal() {
  const modal = document.getElementById('aiWorkflowModal');
  if (!modal) {
    console.error('âŒ AI ì›Œí¬í”Œë¡œìš° ëª¨ë‹¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    return;
  }
  
  modal.style.display = 'flex';
  renderAiToolsList();
}

// AI ì›Œí¬í”Œë¡œìš° ëª¨ë‹¬ ë‹«ê¸°
function closeAiWorkflowModal() {
  const modal = document.getElementById('aiWorkflowModal');
  if (modal) {
    modal.style.display = 'none';
  }
}

// AI ë„êµ¬ ëª©ë¡ ë Œë”ë§ (ì¹´í…Œê³ ë¦¬ë³„)
function renderAiToolsList() {
  const container = document.getElementById('aiWorkflowList');
  if (!container) return;
  
  const tools = loadAiTools();
  
  if (tools.length === 0) {
    container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">ì €ì¥ëœ AI ë„êµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
    return;
  }
  
  // ì¹´í…Œê³ ë¦¬ë³„ ê·¸ë£¹í™”
  const categories = {};
  tools.forEach((tool, index) => {
    if (!categories[tool.category]) {
      categories[tool.category] = [];
    }
    categories[tool.category].push({ ...tool, index });
  });
  
  container.innerHTML = Object.keys(categories).map(category => `
    <div style="margin-bottom: 20px;">
      <h3 style="font-weight: 600; color: #1f2937; margin-bottom: 12px; font-size: 1rem;">
        ${category}
      </h3>
      ${categories[category].map(tool => `
        <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: #f9fafb; border-radius: 8px; margin-bottom: 8px;">
          <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
            <i class="${tool.icon}" style="font-size: 20px; color: ${tool.color}; width: 28px; text-align: center;"></i>
            <div style="flex: 1;">
              <div style="font-weight: 600; color: #1f2937; margin-bottom: 2px;">${tool.name}</div>
              <a href="${tool.url}" target="_blank" style="color: #6b7280; font-size: 0.75rem; text-decoration: none;" 
                 onmouseover="this.style.textDecoration='underline'" 
                 onmouseout="this.style.textDecoration='none'">
                ${tool.url}
              </a>
            </div>
          </div>
          <div style="display: flex; gap: 6px;">
            <button onclick="editAiTool(${tool.index})" style="padding: 6px 10px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.75rem;">
              <i class="fas fa-edit"></i>
            </button>
            <button onclick="deleteAiTool(${tool.index})" style="padding: 6px 10px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.75rem;">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      `).join('')}
    </div>
  `).join('');
}

// ìƒˆ AI ë„êµ¬ ì¶”ê°€
function addNewAiTool() {
  editingAiToolIndex = null; // ìƒˆë¡œ ì¶”ê°€
  document.getElementById('editAiToolName').value = '';
  document.getElementById('editAiToolUrl').value = '';
  document.getElementById('editAiToolCategory').value = 'ì´ë¯¸ì§€ ìƒì„±';
  document.getElementById('editAiToolModal').style.display = 'flex';
}

// AI ë„êµ¬ ìˆ˜ì •
let editingAiToolIndex = null;

function editAiTool(index) {
  editingAiToolIndex = index;
  const tools = loadAiTools();
  const tool = tools[index];
  
  document.getElementById('editAiToolName').value = tool.name;
  document.getElementById('editAiToolUrl').value = tool.url;
  document.getElementById('editAiToolCategory').value = tool.category;
  document.getElementById('editAiToolModal').style.display = 'flex';
}

// AI ë„êµ¬ ìˆ˜ì • ì €ì¥
function saveEditAiTool() {
  const name = document.getElementById('editAiToolName').value.trim();
  const url = document.getElementById('editAiToolUrl').value.trim();
  const category = document.getElementById('editAiToolCategory').value;
  
  if (!name || !url) {
    showToast('âš ï¸ ì´ë¦„ê³¼ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'warning');
    return;
  }
  
  const tools = loadAiTools();
  
  if (editingAiToolIndex === null) {
    // ìƒˆë¡œ ì¶”ê°€
    tools.push({
      name: name,
      url: url,
      category: category,
      icon: 'fas fa-robot',
      color: '#6366f1'
    });
    showToast('âœ… AI ë„êµ¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
  } else {
    // ê¸°ì¡´ ìˆ˜ì •
    tools[editingAiToolIndex] = {
      ...tools[editingAiToolIndex],
      name: name,
      url: url,
      category: category
    };
    showToast('âœ… AI ë„êµ¬ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
  }
  
  saveAiTools(tools);
  renderAiToolsList();
  cancelEditAiTool();
}

// AI ë„êµ¬ ìˆ˜ì • ì·¨ì†Œ
function cancelEditAiTool() {
  document.getElementById('editAiToolModal').style.display = 'none';
  editingAiToolIndex = null;
}

// AI ë„êµ¬ ì‚­ì œ
function deleteAiTool(index) {
  if (!confirm('ì´ AI ë„êµ¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  
  const tools = loadAiTools();
  tools.splice(index, 1);
  
  saveAiTools(tools);
  renderAiToolsList();
  showToast('âœ… AI ë„êµ¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
}

// ì „ì—­ ë…¸ì¶œ
window.openSnsLinksModal = openSnsLinksModal;
window.closeSnsLinksModal = closeSnsLinksModal;
window.addNewSnsLink = addNewSnsLink;
window.editSnsLink = editSnsLink;
window.saveEditSns = saveEditSns;
window.cancelEditSns = cancelEditSns;
window.deleteSnsLink = deleteSnsLink;

window.openAiWorkflowModal = openAiWorkflowModal;
window.closeAiWorkflowModal = closeAiWorkflowModal;
window.addNewAiTool = addNewAiTool;
window.editAiTool = editAiTool;
window.saveEditAiTool = saveEditAiTool;
window.cancelEditAiTool = cancelEditAiTool;
window.deleteAiTool = deleteAiTool;
